<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Кайнракс — рассказы</title>
  <meta name="description" content="Тёмная НФ о подземной цивилизации, где магия — это сбой в физике. Обновления — пт/сб." />
  <meta name="theme-color" content="#0b0f14" />
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23FFD54A' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E">

  <!-- (A) Open Graph / Twitter Meta -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Кайнракс — рассказы">
  <meta property="og:title" content="Кайнракс — рассказы">
  <meta property="og:description" content="Тёмная НФ о подземной цивилизации, где магия — это сбой в физике. Обновления — пт/сб.">
  <meta property="og:image" content="https://kainrax.site/og/kainrax-og.jpg">
  <meta property="og:locale" content="ru_RU">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Кайнракс — рассказы">
  <meta name="twitter:description" content="Короткая НФ без лорового барьера. Обновления — пт/сб.">
  <meta name="twitter:image" content="https://kainrax.site/og/kainrax-og.jpg">

  <!-- (A) Plausible (замените домен, если он другой) -->
  <script defer data-domain="kainrax.site" src="https://plausible.io/js/script.js"></script>

  <style>
  :root{
    --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa5b1;
    --card:rgba(16,21,32,.92); --line:#223042;
    --accent:#7dd3fc; --accent2:#a78bfa; --link:#93c5fd;
    --max:1024px; --r:14px; --shadow:0 12px 36px rgba(0,0,0,.45);
    --code:#0a0e16; --mountain:#121723; --star:rgba(255,255,255,.9);
  }
  [data-theme="light"]{
    --bg:#f7fbff; --fg:#0b0f14; --muted:#5a6774;
    --card:rgba(255,255,255,.97); --line:#e6ecf2;
    --accent:#0ea5e9; --accent2:#7c3aed; --link:#1d4ed8;
    --shadow:0 8px 24px rgba(0,0,0,.08); --code:#f6f8fb; --mountain:#dfe7f3; --star:rgba(10,20,40,.85);
  }
  [data-theme="cringe"]{
    --bg:linear-gradient(135deg,#ffb6f3,#ffd699 50%,#b3f1ff);
    --fg:#111; --muted:#333; --card:rgba(255,255,255,.9); --line:#ffd1f4;
    --accent:#ff3ea5; --accent2:#07f49e; --link:#7c00ff;
    --shadow:0 14px 40px rgba(0,0,0,.25); --code:#fff5ff; --mountain:#ffc6fb; --star:rgba(0,0,0,.75);
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif}
  a{color:var(--link)}
  h1{margin:6px 0 10px;font-size:28px}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
  .btn,button{border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;box-shadow:var(--shadow)}
  input[type="search"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}

  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,21,32,.92), rgba(15,21,32,.7));backdrop-filter: blur(10px) saturate(1.1);border-bottom:1px solid var(--line)}
  [data-theme="light"] header{background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.75))}
  [data-theme="cringe"] header{background:linear-gradient(90deg, rgba(255,255,255,.9), rgba(255,255,255,.6))}
  .head{max-width:var(--max);margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand a{color:var(--fg);text-decoration:none}
  .search{flex:1;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  main{max-width:var(--max);margin:0 auto;padding:20px 16px 80px;position:relative;z-index:1}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:980px){ .grid{grid-template-columns:1.15fr .85fr;gap:22px} }
  .list{display:flex;flex-direction:column;gap:12px}
  
  .story-item{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(125,211,252,.08), transparent);border:1px solid rgba(125,211,252,.18)}
  .story-item a{color:var(--fg);text-decoration:none}
  .title{font-weight:700}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;margin-right:6px}
  .tag:before{content:"✶";color:var(--muted)}
  [data-theme="light"] .tag:before{content:"#" }
  .back{display:inline-flex;align-items:center;gap:8px;margin:6px 0 12px}
  
  /* ===== (B) НОВЫЕ СТИЛИ ===== */

  /* Сигилл-узор на карточках (тонкий) */
  .card { position:relative; overflow:hidden }
  .card::after {
    content:""; position:absolute; inset:0; pointer-events:none;
    background-image:
      radial-gradient(120px 120px at 10% -10%, rgba(125,211,252,.06), transparent 60%),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'><path d='M80 6 L87 27 L109 31 L87 35 L80 56 L73 35 L51 31 L73 27 Z' fill='rgba(125,211,252,0.06)'/></svg>");
    background-repeat:no-repeat, repeat;
    background-size:auto, 160px 160px;
    opacity: 0.7; /* Можно регулировать */
  }

  /* Тонкая полоска ветки */
  .story-item{ border-top:3px solid transparent }
  .story-item[data-arc="surface"]{ border-top-color:#10b981 }
  .story-item[data-arc="kainrax"]{ border-top-color:#7dd3fc }
  .story-item[data-arc="ibut"]{    border-top-color:#f59e0b }

  /* Глич логотипа ✶ */
  .brand a{ display:inline-block; transform:translateZ(0) }
  .brand a:hover{ animation:kx-glitch .6s steps(2,end) }
  @keyframes kx-glitch{
    30%{ transform:translate(.5px,-.5px) skewX(.3deg) }
    60%{ transform:translate(-.5px,.5px) skewY(.3deg) }
  }
  
  /* Шум-бумаги на пергаменте */
  .parchment{ background-blend-mode:multiply }
  .parchment::before{
    content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit;
    background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140'><filter id='n'><feTurbulence baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0.1'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 0 .03 .06 .03 0 0 0'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)' fill='rgba(0,0,0,1)'/></svg>");
    opacity:.55; mix-blend-mode:multiply;
  }
  
  /* ===== КОНЕЦ НОВЫХ СТИЛЕЙ ===== */

  .progress{position:fixed;left:0;top:0;height:3px;background:linear-gradient(90deg, var(--accent), var(--accent2));width:0;z-index:6}
  #timelineProgress{position:fixed;left:0;top:3px;height:2px;background:var(--accent);width:0;z-index:6;opacity:.7}

  /* Читаемый фон для текстов */
  .readbox{background:rgba(20,26,38,.98); border:1px solid #2a3a52; border-radius:18px; padding:16px; box-shadow: var(--shadow)}
  [data-theme="light"] .readbox{background:#fff; border-color:#e6ecf2}
  [data-theme="cringe"] .readbox{background:#fff; color:#1a1a1a; border-color:#e9e1d6}

  /* Пергамент */
  .parchment{ position:relative; overflow:hidden; background: radial-gradient(120% 120% at 50% 0%, rgba(255,245,230,.35), transparent 60%), linear-gradient(#f6efe1, #efe6d3); color:#2b2418; border:1px solid #e4d7bd; box-shadow: 0 10px 30px rgba(0,0,0,.18)}
  
  /* Маргиналии */
  .with-margin{display:grid;grid-template-columns:minmax(0,1fr) 220px;gap:18px}
  @media (max-width:980px){ .with-margin{grid-template-columns:1fr} }
  .margin-notes{position:sticky;top:76px;align-self:start}
  .margin-notes .mnote{font-size:13px; color:var(--muted); border-left:2px solid var(--line); padding-left:10px; margin-bottom:12px}
  .margin-notes .mnote strong { color: var(--fg); }
  .margin-notes .mnote a { cursor: pointer; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="progress" id="progress"></div>
  <div id="timelineProgress"></div>

  <header>
    <div class="head">
      <div class="brand"><a href="#/">Кайнракс ✶</a></div>
      <div class="search" style="max-width:860px">
        <span class="pill" title="Новые тексты чаще всего выходят в эти дни">Обновления: пт/сб</span>
        <input id="q" type="search" placeholder="Поиск по рассказам…" aria-label="Поиск" />
        <a class="btn" href="#/arcs">Ветки</a>
        <a class="btn" href="#/perg">Пергамент</a>
      </div>
    </div>
  </header>

  <main id="app" aria-live="polite"></main>

  <script>
  const PERG = { CODE: 'Chronicle', CODE_HASH: null };
  const app=document.getElementById('app');
  const qEl=document.getElementById('q');
  const state={ theme: localStorage.getItem('theme') || 'dark', route: location.hash.slice(1)||'/', q:'' };

  /* ===== (C) ПРОСМОТРЫ (per-story) ===== */
  const VIEW_NS = "kainrax.site"; // Неймспейс для countapi
  function countKey(slug){ return `story:${slug}`; }
  function viewedKey(slug){ return `viewed:${slug}`; }

  async function incAndGetViews(slug){
    const k = countKey(slug);
    // Один уникальный инкремент на устройство: localStorage-«предохранитель»
    const ukey = viewedKey(slug);
    const already = localStorage.getItem(ukey)==='1';

    const endpoint = already
      ? `https://api.countapi.xyz/get/${encodeURIComponent(VIEW_NS)}/${encodeURIComponent(k)}`
      : `https://api.countapi.xyz/hit/${encodeURIComponent(VIEW_NS)}/${encodeURIComponent(k)}`;

    try{
      const r = await fetch(endpoint, {cache:'no-store'});
      const j = await r.json();
      if(!already) localStorage.setItem(ukey, '1');
      return Number(j.value||0);
    }catch(_){ return 0; }
  }

  const fmtHumanDate=iso=>{ try{const d=new Date(iso);return d.toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'});}catch(_){return iso} };
  function fmtPergDayYear(s){
    if(typeof s!== 'string') return String(s||'');
    const m = s.match(/^(\d{4})-(\d{3})$/);
    if(!m) return fmtHumanDate(s);
    return `${Number(m[2])}-й день ${Number(m[1])}-го года`;
  }
  const getAnno = s => (s.annotation || '').trim();

  let stories=[], pergDocs=[];
  async function safeJson(url, def){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) return def; return await r.json(); }catch(_){ return def; } }
  async function loadContent(){
    stories = await safeJson('content/stories.json', []);
    pergDocs = await safeJson('content/pergament/index.json', []);
    stories.sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0)));
    pergDocs.forEach(d=>{ (d.editions||[]).sort((a,b)=> String(a.date||'').localeCompare(String(b.date||''))); });
    pergDocs.sort((a,b)=> {
      const ad=(a.editions||[]); const bd=(b.editions||[]);
      const al=ad[ad.length-1]?.date||''; const bl=bd[bd.length-1]?.date||'';
      return String(bl).localeCompare(String(al));
    });
  }

  /* ===== ТЕМА & ADMIN ===== */
  function applyTheme(){ document.documentElement.setAttribute('data-theme', state.theme); localStorage.setItem('theme', state.theme); }
  applyTheme();
  let isAdmin = new URLSearchParams(location.search).has('admin') || localStorage.getItem('admin')==='1';
  if(new URLSearchParams(location.search).has('admin')){ localStorage.setItem('admin','1'); history.replaceState({},'',location.pathname+location.hash); }

  /* ===== ROUTER ===== */
  addEventListener('hashchange',()=>{ state.route=location.hash.slice(1)||'/'; render(); });
  qEl.addEventListener('input',()=>{ state.q=qEl.value.trim().toLowerCase(); render(); });

  /* ===== ВЬЮХИ ===== */
  const arcMeta = {
    surface: {id:'surface', title:'Поверхность', desc:'Рассказы и повести не о Кайнракс.', color: '#10b981'},
    kainrax: {id:'kainrax',  title:'Кайнракс',    desc:'Рассказы и повести внутри Кайнракс.', color: '#7dd3fc'},
    ibut:    {id:'ibut',     title:'ИБУТ',        desc:'Лёгкое чтиво про попаданцев.', color: '#f59e0b'},
  };

  function renderList(){
    const q=state.q;
    const items=stories.filter(s=>!q || s.title?.toLowerCase().includes(q));
    app.innerHTML=`
      <div class="grid">
        <section class="card">
          <h1>Рассказы</h1>
          <div class="list">
            ${items.map(s=>`
              <div class="story-item" data-arc="${s.arc||'kainrax'}">
                <a href="#/read/${s.slug||s.id}">
                  <div class="title">${s.title||'Без названия'}</div>
                  <div class="muted">${fmtHumanDate(s.date)} · ветка: ${(arcMeta[s.arc||'kainrax']||{title:'Ветка'}).title}</div>
                </a>
              </div>`).join('')}
          </div>
        </section>
        <aside class="card">
          <h2>Ветки</h2>
          <div class="list">
            ${Object.values(arcMeta).map(a=>`
              <div class="story-item" data-arc="${a.id}">
                <a href="#/arc/${a.id}"><div class="title">${a.title}</div></a>
              </div>`).join('')}
          </div>
        </aside>
      </div>`;
  }
  
  function renderArticle(id){
    const s=stories.find(x=>x.id===id||x.slug===id);
    if(!s){location.hash='#/'; return;}
    
    app.innerHTML=`
      <a class="back" href="#/">← К списку</a>
      <article class="with-margin" data-id="${s.id}" data-slug="${s.slug||s.id}">
        <div class="prose readbox">
          <h1>${s.title}</h1>
          <div class="muted">
            ${fmtHumanDate(s.date)}
            · <a href="#/arc/${s.arc||'kainrax'}">${(arcMeta[s.arc||'kainrax']||{title:'Ветка'}).title}</a>
            <span id="viewsBox" style="display:${isAdmin?'inline':'none'}"> · — просмотров</span>
          </div>
          ${(s.text||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}
        </div>
        <aside class="margin-notes"></aside>
      </article>`;
    
    // Вызов счётчика просмотров
    const vbox = document.getElementById('viewsBox');
    if (isAdmin && vbox) {
      const slugOrId = s.slug || s.id;
      incAndGetViews(slugOrId).then(v => {
        if (vbox) vbox.textContent = ` · ${v} просмотров`;
      });
    }
  }

  function renderPergList(){
    app.innerHTML = `<section class="card"><h1>Пергамент</h1>
      <div class="list">${pergDocs.map(d=>{
        const e=(d.editions||[])[(d.editions||[]).length-1]||{};
        return `<div class="story-item">
          <a href="#/perg/${d.id}"><div class="title">📜 ${d.title}</div></a>
        </div>`;
      }).join('')}</div></section>`;
  }

  async function renderPerg(id){
    const d = pergDocs.find(x=>x.id===id);
    if(!d || !d.editions?.length){ location.hash = '#/perg'; return; }
    
    const editions = d.editions;
    const lastEd = editions[editions.length-1];
    const chosenId = new URLSearchParams(location.hash.split('?')[1]).get('e') || lastEd.id;
    const e = editions.find(x=>x.id===chosenId) || lastEd;
    
    let body = '(не удалось загрузить текст)';
    try{ body = await fetch(e.file, {cache:'no-store'}).then(r=>r.ok?r.text():''); }catch(_){}

    const options = editions.map((x, i) => `<option value="${x.id}" ${x.id===e.id?'selected':''}>Ред. ${i+1}: ${x.title||fmtPergDayYear(x.date)}</option>`).join('');
    
    let marginNotesHTML = (d.margin || []).map(m => `<div class="mnote">${m}</div>`).join('');
    
    const prevEd = editions[editions.findIndex(x => x.id === e.id) - 1];
    if (prevEd) {
      marginNotesHTML += `<div class="mnote"><strong>Предыдущая редакция:</strong> <a onclick="document.getElementById('edSel').value='${prevEd.id}'; document.getElementById('edSel').dispatchEvent(new Event('change'));">${prevEd.title || fmtPergDayYear(prevEd.date)}</a></div>`;
    }

    app.innerHTML = `
      <a class="back" href="#/perg">← К «Пергаменту»</a>
      <article class="with-margin">
        <div class="prose parchment readbox">
          <h1>📜 ${d.title}</h1>
          <div class="muted">Редакции:
            <select id="edSel" class="btn">${options}</select>
          </div>
          <div class="scroll-body" style="margin-top: 1em;">
            ${body.split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}
          </div>
        </div>
        <aside class="margin-notes">${marginNotesHTML}</aside>
      </article>`;

    const sel=document.getElementById('edSel');
    const timelineProgress=document.getElementById('timelineProgress');
    
    function updateTimeline(){
      const currentIdx = editions.findIndex(ed => ed.id === sel.value);
      const progress = editions.length > 1 ? (currentIdx / (editions.length - 1)) * 100 : 100;
      timelineProgress.style.width = `${progress}%`;
    }

    if(sel){
      sel.onchange=()=>{
        // Здесь должен быть ваш код с prompt для доступа, если нужно
        const newEdId = sel.value;
        location.hash = `#/perg/${d.id}?e=${newEdId}`;
        updateTimeline();
      };
      updateTimeline(); // Initial call
    }
  }

  function render(){
    const r=state.route;
    const timelineProgress=document.getElementById('timelineProgress');
    timelineProgress.style.width = '0%'; // Сбрасываем таймлайн при смене роута

    if(r==='/'||r===''){ renderList(); return; }
    const mRead=r.match(/^\/read\/([^?]+)/); if(mRead){ renderArticle(mRead[1]); return; }
    if(r==='/perg'){ renderPergList(); return; }
    const mPerg=r.match(/^\/perg\/([^?]+)/); if(mPerg){ renderPerg(mPerg[1]); return; }
    renderList();
  }

  loadContent().then(()=>{ 
    applyTheme(); 
    render();
  });
  </script>
</body>
</html>
