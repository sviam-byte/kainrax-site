<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã</title>
  <meta name="description" content="–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –ø—è—Ç–Ω–∏—Ü–∞/—Å—É–±–±–æ—Ç–∞. –í–µ—Ç–∫–∏: –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å, –ö–∞–π–Ω—Ä–∞–∫—Å, –ò–ë–£–¢." />
  <meta name="theme-color" content="#0b0f14" />
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23FFD54A' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E">

  <style>
  :root{
    --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa5b1;
    --card:rgba(16,21,32,.85); --line:#223042;
    --accent:#7dd3fc; --accent2:#a78bfa; --link:#93c5fd;
    --max:1024px; --r:14px; --shadow:0 12px 36px rgba(0,0,0,.45);
    --code:#0a0e16; --mountain:#121723; --star:rgba(255,255,255,.9);
  }
  [data-theme="light"]{
    --bg:#f7fbff; --fg:#0b0f14; --muted:#5a6774;
    --card:rgba(255,255,255,.92); --line:#e6ecf2;
    --accent:#0ea5e9; --accent2:#7c3aed; --link:#1d4ed8;
    --shadow:0 8px 24px rgba(0,0,0,.08); --code:#f6f8fb; --mountain:#dfe7f3; --star:rgba(10,20,40,.85);
  }
  [data-theme="cringe"]{
    --bg:linear-gradient(135deg,#ffb6f3,#ffd699 50%,#b3f1ff);
    --fg:#111; --muted:#333; --card:rgba(255,255,255,.88); --line:#ffd1f4;
    --accent:#ff3ea5; --accent2:#07f49e; --link:#7c00ff;
    --shadow:0 14px 40px rgba(0,0,0,.25); --code:#fff5ff; --mountain:#ffc6fb; --star:rgba(0,0,0,.75);
    font-family: "Comic Sans MS", "Comic Sans", cursive;
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif}
  a{color:var(--link)}
  h1,h2,h3{margin:6px 0 10px;font-weight:700}
  h1{font-size:28px}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
  .btn,button{border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;box-shadow:var(--shadow)}
  input[type="search"],input[type="password"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg);width:100%;box-sizing:border-box;}

  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,21,32,.92), rgba(15,21,32,.7));backdrop-filter: blur(10px) saturate(1.1);border-bottom:1px solid var(--line)}
  [data-theme="light"] header{background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.75))}
  [data-theme="cringe"] header{background:linear-gradient(90deg, rgba(255,255,255,.9), rgba(255,255,255,.6))}
  .head{max-width:var(--max);margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand a{color:var(--fg);text-decoration:none}
  .nav-links{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

  main{max-width:var(--max);margin:0 auto;padding:20px 16px 80px;position:relative;z-index:1}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:980px){ .grid{grid-template-columns:1.15fr .85fr;gap:22px} }
  .list{display:flex;flex-direction:column;gap:12px}
  .story-item{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(125,211,252,.08), transparent);border:1px solid rgba(125,211,252,.18)}
  .story-item a{color:var(--fg);text-decoration:none}
  .title{font-weight:700}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;margin-right:6px}
  .tag:before{content:"‚ú∂";color:var(--muted)}
  [data-theme="light"] .tag:before{content:"#"}
  .back{display:inline-flex;align-items:center;gap:8px;margin:6px 0 12px}

  .progress{position:fixed;left:0;top:0;height:3px;background:linear-gradient(90deg, var(--accent), var(--accent2));width:0;z-index:6}
  .prose p{line-height:1.75;margin:0 0 1.2em}
  .prose p:last-child{margin-bottom:0}

  .anno{color:var(--muted);font-style:italic;margin-top:6px}
  .anno-box{border:1px dashed var(--line);background:rgba(125,211,252,.06);padding:12px;border-radius:10px;margin:10px 0 14px}
  [data-theme="light"] .anno-box{background:rgba(14,165,233,.08)}
  [data-theme="cringe"] .anno-box{background:rgba(255,62,165,.08)}
  details.anno-dtl summary{cursor:pointer;user-select:none}

  /* —Ñ–æ–Ω */
  #stars{position:fixed;inset:0;z-index:0;pointer-events:none}
  #ceiling,#mountains{display:none}
  [data-theme="cringe"] #ceiling,[data-theme="cringe"] #mountains{display:block}
  #ceiling path, #mountains path{fill:var(--mountain)}
  
  /* –ú–æ–¥–∞–ª–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:20}
  .modal .box{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:24px;box-shadow:var(--shadow);max-width:440px;width:92%;text-align:center;}
  @keyframes shake { 10%, 90% {transform:translate3d(-1px,0,0);} 20%, 80% {transform:translate3d(2px,0,0);} 30%, 50%, 70% {transform:translate3d(-4px,0,0);} 40%, 60% {transform:translate3d(4px,0,0);} }
  .shake{animation:shake .82s cubic-bezier(.36,.07,.19,.97) both;}
  .denied-text{color:#ef4444;font-weight:700;letter-spacing:1px;margin-top:8px;display:none;}

  /* –ü–µ—Ä–≥–∞–º–µ–Ω—Ç–Ω—ã–π —Å—Ç–∏–ª—å */
  .parchment{background: radial-gradient(120% 120% at 50% 0%, rgba(255,245,230,.35), transparent 60%), linear-gradient(#f6efe1, #efe6d3); color:#2b2418; border:1px solid #e4d7bd; box-shadow: 0 10px 30px rgba(0,0,0,.18)}
  [data-theme="dark"] .parchment{background: radial-gradient(120% 120% at 50% 0%, rgba(90,70,40,.25), transparent 60%), linear-gradient(#2d261b, #201a12); color:#efe7d6; border-color:#5a4a35}
  .parchment h1, .parchment h2, .parchment h3{ font-family: Georgia, 'Times New Roman', serif; letter-spacing:.3px }
  .parchment .prose p{ text-indent:1.2em; }

  /* –ú–∞—Ä–≥–∏–Ω–∞–ª–∏–∏ */
  .with-margin{display:grid;grid-template-columns:minmax(0,1fr) 220px;gap:18px}
  @media (max-width:980px){ .with-margin{grid-template-columns:1fr} .margin-notes{display:none;} }
  .margin-notes{position:sticky;top:76px;align-self:start}
  .margin-notes .mnote{font-size:13px; color:var(--muted); border-left:2px solid var(--line); padding-left:10px; margin-bottom:12px}

  #adminDock{position:fixed;right:14px;bottom:14px;z-index:7;display:none}
  #adminBtns{display:none}
  </style>
</head>
<body>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div id="ceiling" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L8,18 L18,22 L28,15 L38,20 L48,12 L58,19 L68,13 L78,22 L88,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div id="mountains" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L10,18 L20,22 L30,14 L40,20 L50,10 L60,19 L70,13 L80,22 L90,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div class="progress" id="progress"></div>

  <header>
    <div class="head">
      <div class="brand"><a href="#/">–ö–∞–π–Ω—Ä–∞–∫—Å ‚ú∂</a></div>
      <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫‚Ä¶" aria-label="–ü–æ–∏—Å–∫" style="flex:1;min-width:120px;max-width:250px;" />
      <div class="nav-links">
        <a class="btn" href="#/arcs">–í–µ—Ç–∫–∏</a>
        <a class="btn" href="#/scrolls">–ü–µ—Ä–≥–∞–º–µ–Ω—Ç</a>
        <a class="btn" href="#/notes">–ó–∞–º–µ—Ç–∫–∏</a>
        <a class="btn" href="#/perg">–ü–ª–∞–Ω—ã</a>
        <a class="btn" href="#/project">–û –ø—Ä–æ–µ–∫—Ç–µ</a>
        <button id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
      </div>
      <span id="adminBtns">
        <a class="btn" href="/admin/" target="_blank" rel="noopener">–ê–¥–º–∏–Ω–∫–∞</a>
        <a class="btn" href="/admin/#/collections/stories/new" target="_blank" rel="noopener">+ –†–∞—Å—Å–∫–∞–∑</a>
        <a class="btn" href="/admin/#/collections/notes/new"  target="_blank" rel="noopener">+ –ó–∞–º–µ—Ç–∫–∞</a>
        <a class="btn" href="/admin/#/collections/pergament/new" target="_blank" rel="noopener">+ –ü–ª–∞–Ω</a>
      </span>
    </div>
  </header>

  <div id="adminDock"><a class="btn" id="editThisBtn" target="_blank" rel="noopener">‚úèÔ∏è –ü—Ä–∞–≤–∏—Ç—å</a></div>
  <main id="app" aria-live="polite"></main>

  <script>
  /* ===== –ö–û–ù–°–¢–ê–ù–¢–´/–°–û–°–¢–û–Ø–ù–ò–ï ===== */
  window.CUSDIS_APP_ID = "079685b7-f335-4fbd-9217-9d857a3cc369";

  const app=document.getElementById('app');
  const qEl=document.getElementById('q');
  const state={ theme: localStorage.getItem('theme') || 'dark', route: location.hash.slice(1)||'/', q:'' };

  /* ===== –£–¢–ò–õ–´ ===== */
  const fmtDate=iso=>{ try{const d=new Date(iso);return d.toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'});}catch(_){return iso} };
  const getAnno = (s) => {
    const a = (s.annotation || s.anno || s.summary || '').trim();
    if (a) return a;
    const txt = (s.text || '').replace(/(<([^>]+)>)/gi, "").replace(/\s+/g, ' ').trim();
    if (!txt) return '';
    const cut = 180;
    return txt.length > cut ? txt.slice(0, cut) + '‚Ä¶' : txt;
  };
  const parseText = (text) => (text||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('');

  /* ===== –î–ê–ù–ù–´–ï ===== */
  let stories=[], notes=[], pergaments=[], scrolls=[];
  async function safeJson(url, def=[]){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) return def; return await r.json(); }catch(_){ return def; } }
  async function loadContent(){
    // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
    const j = await safeJson('content/index.json', {});
    stories = Array.isArray(j.stories) ? j.stories : await safeJson('content/stories.json');
    notes = Array.isArray(j.notes) ? j.notes : await safeJson('content/notes.json');
    pergaments = Array.isArray(j.pergaments) ? j.pergaments : await safeJson('content/pergament.json');

    // –ü–µ—Ä–≥–∞–º–µ–Ω—Ç—ã (–≤–Ω—É—Ç—Ä–∏–º–∏—Ä–æ–≤—ã–µ)
    scrolls = await safeJson('content/scrolls/index.json');
    
    [stories, notes, pergaments, scrolls].forEach(arr => arr.sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0))));
  }

  /* ===== –í–ï–¢–ö–ò ===== */
  const arcMeta = { surface:{id:'surface',title:'–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å'}, kainrax:{id:'kainrax',title:'–ö–∞–π–Ω—Ä–∞–∫—Å'}, ibut:{id:'ibut',title:'–ò–ë–£–¢'} };
  function buildArcs(){
    const map = {}; stories.forEach(s => { const id = s.arc || 'kainrax'; if(!map[id]) map[id] = { ...(arcMeta[id]||{id,title:id}), items:[] }; map[id].items.push(s); });
    for(const k in map) map[k].items.sort((a,b)=> (a.order||Infinity)-(b.order||Infinity)||(new Date(a.date||0))-(new Date(b.date||0)));
    return Object.values(map);
  }

  /* ===== –¢–ï–ú–ê ===== */
  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme);
    localStorage.setItem('theme', state.theme);
    setUtterancesTheme(state.theme);
    setCusdisTheme();
    const el=document.getElementById('favicon'); const color=state.theme==='light'?'%230A1830':'%23FFD54A';
    el.href = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='${color}' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E`;
  }
  applyTheme();
  document.getElementById('themeBtn').onclick=()=>{ state.theme = state.theme==='dark'?'light':(state.theme==='light'?'cringe':'dark'); applyTheme(); };

  /* ===== –ê–î–ú–ò–ù–ö–ê ===== */
  let isAdmin=new URLSearchParams(location.search).has('admin')||localStorage.getItem('admin')==='1';
  if(new URLSearchParams(location.search).has('admin')){localStorage.setItem('admin','1');history.replaceState({},'',location.pathname+location.hash);}
  function ensureAdminUI(){document.getElementById('adminBtns').style.display=isAdmin?'inline-flex':'none';if(!isAdmin)adminDockHide();}
  addEventListener('keydown',e=>{if(e.altKey&&e.shiftKey&&e.key.toLowerCase()==='a'){isAdmin=!isAdmin;localStorage.setItem('admin',isAdmin?'1':'0');ensureAdminUI();}});

  /* ===== –†–û–£–¢–ï–† ===== */
  addEventListener('hashchange',()=>{state.route=location.hash.slice(1)||'/';render();restoreScroll();});
  qEl.addEventListener('input',()=>{state.q=qEl.value.trim().toLowerCase();render();});

  /* ===== –†–ï–ù–î–ï–† –°–¢–†–ê–ù–ò–¶ ===== */
  function renderItem(item, type) {
    let href, typeName;
    switch(type) {
      case 'story': href = `#/read/${item.slug||item.id}`; typeName = `–í–µ—Ç–∫–∞: ${(arcMeta[item.arc||'kainrax']||{title:''}).title}`; break;
      case 'note': href = `#/note/${item.slug||item.id}`; typeName = `–ó–∞–º–µ—Ç–∫–∞`; break;
      case 'perg': href = `#/perg/${item.slug||item.id}`; typeName = `–ü–ª–∞–Ω`; break;
    }
    return `<div class="story-item">
        <a href="${href}">
          <div class="title">‚ú∂ ${item.title}</div>
          <div class="muted">${fmtDate(item.date)} ¬∑ ${typeName}</div>
        </a>
        ${getAnno(item)?`<div class="anno">${getAnno(item)}</div>`:''}
      </div>`;
  }

  function renderList(){
    const q = state.q;
    let filteredItemsHtml = '';
    if (q) {
        const allContent = [
            ...stories.map(s => ({...s, type: 'story'})),
            ...notes.map(n => ({...n, type: 'note'})),
            ...pergaments.map(p => ({...p, type: 'perg'}))
        ];
        const items = allContent.filter(s => s.title?.toLowerCase().includes(q) || (s.text||'').toLowerCase().includes(q) || (s.tags||[]).join(' ').toLowerCase().includes(q));
        filteredItemsHtml = items.length ? items.map(item => renderItem(item, item.type)).join('') : '<div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
    }

    const arcs = buildArcs();
    app.innerHTML= q ? `<section class="card"><h1>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h1><div class="list">${filteredItemsHtml}</div></section>` : `
      <div class="grid">
        <section class="card">
          <h1>–†–∞—Å—Å–∫–∞–∑—ã</h1>
          <div class="list">${stories.map(s=>renderItem(s, 'story')).join('')}</div>
        </section>
        <aside class="card">
          <h2>–í–µ—Ç–∫–∏</h2>
          <div class="list">${arcs.map(a=>`<div class="story-item"><a href="#/arc/${a.id}"><div class="title">‚ú∂ ${a.title}</div><div class="muted">${a.items.length} —Ç–µ–∫—Å—Ç(–∞)</div></a></div>`).join('')}</div>
          <h3 style="margin-top:14px">–ü–æ–¥–ø–∏—Å–∫–∞</h3>
          <p class="muted">–¢–µ–ª–µ–≥—Ä–∞–º: <a href="https://t.me/kainrax" target="_blank" rel="noopener">@kainrax</a></p>
        </aside>
      </div>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArticle(id, collection, backUrl, type, renderFunc) {
      const item = collection.find(x => x.id === id || x.slug === id);
      if (!item) { location.hash = backUrl; return; }
      
      let headerMeta = `<div class="muted">${fmtDate(item.date)}</div>`;
      let navHtml = '';

      if (type === 'story') {
        const arcs = buildArcs();
        const a = arcs.find(x => x.id === (item.arc || 'kainrax')) || { items: [] };
        const order = a.items;
        const pos = Math.max(0, order.findIndex(v => v.id === item.id || (v.slug && v.slug === item.slug)));
        const prev = order[pos - 1], next = order[pos + 1];
        headerMeta = `<div class="muted">${fmtDate(item.date)} ¬∑ ${item.minutes||'5'} –º–∏–Ω ¬∑ <a href="#/arc/${item.arc||'kainrax'}">${(arcMeta[item.arc||'kainrax']||{title:'–í–µ—Ç–∫–∞'}).title}</a></div>`;
        navHtml = `<hr style="border:0;border-top:1px solid var(--line);margin:18px 0">
          <div style="display:flex;justify-content:space-between;gap:10px">
            ${prev?`<a class="btn" href="#/read/${prev.slug||prev.id}">‚Üê ${prev.title}</a>`:'<span></span>'}
            ${next?`<a class="btn" href="#/read/${next.slug||next.id}">${next.title} ‚Üí</a>`:'<span></span>'}
          </div>`;
      }

      app.innerHTML = `
        <a class="back" href="${backUrl}">‚Üê –ù–∞–∑–∞–¥</a>
        <article class="prose with-margin" data-id="${item.id}" data-slug="${item.slug||item.id}">
          <div>
            <h1>${item.title}</h1>
            ${headerMeta}
            <div style="margin:6px 0 12px">${(item.tags||[]).map(t=>`<a class='tag' href='#/tag/${encodeURIComponent(t)}'>${t}</a>`).join(' ')}</div>
            ${getAnno(item) ? `<details class="anno-dtl anno-box"><summary><strong>–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è</strong></summary><div style="margin-top:8px">${getAnno(item)}</div></details>` : ''}
            ${parseText(item.text)}
            ${navHtml}
          </div>
          <aside class="margin-notes">${(Array.isArray(item.margin)?item.margin:[]).map(m=>`<div class="mnote">${m}</div>`).join('')}</aside>
        </article>
        <section class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></section>`;

      mountComments(`${type}:${item.slug||item.id}`);
      setTimeout(restoreScroll, 0);
      adminDockFor(type, item.slug || item.id);
  }

  /* ===== –ü–ï–†–ì–ê–ú–ï–ù–¢ (–í–ù–£–¢–†–ò–ú–ò–†–û–í–û–ô) ===== */
  const seriesKey = (sc) => sc.series || (sc.id || '').replace(/-?\d+$/, '') || sc.title;
  
  function renderScrolls() {
    app.innerHTML = `<section class="card">
      <h1>–ü–µ—Ä–≥–∞–º–µ–Ω—Ç</h1>
      <div class="muted">–í–Ω—É—Ç—Ä–∏–º–∏—Ä–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Ö—Ä–æ–Ω–∏–∫–∏ –∏ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞.</div>
      <div class="list" style="margin-top:12px">
        ${(scrolls || []).map(sc => `
          <div class="story-item">
            <a href="#/scroll/${sc.id}">
              <div class="title">${sc.protected ? 'üîí' : 'üìú'} ${sc.title} ‚Äî <i>${sc.edition}</i></div>
              <div class="muted">${fmtDate(sc.date)} ¬∑ ${sc.chronicler || ''}</div>
              ${sc.annotation ? `<div class="anno">${sc.annotation}</div>` : ''}
            </a>
          </div>`).join('')}
      </div>
    </section>`;
    adminDockHide(); ensureAdminUI();
  }

  async function renderScroll(id) {
    const sc = (scrolls || []).find(x => x.id === id || x.slug === id);
    if (!sc) { location.hash = '#/scrolls'; return; }

    if (sc.protected) {
      const key = 'scroll:' + sc.id + ':ok';
      if (localStorage.getItem(key) !== '1') {
        const pass = await showAccessModal(sc);
        if (pass) {
          localStorage.setItem(key, '1');
        } else {
          location.hash = '#/scrolls';
          return;
        }
      }
    }

    let body = '';
    try { body = await fetch(sc.file, { cache: 'no-store' }).then(r => r.ok ? r.text() : Promise.reject()); }
    catch (_) { body = '(–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç)'; }

    const same = scrolls.filter(x => seriesKey(x) === seriesKey(sc));
    same.sort((a, b) => (new Date(a.date || 0)) - (new Date(b.date || 0)));
    const i = Math.max(0, same.findIndex(x => x.id === sc.id));
    const prev = same[i - 1], next = same[i + 1];

    app.innerHTML = `
      <a class="back" href="#/scrolls">‚Üê –ö ¬´–ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É¬ª</a>
      <article class="prose parchment" data-id="${sc.id}">
        <h1>${sc.title}</h1>
        <h2>${sc.edition}</h2>
        <div class="muted">${fmtDate(sc.date)} ¬∑ ${sc.chronicler || ''}</div>
        
        <nav style="display:flex;gap:8px;justify-content:space-between;margin:12px 0">
          ${prev ? `<a class="btn" href="#/scroll/${prev.id}">‚Üê ${prev.edition}</a>` : '<span></span>'}
          ${next ? `<a class="btn" href="#/scroll/${next.id}">${next.edition} ‚Üí</a>` : '<span></span>'}
        </nav>

        ${sc.annotation ? `<details class="anno-dtl" open><summary><strong>–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è</strong></summary><div style="margin-top:8px">${sc.annotation}</div></details>` : ''}
        
        <div class="scroll-body" style="margin-top:1em">${parseText(body)}</div>
      </article>

      <section class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></section>`;
    mountComments('scroll:' + sc.id); setTimeout(restoreScroll, 0);
    adminDockFor('scroll', sc.slug || sc.id);
  }

  async function sha256Hex(text){
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function checkCode(input, codeHash){
    if(!codeHash) return true;
    const [alg, hex] = codeHash.split(':');
    if((alg||'sha256')!=='sha256') return false;
    return (await sha256Hex((input||'').trim())).toLowerCase()===hex.toLowerCase();
  }
  function showAccessModal(cfg){
    return new Promise(resolve=>{
      const wrap=document.createElement('div');
      wrap.className='modal';
      wrap.innerHTML=`<div class="box">
        <h3>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h3>
        <p class="muted">${cfg.codeHint||'–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞.'}</p>
        <input id="codeIn" type="password" placeholder="–ö–û–î" />
        <div class="denied-text">–û–¢–ö–ê–ó–ê–ù–û –í –î–û–°–¢–£–ü–ï</div>
        <div style="display:flex; gap:8px; margin-top:16px">
          <button class="btn" id="okBtn" style="flex:1;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          <button class="btn" id="cancelBtn" style="background:transparent">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>`;
      document.body.appendChild(wrap);
      const box = wrap.querySelector('.box'); const codeIn=wrap.querySelector('#codeIn'); const ok=wrap.querySelector('#okBtn'); const cancel=wrap.querySelector('#cancelBtn'); const err=wrap.querySelector('.denied-text');
      
      function close(result) { wrap.remove(); resolve(result); }
      cancel.onclick=()=>close(false);
      ok.onclick=async()=>{
        const pass = await checkCode(codeIn.value, cfg.codeHash);
        if(pass){ close(true); } 
        else { 
          err.style.display='block';
          box.classList.add('shake');
          setTimeout(() => box.classList.remove('shake'), 820);
          codeIn.select(); 
        }
      };
      codeIn.onkeydown=(e)=>{ if(e.key==='Enter') ok.click(); };
      setTimeout(()=>codeIn.focus(),0);
    });
  }


  /* ===== –î–†–£–ì–ò–ï –°–¢–†–ê–ù–ò–¶–´ ===== */
  const renderPage = (title, collection, backUrl, type, renderFunc) => {
    app.innerHTML=`<section class="card"><h1>${title}</h1><div class="list">${collection.map(item => renderItem(item, type)).join('')}</div></section>`;
    adminDockHide();
  };

  function renderProject() {
    const src = (pergaments || []).concat(notes || []);
    const wips = src.filter(n => /\b(wip|–ø–ª–∞–Ω—ã|–≤ —Ä–∞–±–æ—Ç–µ|work|writing)\b/i.test((n.tags || []).join(' ')))
                    .sort((a, b) => (new Date(b.date || 0)) - (new Date(a.date || 0)));
    const wip = wips[0] || null;
    let wipHtml = `<div class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–≥–æ–º ¬´–≤ —Ä–∞–±–æ—Ç–µ¬ª.</div>`;
    if (wip) {
      const isPerg = pergaments.includes(wip);
      wipHtml = renderItem(wip, isPerg ? 'perg' : 'note');
    }
    app.innerHTML = `<section class="card">
        <h1>–û –ø—Ä–æ–µ–∫—Ç–µ</h1>
        <div class="prose"><p>¬´–ö–∞–π–Ω—Ä–∞–∫—Å¬ª ‚Äî —ç—Ç–æ —Å–±–æ—Ä–Ω–∏–∫ –Ω–∞—É—á–Ω–æ-—Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—Å–∫–∞–∑–æ–≤. –ù–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã –≤—ã—Ö–æ–¥—è—Ç –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ.</p></div>
        <h3 style="margin-top:1.5em">–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –ø–∏—à–µ—Ç—Å—è</h3>
        ${wipHtml}
      </section>`;
    adminDockHide();
  }
  
  function renderTag(tag) {
    const all = [...stories.map(s=>({...s,type:'story'})),...notes.map(n=>({...n,type:'note'})),...pergaments.map(p=>({...p,type:'perg'}))];
    const items = all.filter(s => (s.tags||[]).map(t=>t.toLowerCase()).includes(tag.toLowerCase()));
    app.innerHTML=`<section class="card">
      <a class="back" href="#/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a><h1>#${tag}</h1>
      <div class="list">${items.map(item => renderItem(item, item.type)).join('')}</div></section>`;
    adminDockHide();
  }

  /* ===== –ö–û–ú–ú–ï–ù–¢–´ –ò –ü–†–û–ß–ï–ï ===== */
  function mountComments(term){/*...omitted for brevity, same as before...*/}; function setUtterancesTheme(t){/*...*/}; function setCusdisTheme(){/*...*/};
  const adminDock=document.getElementById('adminDock'), editThisBtn=document.getElementById('editThisBtn');
  function adminDockHide(){adminDock.style.display='none';}
  function adminDockFor(kind, slug){
    if(!isAdmin)return; let p='';
    if(kind==='story')p='stories';else if(kind==='note')p='notes';else if(kind==='perg')p='pergament';else if(kind==='scroll')p='scrolls';
    if(p)editThisBtn.href=`/admin/#/collections/${p}/entries/${slug||''}`; else return;
    adminDock.style.display='block';
  }
  const progress=document.getElementById('progress');let ticking=false;
  function onScroll(){if(ticking)return;ticking=true;requestAnimationFrame(()=>{const a=document.querySelector('article.prose');if(!a){progress.style.width='0%';ticking=false;return;}const t=a.scrollHeight-window.innerHeight+1;const p=Math.min(100,Math.max(0,((window.scrollY-a.offsetTop)/t)*100));progress.style.width=(isFinite(p)?p:0)+'%';const i=a.dataset.slug||a.dataset.id;if(i)localStorage.setItem('read:'+i,window.scrollY);ticking=false;});}
  addEventListener('scroll', onScroll,{passive:true});
  function restoreScroll(){const a=document.querySelector('article.prose');if(!a)return;const i=a.dataset.slug||a.dataset.id;const y=+localStorage.getItem('read:'+i)||0;if(y>0)setTimeout(()=>scrollTo({top:y,behavior:'instant'}),0);}
  const canvas=document.getElementById('stars'),ctx=canvas.getContext('2d');let W,H,starsArr=[],running=true;
  const p=window.matchMedia&&window.matchMedia('(prefers-reduced-motion:reduce)').matches;
  function R(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;M();if(p)D(0,true);}
  addEventListener('resize',R);function M(){const b=document.documentElement.getAttribute('data-theme')==='light'?60:120;const k=(W*H)/30000;const c=Math.floor(b+k);starsArr=Array.from({length:c},()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.1+0.3,s:Math.random()*0.5+0.2}));}
  function D(t,o=false){if(!ctx)return;ctx.clearRect(0,0,W,H);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--star').trim()||'rgba(255,255,255,.9)';for(const s of starsArr){const a=o?0.7:0.5+Math.sin((t/1200)*s.s+s.x*0.002)*0.4;ctx.globalAlpha=a;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();}if(!o&&!p&&running)requestAnimationFrame(D);}
  document.addEventListener('visibilitychange',()=>{running=document.visibilityState==='visible';if(running&&!p)requestAnimationFrame(D);});

  /* ===== –ì–õ–ê–í–ù–´–ô –†–û–£–¢–ï–† ===== */
  function render(){
    app.innerHTML = '<div class="muted" style="text-align:center;padding:40px 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    document.title = '–ö–∞–π–Ω—Ä–∞–∫—Å';
    const r=state.route || '/';
    if (state.q) { renderList(); return; }

    const routes = {
      '/': renderList,
      '/arcs': () => renderPage('–í–µ—Ç–∫–∏', buildArcs(), '#/', 'arc'),
      '/notes': () => renderPage('–ó–∞–º–µ—Ç–∫–∏', notes, '#/notes', 'note'),
      '/perg': () => renderPage('–ü–ª–∞–Ω—ã', pergaments, '#/perg', 'perg'),
      '/scrolls': renderScrolls,
      '/project': renderProject,
    };
    const routeAction = routes[r];
    if (routeAction) { routeAction(); return; }
    
    const patterns = [
      [/^\/read\/(.+)$/, (id) => renderArticle(id, stories, '#/', 'story')],
      [/^\/note\/(.+)$/, (id) => renderArticle(id, notes, '#/notes', 'note')],
      [/^\/perg\/(.+)$/, (id) => renderArticle(id, pergaments, '#/perg', 'perg')],
      [/^\/scroll\/(.+)$/, renderScroll],
      [/^\/arc\/(.+)$/, (id) => renderPage(arcMeta[id]?.title, buildArcs().find(a=>a.id===id)?.items || [], '#/arcs', 'story')],
      [/^\/tag\/(.+)$/, (tag) => renderTag(decodeURIComponent(tag))]
    ];

    for (const [pattern, action] of patterns) {
        const match = r.match(pattern);
        if (match) { action(match[1]); return; }
    }
    
    renderList(); // Fallback
  }

  loadContent().then(()=>{ applyTheme(); render(); ensureAdminUI(); R(); if(!p) requestAnimationFrame(D); });
  </script>
</body>
</html>
