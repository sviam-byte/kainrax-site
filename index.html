<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã</title>
  <meta name="description" content="–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –ø—è—Ç–Ω–∏—Ü–∞/—Å—É–±–±–æ—Ç–∞. –í–µ—Ç–∫–∏: –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å, –ö–∞–π–Ω—Ä–∞–∫—Å, –ò–ë–£–¢." />
  <meta name="theme-color" content="#0b0f14" />
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23FFD54A' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E">

  <style>
  :root{
    --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa5b1;
    --card:rgba(16,21,32,.92); --line:#223042;
    --accent:#7dd3fc; --accent2:#a78bfa; --link:#93c5fd;
    --max:1024px; --r:14px; --shadow:0 12px 36px rgba(0,0,0,.45);
    --code:#0a0e16; --mountain:#121723; --star:rgba(255,255,255,.9);
    --prose-w:72ch;
    --halo: drop-shadow(0 0 6px rgba(125,211,252,.35)) drop-shadow(0 0 14px rgba(167,139,250,.25));
  }
  [data-theme="light"]{
    --bg:#f7fbff; --fg:#0b0f14; --muted:#5a6774;
    --card:rgba(255,255,255,.97); --line:#e6ecf2;
    --accent:#0ea5e9; --accent2:#7c3aed; --link:#1d4ed8;
    --shadow:0 8px 24px rgba(0,0,0,.08); --code:#f6f8fb; --mountain:#dfe7f3; --star:rgba(10,20,40,.85);
    --prose-w:68ch;
  }
  [data-theme="cringe"]{
    --bg:linear-gradient(135deg,#ffb6f3,#ffd699 50%,#b3f1ff);
    --fg:#111; --muted:#333; --card:rgba(255,255,255,.9); --line:#ffd1f4;
    --accent:#ff3ea5; --accent2:#07f49e; --link:#7c00ff;
    --shadow:0 14px 40px rgba(0,0,0,.25); --code:#fff5ff; --mountain:#ffc6fb; --star:rgba(0,0,0,.75);
    --prose-w:66ch;
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;letter-spacing:.1px}
  a{color:var(--link)}
  h1{margin:.4rem 0 .2rem;font-size:clamp(26px,1.6vw + 18px,34px);font-weight:900}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted);font-size:12px}
  .card{background:linear-gradient(180deg,rgba(16,23,35,.96),rgba(16,23,35,.92));border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
  [data-theme="light"] .card{background:var(--card)}
  .btn,button{border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;box-shadow:var(--shadow);font-variant-caps:all-small-caps;letter-spacing:.4px}
  input[type="search"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}

  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,21,32,.92), rgba(15,21,32,.7));backdrop-filter: blur(10px) saturate(1.1);border-bottom:1px solid var(--line)}
  [data-theme="light"] header{background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.75))}
  [data-theme="cringe"] header{background:linear-gradient(90deg, rgba(255,255,255,.9), rgba(255,255,255,.6))}
  .head{max-width:var(--max);margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand a{color:var(--fg);text-decoration:none}
  .search{flex:1;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  main{max-width:var(--max);margin:0 auto;padding:20px 16px 80px;position:relative;z-index:1}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:980px){ .grid{grid-template-columns:1.15fr .85fr;gap:22px} }
  .list{display:flex;flex-direction:column;gap:12px}
  .story-item{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(125,211,252,.08), transparent);border:1px solid rgba(125,211,252,.18)}
  [data-theme="light"] .story-item{background:linear-gradient(180deg, rgba(14,165,233,.08), transparent);border-color:rgba(14,165,233,.22)}
  .story-item a{color:var(--fg);text-decoration:none}
  .title{font-weight:800}
  .title:before{
    content:""; display:inline-block; width:14px; height:14px; margin-right:6px; vertical-align:-1px; opacity:.9;
    background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12'%3E%3Cpath fill='%238cc9ff' d='M6 0l2 4 4 2-4 2-2 4-2-4-4-2 4-2z'/%3E%3C/svg%3E") no-repeat center/contain;
  }
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;margin-right:6px}
  .tag:before{content:"‚ú∂";color:var(--muted)}
  [data-theme="light"] .tag:before{content:"#"}
  .back{display:inline-flex;align-items:center;gap:8px;margin:6px 0 12px}

  .progress{position:fixed;left:0;top:0;height:4px;background:linear-gradient(90deg, var(--accent), var(--accent2));width:0;z-index:6}
  .progress:after{content:"";position:absolute;inset:0;background:radial-gradient(60% 100% at 0% 50%, rgba(255,255,255,.18), transparent);mix-blend-mode:screen;pointer-events:none}

  .anno{color:var(--muted);font-style:italic;margin-top:6px}
  .anno-box{border:1px dashed var(--line);background:rgba(125,211,252,.06);padding:12px;border-radius:10px;margin:10px 0 14px}
  [data-theme="light"] .anno-box{background:rgba(14,165,233,.08)}
  [data-theme="cringe"] .anno-box{background:rgba(255,62,165,.08)}
  details.anno-dtl summary{cursor:pointer;user-select:none}

  #stars{position:fixed;inset:0;z-index:0;pointer-events:none}
  #ceiling,#mountains{display:none}
  [data-theme="cringe"] #ceiling,[data-theme="cringe"] #mountains{display:block}
  #ceiling{position:fixed;left:0;right:0;top:0;height:18vh;z-index:0;pointer-events:none;opacity:.95}
  #ceiling svg{width:100%;height:100%;display:block;transform:scaleY(-1)}
  #ceiling path{fill:var(--mountain)}
  #mountains{position:fixed;left:0;right:0;bottom:0;height:28vh;z-index:0;pointer-events:none;opacity:.92}
  #mountains svg{width:100%;height:100%;display:block}
  #mountains path{fill:var(--mountain)}

  .prose.readbox{background:rgba(20,26,38,.98); border:1px solid #2a3a52; border-radius:18px; padding:16px; box-shadow: var(--shadow); max-width:var(--prose-w); margin:0 auto; line-height:1.75}
  [data-theme="light"] .prose.readbox{background:#fff; border-color:#e6ecf2}
  [data-theme="cringe"] .prose.readbox{background:#fff; color:#1a1a1a; border-color:#e9e1d6}
  .prose.readbox hr{ border:0; height:1px; background:linear-gradient(90deg,transparent,#2a3a52,transparent); margin:18px 0 }

  .parchment{--sepia-bg1:#fffaf1; --sepia-bg2:#f5ecda;
    background:linear-gradient(var(--sepia-bg1),var(--sepia-bg2)); color:#2b2418;
    border:1px solid #e7dcc4; box-shadow:0 8px 28px rgba(0,0,0,.18); max-width:66ch; margin:0 auto}
  .scroll-body p{ text-indent:1.2em; margin:0 0 1.05em }

  .with-margin{display:grid;grid-template-columns:minmax(0,1fr) 220px;gap:18px}
  @media (max-width:980px){ .with-margin{grid-template-columns:1fr} }
  .margin-notes{position:sticky;top:76px;align-self:start}
  .margin-notes .mnote{font-size:13px; color:var(--muted); border-left:2px solid var(--line); padding-left:10px; margin-bottom:12px; background:linear-gradient(90deg,rgba(225,213,189,.15),transparent)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:20}
  .modal .box{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow);max-width:440px;width:92%}
  .seal{display:inline-block;min-width:64px;min-height:64px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ff6b6b,#c81e1e);box-shadow:0 8px 24px rgba(0,0,0,.3);transform-origin:center;animation:seal 1.4s ease-in-out infinite}
  @keyframes seal{0%,100%{transform:rotate(-2deg) scale(1)}50%{transform:rotate(2deg) scale(1.06)}}

  #adminDock{position:fixed;right:14px;bottom:14px;z-index:7;display:none}
  #adminBtns{display:none}

  /* –ú—è–≥–∫–∏–π –ø—Å–µ–≤–¥–æ–∫—É—Ä—Å–æ—Ä —É —á—Ç–µ–Ω–∏—è –Ω–∞ —à–∏—Ä–æ–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
  @media (min-width:700px){
    .prose.readbox{position:relative}
    .prose.readbox:after{content:"‚ñç"; position:absolute; right:-16px; top:0; color:var(--accent); animation:blink 1.1s steps(1) infinite}
    @keyframes blink{50%{opacity:0}}
  }
  </style>
</head>
<body>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div id="ceiling" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L8,18 L18,22 L28,15 L38,20 L48,12 L58,19 L68,13 L78,22 L88,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div id="mountains" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L10,18 L20,22 L30,14 L40,20 L50,10 L60,19 L70,13 L80,22 L90,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div class="progress" id="progress"></div>

  <header>
    <div class="head">
      <div class="brand"><a href="#/">–ö–∞–π–Ω—Ä–∞–∫—Å ‚ú∂</a></div>
      <div class="search" style="max-width:860px">
        <span class="pill" title="–ù–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –≤—ã—Ö–æ–¥—è—Ç –≤ —ç—Ç–∏ –¥–Ω–∏">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ø—Ç/—Å–±</span>
        <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–∞—Å—Å–∫–∞–∑–∞–º‚Ä¶" aria-label="–ü–æ–∏—Å–∫" />
        <a class="btn" href="#/arcs">–í–µ—Ç–∫–∏</a>
        <a class="btn" href="#/perg">–ü–µ—Ä–≥–∞–º–µ–Ω—Ç</a>
        <a class="btn" href="#/notes">–ó–∞–º–µ—Ç–∫–∏</a>
        <a class="btn" href="#/project">–û –ø—Ä–æ–µ–∫—Ç–µ | –ø–ª–∞–Ω—ã</a>
        <button id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
        <span id="adminBtns">
          <a class="btn" href="/admin/" target="_blank" rel="noopener">–ê–¥–º–∏–Ω–∫–∞</a>
          <a class="btn" id="newStoryBtn" href="/admin/#/collections/stories/new" target="_blank" rel="noopener">+ –†–∞—Å—Å–∫–∞–∑</a>
          <a class="btn" id="newNoteBtn"  href="/admin/#/collections/notes/new"  target="_blank" rel="noopener">+ –ó–∞–º–µ—Ç–∫–∞</a>
          <a class="btn" id="newPergBtn"  href="/admin/#/collections/pergament/new"  target="_blank" rel="noopener">+ –ü–µ—Ä–≥–∞–º–µ–Ω—Ç</a>
        </span>
      </div>
    </div>
  </header>

  <div id="adminDock"><a class="btn" id="editThisBtn" target="_blank" rel="noopener">‚úèÔ∏è –ü—Ä–∞–≤–∏—Ç—å</a></div>
  <main id="app" aria-live="polite"></main>

  <!-- –§–∏–ª—å—Ç—Ä ¬´—à—É–º¬ª –¥–ª—è –º—è–≥–∫–∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ CSS –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏) -->
  <svg width="0" height="0" style="position:absolute">
    <filter id="fx-noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch" /></filter>
  </svg>

  <script>
  /* ===== –î–û–°–¢–£–ü –ö –ü–ï–†–ì–ê–ú–ï–ù–¢–£: –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò =====
     –í–∞—Ä–∏–∞–Ω—Ç—ã:
       1) –Ø–í–ù–´–ô –ö–û–î:   PERG.CODE = 'Chronicle'
       2) –•–≠–® –ö–û–î–ê:    PERG.CODE_HASH = 'sha256:....hex'    (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ)
     –ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–¥–∞–∫—Ü–∏—è –í–°–ï–ì–î–ê –æ—Ç–∫—Ä—ã—Ç–∞. –î–ª—è –Ω–µ-–ø–æ—Å–ª–µ–¥–Ω–∏—Ö –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ —Ä–µ–¥–∞–∫—Ü–∏–∏:
       { protected:true, code:"..." }  –∏–ª–∏  { protected:true, codeHash:"sha256:..." }
  */
  const PERG = {
    CODE: 'Chronicle',    // <<<< —Ç–≤–æ–π —è–≤–Ω—ã–π –∫–æ–¥
    CODE_HASH: null       // –Ω–∞–ø—Ä–∏–º–µ—Ä: 'sha256:e14dcd50...'; –µ—Å–ª–∏ –∑–∞–¥–∞–Ω, –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç CODE
  };

  /* ===== –ö–û–ù–°–¢–ê–ù–¢–´ / –°–û–°–¢–û–Ø–ù–ò–ï ===== */
  // –î–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (Cusdis). –ü–æ—Å—Ç–∞–≤—å —Å–≤–æ–π ID –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç–æ, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É.
  window.CUSDIS_APP_ID = "079685b7-f335-4fbd-9217-9d857a3cc369";

  const app = document.getElementById('app');
  const qEl = document.getElementById('q');
  const state = {
    theme: localStorage.getItem('theme') || 'dark',
    route: location.hash.slice(1) || '/',
    q: ''
  };

  /* ===== –£–¢–ò–õ–´ ===== */
  const fmtHumanDate = iso => {
    try {
      const d = new Date(iso);
      if (!isFinite(d)) return String(iso||'');
      return d.toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'});
    } catch(_){ return String(iso||''); }
  };

  // –§–æ—Ä–º–∞—Ç ¬´N-–π –¥–µ–Ω—å M-–≥–æ –≥–æ–¥–∞.¬ª –¥–ª—è —Å—Ç—Ä–æ–∫ –≤–∏–¥–∞ YYYY-DOY (–Ω–∞–ø—Ä–∏–º–µ—Ä, "0430-349")
  function fmtPergDayYear(s){
    if(typeof s !== 'string') return String(s||'');
    const m = s.match(/^(\d{4})-(\d{3})$/); // YYYY-DOY
    if(!m) return fmtHumanDate(s);
    const year = Number(m[1]);
    const day  = Number(m[2]);
    return `${day}-–π –¥–µ–Ω—å ${year}-–≥–æ –≥–æ–¥–∞.`;
  }

  function esc(s){ return String(s==null?'':s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

  const getAnno = (s) => {
    const a = (s.annotation || s.anno || s.summary || '').trim();
    if (a) return esc(a);
    const txt = String(s.text || '').replace(/\s+/g, ' ').trim();
    if (!txt) return '';
    const cut = 180; return esc(txt.length > cut ? txt.slice(0, cut) + '‚Ä¶' : txt);
  };

  /* ===== –î–ê–ù–ù–´–ï ===== */
  let stories=[], notes=[], pergDocs=[];
  async function safeJson(url, def){
    try{
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) return def;
      return await r.json();
    }catch(_){ return def; }
  }
  async function loadContent(){
    const j = await safeJson('content/index.json', {});
    stories = Array.isArray(j.stories) ? j.stories : await safeJson('content/stories.json', []);
    notes   = Array.isArray(j.notes)   ? j.notes   : await safeJson('content/notes.json',   []);
    pergDocs= await safeJson('content/pergament/index.json', []);

    stories.sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0)));
    notes.sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0)));

    pergDocs.forEach(d=>{ (d.editions||[]).sort((a,b)=> String(a.date||'').localeCompare(String(b.date||''))); });
    pergDocs.sort((a,b)=> {
      const ad=(a.editions||[]); const bd=(b.editions||[]);
      const al=ad[ad.length-1]?.date||''; const bl=bd[bd.length-1]?.date||'';
      return String(bl).localeCompare(String(al));
    });
  }

  /* ===== –¢–ï–ú–ê ===== */
  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme);
    localStorage.setItem('theme', state.theme);
    setUtterancesTheme(state.theme);
    setCusdisTheme();
    const el=document.getElementById('favicon');
    const color = state.theme==='light' ? '%230A1830' : '%23FFD54A';
    el.href = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='${color}' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E`;
  }
  applyTheme();
  document.getElementById('themeBtn').onclick=()=>{
    state.theme = state.theme==='dark' ? 'light' : (state.theme==='light' ? 'cringe' : 'dark');
    applyTheme();
  };

  /* ===== ADMIN MODE (—Å–∫—Ä—ã—Ç—ã–π —Ç—É–º–±–ª–µ—Ä Alt+Shift+A) ===== */
  let isAdmin = new URLSearchParams(location.search).has('admin') || localStorage.getItem('admin')==='1';
  if(new URLSearchParams(location.search).has('admin')){
    localStorage.setItem('admin','1'); history.replaceState({},'',location.pathname+location.hash);
  }
  function ensureAdminUI(){
    document.getElementById('adminBtns').style.display = isAdmin ? 'inline-flex' : 'none';
    if(!isAdmin) adminDockHide();
  }
  addEventListener('keydown',e=>{
    if(e.altKey&&e.shiftKey&&e.key.toLowerCase()==='a'){
      isAdmin=!isAdmin; localStorage.setItem('admin',isAdmin?'1':'0'); ensureAdminUI();
    }
  });

  /* ===== ROUTER ===== */
  addEventListener('hashchange',()=>{ state.route=location.hash.slice(1)||'/'; render(); restoreScroll(); });
  qEl.addEventListener('input',()=>{ state.q=qEl.value.trim().toLowerCase(); renderList(); });

  /* ===== –í–¨–Æ–•–ò ===== */
  const arcMeta = {
    surface: {id:'surface', title:'–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å', desc:'–†–∞—Å—Å–∫–∞–∑—ã –∏ –ø–æ–≤–µ—Å—Ç–∏ –Ω–µ –æ –ö–∞–π–Ω—Ä–∞–∫—Å.'},
    kainrax: {id:'kainrax',  title:'–ö–∞–π–Ω—Ä–∞–∫—Å',    desc:'–†–∞—Å—Å–∫–∞–∑—ã –∏ –ø–æ–≤–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–∏ –ö–∞–π–Ω—Ä–∞–∫—Å.'},
    ibut:    {id:'ibut',     title:'–ò–ë–£–¢',        desc:'–õ—ë–≥–∫–æ–µ —á—Ç–∏–≤–æ –ø—Ä–æ –ø–æ–ø–∞–¥–∞–Ω—Ü–µ–≤.'},
  };
  function buildArcs(){
    const map = {};
    for(const s of stories){
      const id=s.arc||'kainrax';
      if(!map[id]) map[id] = { ...(arcMeta[id]||{id,title:id,desc:''}), items:[] };
      map[id].items.push(s);
    }
    for(const k in map){
      map[k].items.sort((a,b)=> (a.order||0)-(b.order||0) || (new Date(a.date||0))-(new Date(b.date||0)) );
    }
    return Object.values(map);
  }

  function renderList(){
    const q=state.q;
    const items=stories.filter(s=>{
      if(!q) return true;
      const hay = [
        (s.title||''),
        (s.text||''),
        (s.tags||[]).join(' ')
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });
    const arcs = buildArcs();
    app.innerHTML = `
      <div class="grid">
        <section class="card">
          <h1>–†–∞—Å—Å–∫–∞–∑—ã</h1>
          <div class="muted">–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –í—ã—Ö–æ–¥—ã: –ø—è—Ç–Ω–∏—Ü–∞/—Å—É–±–±–æ—Ç–∞.</div>
          <div class="list">
            ${
              items.length ? items.map(s=>`
                <div class="story-item">
                  <a href="#/read/${encodeURIComponent(s.id)}">
                    <div class="title">‚ú∂ ${esc(s.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
                    <div class="muted">${fmtHumanDate(s.date)} ¬∑ ${s.minutes||Math.max(5,Math.round(String(s.text||'').length/1100))} –º–∏–Ω —á—Ç–µ–Ω–∏—è ¬∑ –≤–µ—Ç–∫–∞: ${(arcMeta[s.arc||'kainrax']||{title:'–í–µ—Ç–∫–∞'}).title}</div>
                  </a>
                  ${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}
                </div>
              `).join('') : `<div class="muted" style="margin-top:10px">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å <code>content/index.json</code> –∏–ª–∏ <code>content/stories.json</code>.</div>`
            }
          </div>
        </section>

        <aside class="card">
          <h2>–í–µ—Ç–∫–∏</h2>
          <div class="list">
            ${arcs.map(a=>`
              <div class="story-item">
                <a href="#/arc/${encodeURIComponent(a.id)}">
                  <div class="title">‚ú∂ ${esc(a.title)}</div>
                  <div class="muted">${a.items.length} —Ç–µ–∫—Å—Ç(–∞)</div>
                  <div>${esc(a.desc||'')}</div>
                </a>
              </div>
            `).join('')}
          </div>
          <h3 style="margin-top:14px">–ü–æ–¥–ø–∏—Å–∫–∞</h3>
          <p class="muted">–¢–µ–ª–µ–≥—Ä–∞–º: <a href="https://t.me/kainrax" target="_blank" rel="noopener">@kainrax</a></p>
        </aside>
      </div>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArcs(){
    const arcs=buildArcs();
    app.innerHTML = `
      <section class="card">
        <h1>–í–µ—Ç–∫–∏</h1>
        <div class="list">
          ${arcs.map(a=>`
            <div class="story-item"><a href="#/arc/${encodeURIComponent(a.id)}">
              <div class="title">‚ú∂ ${esc(a.title)}</div>
              <div class="muted">${a.items.length} —Ç–µ–∫—Å—Ç(–∞)</div>
              <div>${esc(a.desc||'')}</div>
            </a></div>`).join('')}
        </div>
      </section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArc(id){
    const arcs=buildArcs();
    const a=arcs.find(x=>x.id===id)||{id,title:'–í–µ—Ç–∫–∞',items:[],desc:''};
    app.innerHTML = `
      <section class="card">
        <a class="back" href="#/arcs">‚Üê –ö–æ –≤—Å–µ–º –≤–µ—Ç–∫–∞–º</a>
        <h1>${esc(a.title)}</h1><div class="muted">${esc(a.desc||'')}</div>
        <ol class="list" style="margin-top:10px">
          ${a.items.map((s,i)=>`
          <li class="story-item">
            <a href="#/read/${encodeURIComponent(s.id)}">
              <div class="title">‚ú∂ ${i+1}. ${esc(s.title)}</div>
              <div class="muted">${fmtHumanDate(s.date)} ¬∑ ${s.minutes||Math.max(5,Math.round(String(s.text||'').length/1100))} –º–∏–Ω</div>
            </a>
            ${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}
          </li>`).join('')}
        </ol>
      </section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArticle(id){
    const s=stories.find(x=>x.id===id||x.slug===id);
    if(!s){location.hash='#/'; return;}
    const arcs=buildArcs(); const a=arcs.find(x=>x.id===(s.arc||'kainrax'))||{title:'–í–µ—Ç–∫–∞',items:[]};
    const order=a.items; const pos=Math.max(0, order.findIndex(v=> (v.id===s.id) || (v.slug && v.slug===s.slug)));
    const prev=order[pos-1], next=order[pos+1];

    const tags = (s.tags||[]).map(t=>`<a class='tag' href='#/tag/${encodeURIComponent(t)}'>${esc(t)}</a>`).join(' ');
    const body = String(s.text||'').split(/\n\n+/).map(p=>`<p>${esc(p).replace(/\n/g,'<br>')}</p>`).join('');

    app.innerHTML = `
      <a class="back" href="#/">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
      <article class="with-margin" data-id="${esc(s.id)}" data-slug="${esc(s.slug||s.id)}">
        <div class="prose readbox">
          <h1>${esc(s.title)}</h1>
          <div class="muted">${fmtHumanDate(s.date)} ¬∑ ${s.minutes||Math.max(5,Math.round(String(s.text||'').length/1100))} –º–∏–Ω ¬∑ –≤–µ—Ç–∫–∞: <a href="#/arc/${s.arc||'kainrax'}">${(arcMeta[s.arc||'kainrax']||{title:'–í–µ—Ç–∫–∞'}).title}</a> (${pos+1}/${order.length})</div>
          <div style="margin:6px 0 12px">${tags}</div>

          ${getAnno(s) ? `
            <details class="anno-dtl anno-box" ${location.hash.includes('openAnno')?'open':''}>
              <summary><strong>–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è</strong> ‚Äî –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã ${location.hash.includes('openAnno')?'—Å–∫—Ä—ã—Ç—å':'–ø–æ–∫–∞–∑–∞—Ç—å'}</summary>
              <div style="margin-top:8px">${getAnno(s)}</div>
            </details>` : ``}

          ${body}

          <hr>
          <div style="display:flex;justify-content:space-between;gap:10px">
            ${prev?`<a class="btn" href="#/read/${encodeURIComponent(prev.id)}">‚Üê ${esc(prev.title)}</a>`:'<span></span>'}
            ${next?`<a class="btn" href="#/read/${encodeURIComponent(next.id)}">${esc(next.title)} ‚Üí</a>`:'<span></span>'}
          </div>
        </div>
        <aside class="margin-notes"></aside>
      </article>

      <section class="card" style="margin-top:16px">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
        <section id="comments"></section>
      </section>`;
    mountComments('story:'+(s.slug||s.id));
    setTimeout(restoreScroll,0);
    adminDockFor('story', s.slug||s.id);
    ensureAdminUI();
  }

  function renderTag(tag){
    const items=stories.filter(s=> (s.tags||[]).map(t=>t.toLowerCase()).includes(tag.toLowerCase()));
    app.innerHTML = `
      <section class="card">
        <a class="back" href="#/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <h1>#${esc(tag)}</h1>
        <div class="list">
          ${items.map(s=>`
            <div class="story-item"><a href="#/read/${encodeURIComponent(s.id)}">
              <div class="title">‚ú∂ ${esc(s.title)}</div>
              <div class="muted">${fmtHumanDate(s.date)} ¬∑ ${s.minutes||Math.max(5,Math.round(String(s.text||'').length/1100))} –º–∏–Ω ¬∑ –≤–µ—Ç–∫–∞: ${(arcMeta[s.arc||'kainrax']||{title:'–í–µ—Ç–∫–∞'}).title}</div>
            </a>${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}</div>
          `).join('')}
        </div>
      </section>`;
    adminDockHide(); ensureAdminUI();
  }

  /* ===== –ü–ï–†–ì–ê–ú–ï–ù–¢ ===== */
  function lastEdition(d){ const es=d.editions||[]; return es[es.length-1]||null; }
  function isProtected(ed){ return !!(ed && (ed.protected || ed.code || ed.codeHash || (ed.access && ed.access.enabled))); }
  function parseHashQuery(){
    const h = location.hash.split('?')[1]||'';
    const out={};
    h.split('&').forEach(p=>{ if(!p) return; const [k,v] = p.split('='); out[decodeURIComponent(k)] = decodeURIComponent(v||''); });
    return out;
  }

  function renderPergList(){
    const items = pergDocs;
    app.innerHTML = `
      <section class="card"><h1>–ü–µ—Ä–≥–∞–º–µ–Ω—Ç</h1>
        <div class="list">
          ${items.map(d=>{
            const e=lastEdition(d)||{};
            return `
            <div class="story-item">
              <a href="#/perg/${encodeURIComponent(d.id)}">
                <div class="title">üìú ${esc(d.title)}</div>
                <div class="muted">–ø–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–¥.: ${fmtPergDayYear(e.date||d.date||'')}</div>
              </a>
              ${getAnno(d)?`<div class="anno">${getAnno(d)}</div>`:''}
            </div>`;
          }).join('')}
        </div>
      </section>`;
    adminDockHide(); ensureAdminUI();
  }

  async function renderPerg(rawId){
    const id = (rawId||'').split('?')[0];
    const d = (pergDocs||[]).find(x=>x.id===id || x.slug===id);
    if(!d){ location.hash = '#/perg'; return; }

    const editions = (d.editions||[]);
    if(!editions.length){
      app.innerHTML = `<a class="back" href="#/perg">‚Üê –ö ¬´–ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É¬ª</a><section class="card">–ù–µ—Ç —Ä–µ–¥–∞–∫—Ü–∏–π.</section>`;
      return;
    }

    const q = parseHashQuery();
    const chosenId = q.e || editions[editions.length-1].id;
    let e = editions.find(x=>x.id===chosenId) || editions[editions.length-1];
    const lastEd = editions[editions.length-1];
    const isLast = (e===lastEd);

    async function ensureAccessForNonLast(ed){
      if(isLast) return true;
      const key = 'perg:'+d.id+':'+ed.id+':ok';
      if(localStorage.getItem(key)==='1') return true;
      const ok = await showAccessModal(
        { message:'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–æ—Å—Ç—É–ø', codeHint: ed.codeHint || (ed.access&&ed.access.hint) || '—Ö—Ä–æ–Ω–∏–∫—ë—Ä –∏ –≥–æ–¥' },
        (input)=> checkPergCode(input, ed)
      );
      if(ok){ localStorage.setItem(key,'1'); return true; }
      return false;
    }

    const canOpen = await ensureAccessForNonLast(e);
    if(!canOpen){ location.hash = '#/perg'; return; }

    let body = '';
    try{
      body = await fetch(e.file, {cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject());
    } catch(_){ body = '(–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç)'; }

    const options = editions.map(x=>`<option value="${esc(x.id)}" ${x.id===e.id?'selected':''}>${esc(x.title||x.id)} ¬∑ ${fmtPergDayYear(x.date||'')}</option>`).join('');

    let prevBlock = '';
    if (isLast && editions.length > 1){
      const prev = editions[editions.length-2];
      prevBlock = `<div class="anno-box" style="margin-top:10px"><strong>–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è:</strong> ${fmtPergDayYear(prev.date||'')} ‚Äî –¥–æ—Å—Ç—É–ø –ø–æ –∫–æ–¥—É</div>`;
    }

    const bodyHtml = String(body||'').split(/\n\n+/).map(p=>`<p>${esc(p).replace(/\n/g,'<br>')}</p>`).join('');

    app.innerHTML = `
      <a class="back" href="#/perg">‚Üê –ö ¬´–ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É¬ª</a>
      <article class="with-margin" data-id="${esc(d.id)}">
        <div class="prose parchment readbox">
          <h1>üìú ${esc(d.title)}</h1>
          <div class="muted">–†–µ–¥–∞–∫—Ü–∏–∏:
            <select id="edSel" class="btn" style="padding:6px 10px">${options}</select>
          </div>
          ${d.annotation?`<div class="anno" style="margin-top:6px">${esc(d.annotation)}</div>`:''}
          ${prevBlock}
          <div class="scroll-body">${bodyHtml}</div>
        </div>
        <aside class="margin-notes">${(Array.isArray(d.margin)?d.margin:[]).map(m=>`<div class="mnote">${esc(m)}</div>`).join('')}</aside>
      </article>

      <section class="card" style="margin-top:16px">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section>
      </section>`;

    const sel=document.getElementById('edSel');
    if(sel){
      sel.onchange=()=>{ const nv=sel.value; const base = '#/perg/'+encodeURIComponent(d.id); location.hash = base + '?e='+encodeURIComponent(nv); };
    }

    mountComments('perg:'+(d.slug||d.id)+':'+(e.id||''));
    setTimeout(restoreScroll,0);
    adminDockFor('perg', d.slug||d.id);
    ensureAdminUI();
  }

  /* ===== –î–û–°–¢–£–ü: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ ===== */
  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function checkPergCode(input, ed){
    const pass = (input||'').trim();
    if(!pass) return false;

    if(ed && ed.codeHash){
      const [alg, hex] = String(ed.codeHash).split(':');
      if((alg||'sha256').toLowerCase()==='sha256'){
        const got = await sha256Hex(pass);
        return got.toLowerCase() === String(hex||'').toLowerCase();
      }
    }
    if(ed && ed.code){
      return pass === String(ed.code).trim();
    }

    if(PERG.CODE_HASH){
      const [alg, hex] = String(PERG.CODE_HASH).split(':');
      if((alg||'sha256').toLowerCase()==='sha256'){
        const got = await sha256Hex(pass);
        return got.toLowerCase() === String(hex||'').toLowerCase();
      }
    }
    if(PERG.CODE){
      return pass === String(PERG.CODE).trim();
    }
    return false;
  }

  function showAccessModal(cfg, verify){
    return new Promise(resolve=>{
      const wrap=document.createElement('div'); wrap.className='modal';
      wrap.innerHTML=`
        <div class="box">
          <div style="display:flex; gap:12px; align-items:center">
            <div class="seal" aria-hidden="true"></div>
            <div>
              <h3 style="margin:0 0 6px">${esc((cfg&&cfg.message)||'–í–∞—à –¥–æ—Å—Ç—É–ø?')}</h3>
              <div class="muted" style="margin-bottom:10px">${esc(cfg&&cfg.codeHint?('–ü–æ–¥—Å–∫–∞–∑–∫–∞: '+cfg.codeHint):'–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞.')}</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; margin-top:12px">
            <input id="codeIn" type="password" placeholder="–∫–æ–¥" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)"/>
            <button class="btn" id="okBtn">–û–ö</button>
            <button class="btn" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
          </div>
          <div class="muted" id="err" style="margin-top:8px;display:none">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div>
        </div>`;
      document.body.appendChild(wrap);
      const codeIn=wrap.querySelector('#codeIn');
      const ok=wrap.querySelector('#okBtn');
      const cancel=wrap.querySelector('#cancelBtn');
      const err=wrap.querySelector('#err');
      function close(val){ document.body.removeChild(wrap); resolve(val); }
      cancel.onclick=()=> close(false);
      ok.onclick=async()=>{
        const pass = await verify(codeIn.value||'');
        if(pass){ close(true); } else { err.style.display='block'; codeIn.select(); }
      };
      codeIn.onkeydown=(e)=>{ if(e.key==='Enter') ok.click(); };
      setTimeout(()=>codeIn.focus(),0);
    });
  }

  /* ===== –ó–ê–ú–ï–¢–ö–ò / PROJECT ===== */
  function renderNotes(){
    app.innerHTML = `
      <section class="card">
        <h1>–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –∑–∞–º–µ—Ç–∫–∏</h1>
        <div class="list">
          ${(notes||[]).map(n=>`
            <div class="story-item"><a href="#/note/${encodeURIComponent(n.id)}">
              <div class="title">‚ú∂ ${esc(n.title)}</div>
              <div class="muted">${fmtHumanDate(n.date)}</div>
            </a></div>`).join('')}
        </div>
      </section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderNote(id){
    const n=(notes||[]).find(x=>x.id===id||x.slug===id);
    if(!n){location.hash='#/notes';return;}
    const body = String(n.text||'').split(/\n\n+/).map(p=>`<p>${esc(p).replace(/\n/g,'<br>')}</p>`).join('');
    app.innerHTML = `
      <a class="back" href="#/notes">‚Üê –ö –∑–∞–º–µ—Ç–∫–∞–º</a>
      <article class="prose readbox with-margin" data-id="${esc(n.id)}" data-slug="${esc(n.slug||n.id)}">
        <div>
          <h1>${esc(n.title)}</h1>
          <div class="muted">${fmtHumanDate(n.date)}</div>
          ${body}
        </div>
        <aside class="margin-notes">${(Array.isArray(n.margin)?n.margin:[]).map(m=>`<div class="mnote">${esc(m)}</div>`).join('')}</aside>
      </article>
      <div class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></div>`;
    mountComments('note:'+(n.slug||n.id));
    setTimeout(restoreScroll,0);
    adminDockFor('note', n.slug||n.id);
    ensureAdminUI();
  }

  function renderProject(){
    const wip = (notes||[])
      .filter(n => /(wip|–ø–ª–∞–Ω—ã|–≤ —Ä–∞–±–æ—Ç–µ|work|writing)/i.test([n.title, ...(n.tags||[])].join(' ')))
      .sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0)))[0];
    app.innerHTML = `
      <section class="card">
        <h1>–û –ø—Ä–æ–µ–∫—Ç–µ | –ø–ª–∞–Ω—ã</h1>
        <div class="prose">
          <p><strong>–£ –Ω–∞—Å –º–∞–≥–∏—è ‚Äî —ç—Ç–æ —Å–±–æ–π –≤ —Ñ–∏–∑–∏–∫–µ.</strong> –ö–æ–≥–¥–∞ –ø—Ä–æ—à–ª–æ–µ –±–æ–ª–∏—Ç ‚Äî –µ–≥–æ –ª–µ—á–∞—Ç. –ü–æ–±–æ—á–∫–∞: –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–∞–¥–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ ‚Äî 0.37.</p>
          <p>–Ø –ø–∏—à—É –∏—Å—Ç–æ—Ä–∏–∏ <strong>–ö–∞–π–Ω—Ä–∞–∫—Å</strong> ‚Äî –ø–æ–¥–∑–µ–º–Ω–æ–π —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏, —Å–±–µ–∂–∞–≤—à–µ–π –æ—Ç –±–æ–≥–æ–≤ ‚Äî —Å–ª–æ–º–∞–Ω–Ω—ã—Ö –ò–ò. –¢—ë–º–Ω–∞—è –ù–§/—Ñ—ç–Ω—Ç–µ–∑–∏, —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–ø—É—â–µ–Ω–∏—è –∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è —Ü–µ–Ω–∞.</p>
          <p>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è-—Ä–∞—Å—Å–∫–∞–∑—ã: <strong>–ø—è—Ç–Ω–∏—Ü—ã –∏–ª–∏ —Å—É–±–±–æ—Ç—ã</strong>.</p>
          <p>–í —Ä–∞–±–æ—Ç–µ: —Ä–æ–º–∞–Ω –æ –ø–æ–ø—ã—Ç–∫–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–∞–¥–µ–Ω–∏–µ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ñ–æ–ª–∫-—Ö–æ—Ä—Ä–æ—Ä-–ø–æ–≤–µ—Å—Ç—å –æ –∂—Ä–∏—Ü–µ-¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–π¬ª. –û–¥–∏–Ω –º–∏—Ä. –û–¥–Ω–∏ –∂—ë—Å—Ç–∫–∏–µ ‚Äî –Ω–æ —Å–∫—Ä—ã—Ç—ã–µ ‚Äî –ø—Ä–∞–≤–∏–ª–∞.</p>
          <p><em>–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å:</em> –ª—É—á—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äî –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏.</p>
          <div class="anno-box"><strong>–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –ø–∏—à–µ—Ç—Å—è:</strong> ${
            wip ? `<a href="#/note/${encodeURIComponent(wip.id)}">${esc(wip.title)}</a> ¬∑ ${fmtHumanDate(wip.date)}`
                : `–ø–æ–≤–µ—Å—Ç—å –æ –¶–≤–µ—Ç–∫–µ, –ò–ë–£–¢ –∏ –ø–∞—Ä–∞ —Ä–∞—Å—Å–∫–∞–∑–æ–≤; —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ä–æ–º–∞–Ω`
          }</div>
        </div>
      </section>`;
    adminDockHide(); ensureAdminUI();
  }

  /* ===== –ö–û–ú–ú–ï–ù–¢–´ ===== */
  function mountComments(term){
    const wrap=document.getElementById('comments'); if(!wrap) return;
    wrap.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button class="btn" id="tab-gh">GitHub</button>
        <button class="btn" id="tab-anon">–ê–Ω–æ–Ω–∏–º–Ω–æ</button>
      </div>
      <div id="c-gh"></div>
      <div id="c-anon" style="display:none;min-height:300px"></div>`;
    const ghBox=wrap.querySelector('#c-gh'), anonBox=wrap.querySelector('#c-anon');
    let ghLoaded=false, anonLoaded=false;

    function loadGH(){
      if (ghLoaded) return; ghLoaded=true; ghBox.innerHTML='';
      const s=document.createElement('script');
      s.src='https://utteranc.es/client.js';
      s.setAttribute('repo','sviam-byte/kainrax-site');
      s.setAttribute('issue-term', term || 'home');
      s.setAttribute('label','comments');
      s.setAttribute('theme', document.documentElement.getAttribute('data-theme')==='light'?'github-light':'github-dark');
      s.setAttribute('crossorigin','anonymous');
      s.async=true; ghBox.appendChild(s);
    }
    function loadAnon(){
      if (!window.CUSDIS_APP_ID){ anonBox.innerHTML='<div class="muted">–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.</div>'; return; }
      if (anonLoaded) return; anonLoaded=true; anonBox.innerHTML='';
      const t=document.createElement('div');
      t.id='cusdis_thread'; t.dataset.host='https://cusdis.com'; t.dataset.appId=window.CUSDIS_APP_ID;
      t.dataset.pageId=term || (location.pathname+location.hash);
      t.dataset.pageUrl=location.href; t.dataset.pageTitle=document.title; t.dataset.lang='ru';
      t.dataset.theme=(document.documentElement.getAttribute('data-theme')==='light')?'light':'dark';
      anonBox.appendChild(t);
      if (!window.__cusdisLoaded){
        const s=document.createElement('script'); s.defer=true; s.src='https://cusdis.com/js/cusdis.es.js';
        s.onload=()=>{ window.__cusdisLoaded=true; try{ window.CUSDIS?.renderTo?.('#cusdis_thread'); setCusdisTheme(); }catch(_){} };
        document.body.appendChild(s);
      } else {
        try{ window.CUSDIS?.renderTo?.('#cusdis_thread'); setCusdisTheme(); }catch(_){}
      }
    }
    function showGH(){ ghBox.style.display='block'; anonBox.style.display='none'; loadGH(); }
    function showAnon(){ ghBox.style.display='none'; anonBox.style.display='block'; loadAnon(); }
    wrap.querySelector('#tab-gh').onclick=showGH;
    wrap.querySelector('#tab-anon').onclick=showAnon;
    const io=new IntersectionObserver(es=>{
      if(es.some(e=>e.isIntersecting)){ showGH(); io.disconnect(); }
    },{rootMargin:'200px'}); io.observe(wrap);
  }
  function setUtterancesTheme(theme){
    const iframe=document.querySelector('iframe.utterances-frame');
    if(iframe) iframe.contentWindow.postMessage({type:'set-theme', theme:theme==='light'?'github-light':'github-dark'}, 'https://utteranc.es');
  }
  function setCusdisTheme(){
    try{ window.CUSDIS?.setTheme?.(document.documentElement.getAttribute('data-theme')==='light'?'light':'dark'); }catch(_){}
  }

  /* ===== –ê–î–ú–ò–ù –ü–õ–ê–í–ê–Æ–©–ê–Ø –ö–ù–û–ü–ö–ê ===== */
  const adminDock=document.getElementById('adminDock');
  const editThisBtn=document.getElementById('editThisBtn');
  function adminDockHide(){ adminDock.style.display='none'; }
  function adminDockFor(kind, slug){
    if (!isAdmin) return adminDockHide();
    if(kind==='story') editThisBtn.href=`/admin/#/collections/stories/entries/${slug}`;
    else if(kind==='note') editThisBtn.href=`/admin/#/collections/notes/entries/${slug}`;
    else if(kind==='perg') editThisBtn.href=`/admin/#/collections/pergament/entries/${slug}`;
    adminDock.style.display='block';
  }

  /* ===== –ü–†–û–ì–†–ï–°–° + –í–û–°–°–¢.–°–ö–†–û–õ–õ ===== */
  const progress=document.getElementById('progress'); let ticking=false;
  function onScroll(){
    if(ticking) return; ticking=true;
    requestAnimationFrame(()=>{
      const art=document.querySelector('article');
      if(!art){progress.style.width='0%'; ticking=false; return;}
      const total=art.scrollHeight - window.innerHeight + 1;
      const pct=Math.min(100, Math.max(0, ((window.scrollY - art.offsetTop) / total)*100));
      progress.style.width=(isFinite(pct)?pct:0)+'%';
      const id=art.dataset.slug||art.dataset.id;
      if(id){ localStorage.setItem('read:'+id, String(window.scrollY)); }
      ticking=false;
    });
  }
  addEventListener('scroll', onScroll, {passive:true});
  function restoreScroll(){
    const art=document.querySelector('article'); if(!art) return;
    const id=art.dataset.slug||art.dataset.id; const y=+localStorage.getItem('read:'+id)||0;
    if(y>0) setTimeout(()=>scrollTo({top:y,behavior:'instant'}),0);
  }

  /* ===== –ó–í–Å–ó–î–´ (—Ñ–æ–Ω) ===== */
  const canvas=document.getElementById('stars'); const ctx=canvas.getContext('2d');
  let W,H,starsArr=[], running=true;
  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; makeStars(); if(prefersReduced){ drawStars(0,true); } }
  addEventListener('resize', resize);
  function makeStars(){
    const base = document.documentElement.getAttribute('data-theme')==='light' ? 60 : 120;
    const k = (W*H)/30000; const count = Math.floor(base + k);
    starsArr = Array.from({length: count}, ()=>({ x: Math.random()*W, y: Math.random()*H, r: Math.random()*1.1+0.3, s: Math.random()*0.5+0.2 }));
  }
  function drawStars(ts, once=false){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--star').trim() || 'rgba(255,255,255,.9)';
    for(const st of starsArr){
      const a = once ? 0.7 : 0.5 + Math.sin((ts/1200)*st.s + st.x*0.002)*0.4;
      ctx.globalAlpha = a; ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI*2); ctx.fill();
    }
    if(!once && !prefersReduced && running) requestAnimationFrame(drawStars);
  }
  document.addEventListener('visibilitychange',()=>{ running = document.visibilityState==='visible'; if(running && !prefersReduced) requestAnimationFrame(drawStars); });

  /* ===== –†–ï–ù–î–ï–† ===== */
  function render(){
    const r=state.route;
    if(r==='/'||r===''){ renderList(); return; }
    if(r==='/arcs'){ renderArcs(); return; }
    if(r==='/notes'){ renderNotes(); return; }
    if(r==='/project'){ renderProject(); return; }
    if(r==='/perg'){ renderPergList(); return; }
    const mRead=r.match(/^\/read\/([^?]+)(?:\?.*)?$/); if(mRead){ renderArticle(decodeURIComponent(mRead[1])); return; }
    const mArc=r.match(/^\/arc\/([^?]+)(?:\?.*)?$/); if(mArc){ renderArc(decodeURIComponent(mArc[1])); return; }
    const mTag=r.match(/^\/tag\/([^?]+)(?:\?.*)?$/); if(mTag){ renderTag(decodeURIComponent(mTag[1])); return; }
    const mNote=r.match(/^\/note\/([^?]+)(?:\?.*)?$/); if(mNote){ renderNote(decodeURIComponent(mNote[1])); return; }
    const mPerg=r.match(/^\/perg\/([^?]+)(?:\?.*)?$/); if(mPerg){ renderPerg(decodeURIComponent(mPerg[1])); return; }
    renderList();
  }

  loadContent().then(()=>{
    applyTheme(); render(); ensureAdminUI(); resize();
    if(!prefersReduced) requestAnimationFrame(drawStars);
  });
  </script>
</body>
</html>
