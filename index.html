<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã</title>
  <meta name="description" content="–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –í–µ—Ç–∫–∏, –∑–∞–º–µ—Ç–∫–∏ –∏ –ü–µ—Ä–≥–∞–º–µ–Ω—Ç —Å —Ä–µ–¥. –ø–æ–º–µ—Ç–∫–∞–º–∏." />
  <meta name="theme-color" content="#0b0f14" />
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23FFD54A' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E">
  <style>
  :root{
    --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa5b1;
    --card:rgba(16,21,32,.85); --line:#223042;
    --accent:#7dd3fc; --accent2:#a78bfa; --link:#93c5fd;
    --max:960px; --r:14px; --shadow:0 12px 36px rgba(0,0,0,.45);
    --code:#0a0e16; --mountain:#121723; --star:rgba(255,255,255,.9);
  }
  [data-theme="light"]{
    --bg:#f7fbff; --fg:#0b0f14; --muted:#5a6774;
    --card:rgba(255,255,255,.92); --line:#e6ecf2;
    --accent:#0ea5e9; --accent2:#7c3aed; --link:#1d4ed8;
    --shadow:0 8px 24px rgba(0,0,0,.08); --code:#f6f8fb; --mountain:#dfe7f3; --star:rgba(10,20,40,.85);
  }
  /* —É—Å–∏–ª–µ–Ω–Ω—ã–π –∫—Ä–∏–Ω–∂-—Ä–µ–∂–∏–º */
  @keyframes cringeBg { 0%{background-position:0 0} 100%{background-position:200% 0} }
  @keyframes wiggle { 0%,100%{transform:rotate(-1.5deg)} 50%{transform:rotate(1.5deg)} }
  @keyframes bounceY { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  [data-theme="cringe"]{
    --bg:linear-gradient(90deg,#ff6bd6,#ffd36b,#6bffcf,#6bb7ff,#d36bff);
    --fg:#0b0014; --muted:#350a3a;
    --card:rgba(255,255,255,.92); --line:#ffb0f0;
    --accent:#ff3ea5; --accent2:#07f49e; --link:#7c00ff;
    --shadow:0 20px 50px rgba(0,0,0,.25); --code:#fff5ff; --mountain:#ffc6fb; --star:rgba(0,0,0,.8);
    background-size:200% 200%;
    animation:cringeBg 12s linear infinite;
    cursor: crosshair;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif}
  [data-theme="cringe"] body{ font-family: "Comic Sans MS", "Papyrus", system-ui, sans-serif; letter-spacing:.2px }
  a{color:var(--link)} h1{margin:6px 0 10px;font-size:28px}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
  .btn,button{border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;box-shadow:var(--shadow)}
  [data-theme="cringe"] .btn{ transform:skew(-2deg); box-shadow:0 10px 20px rgba(255,0,170,.25) }
  input[type="search"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,21,32,.9), rgba(15,21,32,.65));backdrop-filter: blur(10px) saturate(1.1);border-bottom:1px solid var(--line)}
  [data-theme="light"] header{background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.75))}
  [data-theme="cringe"] header{background:linear-gradient(90deg, rgba(255,255,255,.95), rgba(255,255,255,.6)); animation:wiggle 2.8s ease-in-out infinite}
  .head{max-width:var(--max);margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand a{color:var(--fg);text-decoration:none}
  .search{flex:1;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  main{max-width:var(--max);margin:0 auto;padding:20px 16px 80px;position:relative;z-index:1}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:900px){ .grid{grid-template-columns:1.15fr .85fr;gap:22px} }
  .list{display:flex;flex-direction:column;gap:12px}
  .story-item{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(125,211,252,.08), transparent);border:1px solid rgba(125,211,252,.18)}
  .story-item a{color:var(--fg);text-decoration:none}
  .title{font-weight:700}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;margin-right:6px}
  .tag:before{content:"‚ú∂";color:var(--muted)}
  [data-theme="light"] .tag:before{content:"#"}
  [data-theme="cringe"] .tag{border-color:#ff7bd9}
  .back{display:inline-flex;align-items:center;gap:8px;margin:6px 0 12px}
  .progress{position:fixed;left:0;top:0;height:3px;background:linear-gradient(90deg, var(--accent), var(--accent2));width:0;z-index:6}
  .anno{color:var(--muted);font-style:italic;margin-top:6px}
  .anno-box{border:1px dashed var(--line);background:rgba(125,211,252,.06);padding:12px;border-radius:10px;margin:10px 0 14px}
  [data-theme="light"] .anno-box{background:rgba(14,165,233,.08)}
  [data-theme="cringe"] .anno-box{background:rgba(255,62,165,.10); border-color:#ff9be6}
  details.anno-dtl summary{cursor:pointer;user-select:none}
  /* —Ñ–æ–Ω */
  #stars{position:fixed;inset:0;z-index:0;pointer-events:none}
  #ceiling{position:fixed;left:0;right:0;top:0;height:18vh;z-index:0;pointer-events:none;opacity:.95}
  #ceiling svg{width:100%;height:100%;display:block;transform:scaleY(-1)}
  #ceiling path{fill:var(--mountain)}
  #mountains{position:fixed;left:0;right:0;bottom:0;height:28vh;z-index:0;pointer-events:none;opacity:.92}
  #mountains svg{width:100%;height:100%;display:block}
  #mountains path{fill:var(--mountain)}
  /* –ü–µ—Ä–≥–∞–º–µ–Ω—Ç */
  .parchment{background: radial-gradient(120% 120% at 50% 0%, rgba(255,245,230,.35), transparent 60%), linear-gradient(#f6efe1, #efe6d3); color:#2b2418; border:1px solid #e4d7bd; box-shadow: 0 10px 30px rgba(0,0,0,.18)}
  [data-theme="dark"] .parchment{background: radial-gradient(120% 120% at 50% 0%, rgba(90,70,40,.25), transparent 60%), linear-gradient(#2d261b, #201a12); color:#efe7d6; border-color:#5a4a35}
  .parchment h1{ font-family: Georgia, 'Times New Roman', serif; letter-spacing:.3px }
  .scroll-body p{ text-indent:1.2em; margin:0 0 1em }
  .edition-pill{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #d1bfa0; background:#f3ead7; color:#6b5636; font-size:12px }
  [data-theme="dark"] .edition-pill{ background:#3a3123; color:#e7dcc8; border-color:#5a4a35 }
  /* –∞–¥–º–∏–Ω */
  #adminDock{position:fixed;right:14px;bottom:14px;z-index:7;display:none}
  #adminBtns{display:none}
  /* –∫—Ä–∏–Ω–∂ —Å—Ç–∏–∫–µ—Ä—ã */
  [data-theme="cringe"] .sticker{position:fixed; z-index:2; opacity:.9; filter:drop-shadow(0 6px 16px rgba(0,0,0,.25)); animation:bounceY 3.6s ease-in-out infinite}
  [data-theme="cringe"] .sticker.s1{left:10px;top:64px; transform:rotate(-8deg)}
  [data-theme="cringe"] .sticker.s2{right:12px;bottom:76px; transform:rotate(8deg)}
  </style>
</head>
<body>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div id="ceiling" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L8,18 L18,22 L28,15 L38,20 L48,12 L58,19 L68,13 L78,22 L88,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div id="mountains" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L10,18 L20,22 L30,14 L40,20 L50,10 L60,19 L70,13 L80,22 L90,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div class="progress" id="progress"></div>
  <img class="sticker s1" alt="sparkle" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='72' height='72' viewBox='0 0 72 72'%3E%3Ctext y='50' font-size='48'%3E%F0%9F%92%96%3C/text%3E%3C/svg%3E"/>
  <img class="sticker s2" alt="star" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='70' height='70' viewBox='0 0 70 70'%3E%3Ctext y='50' font-size='48'%3E%F0%9F%8C%9F%3C/text%3E%3C/svg%3E"/>

  <header>
    <div class="head">
      <div class="brand"><a href="#/">–ö–∞–π–Ω—Ä–∞–∫—Å ‚ú∂</a></div>
      <div class="search" style="max-width:780px">
        <span class="pill">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ø—Ç/—Å–±</span>
        <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–∞—Å—Å–∫–∞–∑–∞–º‚Ä¶" aria-label="–ü–æ–∏—Å–∫" />
        <a class="btn" href="#/arcs">–í–µ—Ç–∫–∏</a>
        <a class="btn" href="#/notes">–ó–∞–º–µ—Ç–∫–∏</a>
        <a class="btn" href="#/scrolls">–ü–µ—Ä–≥–∞–º–µ–Ω—Ç</a>
        <a class="btn" href="#/project">–û –ø—Ä–æ–µ–∫—Ç–µ | –ø–ª–∞–Ω—ã</a>
        <button id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
        <span id="adminBtns">
          <a class="btn" href="/admin/" target="_blank" rel="noopener">–ê–¥–º–∏–Ω–∫–∞</a>
          <a class="btn" id="newStoryBtn" href="/admin/#/collections/stories/new" target="_blank" rel="noopener">+ –†–∞—Å—Å–∫–∞–∑</a>
          <a class="btn" id="newNoteBtn"  href="/admin/#/collections/notes/new"  target="_blank" rel="noopener">+ –ó–∞–º–µ—Ç–∫–∞</a>
          <a class="btn" id="newScrollBtn" href="/admin/#/collections/scrolls/new" target="_blank" rel="noopener">+ –ü–µ—Ä–≥–∞–º–µ–Ω—Ç</a>
        </span>
      </div>
    </div>
  </header>

  <div id="adminDock"><a class="btn" id="editThisBtn" target="_blank" rel="noopener">‚úèÔ∏è –ü—Ä–∞–≤–∏—Ç—å</a></div>
  <main id="app" aria-live="polite"></main>

  <script>
  /* ===== –ö–û–ù–°–¢–ê–ù–¢–´ ===== */
  window.CUSDIS_APP_ID = "079685b7-f335-4fbd-9217-9d857a3cc369"; // –º–æ–∂–µ—à—å —Å–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å
  const app=document.getElementById('app');
  const qEl=document.getElementById('q');
  const state={ theme: localStorage.getItem('theme') || 'dark', route: location.hash.slice(1)||'/', q:'' };

  /* ===== –í–ï–¢–ö–ò (—Ç–æ–ª—å–∫–æ –º–µ—Ç–∞) ===== */
  const arcs=[
    { id:'surface', title:'–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å', desc:'–†–∞—Å—Å–∫–∞–∑—ã –∏ –ø–æ–≤–µ—Å—Ç–∏ –Ω–µ –æ –ö–∞–π–Ω—Ä–∞–∫—Å.' },
    { id:'kainrax', title:'–ö–∞–π–Ω—Ä–∞–∫—Å',    desc:'–†–∞—Å—Å–∫–∞–∑—ã –∏ –ø–æ–≤–µ—Å—Ç–∏, –¥–µ–π—Å—Ç–≤–∏–µ –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –ö–∞–π–Ω—Ä–∞–∫—Å.' },
    { id:'ibut',    title:'–ò–ë–£–¢',        desc:'–õ—ë–≥–∫–æ–µ —á—Ç–∏–≤–æ –ø—Ä–æ –ø–æ–ø–∞–¥–∞–Ω—Ü–µ–≤.' }
  ];
  const arcById=id=>arcs.find(a=>a.id===id)||{id, title:'–í–µ—Ç–∫–∞', desc:''};
  const fmtDate=iso=>{ try{const d=new Date(iso);return d.toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'});}catch(_){return iso} };
  const getAnno = (s) => {
    const a = (s.annotation || s.anno || s.summary || '').trim();
    if (a) return a;
    const txt = (s.text || '').replace(/\s+/g, ' ').trim();
    if (!txt) return '';
    const cut = 180; return txt.length > cut ? txt.slice(0, cut) + '‚Ä¶' : txt;
  };
  const estMinutes = (s) => {
    if (s.minutes) return s.minutes;
    const chars = (s.text||'').length; // –≥—Ä—É–±–æ –ø–æ –∑–Ω–∞–∫–∞–º
    const m = Math.max(3, Math.min(60, Math.ceil(chars/1100))); // ~1100 –∑–Ω/–º–∏–Ω
    return m;
  };

  /* ===== –î–ê–ù–ù–´–ï ===== */
  let stories=[], notes=[], scrolls=[];
  let scrollsAccess=null; // {codeHash, codeHint, message}

  async function loadContent(){
    // –û–±—â–∏–π –∏–Ω–¥–µ–∫—Å
    try{
      const j=await fetch('content/index.json',{cache:'no-store'}).then(r=>r.ok?r.json():Promise.reject());
      if(Array.isArray(j.stories)) stories=j.stories; else stories=[];
      if(Array.isArray(j.notes))   notes=j.notes;   else notes=[];
      if(Array.isArray(j.scrolls)) scrolls=j.scrolls; // –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä—è–º–æ —Ç—É—Ç
    }catch(e){
      try{
        const [sj,nj]=await Promise.all([
          fetch('content/stories.json',{cache:'no-store'}).then(r=>r.ok?r.json():[]),
          fetch('content/notes.json',{cache:'no-store'}).then(r=>r.ok?r.json():[])
        ]);
        stories = Array.isArray(sj)?sj:[]; notes = Array.isArray(nj)?nj:[];
      }catch(_){ stories=[]; notes=[]; }
    }
    // –û—Ç–¥–µ–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç –ü–µ—Ä–≥–∞–º–µ–Ω—Ç–∞
    try{ const pj = await fetch('content/scrolls/index.json',{cache:'no-store'}).then(r=>r.ok?r.json():[]); if(Array.isArray(pj)) scrolls = pj; }catch(_){}
    // –î–æ—Å—Ç—É–ø –∫ –ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É (–º—è–≥–∫–∏–π, –æ–±—â–∏–π)
    try{ const aj = await fetch('content/scrolls/access.json',{cache:'no-store'}).then(r=>r.ok?r.json():null); if(aj) scrollsAccess = aj; }catch(_){}

    // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    stories.sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0)));
    notes.sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0)));
    scrolls.sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0)));
  }

  /* ===== –¢–ï–ú–ê ===== */
  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme);
    localStorage.setItem('theme', state.theme);
    setUtterancesTheme(state.theme); setCusdisTheme();
    const el=document.getElementById('favicon');
    const color = state.theme==='light' ? '%230A1830' : '%23FFD54A';
    el.href = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='${color}' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E`;
  }
  applyTheme();
  document.getElementById('themeBtn').onclick=()=>{
    state.theme = state.theme==='dark' ? 'light' : (state.theme==='light' ? 'cringe' : 'dark');
    applyTheme();
  };

  /* ===== ADMIN ===== */
  let isAdmin = new URLSearchParams(location.search).has('admin') || localStorage.getItem('admin')==='1';
  if(new URLSearchParams(location.search).has('admin')){ localStorage.setItem('admin','1'); history.replaceState({},'',location.pathname+location.hash); }
  function ensureAdminUI(){ document.getElementById('adminBtns').style.display = isAdmin ? 'inline-flex' : 'none'; if(!isAdmin) adminDockHide(); }
  addEventListener('keydown',e=>{ if(e.altKey&&e.shiftKey&&e.key.toLowerCase()==='a'){ isAdmin=!isAdmin; localStorage.setItem('admin',isAdmin?'1':'0'); ensureAdminUI(); } });

  /* ===== –†–û–£–¢–ï–† / –ü–û–ò–°–ö ===== */
  addEventListener('hashchange',()=>{ state.route=location.hash.slice(1)||'/'; render(); restoreScroll(); });
  qEl.addEventListener('input',()=>{ state.q=qEl.value.trim().toLowerCase(); renderList(); });

  /* ===== –•–ï–õ–ü–ï–†–´ –ü–û –í–ï–¢–ö–ê–ú ===== */
  const storiesByArc = (id) => stories
    .filter(s=> (s.arc||'').toLowerCase() === (id||'').toLowerCase())
    .sort((a,b)=>{
      const ao = (a.order??Infinity), bo=(b.order??Infinity);
      if(ao!==bo) return ao-bo;
      return (new Date(a.date||0)) - (new Date(b.date||0));
    });

  /* ===== –í–¨–Æ–•–ò ===== */
  function renderList(){
    const q=state.q;
    const items=stories.filter(s=>!q || s.title?.toLowerCase().includes(q) || (s.text||'').toLowerCase().includes(q) || (s.tags||[]).join(' ').toLowerCase().includes(q));
    app.innerHTML=`
      <div class="grid">
        <section class="card">
          <h1>–†–∞—Å—Å–∫–∞–∑—ã</h1>
          <div class="muted">–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –í—ã—Ö–æ–¥—ã: –ø—è—Ç–Ω–∏—Ü–∞/—Å—É–±–±–æ—Ç–∞.</div>
          <div class="list">
            ${items.length?items.map(s=>`
              <div class="story-item">
                <a href="#/read/${s.id}">
                  <div class="title">‚ú∂ ${s.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                  <div class="muted">${fmtDate(s.date)} ¬∑ ${estMinutes(s)} –º–∏–Ω —á—Ç–µ–Ω–∏—è ¬∑ –≤–µ—Ç–∫–∞: ${arcById(s.arc).title}</div>
                </a>
                ${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}
              </div>`).join(''):`<div class="muted" style="margin-top:10px">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å <code>content/index.json</code> –∏–ª–∏ <code>content/stories.json</code>.</div>`}
          </div>
        </section>

        <aside class="card">
          <h2>–í–µ—Ç–∫–∏</h2>
          <div class="list">
            ${arcs.map(a=>{
              const count = storiesByArc(a.id).length;
              return `
              <div class="story-item">
                <a href="#/arc/${a.id}">
                  <div class="title">‚ú∂ ${a.title}</div>
                  <div class="muted">${count} —Ç–µ–∫—Å—Ç(–∞)</div>
                  <div>${a.desc}</div>
                </a>
              </div>`;
            }).join('')}
          </div>
          <h3 style="margin-top:14px">–ü–æ–¥–ø–∏—Å–∫–∞</h3>
          <p class="muted">–¢–µ–ª–µ–≥—Ä–∞–º: <a href="https://t.me/kainrax" target="_blank" rel="noopener">@kainrax</a></p>
        </aside>
      </div>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArcs(){
    app.innerHTML=`<section class="card"><h1>–í–µ—Ç–∫–∏</h1>
    <div class="list">${arcs.map(a=>{
      const count = storiesByArc(a.id).length;
      return `
      <div class="story-item"><a href="#/arc/${a.id}">
        <div class="title">‚ú∂ ${a.title}</div>
        <div class="muted">${count} —Ç–µ–∫—Å—Ç(–∞)</div>
        <div>${a.desc}</div>
      </a></div>`;}).join('')}</div></section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArc(id){
    const a=arcById(id);
    const arr = storiesByArc(id);
    app.innerHTML=`<section class="card">
      <a class="back" href="#/arcs">‚Üê –ö–æ –≤—Å–µ–º –≤–µ—Ç–∫–∞–º</a>
      <h1>${a.title}</h1><div class="muted">${a.desc}</div>
      <ol class="list" style="margin-top:10px">${arr.map((s,i)=>`
        <li class="story-item">
          <a href="#/read/${s.id}">
            <div class="title">‚ú∂ ${i+1}. ${s.title}</div>
            <div class="muted">${fmtDate(s.date)} ¬∑ ${estMinutes(s)} –º–∏–Ω</div>
          </a>
          ${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}
        </li>`).join('')}
      </ol></section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderNotes(){
    app.innerHTML=`<section class="card"><h1>–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –∑–∞–º–µ—Ç–∫–∏</h1>
    <div class="list">${(notes||[]).map(n=>`
      <div class="story-item"><a href="#/note/${n.id}">
        <div class="title">‚ú∂ ${n.title}</div>
        <div class="muted">${fmtDate(n.date)}</div>
      </a></div>`).join('')}</div></section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderNote(id){
    const n=(notes||[]).find(x=>x.id===id||x.slug===id); if(!n){location.hash='#/notes';return;}
    app.innerHTML=`<a class="back" href="#/notes">‚Üê –ö –∑–∞–º–µ—Ç–∫–∞–º</a>
    <article class="prose" data-id="${n.id}" data-slug="${n.slug||n.id}">
      <h1>${n.title}</h1>
      <div class="muted">${fmtDate(n.date)}</div>
      ${(n.text||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}
    </article>
    <div class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></div>`;
    mountComments('note:'+(n.slug||n.id)); setTimeout(restoreScroll,0);
    adminDockFor('note', n.slug||n.id); ensureAdminUI();
  }

  function renderProject(){
    const wip = (notes||[])
      .filter(n => /(wip|–ø–ª–∞–Ω—ã|–≤ —Ä–∞–±–æ—Ç–µ|work|writing)/i.test([n.title, ...(n.tags||[])].join(' ')))
      .sort((a,b)=> (new Date(b.date||0))-(new Date(a.date||0)))[0];

    app.innerHTML=`<section class="card">
      <h1>–û –ø—Ä–æ–µ–∫—Ç–µ | –ø–ª–∞–Ω—ã</h1>
      <div class="prose">
        <p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–∞—Ä—É –ª–µ—Ç –º–µ–Ω—è –Ω–µ –æ—Ç–ø—É—Å–∫–∞–µ—Ç –∏–¥–µ—è –º–∏—Ä–∞, –≥–¥–µ –º–∞–≥–∏—è ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —Å–±–æ–π –≤ —Ñ–∏–∑–∏–∫–µ, –≥–¥–µ –±–æ–≥–∏ ‚Äî —Å–ª–æ–º–∞–Ω–Ω—ã–π –ò–ò, –∞ –ª—é–¥–∏ –Ω–∞ —Ñ–æ–Ω–µ –±–æ–ª—å—à–∏—Ö —Å–æ–±—ã—Ç–∏–π –∂–∏–≤—É—Ç —Å–≤–æ–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –∂–∏–∑–Ω–∏.</p>
        <p>–¢–∞–∫ —Ä–æ–¥–∏–ª–∞—Å—å –ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—è, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –Ω–∞ –∫–æ—Å—Ç—è—Ö —É–±–∏—Ç—ã—Ö –±–æ–≥–æ–≤. –ù–∞—Ü–∏—è –ö–∞–∏–Ω–∞, –Ω–∞—Ü–∏—è –≥–µ–Ω–∏–µ–≤ –∏ –æ–±—ã—á–Ω—ã—Ö –ª—é–¥–µ–π, –∂–∏–≤—É—â–∞—è –ø–æ–¥ –∑–µ–º–ª—ë–π –≤ –≤–µ—á–Ω–æ–º —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏.</p>
        <p>–ó–¥–µ—Å—å —è –±—É–¥—É –ø–∏—Å–∞—Ç—å –µ—ë. –ö–∞–Ω–∞–ª—å—á–∏–∫-—Ç–≤–æ—Ä—á–µ—Å–∫–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è, –≥–¥–µ —è –≤—ã–∫–ª–∞–¥—ã–≤–∞—é —Ä–∞—Å—Å–∫–∞–∑—ã, –Ω–∞—Ä–∞–±–æ—Ç–∫–∏, –∞ –ø–æ—Ç–æ–º ‚Äî —ç–ø–∏—á–µ—Å–∫–∏–π —Ä–æ–º–∞–Ω.</p>
        <p><strong>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å.</strong></p>
        <div class="anno-box"><strong>–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –ø–∏—à–µ—Ç—Å—è:</strong> ${wip ? `<a href=\"#/note/${wip.id}\">${wip.title}</a> ¬∑ ${fmtDate(wip.date)}` : `–ø–æ–≤–µ—Å—Ç—å –æ –¶–≤–µ—Ç–∫–µ, –ò–ë–£–¢ –∏ –ø–∞—Ä–∞ —Ä–∞—Å—Å–∫–∞–∑–æ–≤; —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ä–æ–º–∞–Ω`}</div>
      </div>
    </section>`;
    adminDockHide(); ensureAdminUI();
  }

  /* ===== –ü–µ—Ä–≥–∞–º–µ–Ω—Ç (scrolls) ===== */
  async function ensureScrollsAccess(){
    if(!scrollsAccess) return true; // –Ω–µ—Ç —Ñ–∞–π–ª–∞ ‚Äî –Ω–µ—Ç –∑–∞—â–∏—Ç—ã
    const key='scrolls:gate:ok'; if(localStorage.getItem(key)==='1') return true;
    const hint=scrollsAccess.codeHint?`\n–ü–æ–¥—Å–∫–∞–∑–∫–∞: ${scrollsAccess.codeHint}`:'';
    const msg=scrollsAccess.message || '–î–æ—Å—Ç—É–ø –∫ ¬´–ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É¬ª. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:';
    let input = prompt(`${msg}${hint}`) || '';
    input=input.trim();
    const ok = await checkCode(input, scrollsAccess.codeHash);
    if(ok){ localStorage.setItem(key,'1'); return true; }
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.');
    return false;
  }

  function renderScrolls(){
    ensureScrollsAccess().then(can=>{
      if(!can){ location.hash='#/'; return; }
      app.innerHTML = `<section class="card">
        <h1>–ü–µ—Ä–≥–∞–º–µ–Ω—Ç</h1>
        <div class="list">
          ${(scrolls||[]).map(sc=>`
            <div class="story-item">
              <a href="#/scroll/${sc.id}">
                <div class="title">üìú ${sc.title} ${sc.edition?`<span class=\"edition-pill\">–†–ï–î–ê–ö–¶–ò–Ø ${sc.edition}</span>`:''}</div>
                <div class="muted">${fmtDate(sc.date)}${sc.protected?' ¬∑ üîí –ø–æ –∫–æ–¥—É':''}</div>
              </a>
              ${getAnno(sc)?`<div class="anno">${getAnno(sc)}</div>`:''}
            </div>`).join('')}
        </div>
      </section>`;
      adminDockHide(); ensureAdminUI();
    });
  }

  async function renderScroll(id){
    const sc = (scrolls||[]).find(x=>x.id===id || x.slug===id);
    if(!sc){ location.hash='#/scrolls'; return; }

    // –∑–∞—â–∏—Ç–∞ –ø–æ –∫–æ–¥—É (–ø–µ—Ä-—Å–∫—Ä–æ–ª–ª)
    if(sc.protected){
      const key = 'scroll:'+sc.id+':ok';
      const ok  = localStorage.getItem(key)==='1';
      if(!ok){
        const hint = sc.codeHint ? `\n–ü–æ–¥—Å–∫–∞–∑–∫–∞: ${sc.codeHint}` : '';
        let input = prompt(`–î–æ—Å—Ç—É–ø –∫ ¬´${sc.title}¬ª. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:${hint}`) || '';
        input = input.trim();
        const pass = await checkCode(input, sc.codeHash);
        if(!pass){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.'); location.hash='#/scrolls'; return; }
        localStorage.setItem(key,'1');
      }
    }

    // –ø–æ–¥—Ç—è–Ω—É—Ç—å —Ç–µ–ª–æ
    let body = '';
    try{ body = await fetch(sc.file, {cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject()); }
    catch(_){ body = '(–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç)'; }

    // –¥–µ—Ç–∞–ª–∏ ¬´–†–ï–î–ê–ö–¶–ò–Ø¬ª: –¥–∞—Ç–∞ + –•—Ä–æ–Ω–∏–∫—ë—Ä
    const metaBox = `
      <details class="anno-dtl anno-box" open>
        <summary><strong>–†–ï–î–ê–ö–¶–ò–Ø ${sc.edition || '‚Äî'}</strong> ‚Äî —Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å</summary>
        <div style="margin-top:8px" class="muted">${fmtDate(sc.date)}${sc.chronicler?` ¬∑ –•—Ä–æ–Ω–∏–∫—ë—Ä: ${sc.chronicler}`:''}</div>
      </details>`;

    app.innerHTML = `
      <a class="back" href="#/scrolls">‚Üê –ö ¬´–ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É¬ª</a>
      <article class="prose parchment" data-id="${sc.id}">
        <h1>üìú ${sc.title}</h1>
        <div style="margin:.5rem 0 1rem">${sc.edition?`<span class=\"edition-pill\">–†–ï–î–ê–ö–¶–ò–Ø ${sc.edition}</span>`:''} ${(sc.tags||[]).map(t=>`<span class=\"tag\">${t}</span>`).join('')}</div>
        ${metaBox}
        <div class="scroll-body">${body.split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}</div>
      </article>
      <section class="card" style="margin-top:16px">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section>
      </section>`;
    mountComments('scroll:'+sc.id); setTimeout(restoreScroll,0);
    adminDockHide(); ensureAdminUI();
  }

  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function checkCode(input, codeHash){
    if(!codeHash) return true;
    const [alg, hex] = String(codeHash).split(':');
    if((alg||'sha256')!=='sha256') return false;
    const got = await sha256Hex(input);
    return got.toLowerCase()===String(hex||'').toLowerCase();
  }

  /* ===== –ö–û–ú–ú–ï–ù–¢–´ ===== */
  function mountComments(term){
    const wrap=document.getElementById('comments'); if(!wrap) return;
    wrap.innerHTML=`
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button class="btn" id="tab-gh">GitHub</button>
        <button class="btn" id="tab-anon">–ê–Ω–æ–Ω–∏–º–Ω–æ</button>
      </div>
      <div id="c-gh"></div>
      <div id="c-anon" style="display:none;min-height:300px"></div>`;
    const ghBox=wrap.querySelector('#c-gh'), anonBox=wrap.querySelector('#c-anon');
    let ghLoaded=false, anonLoaded=false;
    function loadGH(){ if (ghLoaded) return; ghLoaded=true; ghBox.innerHTML='';
      const s=document.createElement('script'); s.src='https://utteranc.es/client.js';
      s.setAttribute('repo','sviam-byte/kainrax-site'); s.setAttribute('issue-term', term || 'home'); s.setAttribute('label','comments');
      s.setAttribute('theme', document.documentElement.getAttribute('data-theme')==='light'?'github-light':'github-dark');
      s.setAttribute('crossorigin','anonymous'); s.async=true; ghBox.appendChild(s);
    }
    function loadAnon(){ if (!window.CUSDIS_APP_ID){ anonBox.innerHTML='<div class="muted">–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.</div>'; return; }
      if (anonLoaded) return; anonLoaded=true; anonBox.innerHTML='';
      const t=document.createElement('div'); t.id='cusdis_thread'; t.dataset.host='https://cusdis.com'; t.dataset.appId=window.CUSDIS_APP_ID;
      t.dataset.pageId=term || (location.pathname+location.hash); t.dataset.pageUrl=location.href; t.dataset.pageTitle=document.title;
      t.dataset.lang='ru'; t.dataset.theme=(document.documentElement.getAttribute('data-theme')==='light')?'light':'dark';
      anonBox.appendChild(t);
      if (!window.__cusdisLoaded){ const s=document.createElement('script'); s.defer=true; s.src='https://cusdis.com/js/cusdis.es.js';
        s.onload=()=>{ window.__cusdisLoaded=true; try{ window.CUSDIS?.renderTo?.('#cusdis_thread'); setCusdisTheme(); }catch(_){} };
        document.body.appendChild(s);
      } else { try{ window.CUSDIS?.renderTo?.('#cusdis_thread'); setCusdisTheme(); }catch(_){} }
    }
    function showGH(){ ghBox.style.display='block'; anonBox.style.display='none'; loadGH(); }
    function showAnon(){ ghBox.style.display='none'; anonBox.style.display='block'; loadAnon(); }
    wrap.querySelector('#tab-gh').onclick=showGH; wrap.querySelector('#tab-anon').onclick=showAnon;
    const io=new IntersectionObserver(es=>{ if(es.some(e=>e.isIntersecting)){ showGH(); io.disconnect(); } },{rootMargin:'200px'});
    io.observe(wrap);
  }
  function setUtterancesTheme(theme){ const iframe=document.querySelector('iframe.utterances-frame'); if(iframe) iframe.contentWindow.postMessage({type:'set-theme', theme:theme==='light'?'github-light':'github-dark'}, 'https://utterances.es'); }
  function setCusdisTheme(){ try{ window.CUSDIS?.setTheme?.(document.documentElement.getAttribute('data-theme')==='light'?'light':'dark'); }catch(_){} }

  /* ===== –ê–î–ú–ò–ù –ö–ù–û–ü–ö–ê ===== */
  const adminDock=document.getElementById('adminDock');
  const editThisBtn=document.getElementById('editThisBtn');
  function adminDockHide(){ adminDock.style.display='none'; }
  function adminDockFor(kind, slug){ if (!isAdmin) return adminDockHide();
    if(kind==='story') editThisBtn.href=`/admin/#/collections/stories/entries/${slug}`;
    else if(kind==='note') editThisBtn.href=`/admin/#/collections/notes/entries/${slug}`;
    else if(kind==='scroll') editThisBtn.href=`/admin/#/collections/scrolls/entries/${slug}`;
    adminDock.style.display='block'; }

  /* ===== –ü–†–û–ì–†–ï–°–°/–°–ö–†–û–õ–õ ===== */
  const progress=document.getElementById('progress'); let ticking=false;
  function onScroll(){ if(ticking) return; ticking=true; requestAnimationFrame(()=>{
    const art=document.querySelector('article'); if(!art){progress.style.width='0%'; ticking=false; return;}
    const total=art.scrollHeight - window.innerHeight + 1;
    const top = Math.max(0, window.scrollY - (art.getBoundingClientRect().top + window.scrollY));
    const pct=Math.min(100, Math.max(0, (top / total)*100));
    progress.style.width=(isFinite(pct)?pct:0)+'%';
    const id=art.dataset.slug||art.dataset.id; if(id){ localStorage.setItem('read:'+id, window.scrollY); }
    ticking=false; }); }
  addEventListener('scroll', onScroll, {passive:true});
  function restoreScroll(){ const art=document.querySelector('article'); if(!art) return; const id=art.dataset.slug||art.dataset.id; const y=+localStorage.getItem('read:'+id)||0; if(y>0) setTimeout(()=>scrollTo({top:y,behavior:'instant'}),0); }

  /* ===== –ó–í–Å–ó–î–´ ===== */
  const canvas=document.getElementById('stars'); const ctx=canvas.getContext('2d');
  let W,H,starsArr=[], running=true; const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; makeStars(); if(prefersReduced){ drawStars(0,true); } }
  addEventListener('resize', resize);
  function makeStars(){ const base = document.documentElement.getAttribute('data-theme')==='light' ? 60 : 120; const k = (W*H)/30000; const count = Math.floor(base + k); starsArr = Array.from({length: count}, ()=>({ x: Math.random()*W, y: Math.random()*H, r: Math.random()*1.1+0.3, s: Math.random()*0.5+0.2 })); }
  function drawStars(ts, once=false){ ctx.clearRect(0,0,W,H); ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--star').trim() || 'rgba(255,255,255,.9)'; for(const st of starsArr){ const a = once ? 0.7 : 0.5 + Math.sin((ts/1200)*st.s + st.x*0.002)*0.4; ctx.globalAlpha = a; ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI*2); ctx.fill(); } if(!once && !prefersReduced && running) requestAnimationFrame(drawStars); }
  document.addEventListener('visibilitychange',()=>{ running = document.visibilityState==='visible'; if(running && !prefersReduced) requestAnimationFrame(drawStars); });

  /* ===== –†–û–£–¢–ï–† ===== */
  function render(){
    const r=state.route;
    if(r==='/'||r===''){ renderList(); return; }
    if(r==='/project'){ renderProject(); return; }
    if(r==='/arcs'){ renderArcs(); return; }
    if(r==='/notes'){ renderNotes(); return; }
    if(r==='/scrolls'){ renderScrolls(); return; }
    const mRead=r.match(/^\/read\/(.+)$/); if(mRead){ renderArticle(mRead[1]); return; }
    const mArc=r.match(/^\/arc\/(.+)$/); if(mArc){ renderArc(mArc[1]); return; }
    const mTag=r.match(/^\/tag\/(.+)$/); if(mTag){ renderTag(decodeURIComponent(mTag[1])); return; }
    const mNote=r.match(/^\/note\/(.+)$/); if(mNote){ renderNote(mNote[1]); return; }
    const mScroll=r.match(/^\/scroll\/(.+)$/); if(mScroll){ renderScroll(mScroll[1]); return; }
    renderList();
  }

  loadContent().then(()=>{ applyTheme(); render(); ensureAdminUI(); resize(); const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; if(!reduce) requestAnimationFrame(drawStars); });
  </script>
</body>
</html>
