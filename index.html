<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Кайнракс — рассказы</title>
  <meta name="description" content="Короткая НФ без лорового барьера. Обновления — пятница/суббота. Ветки: Поверхность, Кайнракс, ИБУТ." />
  <meta name="theme-color" content="#0b0f14" />
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23FFD54A' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Кайнракс — рассказы">
  <meta property="og:title" content="Кайнракс — рассказы">
  <meta property="og:description" content="Тёмная НФ о подземной цивилизации, где магия — это сбой в физике. Обновления — пт/сб.">
  <meta property="og:image" content="https://kainrax.site/og/kainrax-og.jpg">
  <meta property="og:locale" content="ru_RU">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Кайнракс — рассказы">
  <meta name="twitter:description" content="Короткая НФ без лорового барьера. Обновления — пт/сб.">
  <meta name="twitter:image" content="https://kainrax.site/og/kainrax-og.jpg">

  <!-- Plausible (замени домен, если иной) -->
  <script defer data-domain="kainrax.site" src="https://plausible.io/js/script.js"></script>

  <style>
  :root{
    --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa5b1;
    --card:rgba(16,21,32,.92); --line:#223042;
    --accent:#7dd3fc; --accent2:#a78bfa; --link:#93c5fd;
    --max:1024px; --r:14px; --shadow:0 12px 36px rgba(0,0,0,.45);
    --code:#0a0e16; --mountain:#121723; --star:rgba(255,255,255,.9);
  }
  [data-theme="light"]{
    --bg:#f7fbff; --fg:#0b0f14; --muted:#5a6774;
    --card:rgba(255,255,255,.97); --line:#e6ecf2;
    --accent:#0ea5e9; --accent2:#7c3aed; --link:#1d4ed8;
    --shadow:0 8px 24px rgba(0,0,0,.08); --code:#f6f8fb; --mountain:#dfe7f3; --star:rgba(10,20,40,.85);
  }
  [data-theme="cringe"]{
    --bg:linear-gradient(135deg,#ffb6f3,#ffd699 50%,#b3f1ff);
    --fg:#111; --muted:#333; --card:rgba(255,255,255,.9); --line:#ffd1f4;
    --accent:#ff3ea5; --accent2:#07f49e; --link:#7c00ff;
    --shadow:0 14px 40px rgba(0,0,0,.25); --code:#fff5ff; --mountain:#ffc6fb; --star:rgba(0,0,0,.75);
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif}
  a{color:var(--link)}
  h1{margin:6px 0 10px;font-size:28px}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
  .btn,button{border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;box-shadow:var(--shadow)}
  input[type="search"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}

  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,21,32,.92), rgba(15,21,32,.7));backdrop-filter: blur(10px) saturate(1.1);border-bottom:1px solid var(--line)}
  [data-theme="light"] header{background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.75))}
  [data-theme="cringe"] header{background:linear-gradient(90deg, rgba(255,255,255,.9), rgba(255,255,255,.6))}
  .head{max-width:var(--max);margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand a{color:var(--fg);text-decoration:none}
  .search{flex:1;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  main{max-width:var(--max);margin:0 auto;padding:20px 16px 80px;position:relative;z-index:1}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:980px){ .grid{grid-template-columns:1.15fr .85fr;gap:22px} }
  .list{display:flex;flex-direction:column;gap:12px}
  .story-item{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(125,211,252,.08), transparent);border:1px solid rgba(125,211,252,.18)}
  .story-item a{color:var(--fg);text-decoration:none}
  .title{font-weight:700}
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;margin-right:6px}
  .tag:before{content:"✶";color:var(--muted)}
  [data-theme="light"] .tag:before{content:"#" }
  .back{display:inline-flex;align-items:center;gap:8px;margin:6px 0 12px}

  .progress{position:fixed;left:0;top:0;height:3px;background:linear-gradient(90deg, var(--accent), var(--accent2));width:0;z-index:6}

  /* аннотация */
  .anno{color:var(--muted);font-style:italic;margin-top:6px}
  .anno-box{border:1px dashed var(--line);background:rgba(125,211,252,.06);padding:12px;border-radius:10px;margin:10px 0 14px}
  [data-theme="light"] .anno-box{background:rgba(14,165,233,.08)}
  [data-theme="cringe"] .anno-box{background:rgba(255,62,165,.08)}
  details.anno-dtl summary{cursor:pointer;user-select:none}

  /* фон: звёзды + «горы». В НЕ-кринже прячем */
  #stars{position:fixed;inset:0;z-index:0;pointer-events:none}
  #ceiling,#mountains{display:none}
  [data-theme="cringe"] #ceiling,[data-theme="cringe"] #mountains{display:block}
  #ceiling{position:fixed;left:0;right:0;top:0;height:18vh;z-index:0;pointer-events:none;opacity:.95}
  #ceiling svg{width:100%;height:100%;display:block;transform:scaleY(-1)}
  #ceiling path{fill:var(--mountain)}
  #mountains{position:fixed;left:0;right:0;bottom:0;height:28vh;z-index:0;pointer-events:none;opacity:.92}
  #mountains svg{width:100%;height:100%;display:block}
  #mountains path{fill:var(--mountain)}
  
  /* Линия Свода (неба) */
  #sky-line {
    position: fixed;
    left: -5%;
    width: 110%;
    height: 4px;
    z-index: 0;
    pointer-events: none;
    opacity: 0.6;
    filter: blur(2px);
    transform: skewY(-2deg);
    background: radial-gradient(ellipse 80% 150% at 50% 50%, var(--accent, #ffab00) 0%, transparent 60%);
  }
  [data-theme="light"] #sky-line {
    background: radial-gradient(ellipse 80% 150% at 50% 50%, var(--accent, #0ea5e9) 0%, transparent 50%);
    opacity: 0.5;
  }
  [data-theme="cringe"] #sky-line {
    height: 5px;
    background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
    background-size: 200% 200%;
    animation: cringe-line-anim 3s linear infinite;
    filter: blur(3px);
    opacity: 0.8;
  }
  @keyframes cringe-line-anim { 0%{background-position:0% 50%} 100%{background-position:200% 50%} }

  /* ЧИТАЕМЫЙ ФОН ДЛЯ ТЕКСТОВ */
  .readbox{background:rgba(20,26,38,.98); border:1px solid #2a3a52; border-radius:18px; padding:16px; box-shadow: var(--shadow)}
  [data-theme="light"] .readbox{background:#fff; border-color:#e6ecf2}
  [data-theme="cringe"] .readbox{background:#fff; color:#1a1a1a; border-color:#e9e1d6}

  /* Пергамент */
  .parchment{background: radial-gradient(120% 120% at 50% 0%, rgba(255,245,230,.35), transparent 60%), linear-gradient(#f6efe1, #efe6d3); color:#2b2418; border:1px solid #e4d7bd; box-shadow: 0 10px 30px rgba(0,0,0,.18); position:relative; background-blend-mode: multiply; }
  .parchment::before{ content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit; background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140'><filter id='n'><feTurbulence baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0.1'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 0 .03 .06 .03 0 0 0'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)' fill='rgba(0,0,0,1)'/></svg>"); opacity:.55; mix-blend-mode:multiply; }
  [data-theme="light"] .parchment{background: radial-gradient(120% 120% at 50% 0%, rgba(255,250,240,.6), transparent 60%), linear-gradient(#fffaf1, #f5ecda); color:#2b2418; border-color:#e8dcc4}
  [data-theme="cringe"] .parchment{background: radial-gradient(120% 120% at 50% 0%, rgba(255,255,255,.85), transparent 60%), linear-gradient(#ffffff, #faf7ef); color:#222; border-color:#e9e1d6}
  .scroll-body p{ text-indent:1.2em; margin:0 0 1em }

  /* Маргиналии */
  .with-margin{display:grid;grid-template-columns:minmax(0,1fr) 220px;gap:18px}
  @media (max-width:980px){ .with-margin{grid-template-columns:1fr} }
  .margin-notes{position:sticky;top:76px;align-self:start}
  .margin-notes .mnote{font-size:13px; color:var(--muted); border-left:2px solid var(--line); padding-left:10px; margin-bottom:12px; cursor:pointer;}
  .margin-notes .mnote:hover{color:var(--fg); border-left-color:var(--accent)}

  /* модалка доступа */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:20}
  .modal .box{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:var(--shadow);max-width:440px;width:92%}
  .seal{display:inline-block;min-width:64px;min-height:64px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ff6b6b,#c81e1e);box-shadow:0 8px 24px rgba(0,0,0,.3);transform-origin:center;animation:seal 1.4s ease-in-out infinite}
  @keyframes seal{0%,100%{transform:rotate(-2deg) scale(1)}50%{transform:rotate(2deg) scale(1.06)}}

  /* админ-панель скрыта */
  #adminDock{position:fixed;right:14px;bottom:14px;z-index:7;display:none}
  #adminBtns{display:none}

  /* Сигилл-узор на карточках */
  .card{ position:relative; overflow:hidden }
  .card::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background-image:
      radial-gradient(120px 120px at 10% -10%, rgba(125,211,252,.04), transparent 60%),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'><path d='M80 6 L87 27 L109 31 L87 35 L80 56 L73 35 L51 31 L73 27 Z' fill='rgba(125,211,252,0.04)'/></svg>");
    background-repeat:no-repeat, repeat;
    background-size:auto, 160px 160px;
    opacity: 0.7;
  }

  /* Тонкая полоска ветки */
  .story-item{ border-top:3px solid transparent }
  .story-item[data-arc="surface"]{ border-top-color:#10b981 }
  .story-item[data-arc="kainrax"]{ border-top-color:#7dd3fc }
  .story-item[data-arc="ibut"]{    border-top-color:#f59e0b }

  /* Глич логотипа ✶ */
  .brand a{ display:inline-block; transform:translateZ(0) }
  .brand a:hover{ animation:kx-glitch .6s steps(2,end) }
  @keyframes kx-glitch{
    30%{ transform:translate(.5px,-.5px) skewX(.3deg) }
    60%{ transform:translate(-.5px,.5px) skewY(.3deg) }
  }
  
  /* Скрытый по умолчанию счётчик просмотров */
  #viewsBox { display: none; }
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div id="ceiling" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L8,18 L18,22 L28,15 L38,20 L48,12 L58,19 L68,13 L78,22 L88,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div id="mountains" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L10,18 L20,22 L30,14 L40,20 L50,10 L60,19 L70,13 L80,22 L90,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div class="progress" id="progress"></div>

  <header>
    <div class="head">
      <div class="brand"><a href="#/">Кайнракс ✶</a></div>
      <div class="search" style="max-width:860px">
        <span class="pill" title="Новые тексты чаще всего выходят в эти дни">Обновления: пт/сб</span>
        <input id="q" type="search" placeholder="Поиск по рассказам…" aria-label="Поиск" />
        <a class="btn" href="#/arcs">Ветки</a>
        <a class="btn" href="#/perg">Пергамент</a>
        <a class="btn" href="#/notes">Заметки</a>
        <a class="btn" href="#/project">О проекте | планы</a>
        <button id="themeBtn" title="Сменить тему">🌓</button>
        <span id="adminBtns">
          <a class="btn" href="/admin/" target="_blank" rel="noopener">Админка</a>
          <a class="btn" id="newStoryBtn" href="/admin/#/collections/stories/new" target="_blank" rel="noopener">+ Рассказ</a>
          <a class="btn" id="newNoteBtn"  href="/admin/#/collections/notes/new"  target="_blank" rel="noopener">+ Заметка</a>
          <a class="btn" id="newPergBtn"  href="/admin/#/collections/pergament/new"  target="_blank" rel="noopener">+ Пергамент</a>
        </span>
      </div>
    </div>
  </header>

  <div id="adminDock"><a class="btn" id="editThisBtn" target="_blank" rel="noopener">✏️ Править</a></div>
  <main id="app" aria-live="polite"></main>

  <script>
  /* ===== ГЛОБАЛЬНЫЕ НАСТРОЙКИ ===== */
  const PERG = { CODE: 'Chronicle', CODE_HASH: null };
  window.CUSDIS_APP_ID = "079685b7-f335-4fbd-9217-9d857a3cc369";

  /* ===== СОСТОЯНИЕ И КОНСТАНТЫ ===== */
  const app=document.getElementById('app'), qEl=document.getElementById('q');
  const state={ theme: localStorage.getItem('theme') || 'dark', route: location.hash.slice(1)||'/', q:'' };
  let stories=[], notes=[], pergDocs=[];
  let isAdmin = new URLSearchParams(location.search).has('admin') || localStorage.getItem('admin')==='1';
  if(new URLSearchParams(location.search).has('admin')){ localStorage.setItem('admin','1'); history.replaceState({},'',location.pathname+location.hash); }

  /* ===== СЧЕТЧИКИ ПРОСМОТРОВ ===== */
  const VIEW_NS = "kainrax.site";
  async function incAndGetViews(slug){
    const k=`story:${slug}`, ukey=`viewed:${slug}`, already=localStorage.getItem(ukey)==='1';
    const endpoint=already?`https://api.countapi.xyz/get/${VIEW_NS}/${k}`:`https://api.countapi.xyz/hit/${VIEW_NS}/${k}`;
    try{ const j=await(await fetch(endpoint,{cache:'no-store'})).json(); if(!already)localStorage.setItem(ukey,'1'); return Number(j.value||0); }catch(_){ return 0; }
  }
  
  /* ===== УТИЛИТЫ ===== */
  const fmtHumanDate=iso=>new Date(iso).toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'})||iso;
  const fmtPergDayYear=s=>{ const m=(s||'').match(/^(\d{4})-(\d{3})$/); return m?`${+m[2]}-й день ${+m[1]}-го года.` : fmtHumanDate(s); };
  const getAnno = s => (s.annotation||s.anno||s.summary||'').trim() || ((s.text||'').slice(0,180).replace(/\s+/g,' ')+'…');

  /* ===== ЗАГРУЗКА ДАННЫХ ===== */
  async function loadContent(){
    const j=await(await fetch('content/index.json',{cache:'no-store'})).json().catch(()=>({}));
    stories=j.stories||await(await fetch('content/stories.json',{cache:'no-store'})).json().catch(()=>[]);
    notes=j.notes||await(await fetch('content/notes.json',{cache:'no-store'})).json().catch(()=>[]);
    pergDocs=await(await fetch('content/pergament/index.json',{cache:'no-store'})).json().catch(()=>[]);
    stories.sort((a,b)=>(new Date(b.date||0))-(new Date(a.date||0)));
    notes.sort((a,b)=>(new Date(b.date||0))-(new Date(a.date||0)));
    pergDocs.forEach(d=>(d.editions||[]).sort((a,b)=>String(a.date||'').localeCompare(String(b.date||''))));
    pergDocs.sort((a,b)=>{ const al=(a.editions||[]).at(-1)?.date||'', bl=(b.editions||[]).at(-1)?.date||''; return bl.localeCompare(al); });
  }

  /* ===== ВЬЮХИ И РЕНДЕР ===== */
  const arcMeta = {
    surface: {id:'surface', title:'Поверхность', desc:'Рассказы и повести не о Кайнракс.'},
    kainrax: {id:'kainrax',  title:'Кайнракс',    desc:'Рассказы и повести внутри Кайнракс.'},
    ibut:    {id:'ibut',     title:'ИБУТ',        desc:'Лёгкое чтиво про попаданцев.'},
  };
  function buildArcs(){
    const map = {};
    for(const s of stories){ const id=s.arc||'kainrax'; if(!map[id])map[id]={...(arcMeta[id]||{id,title:id,desc:''}),items:[]}; map[id].items.push(s); }
    for(const k in map) map[k].items.sort((a,b)=>(a.order||0)-(b.order||0)||(new Date(a.date||0))-(new Date(b.date||0)));
    return Object.values(map);
  }
  function renderList(){
    const items=stories.filter(s=>!state.q || (s.title+' '+(s.tags||[]).join(' ')+' '+(s.text||'')).toLowerCase().includes(state.q));
    const arcs=buildArcs();
    app.innerHTML=`<div class="grid"><section class="card"><h1>Рассказы</h1><div class="muted">Короткая НФ без лорового барьера. Выходы: пт/сб.</div><div class="list">${items.length?items.map(s=>`<div class="story-item" data-arc="${s.arc||'kainrax'}"><a href="#/read/${s.id}"><div class="title">✶ ${s.title||'Без названия'}</div><div class="muted">${fmtHumanDate(s.date)} · ${s.minutes||Math.max(5,Math.round((s.text||'').length/1100))} мин · ветка: ${(arcMeta[s.arc||'kainrax']||{title:'Ветка'}).title}</div></a>${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}</div>`).join(''):'<div class="muted" style="margin-top:10px">Ничего не найдено.</div>'}</div></section><aside class="card"><h2>Ветки</h2><div class="list">${arcs.map(a=>`<div class="story-item" data-arc="${a.id}"><a href="#/arc/${a.id}"><div class="title">✶ ${a.title}</div><div class="muted">${a.items.length} текст(а)</div><div>${a.desc||''}</div></a></div>`).join('')}</div><h3 style="margin-top:14px">Подписка</h3><p class="muted">Телеграм: <a href="https://t.me/kainrax" target="_blank" rel="noopener">@kainrax</a></p></aside></div>`;
    adminDockHide(); ensureAdminUI();
  }
  function renderArticle(id){
    const s=stories.find(x=>x.id===id||x.slug===id); if(!s){location.hash='/'; return;}
    const a=buildArcs().find(x=>x.id===(s.arc||'kainrax'))||{title:'Ветка',items:[]}; const order=a.items; const pos=Math.max(0,order.findIndex(v=>(v.id===s.id)||(v.slug&&v.slug===s.slug))); const prev=order[pos-1], next=order[pos+1];
    app.innerHTML=`<a class="back" href="#/">← К списку</a><article class="with-margin" data-id="${s.id}" data-slug="${s.slug||s.id}"><div class="prose readbox"><h1>${s.title}</h1><div class="muted">${fmtHumanDate(s.date)} · ${s.minutes||Math.max(5,Math.round((s.text||'').length/1100))} мин · ветка: <a href="#/arc/${s.arc||'kainrax'}">${(arcMeta[s.arc||'kainrax']||{title:'Ветка'}).title}</a> (${pos+1}/${order.length}) · <span id="viewsBox" title="Просмотры (только для админа)"></span></div><div style="margin:6px 0 12px">${(s.tags||[]).map(t=>`<a class='tag' href='#/tag/${encodeURIComponent(t)}'>${t}</a>`).join(' ')}</div>${getAnno(s)?`<details class="anno-dtl anno-box"><summary><strong>Аннотация</strong></summary><div style="margin-top:8px">${getAnno(s)}</div></details>`:''}${(s.text||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}<hr style="border:0;border-top:1px solid var(--line);margin:18px 0"><div style="display:flex;justify-content:space-between;gap:10px">${prev?`<a class="btn" href="#/read/${prev.id}">← ${prev.title}</a>`:'<span></span>'}${next?`<a class="btn" href="#/read/${next.id}">${next.title} →</a>`:'<span></span>'}</div></div><aside class="margin-notes"></aside></article><section class="card" style="margin-top:16px"><h3>Комментарии</h3><section id="comments"></section></section>`;
    const vbox=document.getElementById('viewsBox'); if(vbox&&isAdmin){vbox.style.display='inline'; incAndGetViews(s.slug||s.id).then(v=>{if(vbox)vbox.textContent=`${v} просм.`;});}
    mountComments(`story:${s.slug||s.id}`); setTimeout(restoreScroll,0); adminDockFor('story',s.slug||s.id); ensureAdminUI();
  }
  async function renderPerg(rawId){
    const id = (rawId||'').split('?')[0];
    const d = pergDocs.find(x=>x.id===id||x.slug===id); if(!d){location.hash='#/perg';return;}
    const editions = d.editions||[]; if(!editions.length){app.innerHTML=`<a class="back" href="#/perg">← К «Пергаменту»</a><section class="card">У этого документа пока нет редакций.</section>`;return;}
    const q=parseHashQuery(), lastEd=editions.at(-1), e=editions.find(x=>x.id===q.e)||lastEd;

    const accessOK = (e===lastEd) || localStorage.getItem(`perg:${d.id}:${e.id}:ok`)==='1' || await showAccessModal({message:'Подтвердите доступ',codeHint:e.codeHint||'хроникёр и год'},(input)=>checkPergCode(input,e)).then(ok=>{if(ok)localStorage.setItem(`perg:${d.id}:${e.id}:ok`,'1');return ok;});
    if(!accessOK){location.hash=`#/perg/${id}`;return;}
    
    const body = await fetch(e.file,{cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject()).catch(()=>'(не удалось загрузить текст)');
    const options = editions.map(x=>`<option value="${x.id}" ${x.id===e.id?'selected':''}>${x.title||x.id} · ${fmtPergDayYear(x.date||'')}</option>`).join('');
    
    let marginNotesHTML=(d.margin||[]).map(m=>`<div class="mnote">${m}</div>`).join('');
    if(e===lastEd&&editions.length>1){ const prev=editions.at(-2); marginNotesHTML=`<div class="mnote" onclick="location.hash='#/perg/${id}?e=${prev.id}'"><strong>Предыдущая редакция</strong><br>${fmtPergDayYear(prev.date||'')} — доступ по коду.</div>`+marginNotesHTML;}
    
    app.innerHTML=`<a class="back" href="#/perg">← К «Пергаменту»</a><article class="with-margin" data-id="${d.id}"><div class="prose parchment readbox"><h1>📜 ${d.title}</h1><div class="muted">Редакции: <select id="edSel" class="btn">${options}</select></div>${d.annotation?`<div class="anno">${d.annotation}</div>`:''}${(body||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}</div><aside class="margin-notes">${marginNotesHTML}</aside></article><section class="card" style="margin-top:16px"><h3>Комментарии</h3><section id="comments"></section></section>`;
    document.getElementById('edSel').onchange=(ev)=>{location.hash=`#/perg/${id}?e=${ev.target.value}`;};
    mountComments(`perg:${d.slug||d.id}:${e.id||''}`); setTimeout(restoreScroll,0); adminDockFor('perg',d.slug||d.id); ensureAdminUI();
  }
  function render(route=state.route){
    if(route==='/'||route===''){renderList();return;} const mRead=route.match(/^\/read\/([^?]+)/);if(mRead){renderArticle(mRead[1]);return;} const mPerg=route.match(/^\/perg\/([^?]+)/);if(mPerg){renderPerg(mPerg[1]);return;}
    app.innerHTML = 'Загрузка...'; // Fallback for other routes
  }

  /* ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===== */
  function parseHashQuery(){ const h=location.hash.split('?')[1]||''; const out={}; h.split('&').forEach(p=>{if(!p)return;const[k,v]=p.split('=');out[decodeURIComponent(k)]=decodeURIComponent(v||'');}); return out;}
  async function sha256Hex(text){const enc=new TextEncoder().encode(text);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
  async function checkPergCode(input,ed){const pass=(input||'').trim();if(!pass)return false;if(ed?.codeHash){const[,hex]=String(ed.codeHash).split(':');return(await sha256Hex(pass)).toLowerCase()===String(hex||'').toLowerCase();}if(ed?.code)return pass===String(ed.code).trim();if(PERG.CODE_HASH){const[,hex]=String(PERG.CODE_HASH).split(':');return(await sha256Hex(pass)).toLowerCase()===String(hex||'').toLowerCase();}if(PERG.CODE)return pass===String(PERG.CODE).trim();return false;}
  function showAccessModal(cfg,verify){return new Promise(resolve=>{const w=document.createElement('div');w.className='modal';w.innerHTML=`<div class="box"><div style="display:flex;gap:12px;align-items:center"><div class="seal"></div><div><h3>${cfg?.message||'Доступ'}</h3><div class="muted">${cfg?.codeHint?'Подсказка: '+cfg.codeHint:'Введите код.'}</div></div></div><div style="display:flex;gap:8px;margin-top:12px"><input id="codeIn" type="password" placeholder="код" style="flex:1"/><button class="btn" id="okBtn">ОК</button><button class="btn" id="cancelBtn">Отмена</button></div><div class="muted" id="err" style="display:none">Неверно</div></div>`;document.body.appendChild(w);const i=w.querySelector('#codeIn'),ok=w.querySelector('#okBtn'),c=w.querySelector('#cancelBtn'),err=w.querySelector('#err');const cl=v=>{document.body.removeChild(w);resolve(v);};c.onclick=()=>cl(false);ok.onclick=async()=>{const pass=await verify(i.value||'');if(pass)cl(true);else{err.style.display='block';i.select();}};i.onkeydown=e=>{if(e.key==='Enter')ok.click();};setTimeout(()=>i.focus(),0);});}
  function mountComments(term){const w=document.getElementById('comments');if(!w)return;w.innerHTML=`<div style="display:flex;gap:8px;margin-bottom:10px"><button class="btn" id="tab-gh">GitHub</button><button class="btn" id="tab-anon">Анонимно</button></div><div id="c-gh"></div><div id="c-anon" style="display:none"></div>`;const gh=w.querySelector('#c-gh'),an=w.querySelector('#c-anon');let gL=false,aL=false;function Lgh(){if(gL)return;gL=true;gh.innerHTML='';const s=document.createElement('script');s.src='https://utteranc.es/client.js';s.setAttribute('repo','sviam-byte/kainrax-site');s.setAttribute('issue-term',term);s.setAttribute('label','comments');s.setAttribute('theme',state.theme==='light'?'github-light':'github-dark');s.async=true;gh.appendChild(s);}function Lan(){if(!window.CUSDIS_APP_ID){an.innerHTML='<div class="muted">Анонимные комментарии отключены.</div>';return;}if(aL)return;aL=true;an.innerHTML='';const t=document.createElement('div');t.id='cusdis_thread';t.dataset.appId=window.CUSDIS_APP_ID;t.dataset.pageId=term;t.dataset.theme=state.theme;an.appendChild(t);if(!window.__cusdisLoaded){const s=document.createElement('script');s.defer=true;s.src='https://cusdis.com/js/cusdis.es.js';s.onload=()=>{window.__cusdisLoaded=true;window.CUSDIS?.renderTo('#cusdis_thread');};document.body.appendChild(s);}else{window.CUSDIS?.renderTo('#cusdis_thread');}}w.querySelector('#tab-gh').onclick=()=>{gh.style.display='block';an.style.display='none';Lgh();};w.querySelector('#tab-anon').onclick=()=>{gh.style.display='none';an.style.display='block';Lan();};const io=new IntersectionObserver(es=>{if(es.some(e=>e.isIntersecting)){w.querySelector('#tab-gh').click();io.disconnect();}},{rootMargin:'200px'});io.observe(w);}
  function setUtterancesTheme(theme){const fr=document.querySelector('iframe.utterances-frame');if(fr)fr.contentWindow.postMessage({type:'set-theme',theme:theme==='light'?'github-light':'github-dark'},'https://utteranc.es');}
  function setCusdisTheme(){window.CUSDIS?.setTheme(state.theme);}
  const adminDock=document.getElementById('adminDock'),editThisBtn=document.getElementById('editThisBtn');function adminDockHide(){adminDock.style.display='none';}function adminDockFor(k,s){if(!isAdmin)return;editThisBtn.href=`/admin/#/collections/${k==='story'?'stories':k==='note'?'notes':'pergament'}/entries/${s}`;adminDock.style.display='block';}
  const progress=document.getElementById('progress');let ticking=false;function onScroll(){if(!ticking){ticking=true;requestAnimationFrame(()=>{const art=document.querySelector('article');if(!art){progress.style.width='0%';ticking=false;return;}const tot=art.scrollHeight-innerHeight+1,pct=Math.min(100,Math.max(0,((scrollY-art.offsetTop)/tot)*100));progress.style.width=`${isFinite(pct)?pct:0}%`;localStorage.setItem(`read:${art.dataset.slug||art.dataset.id}`,scrollY);ticking=false;});}}addEventListener('scroll',onScroll,{passive:true});function restoreScroll(){const art=document.querySelector('article');if(!art)return;const y=+localStorage.getItem(`read:${art.dataset.slug||art.dataset.id}`)||0;if(y>0)setTimeout(()=>scrollTo({top:y,behavior:'instant'}),0);}
  const canvas=document.getElementById('stars'),ctx=canvas.getContext('2d');let W,H,starsArr=[],run=true;const prm=window.matchMedia?.('(prefers-reduced-motion:reduce)').matches;function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;makeStars();if(prm)drawStars(0,true);}function makeStars(){const k=(W*H)/30000;const c=Math.floor((state.theme==='light'?60:120)+k);starsArr=Array.from({length:c},()=>({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.1+0.3,s:Math.random()*0.5+0.2}));}function drawStars(ts,once=false){ctx.clearRect(0,0,W,H);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--star').trim()||'#fff';for(const s of starsArr){ctx.globalAlpha=once?0.7:0.5+Math.sin((ts/1200)*s.s+s.x*0.002)*0.4;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();}if(!once&&!prm&&run)requestAnimationFrame(drawStars);}
  function initSkyLine(){const el=document.getElementById('sky-line');if(!el)return;let r=true;function upd(){const n=new Date(),p=((n.getHours()*36e5)+(n.getMinutes()*6e4)+(n.getSeconds()*1e3)+n.getMilliseconds())/864e5;el.style.top=`${p*100}vh`;if(r)requestAnimationFrame(upd);}document.addEventListener('visibilitychange',()=>{r=document.visibilityState==='visible';if(r)requestAnimationFrame(upd);});requestAnimationFrame(upd);}
  
  /* ===== ИНИЦИАЛИЗАЦИЯ ===== */
  function applyTheme(){document.documentElement.setAttribute('data-theme',state.theme);localStorage.setItem('theme',state.theme);setUtterancesTheme(state.theme);setCusdisTheme();const el=document.getElementById('favicon'),c=state.theme==='light'?'%230A1830':'%23FFD54A';el.href=`data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='${c}' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E`;}
  function ensureAdminUI(){document.getElementById('adminBtns').style.display=isAdmin?'inline-flex':'none';if(!isAdmin)adminDockHide();}
  addEventListener('hashchange',()=>{state.route=location.hash.slice(1)||'/';render();restoreScroll();});
  qEl.addEventListener('input',()=>{state.q=qEl.value.trim().toLowerCase();render();});
  document.getElementById('themeBtn').onclick=()=>{state.theme=state.theme==='dark'?'light':(state.theme==='light'?'cringe':'dark');applyTheme();};
  addEventListener('keydown',e=>{if(e.altKey&&e.shiftKey&&e.key.toLowerCase()==='a'){isAdmin=!isAdmin;localStorage.setItem('admin',isAdmin?'1':'0');ensureAdminUI();location.reload();}});

  // Main execution
  loadContent().then(()=>{ 
    applyTheme(); 
    render(); 
    ensureAdminUI(); 
    resize();
    addEventListener('resize',resize);
    if(!prm) requestAnimationFrame(drawStars);
    initSkyLine();
  });
  </script>
</body>
</html>
