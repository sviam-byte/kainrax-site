<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã –∏ —Å—Ç–∞—Ç—å–∏</title>
  <meta name="description" content="–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –ø—è—Ç–Ω–∏—Ü–∞/—Å—É–±–±–æ—Ç–∞. –í–µ—Ç–∫–∏: –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å, –ö–∞–π–Ω—Ä–∞–∫—Å, –ò–ë–£–¢." />
  <meta name="theme-color" content="#0b0f14" />

  <!-- OG/Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="–ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã –∏ —Å—Ç–∞—Ç—å–∏">
  <meta property="og:title" content="–ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã –∏ —Å—Ç–∞—Ç—å–∏">
  <meta property="og:description" content="–¢—ë–º–Ω–∞—è –ù–§ –æ –ø–æ–¥–∑–µ–º–Ω–æ–π —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏, –≥–¥–µ –º–∞–≥–∏—è ‚Äî —ç—Ç–æ —Å–±–æ–π –≤ —Ñ–∏–∑–∏–∫–µ. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –ø—Ç/—Å–±.">
  <meta property="og:image" content="https://kainrax.site/og/kainrax-og.jpg">
  <meta property="og:locale" content="ru_RU">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="–ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã –∏ —Å—Ç–∞—Ç—å–∏">
  <meta name="twitter:description" content="–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –ø—Ç/—Å–±.">
  <meta name="twitter:image" content="https://kainrax.site/og/kainrax-og.jpg">

  <!-- perf hints -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://plausible.io">

  <!-- Favicon -->
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23FFD54A' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E">

  <style>
  :root{
    --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa5b1;
    --card:rgba(16,21,32,.92); --line:#223042;
    --accent:#7dd3fc; --accent2:#a78bfa; --link:#93c5fd;
    --max:1024px; --r:14px; --shadow:0 12px 36px rgba(0,0,0,.45);
    --code:#0a0e16; --mountain:#121723; --star:rgba(255,255,255,.9);
    --surface:#10b981; --kainrax:#7dd3fc; --ibut:#f59e0b; --article:#c084fc;
  }
  [data-theme="light"]{
    --bg:#f7fbff; --fg:#0b0f14; --muted:#5a6774;
    --card:rgba(255,255,255,.97); --line:#e6ecf2;
    --accent:#0ea5e9; --accent2:#7c3aed; --link:#1d4ed8;
    --shadow:0 8px 24px rgba(0,0,0,.08); --code:#f6f8fb; --mountain:#dfe7f3; --star:rgba(10,20,40,.85);
  }
  [data-theme="cringe"]{
    --bg:linear-gradient(135deg,#ffb6f3,#ffd699 50%,#b3f1ff);
    --fg:#111; --muted:#333; --card:rgba(255,255,255,.9); --line:#ffd1f4;
    --accent:#ff3ea5; --accent2:#07f49e; --link:#7c00ff;
    --shadow:0 14px 40px rgba(0,0,0,.25); --code:#fff5ff; --mountain:#ffc6fb; --star:rgba(0,0,0,.75);
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif}
  a{color:var(--link); text-decoration:none; position:relative}
  a:hover{ text-shadow:0 0 .15px currentColor, 0 0 .25px currentColor; }

  h1{margin:6px 0 10px;font-size:28px}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted);font-size:12px}
  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow);overflow:hidden}
  .card::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:soft-light; opacity:.28;
    background-image: radial-gradient(120px 120px at 12% -10%, rgba(125,211,252,.08), transparent 60%);
  }

  .btn,button{border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;box-shadow:var(--shadow)}
  input[type="search"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}

  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,21,32,.92), rgba(15,21,32,.7));backdrop-filter: blur(10px) saturate(1.1);border-bottom:1px solid var(--line);transition:transform .22s ease}
  [data-theme="light"] header{background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.75))}
  [data-theme="cringe"] header{background:linear-gradient(90deg, rgba(255,255,255,.9), rgba(255,255,255,.6))}
  .head{max-width:var(--max);margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand a{color:var(--fg);display:inline-block;transform:translateZ(0)}
  .brand a:hover{ animation:kx-glitch .6s steps(2,end) }
  @keyframes kx-glitch{ 30%{ transform:translate(.4px,-.4px) skewX(.25deg) } 60%{ transform:translate(-.4px,.4px) skewY(.25deg) } }

  .search{flex:1;display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  main{max-width:var(--max);margin:0 auto;padding:20px 16px 80px;position:relative;z-index:1}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:980px){ .grid{grid-template-columns:1.15fr .85fr;gap:22px} }

  .list{display:flex;flex-direction:column;gap:12px}
  .story-item{position:relative;padding:14px 14px 14px 16px;border-radius:12px;background:linear-gradient(180deg, rgba(125,211,252,.08), transparent);border:1px solid rgba(125,211,252,.18)}
  .story-item a{color:var(--fg);text-decoration:none}
  .title{font-weight:700}
  .story-item::before{
    content:""; position:absolute; left:-2px; top:-2px; height:8px; width:40%;
    background:linear-gradient(12deg, var(--kainrax), transparent 60%); border-top-left-radius:12px; transform:skewX(-12deg);
  }
  .story-item[data-arc="surface"]::before{ background:linear-gradient(12deg, var(--surface), transparent 60%) }
  .story-item[data-arc="kainrax"]::before{ background:linear-gradient(12deg, var(--kainrax), transparent 60%) }
  .story-item[data-arc="ibut"]::before{    background:linear-gradient(12deg, var(--ibut),    transparent 60%) }
  .story-item[data-kind="article"]::before{ background:linear-gradient(12deg, var(--article), transparent 60%) }

  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;margin-right:6px}
  .tag:before{content:"‚ú∂";color:var(--muted)}
  [data-theme="light"] .tag:before{content:"#"}
  .back{display:inline-flex;align-items:center;gap:8px;margin:6px 0 12px}

  .progress{position:fixed;left:0;top:0;height:3px;background:linear-gradient(90deg, var(--accent), var(--accent2));width:0;z-index:6}

  .anno{color:var(--muted);font-style:italic;margin-top:6px}
  .anno-box{border:1px dashed var(--line);background:rgba(125,211,252,.06);padding:12px;border-radius:10px;margin:10px 0 14px}
  [data-theme="light"] .anno-box{background:rgba(14,165,233,.08)}
  [data-theme="cringe"] .anno-box{background:rgba(255,62,165,.08)}
  details.anno-dtl summary{cursor:pointer;user-select:none}

  #stars{position:fixed;inset:0;z-index:0;pointer-events:none}
  #ceiling,#mountains{display:none}
  [data-theme="cringe"] #ceiling,[data-theme="cringe"] #mountains{display:block}
  #ceiling{position:fixed;left:0;right:0;top:0;height:18vh;z-index:0;pointer-events:none;opacity:.95}
  #ceiling svg{width:100%;height:100%;display:block;transform:scaleY(-1)}
  #ceiling path{fill:var(--mountain)}
  #mountains{position:fixed;left:0;right:0;bottom:0;height:28vh;z-index:0;pointer-events:none;opacity:.92}
  #mountains svg{width:100%;height:100%;display:block}
  #mountains path{fill:var(--mountain)}

  #sky-line { position: fixed; left: 0; right: 0; height: 3px; z-index: 0; pointer-events: none; opacity: .7; filter: blur(1px);
    background: radial-gradient(ellipse 80% 150% at 50% 50%, var(--accent, #ffab00) 0%, transparent 50%); }
  [data-theme="light"] #sky-line { background: radial-gradient(ellipse 80% 150% at 50% 50%, var(--accent, #0ea5e9) 0%, transparent 40%); opacity: .6; }
  [data-theme="cringe"] #sky-line { height: 4px; background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
    background-size: 200% 200%; animation: cringe-line-anim 3s linear infinite; filter: blur(2px); opacity: .8; }
  @keyframes cringe-line-anim { 0%{background-position:0% 50%} 100%{background-position:200% 50%} }

  .readbox{background:rgba(20,26,38,.98); border:1px solid #2a3a52; border-radius:18px; padding:16px; box-shadow: var(--shadow)}
  [data-theme="light"] .readbox{background:#fff; border-color:#e6ecf2}
  [data-theme="cringe"] .readbox{background:#fff; color:#1a1a1a; border-color:#e9e1d6}

  .parchment{
    position:relative;
    background: radial-gradient(120% 120% at 50% 0%, rgba(255,245,230,.35), transparent 60%), linear-gradient(#f6efe1, #efe6d3);
    color:#2b2418; border:1px solid #e4d7bd; box-shadow: 0 10px 30px rgba(0,0,0,.18); background-blend-mode:multiply;
  }
  .parchment::before{
    content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit; mix-blend-mode:multiply; opacity:.55;
    background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140'><filter id='n'><feTurbulence baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0.1'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 0 .03 .06 .03 0 0 0'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)' fill='rgba(0,0,0,1)'/></svg>");
  }

  .with-margin{display:grid;grid-template-columns:minmax(0,1fr) 220px;gap:18px}
  @media (max-width:980px){ .with-margin{grid-template-columns:1fr} }
  .margin-notes{position:sticky;top:76px;align-self:start}
  .margin-notes .mnote{font-size:13px; color:var(--muted); border-left:2px solid var(--line); padding-left:10px; margin-bottom:12px}
  .mnote .linklike{cursor:pointer; text-decoration:underline}

  /* ===== –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –≥–æ–¥–∞ ===== */
  .yearbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:10px 0 12px}
  .pill.year{cursor:pointer;position:relative;user-select:none}
  .pill.year .badge{ position:absolute; right:-6px; top:-6px; font-size:11px; line-height:1; padding:2px 6px; border-radius:999px; border:1px solid var(--line); background:var(--card); color:var(--muted) }
  .pill[data-active="true"]{ color:var(--fg); border-color:var(--accent); box-shadow:0 0 0 1px rgba(125,211,252,.35) inset, var(--shadow) }

  /* ===== –ö–æ–Ω—Ç–µ–Ω—Ç ===== */
  .prose img{ max-width:100%; height:auto; border-radius:12px; display:block; margin:8px auto }
  figure{ margin:10px 0; }
  figure img{ max-width:100%; display:block }
  figcaption{ font-size:13px; color:var(--muted); text-align:center; margin-top:4px }
  .byline{ color:var(--muted); display:flex; gap:10px; flex-wrap:wrap }
  .byline .dot::before{ content:"‚Ä¢"; margin:0 6px; color:var(--muted) }
  code, pre{ background:var(--code); color:var(--fg); padding:2px 6px; border-radius:6px }
  pre{ padding:10px 12px; overflow:auto }
  blockquote{ border-left:3px solid var(--line); padding-left:12px; color:var(--muted) }

  /* ===== MathJax: —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö ===== */
  html, body { max-width: 100%; overflow-x: hidden; } /* —Ä–µ–º–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ */

  .prose .mjx-container{
    display:block;
    max-inline-size:100%;
    box-sizing:border-box;
    overflow-x:auto;          /* –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å –ø–æ X */
    overflow-y:hidden;
    -webkit-overflow-scrolling:touch;
    margin:12px 0;
  }
  /* –ø–µ—Ä–µ–Ω–æ—Å—ã –≤ \text{...} –∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞—Ö */
  .prose .mjx-container mjx-mtext,
  .prose .mjx-container mjx-mi,
  .prose .mjx-container mjx-mn{
    white-space:normal !important;
    word-break:break-word;
    overflow-wrap:anywhere;
  }

  /* –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è –º—è–≥–∫–æ–≥–æ –∞–≤—Ç–æ—Å–∫–µ–π–ª–∞ –¥–∏—Å–ø–ª–µ–π–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª */
  .kx-math-fit{ width:100%; overflow:hidden; position:relative; }
  .kx-math-fit > .mjx-container{ will-change:transform; transform-origin:left top; }

  /* ===== –°–∫—Ä—ã–≤–∞–µ–º–∞—è —à–∞–ø–∫–∞ (–º–æ–±–∏–ª–∫–∏) ===== */
  .mobile-only { display: none; }
  @media (max-width:980px){
    body.header-collapsed header{ transform: translateY(-100%); }
    .mobile-only { display: inline-flex; }
    .show-header-fab{
      position: fixed;
      right: 12px;
      top: 10px;
      z-index: 6;
      display: none;
      padding: 8px 10px;
    }
    body.header-collapsed .show-header-fab{ display: inline-flex; }
  }

  /* —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –¥—ë—Ä–≥–∞–ª—Å—è –ø–æ —à–∏—Ä–∏–Ω–µ –≤ grid */
  .with-margin > * { min-width: 0; }
  </style>
</head>

<body>
  <!-- noscript –ø–∏–∫—Å–µ–ª—å –¥–ª—è –º–µ—Ç—Ä–∏–∫–∏ -->
  <noscript><div><img src="https://mc.yandex.ru/watch/103716449" style="position:absolute; left:-9999px;" alt=""></div></noscript>

  <div id="sky-line" aria-hidden="true"></div>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div id="ceiling" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L8,18 L18,22 L28,15 L38,20 L48,12 L58,19 L68,13 L78,22 L88,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div id="mountains" aria-hidden="true"><svg viewBox="0 0 100 30" preserveAspectRatio="none"><path d="M0,25 L10,18 L20,22 L30,14 L40,20 L50,10 L60,19 L70,13 L80,22 L90,16 L100,23 L100,30 L0,30 Z"/></svg></div>
  <div class="progress" id="progress"></div>

  <header>
    <div class="head">
      <div class="brand"><a href="#/">–ö–∞–π–Ω—Ä–∞–∫—Å ‚ú∂</a></div>
      <div class="search" style="max-width:860px">
        <span class="pill" title="–ù–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –≤—ã—Ö–æ–¥—è—Ç –≤ —ç—Ç–∏ –¥–Ω–∏">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ø—Ç/—Å–±</span>
        <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–∞—Å—Å–∫–∞–∑–∞–º –∏ —Å—Ç–∞—Ç—å—è–º‚Ä¶" aria-label="–ü–æ–∏—Å–∫" />
        <a class="btn" href="#/arcs">–í–µ—Ç–∫–∏</a>
        <a class="btn" href="#/articles">–°—Ç–∞—Ç—å–∏</a>
        <a class="btn" href="#/perg">–ü–µ—Ä–≥–∞–º–µ–Ω—Ç</a>
        <a class="btn" href="#/notes">–ó–∞–º–µ—Ç–∫–∏</a>
        <a class="btn" href="#/project">–û –ø—Ä–æ–µ–∫—Ç–µ | –ø–ª–∞–Ω—ã</a>
        <a class="btn" href="/o2log/">–õ–æ–≥–∏ O‚ÇÇ</a>
        <a class="btn" href="https://chrishpoderi.netlify.app/" target="_blank" rel="noopener">–í–Ω—É—Ç—Ä–∏–º–∏—Ä–æ–≤–∞—è –¥–æ—Å–∫–∞</a>
        <button id="themeBtn" class="btn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É (T)">üåì</button>
        <button id="hideHeaderBtn" class="btn mobile-only" title="–°–∫—Ä—ã—Ç—å —à–∞–ø–∫—É">‚ñ¥</button>
        <span id="adminBtns" style="display:none">
          <a class="btn" href="/admin/" target="_blank" rel="noopener">–ê–¥–º–∏–Ω–∫–∞</a>
          <a class="btn" id="newStoryBtn"   href="/admin/#/collections/stories/new"   target="_blank" rel="noopener">+ –†–∞—Å—Å–∫–∞–∑</a>
          <a class="btn" id="newArticleBtn" href="/admin/#/collections/articles/new"  target="_blank" rel="noopener">+ –°—Ç–∞—Ç—å—è</a>
          <a class="btn" id="newNoteBtn"    href="/admin/#/collections/notes/new"     target="_blank" rel="noopener">+ –ó–∞–º–µ—Ç–∫–∞</a>
          <a class="btn" id="newPergBtn"    href="/admin/#/collections/pergament/new" target="_blank" rel="noopener">+ –ü–µ—Ä–≥–∞–º–µ–Ω—Ç</a>
        </span>
      </div>
    </div>
  </header>

  <!-- FAB –¥–ª—è –ø–æ–∫–∞–∑–∞ —à–∞–ø–∫–∏ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö -->
  <button id="showHeaderFab" class="btn show-header-fab" title="–ü–æ–∫–∞–∑–∞—Ç—å —à–∞–ø–∫—É" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å —à–∞–ø–∫—É">‚ñæ</button>

  <div id="adminDock"><a class="btn" id="editThisBtn" target="_blank" rel="noopener">‚úèÔ∏è –ü—Ä–∞–≤–∏—Ç—å</a></div>
  <main id="app" aria-live="polite"></main>

  <script>
  /* ===== –ö–æ–Ω—Ñ–∏–≥ ===== */
  const PERG = { CODE: 'Chronicle', CODE_HASH: null };
  const PROD_HOSTS = ['kainrax.netlify.app','kainrax.site'];
  const MEDIA_PROXY = '/api/media';

  const API_INDEX_CANDIDATES = ['/api/content-index','/.netlify/functions/content-index','content/index.json'];
  const API_HIT = '/api/hit'; // UI —Å—á—ë—Ç—á–∏–∫ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º

  // Plausible ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–æ–¥–µ, –ª–µ–Ω–∏–≤–æ
  (function loadPlausibleOnProd(){
    if (PROD_HOSTS.includes(location.hostname)) {
      window.addEventListener('load', () => {
        const loader = () => {
          const s=document.createElement('script'); s.defer=true;
          s.setAttribute('data-domain', location.hostname);
          s.src='https://plausible.io/js/script.js';
          document.head.appendChild(s);
        };
        ('requestIdleCallback' in window) ? requestIdleCallback(loader) : setTimeout(loader, 1200);
      });
    }
  })();

  /* ===== –Ø.–ú–µ—Ç—Ä–∏–∫–∞ ‚Äî –ª–µ–Ω–∏–≤—ã–π —Å—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ ===== */
  function initYM(){
    if (window.__ymInited) return; window.__ymInited = true;
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}; m[i].l=1*new Date();
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a);
    })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js?id=103716449', 'ym');
    try{
      ym(103716449,'init',{webvisor:true,clickmap:true,trackLinks:true,accurateTrackBounce:true,ecommerce:'dataLayer'});
      let last=location.href;
      const hit=()=>{ try{ ym(103716449,'hit',location.href,{referer:last,title:document.title}); last=location.href; }catch(e){} };
      if (document.readyState !== 'loading') hit(); else document.addEventListener('DOMContentLoaded', hit, {once:true});
      addEventListener('hashchange', hit);
    }catch(_){}
  }
  window.addEventListener('load', () => {
    ('requestIdleCallback' in window) ? requestIdleCallback(initYM) : setTimeout(initYM, 1500);
  });

  /* ===== –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ MathJax (+—É—Å—Ç–æ–π—á–∏–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) ===== */
  let mjPending=null;
  function ensureMathJax(){
    if (window.MathJax) return Promise.resolve();
    if (mjPending) return mjPending;
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        tags: 'ams'
      },
      chtml: {
        linebreaks: { automatic: true, width: 'container' },
        scale: 1,
        mtextInheritFont: true,
        matchFontHeight: false
      },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
    mjPending = new Promise(res=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
      s.async=true; s.onload=()=>res(); s.onerror=()=>res();
      document.head.appendChild(s);
    });
    return mjPending;
  }

  // Typeset + –∞–≤—Ç–æ—Å–∫–µ–π–ª –¥–∏—Å–ø–ª–µ–π–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª
  async function typesetMath(scope){
    try{
      if(!scope) return;
      const html = scope.innerHTML || '';
      const hasMath = /\$\$[\s\S]*?\$\$|\\\[|\\\(|(^|[^\\])\$(?=\S)[\s\S]*?\$(?!\w)/.test(html);
      if(!hasMath) return;
      await ensureMathJax();
      if(window.MathJax){
        if (MathJax.typesetClear) MathJax.typesetClear([scope]);
        await MathJax.typesetPromise([scope]);
        KX_refitMath(scope);
      }
    }catch(_){}
  }
  </script>

  <script>
  /* ===== –ú–µ–ª–∫–∏–µ —Ö–µ–ª–ø–µ—Ä—ã ===== */
  const timeout = (ms)=> new Promise(res=> setTimeout(res, ms));
  async function fetchJson(url,{timeoutMs=1500,headers={}}={}){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs); try{ const r=await fetch(url,{signal:ctrl.signal,headers}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); } finally{ clearTimeout(t); } }
  async function fetchText(url,{timeoutMs=4000,cacheMode}={}){ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs); try{ const r=await fetch(url,{signal:ctrl.signal, ...(cacheMode?{cache:cacheMode}:{})}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.text(); } finally{ clearTimeout(t); } }

  const CACHE = {
    get(k){ try{ return JSON.parse(sessionStorage.getItem(k)); }catch(_){ return null; } },
    set(k,v){ try{ sessionStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
  };

  function rewriteMediaUrl(src){
    if(!src) return src;
    if(/^https?:\/\//i.test(src)) return `${MEDIA_PROXY}?url=${encodeURIComponent(src)}`;
    if(/^hub:\//i.test(src) || /^asset:\//i.test(src)) return `${MEDIA_PROXY}?url=${encodeURIComponent(src)}`;
    return src;
  }
  </script>

  <script>
  /* ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===== */
  window.CUSDIS_APP_ID = "079685b7-f335-4fbd-9217-9d857a3cc369";
  const app=document.getElementById('app');
  const qEl=document.getElementById('q');
  const state={ theme: localStorage.getItem('theme') || 'dark', route: location.hash.slice(1)||'/', q:'', year: null };

  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme);
    localStorage.setItem('theme', state.theme);
    setUtterancesTheme(state.theme);
    setCusdisTheme();
    const el=document.getElementById('favicon');
    const color = state.theme==='light' ? '%230A1830' : '%23FFD54A';
    el.href = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='${color}' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E`;
  }
  applyTheme();
  document.getElementById('themeBtn').onclick=()=>{ state.theme = state.theme==='dark' ? 'light' : (state.theme==='light' ? 'cringe' : 'dark'); applyTheme(); };
  document.addEventListener('keyup',(e)=>{ if((e.key||'').toLowerCase()==='t'){ state.theme = state.theme==='dark' ? 'light' : (state.theme==='light' ? 'cringe' : 'dark'); applyTheme(); } });

  /* ===== –°–∫—Ä—ã–≤–∞–µ–º–∞—è —à–∞–ø–∫–∞ (–º–æ–±–∏–ª–∫–∏) ===== */
  const hideHeaderBtn = document.getElementById('hideHeaderBtn');
  const showHeaderFab = document.getElementById('showHeaderFab');
  function setHeaderCollapsed(v){
    document.body.classList.toggle('header-collapsed', !!v);
    try { localStorage.setItem('headerCollapsed', v ? '1' : '0'); } catch(_){}
  }
  if (localStorage.getItem('headerCollapsed') === '1') setHeaderCollapsed(true);
  if (hideHeaderBtn) hideHeaderBtn.onclick = ()=> setHeaderCollapsed(true);
  if (showHeaderFab) showHeaderFab.onclick = ()=> setHeaderCollapsed(false);
  document.addEventListener('keyup',(e)=>{
    if ((e.key||'').toLowerCase()==='h'){
      setHeaderCollapsed(!document.body.classList.contains('header-collapsed'));
    }
  });
    
  <script>
  (function(){
    const headerEl = document.querySelector('header');
    if (!headerEl || !('ontouchstart' in window)) return;
  
    const SWIPE_DIST = 22, SWIPE_TIME = 700, SIDE_DRIFT = 80;
  
    // –°–∫—Ä—ã—Ç—å: —Å–≤–∞–π–ø –≤–≤–µ—Ä—Ö –ø–æ —Å–∞–º–æ–π —à–∞–ø–∫–µ
    let hStartY = 0, hStartX = 0, hStartT = 0, hActive = false;
    function onHeaderStart(e){
      const t = (e.touches && e.touches[0]) || e;
      hStartY = t.clientY; hStartX = t.clientX; hStartT = performance.now(); hActive = true;
    }
    function onHeaderEnd(e){
      if (!hActive) return; hActive = false;
      const t = (e.changedTouches && e.changedTouches[0]) || e;
      const dy = t.clientY - hStartY;
      const dx = t.clientX - hStartX;
      const dt = performance.now() - hStartT;
      if (dt <= SWIPE_TIME && dy < -SWIPE_DIST && Math.abs(dx) <= SIDE_DRIFT) {
        if (!document.body.classList.contains('header-collapsed')) setHeaderCollapsed(true);
      }
    }
    headerEl.addEventListener('touchstart', onHeaderStart, {passive:true});
    headerEl.addEventListener('touchend',   onHeaderEnd,   {passive:true});
  
    // –ü–æ–∫–∞–∑–∞—Ç—å: —Å–≤–∞–π–ø –≤–Ω–∏–∑, –∫–æ–≥–¥–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —É –≤–µ—Ä—Ö–Ω–µ–π –∫—Ä–æ–º–∫–∏
    let gStartY = 0, gStartT = 0;
    function onDocStart(e){ const t = e.touches[0]; gStartY = t.clientY; gStartT = performance.now(); }
    function onDocEnd(e){
      const t = e.changedTouches[0];
      const dy = t.clientY - gStartY;
      const dt = performance.now() - gStartT;
      const nearTop = (window.scrollY || window.pageYOffset || 0) <= 4;
      if (nearTop && dt <= SWIPE_TIME && dy > SWIPE_DIST) {
        if (document.body.classList.contains('header-collapsed')) setHeaderCollapsed(false);
      }
    }
    document.addEventListener('touchstart', onDocStart, {passive:true});
    document.addEventListener('touchend',   onDocEnd,   {passive:true});
  })();
  </script>


  /* ===== Admin mode ===== */
  let isAdmin = new URLSearchParams(location.search).has('admin') || localStorage.getItem('admin')==='1';
  if(new URLSearchParams(location.search).has('admin')){ localStorage.setItem('admin','1'); history.replaceState({},'',location.pathname+location.hash); }
  addEventListener('keydown',e=>{ if(e.altKey&&e.shiftKey&&e.key.toLowerCase()==='a'){ isAdmin=!isAdmin; localStorage.setItem('admin',isAdmin?'1':'0'); ensureAdminUI(); } }, {passive:true});
  function ensureAdminUI(){
    document.getElementById('adminBtns').style.display = isAdmin ? 'inline-flex' : 'none';
    document.querySelectorAll('[data-admin-only]').forEach(el => { el.style.display = isAdmin ? '' : 'none'; });
    if(!isAdmin) adminDockHide();
  }
  </script>

  <script>
  /* ===== Markdown / –∫–æ–Ω—Ç–µ–Ω—Ç ===== */
  const safeYear = (y)=> Number.isInteger(+y) && +y>0 ? +y : null;

  function toDate(val){ if(!val) return null; if(val instanceof Date) return val;
    if(typeof val==='number') return new Date(val);
    if(typeof val==='string'){ const s=val.trim(); if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00Z'); const d=new Date(s); if(!isNaN(d)) return d; }
    return null;
  }
  function ts(val){ const d=toDate(val); return d? d.getTime() : 0; }
  function fmtHumanDate(v){ const d=toDate(v); return d ? d.toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'}) : ''; }
  function fmtHumanDateTime(v){ const d=toDate(v); return d ? d.toLocaleString('ru-RU',{year:'numeric',month:'long',day:'numeric', hour:'2-digit', minute:'2-digit'}) : ''; }
  function fmtPergDayYear(s){ if(typeof s!=='string') return String(s||''); const m=s.match(/^(\d{4})-(\d{3})$/); if(!m) return fmtHumanDate(s); const year=+m[1], day=+m[2]; return `${day}-–π –¥–µ–Ω—å ${year}-–≥–æ –≥–æ–¥–∞.`; }
  const getAnno = (s) => { const a=(s.annotation||s.anno||s.summary||'').trim(); if(a) return a; const txt=(s.text||'').replace(/\s+/g,' ').trim(); if(!txt) return ''; const cut=180; return txt.length>cut? txt.slice(0,cut)+'‚Ä¶' : txt; };

  function normalizeTags(val){
    if (Array.isArray(val)) return val;
    if (typeof val === 'string') {
      const s = val.trim();
      if (!s) return [];
      if (/^\[.*\]$/.test(s)) { try { return JSON.parse(s.replace(/'/g,'"')); } catch(_){} }
      return s.split(',').map(x=>x.trim()).filter(Boolean);
    }
    return [];
  }

  function parseFrontMatter(md){
    const m = md.match(/^---\s*([\s\S]*?)\s*---\s*\n?([\s\S]*)$/);
    if (!m) return { attributes:{}, body: md.trim() };
    const yaml = m[1], body = m[2].trim();
    const attrs = {};
    yaml.split('\n').forEach(line=>{
      const i=line.indexOf(':'); if(i<0) return;
      const k=line.slice(0,i).trim(); let v=line.slice(i+1).trim();
      if (/^\[.*\]$/.test(v)) { try { v = JSON.parse(v.replace(/'/g,'"')); } catch {} }
      attrs[k]=String(v).replace(/^['"]|['"]$/g,'');
    });
    return { attributes: attrs, body };
  }

  function mdToHtml(md) {
    let html = md
      .replace(/```([\s\S]*?)```/g, (m,code)=> `<pre><code>${code.replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</code></pre>`)
      .replace(/^> (.*)$/gim, '<blockquote>$1</blockquote>')
      .replace(/^### (.*)$/gim, '<h3>$1</h3>')
      .replace(/^## (.*)$/gim,  '<h2>$1</h2>')
      .replace(/^# (.*)$/gim,   '<h1>$1</h1>')
      .replace(/^\s*-\s+(.*)$/gim, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)(?!\s*<li>)/gims, '<ul>$1</ul>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/!\[([^\]]*)\]\(([^)\s]+)(?:\s+"([^"]+)")?\)/g, (m,alt,src,cap)=> {
        const finalSrc = rewriteMediaUrl(src);
        const capHtml = cap ? `<figcaption>${cap}</figcaption>` : '';
        return `<figure><img src="${finalSrc}" alt="${alt||''}" loading="lazy" decoding="async" referrerpolicy="no-referrer">${capHtml}</figure>`;
      })
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
      .replace(/^\s*---\s*$/gim,'<hr>');
    html = html.split(/\n{2,}/).map(b => /<(h\d|ul|ol|pre|blockquote|figure|hr)/i.test(b) ? b : `<p>${b.replace(/\n/g,'<br>')}</p>`).join('\n');
    return html;
  }
  </script>

  <script>
  /* ===== –î–∞–Ω–Ω—ã–µ ===== */
  let stories=[], notes=[], pergDocs=[], articles=[];

  async function firstJson(urls,{timeouts=[8000,8000,5000]}={}) {
    for (let i=0;i<urls.length;i++){
      const url=urls[i];
      try{
        const j=await fetchJson(url,{timeoutMs:timeouts[i] ?? 6000, headers:{'Accept':'application/json'}});
        if (j && (Array.isArray(j.stories) || Array.isArray(j.notes) || Array.isArray(j.articles))) return j;
        if (Array.isArray(j)) return { stories:[], notes:[], articles:j };
      }catch(e){}
    }
    return null;
  }

  async function loadContent(){
    let j = CACHE.get('__contentIndex');
    if (!j) j = await firstJson(API_INDEX_CANDIDATES);
    if (!j) j = { stories:[], notes:[], articles:[] };
    else CACHE.set('__contentIndex', j);

    if (!Array.isArray(j.articles) || !j.articles.length) {
      try {
        const aj = await fetchJson('content/articles/index.json',{timeoutMs:6000, headers:{'Accept':'application/json'}});
        j.articles = Array.isArray(aj) ? aj : (aj.articles||[]);
      } catch(_) {}
    }

    try{ pergDocs = await fetchJson('content/pergament/index.json',{timeoutMs:5000, headers:{'Accept':'application/json'}}); }
    catch{ pergDocs = []; }

    const tie = (a,b)=> String((a.slug||a.id||'') ).localeCompare(String(b.slug||b.id||''), 'ru');

    stories  = (Array.isArray(j.stories)?j.stories:[]).map(s=>({
      ...s,
      id:   s.id   || s.slug || '',
      slug: s.slug || s.id   || '',
      year: safeYear(s.year ?? s.worldYear),
      file: s.file || (s.slug||s.id ? `content/stories/${(s.slug||s.id)}.md` : undefined),
      tags: Array.isArray(s.tags) ? s.tags : (typeof s.tags==='string' ? s.tags.split(',').map(x=>x.trim()).filter(Boolean) : [])
    }));
    notes    = (Array.isArray(j.notes)?j.notes:[]).map(n=>({
      ...n,
      id:   n.id   || n.slug || '',
      slug: n.slug || n.id   || '',
      file: n.file || (n.slug||n.id ? `content/notes/${(n.slug||n.id)}.md` : undefined),
      tags: Array.isArray(n.tags) ? n.tags : (typeof n.tags==='string' ? n.tags.split(',').map(x=>x.trim()).filter(Boolean) : [])
    }));
    articles = (Array.isArray(j.articles)?j.articles:[]).map(a=>({
      ...a,
      id:   a.id   || a.slug || '',
      slug: a.slug || a.id   || '',
      year: safeYear(a.year),
      file: a.file || (a.slug||a.id ? `content/articles/${(a.slug||a.id)}.md` : undefined),
      tags: Array.isArray(a.tags) ? a.tags : (typeof a.tags==='string' ? a.tags.split(',').map(x=>x.trim()).filter(Boolean) : [])
    }));

    const ts2 = (v)=> { const d = (v?new Date(v):null); return d && !isNaN(+d) ? +d : 0; };
    stories.sort ((a,b)=> ts2(b.date)-ts2(a.date) || tie(a,b));
    notes.sort   ((a,b)=> ts2(b.date)-ts2(a.date) || tie(a,b));
    articles.sort((a,b)=> ts2(b.date)-ts2(a.date) || tie(a,b));

    pergDocs.forEach(d=>{ (d.editions||[]).sort((a,b)=> String(a.date||'').localeCompare(String(b.date||''))); });
    pergDocs.sort((a,b)=> {
      const ad=(a.editions||[]), bd=(b.editions||[]); const al=ad[ad.length-1]?.date||'', bl=bd[bd.length-1]?.date||'';
      return String(bl).localeCompare(String(al));
    });

    (async ()=> {
      try{
        const fresh = await firstJson(API_INDEX_CANDIDATES);
        if (fresh) { CACHE.set('__contentIndex', fresh); }
      }catch(_){}
    })();
  }
  </script>

  <script>
  /* ===== –†–æ—É—Ç–µ—Ä –∏ —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–æ–≤ ===== */
  addEventListener('hashchange',()=>{ state.route=location.hash.slice(1)||'/'; render(); restoreScroll(); }, {passive:true});
  qEl.addEventListener('input',()=>{ state.q=qEl.value.trim().toLowerCase(); renderList(); });

  const arcMeta = {
    surface: {id:'surface', title:'–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å', desc:'–†–∞—Å—Å–∫–∞–∑—ã –∏ –ø–æ–≤–µ—Å—Ç–∏ –Ω–µ –æ –ö–∞–π–Ω—Ä–∞–∫—Å.'},
    kainrax: {id:'kainrax',  title:'–ö–∞–π–Ω—Ä–∞–∫—Å',    desc:'–†–∞—Å—Å–∫–∞–∑—ã –∏ –ø–æ–≤–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–∏ –ö–∞–π–Ω—Ä–∞–∫—Å.'},
    ibut:    {id:'ibut',     title:'–ò–ë–£–¢',        desc:'–õ—ë–≥–∫–æ–µ —á—Ç–∏–≤–æ –ø—Ä–æ –ø–æ–ø–∞–¥–∞–Ω—Ü–µ–≤.'},
  };

  function buildArcs(){
    const map = {};
    for(const s of stories){
      const id=s.arc||'kainrax';
      if(!map[id]) map[id]={...(arcMeta[id]||{id,title:id,desc:''}), items:[]};
      map[id].items.push(s);
    }
    for(const k in map){
      map[k].items.sort((a,b)=> ts(a.date)-ts(b.date) || String((a.slug||a.id)).localeCompare(String((b.slug||b.id))) );
    }
    return Object.values(map);
  }

  function findStoryByKey(key){
    if(!key) return null;
    let s = stories.find(x=> (x.id||'') === key);
    if(s) return s;
    const bySlug = stories.filter(x=> (x.slug||'') === key);
    bySlug.sort((a,b)=> ts(b.date)-ts(a.date) || String(a.id).localeCompare(String(b.id)));
    return bySlug[0] || null;
  }
  function findArticleByKey(key){
    if(!key) return null;
    let a = articles.find(x=> (x.id||'') === key);
    if(a) return a;
    const bySlug = articles.filter(x=> (x.slug||'') === key);
    bySlug.sort((a,b)=> ts(b.date)-ts(a.date) || String(a.id).localeCompare(String(b.id)));
    return bySlug[0] || null;
  }

  function parseHashQuery(){ const h = location.hash.split('?')[1]||''; const out={}; h.split('&').forEach(p=>{ if(!p) return; const [k,v]=p.split('='); out[decodeURIComponent(k)] = decodeURIComponent(v||''); }); return out; }
  function currentYearSelection(){ const hq = parseHashQuery(); const ySel = Number.isFinite(+hq.year) ? (+hq.year) : null; state.year = ySel; return ySel; }

  function collectYearCounts(list,{excludeArc}={}) {
    return list.reduce((acc, it)=>{
      if (excludeArc && it.arc === excludeArc) return acc;
      const y = safeYear(it.year);
      if (y != null) acc[y] = (acc[y]||0)+1;
      return acc;
    }, {});
  }
  function yearBarHtml(years, counts, ySel){
    return `
      <div class="yearbar" id="yearbar">
        <span class="muted">–ì–æ–¥:</span>
        <span class="pill year" data-year="" data-active="${ySel==null}">–í—Å–µ</span>
        ${years.map(y=>`
          <span class="pill year" data-year="${y}" data-active="${ySel===y}">
            ${y}<span class="badge">${counts[y]}</span>
          </span>`).join('')}
      </div>`;
  }

  function renderList(){
    const q = state.q;
    const ySel = currentYearSelection();

    const baseStories = stories.filter(s=>{
      if (!q) return true;
      const hay=[s.title||'', (s.text||''), (s.tags||[]).join(' ')].join(' ').toLowerCase();
      return hay.includes(q);
    });
    const baseArticles = articles.filter(a=>{
      if (!q) return true;
      const hay=[a.title||'', a.author||'', a.outlet||'', (a.text||''), (a.tags||[]).join(' ')].join(' ').toLowerCase();
      return hay.includes(q);
    });

    const unionForYears = baseStories.concat(baseArticles);
    const counts = collectYearCounts(unionForYears, {excludeArc:'ibut'});
    const years  = Object.keys(counts).map(Number).sort((a,b)=>a-b);

    const itemsStories = baseStories.filter(s=> ySel==null ? true : safeYear(s.year)===ySel);
    const itemsArticles = baseArticles.filter(a=> ySel==null ? true : safeYear(a.year)===ySel);

    const yearBar = yearBarHtml(years, counts, ySel);

    app.innerHTML=`
      <div class="grid">
        <section class="card">
          <h1>–†–∞—Å—Å–∫–∞–∑—ã</h1>
          <div class="muted">–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –í—ã—Ö–æ–¥—ã: –ø—è—Ç–Ω–∏—Ü–∞/—Å—É–±–±–æ—Ç–∞.</div>
          ${yearBar}
          <div class="list">
            ${itemsStories.length?itemsStories.map(s=>`
              <div class="story-item" data-arc="${s.arc||'kainrax'}">
                <a href="#/read-id/${s.id}">
                  <div class="title">‚ú∂ ${s.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                  <div class="muted">
                    ${fmtHumanDate(s.date)}
                    ¬∑ ${s.minutes||Math.max(5,Math.round((s.text||'').length/1100))} –º–∏–Ω —á—Ç–µ–Ω–∏—è
                    ¬∑ –≤–µ—Ç–∫–∞: ${(arcMeta[s.arc||'kainrax']||{title:'–í–µ—Ç–∫–∞'}).title}
                    ${(s.arc!=='ibut' && safeYear(s.year)!=null)?` ¬∑ –≥–æ–¥: ${safeYear(s.year)}`:''}
                  </div>
                </a>
                ${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}
              </div>`).join(''):'<div class="muted" style="margin-top:10px">–ü—É—Å—Ç–æ.</div>'}
          </div>

          <h1 style="margin-top:22px">–°—Ç–∞—Ç—å–∏</h1>
          <div class="muted">–ú–∏–Ω–∏-–∞—Ä—Ö–∏–≤ —Å—Ç–∞—Ç–µ–π. –§–æ—Ä–º—É–ª—ã, –∫–∞—Ä—Ç–∏–Ω–∫–∏, —Å—Å—ã–ª–∫–∏, –ø–æ–¥–ø–∏—Å–∏.</div>
          <div class="list" style="margin-top:10px">
            ${itemsArticles.length?itemsArticles.map(a=>`
              <div class="story-item" data-kind="article">
                <a href="#/read-article/${a.id}">
                  <div class="title">üì∞ ${a.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                  <div class="muted">
                    ${fmtHumanDateTime(a.date)}
                    ${safeYear(a.year)!=null?` ¬∑ –≥–æ–¥: ${safeYear(a.year)}`:''}
                    ${a.outlet?` ¬∑ ${a.outlet}`:''}
                    ${a.author?` ¬∑ ${a.author}`:''}
                    ¬∑ ${a.minutes||Math.max(6,Math.round((a.text||'').length/1000))} –º–∏–Ω
                  </div>
                </a>
                ${getAnno(a)?`<div class="anno">${getAnno(a)}</div>`:''}
              </div>`).join(''):'<div class="muted" style="margin-top:10px">–ü–æ–∫–∞ —Å—Ç–∞—Ç–µ–π –Ω–µ—Ç.</div>'}
          </div>
        </section>

        <aside class="card">
          <h2>–í–µ—Ç–∫–∏</h2>
          <div class="list">
            ${buildArcs().map(a=>`
              <div class="story-item" data-arc="${a.id}">
                <a href="#/arc/${a.id}">
                  <div class="title">‚ú∂ ${a.title}</div>
                  <div class="muted">${a.items.length} —Ç–µ–∫—Å—Ç(–∞)</div>
                  <div>${a.desc||''}</div>
                </a>
              </div>`).join('')}
          </div>
          <h3 style="margin-top:14px">–ü–æ–¥–ø–∏—Å–∫–∞</h3>
          <p class="muted">–¢–µ–ª–µ–≥—Ä–∞–º: <a href="https://t.me/kainrax" target="_blank" rel="noopener">@kainrax</a></p>
        </aside>
      </div>`;

    const ybar = document.getElementById('yearbar');
    if (ybar){
      ybar.addEventListener('click', (e)=>{
        const pill = e.target.closest('.pill.year'); if(!pill) return;
        const v = pill.dataset.year || '';
        const newHash = v ? `#/?year=${encodeURIComponent(v)}` : '#/';
        if (location.hash !== newHash) location.hash = newHash; else renderList();
      });
    }

    adminDockHide(); ensureAdminUI();

    const needS = itemsStories.filter(s=>!s.title || !s.date).slice(0,8);
    if(needS.length){ Promise.all(needS.map(s=>loadMdIntoStory(s,isAdmin))).then(()=>{ renderList(); }); }
    const needA = itemsArticles.filter(a=>!a.title || !a.date).slice(0,8);
    if(needA.length){ Promise.all(needA.map(a=>loadMdIntoArticle(a,isAdmin))).then(()=>{ renderList(); }); }
  }
  </script>

  <script>
  /* ===== –í–µ—Ç–∫–∏/—Ç–µ–≥–∏/—Å—Ç—Ä–∞–Ω–∏—Ü—ã ===== */
  function renderArcs(){ const arcs=buildArcs(); app.innerHTML=`<section class="card"><h1>–í–µ—Ç–∫–∏</h1>
    <div class="list">${arcs.map(a=>`
      <div class="story-item" data-arc="${a.id}"><a href="#/arc/${a.id}">
        <div class="title">‚ú∂ ${a.title}</div>
        <div class="muted">${a.items.length} —Ç–µ–∫—Å—Ç(–∞)</div>
        <div>${a.desc||''}</div>
      </a></div>`).join('')}</div></section>`; adminDockHide(); ensureAdminUI(); }

  function renderArc(id){
    const arcs=buildArcs();
    const a=arcs.find(x=>x.id===id)||{id,title:'–í–µ—Ç–∫–∞',items:[],desc:''};
    app.innerHTML=`<section class="card">
      <a class="back" href="#/arcs">‚Üê –ö–æ –≤—Å–µ–º –≤–µ—Ç–∫–∞–º</a>
      <h1>${a.title}</h1><div class="muted">${a.desc||''}</div>
      <ol class="list" style="margin-top:10px">${a.items.map((s,i)=>`
        <li class="story-item" data-arc="${s.arc||'kainrax'}">
          <a href="#/read-id/${s.id}">
            <div class="title">‚ú∂ ${i+1}. ${s.title}</div>
            <div class="muted">${fmtHumanDate(s.date)} ¬∑ ${s.minutes||Math.max(5,Math.round((s.text||'').length/1100))} –º–∏–Ω</div>
          </a>
          ${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}
        </li>`).join('')}
      </ol></section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderTag(tag){
    const st=stories.filter(s=> (s.tags||[]).map(t=>t.toLowerCase()).includes(tag.toLowerCase()));
    const ar=articles.filter(a=> (a.tags||[]).map(t=>t.toLowerCase()).includes(tag.toLowerCase()));
    app.innerHTML=`<section class="card">
      <a class="back" href="#/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      <h1>#${tag}</h1>

      <h3>–í —Ä–∞—Å—Å–∫–∞–∑–∞—Ö</h3>
      <div class="list">${st.length?st.map(s=>`
        <div class="story-item" data-arc="${s.arc||'kainrax'}"><a href="#/read-id/${s.id}">
          <div class="title">‚ú∂ ${s.title}</div>
          <div class="muted">${fmtHumanDate(s.date)} ¬∑ ${s.minutes||Math.max(5,Math.round((s.text||'').length/1100))} –º–∏–Ω ¬∑ –≤–µ—Ç–∫–∞: ${(arcMeta[s.arc||'kainrax']||{title:'–í–µ—Ç–∫–∞'}).title}</div>
        </a>${getAnno(s)?`<div class="anno">${getAnno(s)}</div>`:''}</div>`).join(''):`<div class="muted">‚Äî</div>`}</div>

      <h3 style="margin-top:14px">–í —Å—Ç–∞—Ç—å—è—Ö</h3>
      <div class="list">${ar.length?ar.map(a=>`
        <div class="story-item" data-kind="article"><a href="#/read-article/${a.id}">
          <div class="title">üì∞ ${a.title}</div>
          <div class="muted">${fmtHumanDateTime(a.date)} ${a.outlet?` ¬∑ ${a.outlet}`:''} ${a.author?` ¬∑ ${a.author}`:''}</div>
        </a>${getAnno(a)?`<div class="anno">${getAnno(a)}</div>`:''}</div>`).join(''):`<div class="muted">‚Äî</div>`}</div>
    </section>`;
    adminDockHide(); ensureAdminUI();
  }
  </script>

  <script>
  /* ===== –°—Ç–∞—Ç—å–∏ ===== */
  async function loadMdIntoStory(s, isAdmin){
    if (!s) return s;
    let file = s.file;
    if(!file){
      const name=(s.slug||s.id||'').trim();
      if(name) file = `content/stories/${name}.md`;
    }
    if(!file || s.text) return s;
    try{
      const raw = await fetchText(file,{ timeoutMs: 6000, cacheMode: isAdmin?'no-store':undefined });
      const { attributes, body } = parseFrontMatter(raw);
      s.file       = file;
      s.title      = s.title      || attributes.title || s.id;
      s.date       = s.date       || attributes.date  || '';
      s.minutes    = s.minutes    || Number(attributes.minutes)|| Math.max(5, Math.round((body||'').length/1100));
      s.arc        = s.arc        || attributes.arc   || 'kainrax';
      s.tags       = s.tags       || normalizeTags(attributes.tags);
      s.annotation = s.annotation || attributes.annotation || '';
      const yRaw   = (attributes.year ?? attributes.worldYear ?? attributes.pergYear);
      s.year       = s.year ?? safeYear(yRaw);
      s.text       = body || '';
    }catch(e){}
    return s;
  }

  async function loadMdIntoNote(n, isAdmin){
    if (!n) return n;
    let file = n.file;
    if(!file){
      const name=(n.slug||n.id||'').trim();
      if(name) file = `content/notes/${name}.md`;
    }
    if(!file || n.text) return n;
    try{
      const raw = await fetchText(file,{ timeoutMs: 6000, cacheMode: isAdmin?'no-store':undefined });
      const { attributes, body } = parseFrontMatter(raw);
      n.file       = file;
      n.title      = n.title || attributes.title || n.id;
      n.date       = n.date  || attributes.date  || '';
      n.tags       = n.tags  || normalizeTags(attributes.tags);
      n.annotation = n.annotation || attributes.annotation || '';
      n.text       = body || '';
    }catch(e){}
    return n;
  }

  async function loadMdIntoArticle(a, isAdmin){
    if (!a) return a;
    let file = a.file;
    if(!file){
      const name=(a.slug||a.id||'').trim();
      if(name) file = `content/articles/${name}.md`;
    }
    if(!file || a.text) return a;
    try{
      const raw = await fetchText(file,{ timeoutMs: 7000, cacheMode: isAdmin?'no-store':undefined });
      const { attributes, body } = parseFrontMatter(raw);
      a.file       = file;
      a.title      = a.title      || attributes.title || a.id;
      a.date       = a.date       || attributes.date  || '';
      a.minutes    = a.minutes    || Number(attributes.minutes)|| Math.max(6, Math.round((body||'').length/1000));
      a.tags       = a.tags       || normalizeTags(attributes.tags);
      a.annotation = a.annotation || attributes.annotation || '';
      a.year       = a.year ?? safeYear(attributes.year);
      a.author     = a.author     || attributes.author || '';
      a.outlet     = a.outlet     || attributes.outlet || attributes.journal || '';
      a.cover      = a.cover      || attributes.cover  || '';
      a.text       = body || '';
    }catch(e){}
    return a;
  }

  function renderArticlesList(){
    const q = state.q;
    const ySel = currentYearSelection();
    const base = articles.filter(a=>{
      if (!q) return true;
      const hay=[a.title||'', a.author||'', a.outlet||'', (a.text||''), (a.tags||[]).join(' ')].join(' ').toLowerCase();
      return hay.includes(q);
    });
    const counts = collectYearCounts(base);
    const years  = Object.keys(counts).map(Number).sort((a,b)=>a-b);
    const items = base.filter(a=> ySel==null ? true : safeYear(a.year)===ySel);
    const yearBar = yearBarHtml(years, counts, ySel);

    app.innerHTML = `
      <section class="card">
        <a class="back" href="#/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <h1>–°—Ç–∞—Ç—å–∏</h1>
        <div class="muted">–ê—Ä—Ö–∏–≤: —Ñ–æ—Ä–º—É–ª—ã, –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –ø–æ–¥–ø–∏—Å–∏.</div>
        ${yearBar}
        <div class="list" style="margin-top:8px">
          ${
            items.length
              ? items.map(a => `
                <div class="story-item" data-kind="article">
                  <a href="#/read-article/${a.id}">
                    <div class="title">üì∞ ${a.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                    <div class="muted">
                      ${fmtHumanDateTime(a.date)}
                      ${safeYear(a.year)!=null?` ¬∑ –≥–æ–¥: ${safeYear(a.year)}`:''}
                      ${a.outlet?` ¬∑ ${a.outlet}`:''}
                      ${a.author?` ¬∑ ${a.author}`:''}
                      ¬∑ ${a.minutes||Math.max(6,Math.round((a.text||'').length/1000))} –º–∏–Ω
                    </div>
                  </a>
                  ${getAnno(a)?`<div class="anno">${getAnno(a)}</div>`:''}
                </div>`).join('')
              : '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –°–º–æ—Ç—Ä–∏ <code>content/articles</code>.</div>'
          }
        </div>
      </section>`;
    const ybar = document.getElementById('yearbar');
    if (ybar){
      ybar.addEventListener('click', (e)=>{
        const pill = e.target.closest('.pill.year'); if(!pill) return;
        const v = pill.dataset.year || '';
        const newHash = v ? `#/articles?year=${encodeURIComponent(v)}` : '#/articles';
        if (location.hash !== newHash) location.hash = newHash; else renderArticlesList();
      });
    }
    adminDockHide(); ensureAdminUI();
  }

  async function renderArticleRead(id){
    const a=findArticleByKey(id); if(!a){ location.hash='#/articles'; return; }
    try{ await loadMdIntoArticle(a, isAdmin); }catch(e){}

    app.innerHTML = `
      <a class="back" href="#/articles">‚Üê –ö —Å—Ç–∞—Ç—å—è–º</a>
      <article class="with-margin" data-id="${a.id}" data-slug="${a.slug||a.id}">
        <div class="prose readbox">
          ${a.cover?`<img src="${rewriteMediaUrl(a.cover)}" alt="cover" loading="lazy" decoding="async" referrerpolicy="no-referrer" style="margin-bottom:10px">`:''}
          <h1>${a.title}</h1>
          <div class="byline">
            ${a.outlet?`<span>${a.outlet}</span>`:''}
            ${a.author?`<span class="dot">${a.author}</span>`:''}
            ${a.date?`<span class="dot">${fmtHumanDateTime(a.date)}</span>`:''}
            <span class="dot">${a.minutes||Math.max(6,Math.round((a.text||'').length/1000))} –º–∏–Ω</span>
          </div>
          <div style="margin:6px 0 12px">${(a.tags||[]).map(t=>`<a class='tag' href='#/tag/${encodeURIComponent(t)}'>${t}</a>`).join(' ')}</div>
          ${a.annotation?`<div class="anno-box"><strong>–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è:</strong> ${a.annotation}</div>`:''}
          <div class="article-body">${mdToHtml(a.text||'')}</div>
        </div>
        <aside class="margin-notes"></aside>
      </article>
      <section class="card" style="margin-top:16px">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section>
      </section>`;

    await typesetMath(document.querySelector('.article-body'));
    KX_refitMath(document);
    mountComments('article:'+(a.slug||a.id));
    setTimeout(restoreScroll,0);
    adminDockFor('article', a.slug||a.id);
    ensureAdminUI();
    window.hit && window.hit('article:'+(a.slug||a.id)).catch(()=>{});
  }
  </script>

  <script>
  /* ===== –ò—Å—Ç–æ—Ä–∏–∏, –∑–∞–º–µ—Ç–∫–∏, –ø–µ—Ä–≥–∞–º–µ–Ω—Ç ===== */
  function lastEdition(d){ const es=d.editions||[]; return es[es.length-1]||null; }
  function renderPergList(){
    const items = pergDocs;
    app.innerHTML = `<section class="card"><h1>–ü–µ—Ä–≥–∞–º–µ–Ω—Ç</h1>
      <div class="list">${items.map(d=>{
        const e=lastEdition(d)||{};
        return `<div class="story-item" data-arc="kainrax">
          <a href="#/perg/${encodeURIComponent(d.id)}">
            <div class="title">üìú ${d.title}</div>
            <div class="muted">–ø–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–¥.: ${fmtPergDayYear(e.date||d.date||'')}</div>
          </a>
          ${getAnno(d)?`<div class="anno">${getAnno(d)}</div>`:''}
        </div>`; }).join('')}</div></section>`;
    adminDockHide(); ensureAdminUI();
  }

  async function renderPerg(rawId){
    const id = (rawId||'').split('?')[0];
    const d = (pergDocs||[]).find(x=>x.id===id || x.slug===id);
    if(!d){ location.hash = '#/perg'; return; }
    const editions = (d.editions||[]);
    if(!editions.length){ app.innerHTML = `<a class="back" href="#/perg">‚Üê –ö ¬´–ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É¬ª</a><section class="card">–ù–µ—Ç —Ä–µ–¥–∞–∫—Ü–∏–π.</section>`; return; }
    const q = parseHashQuery();
    const chosenId = q.e || editions[editions.length-1].id;
    let e = editions.find(x=>x.id===chosenId) || editions[editions.length-1];
    const lastEd = editions[editions.length-1];
    const isLast = (e===lastEd);

    async function sha256Hex(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest('SHA-256', enc); const arr=Array.from(new Uint8Array(buf)); return arr.map(b=>b.toString(16).padStart(2,'0')).join(''); }
    async function checkPergCode(input, ed){
      const pass=(input||'').trim(); if(!pass) return false;
      if(ed && ed.codeHash){ const [alg, hex]=String(ed.codeHash).split(':'); if((alg||'sha256').toLowerCase()==='sha256'){ const got=await sha256Hex(pass); return got.toLowerCase()===String(hex||'').toLowerCase(); } }
      if(ed && ed.code){ return pass===String(ed.code).trim(); }
      if(PERG.CODE_HASH){ const [alg, hex]=String(PERG.CODE_HASH).split(':'); if((alg||'sha256').toLowerCase()==='sha256'){ const got=await sha256Hex(pass); return got.toLowerCase()===String(hex||'').toLowerCase(); } }
      if(PERG.CODE){ return pass===String(PERG.CODE).trim(); }
      return false;
    }
    function showAccessModal(cfg, verify){
      return new Promise(resolve=>{
        const wrap=document.createElement('div'); wrap.className='modal';
        wrap.innerHTML=`<div class="box">
          <div style="display:flex; gap:12px; align-items:center">
            <div class="seal" aria-hidden="true"></div>
            <div>
              <h3 style="margin:0 0 6px">${(cfg&&cfg.message)||'–í–∞—à –¥–æ—Å—Ç—É–ø?'}</h3>
              <div class="muted" style="margin-bottom:10px">${cfg&&cfg.codeHint?('–ü–æ–¥—Å–∫–∞–∑–∫–∞: '+cfg.codeHint):'–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞.'}</div>
            </div>
          </div>
          <div style="display:flex; gap:8px; margin-top:12px">
            <input id="codeIn" type="password" placeholder="–∫–æ–¥" style="flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)"/>
            <button class="btn" id="okBtn">–û–ö</button>
            <button class="btn" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
          </div>
          <div class="muted" id="err" style="margin-top:8px;display:none">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div>
        </div>`;
        document.body.appendChild(wrap);
        const codeIn=wrap.querySelector('#codeIn');
        const ok=wrap.querySelector('#okBtn');
        const cancel=wrap.querySelector('#cancelBtn');
        const err=wrap.querySelector('#err');
        function close(val){ document.body.removeChild(wrap); resolve(val); }
        cancel.onclick=()=> close(false);
        ok.onclick=async()=>{ const pass = await verify(codeIn.value||''); if(pass){ close(true); } else { err.style.display='block'; codeIn.select(); } };
        codeIn.onkeydown=(e)=>{ if(e.key==='Enter') ok.click(); };
        setTimeout(()=>codeIn.focus(),0);
      });
    }
    async function ensureAccessForNonLast(ed){
      if(isLast) return true;
      const key = 'perg:'+d.id+':'+ed.id+':ok';
      if(localStorage.getItem(key)==='1') return true;
      const ok = await showAccessModal(
        { message:'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–æ—Å—Ç—É–ø', codeHint: ed.codeHint || (ed.access&&ed.access.hint) || '—Ö—Ä–æ–Ω–∏–∫—ë—Ä –∏ –≥–æ–¥' },
        (input)=> checkPergCode(input, ed)
      );
      if(ok){ localStorage.setItem(key,'1'); return true; }
      return false;
    }
    const canOpen = await ensureAccessForNonLast(e);
    if(!canOpen){ location.hash = '#/perg'; return; }

    let body = '';
    try{ body = await fetchText(e.file, { timeoutMs: 4000, cacheMode: isAdmin?'no-store':undefined }); }
    catch(_){ body = '(–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç)'; }

    const options = editions.map(x=>`<option value="${x.id}" ${x.id===e.id?'selected':''}>${x.title||x.id} ¬∑ ${fmtPergDayYear(x.date||'')}</option>`).join('');
    const idx = editions.findIndex(x=>x.id===e.id);
    const frac = (idx+1)/editions.length*100;
    const lastLabel = fmtPergDayYear(lastEd.date||'');
    const currLabel = fmtPergDayYear(e.date||'');

    let prevBlock = '';
    let prevObj = null;
    if (isLast && editions.length > 1){
      prevObj = editions[editions.length-2];
      prevBlock = `<div class="anno-box" id="prevBox" style="margin-top:10px;cursor:pointer">
        <strong>–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è:</strong> ${fmtPergDayYear(prevObj.date||'')} ‚Äî <u>–¥–æ—Å—Ç—É–ø –ø–æ –∫–æ–¥—É</u>
      </div>`;
    }

    app.innerHTML = `
      <a class="back" href="#/perg">‚Üê –ö ¬´–ü–µ—Ä–≥–∞–º–µ–Ω—Ç—É¬ª</a>
      <article class="with-margin" data-id="${d.id}">
        <div class="prose parchment readbox">
          <h1>üìú ${d.title}</h1>
          <div class="muted">–†–µ–¥–∞–∫—Ü–∏–∏:
            <select id="edSel" class="btn" style="padding:6px 10px">${options}</select>
          </div>
          <div class="edhint">${currLabel} ‚Üí –ø–æ—Å–ª–µ–¥–Ω—è—è: ${lastLabel}</div>
          <div class="edbar"><div class="fill" id="edProgress" style="width:${frac.toFixed(1)}%"></div></div>
          ${d.annotation?`<div class="anno">${d.annotation}</div>`:''}
          ${prevBlock}
          <div class="scroll-body">${(body||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}</div>
        </div>
        <aside class="margin-notes">
          ${(Array.isArray(d.margin)?d.margin:[]).map(m=>`<div class="mnote">${m}</div>`).join('')}
          ${!isLast ? `<div class="mnote">–≠—Ç–∞ –≤–µ—Ä—Å–∏—è –∑–∞—â–∏—â–µ–Ω–∞: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.</div>`:''}
          ${isLast && prevObj ? `<div class="mnote"><span class="linklike" id="mPrevLink">–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è: ${fmtPergDayYear(prevObj.date||'')} (–∫–ª–∏–∫ ‚Äî –≤–≤–µ—Å—Ç–∏ –∫–æ–¥)</span></div>`:''}
        </aside>
      </article>
      <section class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></section>`;

    const sel=document.getElementById('edSel');
    const edProgress=document.getElementById('edProgress');
    const edHint=document.querySelector('.edhint');
    function updateEdUI(nv){
      const ix = editions.findIndex(x=>x.id===nv);
      const e2 = editions[ix];
      const f = (ix+1)/editions.length*100;
      if(edProgress) edProgress.style.width = f.toFixed(1)+'%';
      if(edHint) edHint.textContent = `${fmtPergDayYear(e2.date||'')} ‚Üí –ø–æ—Å–ª–µ–¥–Ω—è—è: ${lastLabel}`;
    }
    if(sel){ sel.onchange=()=>{ const nv=sel.value; updateEdUI(nv); const base = '#/perg/'+encodeURIComponent(d.id); location.hash = base + '?e='+encodeURIComponent(nv); }; }

    const prevBox=document.getElementById('prevBox');
    const mPrevLink=document.getElementById('mPrevLink');
    async function openPrev(){
      if(!prevObj) return;
      const ok = await showAccessModal(
        { message:'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ä–µ–¥–∞–∫—Ü–∏–∏', codeHint: prevObj.codeHint || (prevObj.access&&prevObj.access.hint) || '—Ö—Ä–æ–Ω–∏–∫—ë—Ä –∏ –≥–æ–¥' },
        (input)=> checkPergCode(input, prevObj)
      );
      if(ok){
        const base = '#/perg/'+encodeURIComponent(d.id);
        location.hash = base + '?e='+encodeURIComponent(prevObj.id);
      }
    }
    if(prevBox) prevBox.addEventListener('click', openPrev);
    if(mPrevLink) mPrevLink.addEventListener('click', openPrev);

    mountComments('perg:'+(d.slug||d.id)+':'+(e.id||''));
    setTimeout(restoreScroll,0);
    adminDockFor('perg', d.slug||d.id);
    ensureAdminUI();
    window.hit && window.hit('perg:'+(d.slug||d.id)+':'+(e.id||'')).catch(()=>{});
  }
  </script>

  <script>
  /* ===== –ö–æ–º–º–µ–Ω—Ç—ã / —Å–ª—É–∂–µ–±–∫–∏ / –ø—Ä–æ–≥—Ä–µ—Å—Å ===== */
  function mountComments(term){
    const wrap=document.getElementById('comments'); if(!wrap) return;
    wrap.innerHTML=`
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button class="btn" id="tab-gh">GitHub</button>
        <button class="btn" id="tab-anon">–ê–Ω–æ–Ω–∏–º–Ω–æ</button>
      </div>
      <div id="c-gh"></div>
      <div id="c-anon" style="display:none;min-height:300px"></div>`;
    const ghBox=wrap.querySelector('#c-gh'), anonBox=wrap.querySelector('#c-anon'); let ghLoaded=false, anonLoaded=false;
    function loadGH(){ if (ghLoaded) return; ghLoaded=true; ghBox.innerHTML=''; const s=document.createElement('script'); s.src='https://utteranc.es/client.js'; s.setAttribute('repo','sviam-byte/kainrax-site'); s.setAttribute('issue-term', term || 'home'); s.setAttribute('label','comments'); s.setAttribute('theme', document.documentElement.getAttribute('data-theme')==='light'?'github-light':'github-dark'); s.setAttribute('crossorigin','anonymous'); s.async=true; ghBox.appendChild(s); }
    function loadAnon(){ if (!window.CUSDIS_APP_ID){ anonBox.innerHTML='<div class="muted">–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.</div>'; return; }
      if (anonLoaded) return; anonLoaded=true; anonBox.innerHTML=''; const t=document.createElement('div'); t.id='cusdis_thread'; t.dataset.host='https://cusdis.com'; t.dataset.appId=window.CUSDIS_APP_ID; t.dataset.pageId=term || (location.pathname+location.hash); t.dataset.pageUrl=location.href; t.dataset.pageTitle=document.title; t.dataset.lang='ru'; t.dataset.theme=(document.documentElement.getAttribute('data-theme')==='light')?'light':'dark'; anonBox.appendChild(t);
      if (!window.__cusdisLoaded){ const s=document.createElement('script'); s.defer=true; s.src='https://cusdis.com/js/cusdis.es.js'; s.onload=()=>{ window.__cusdisLoaded=true; try{ window.CUSDIS?.renderTo?.('#cusdis_thread'); setCusdisTheme(); }catch(_){} }; document.body.appendChild(s); } else { try{ window.CUSDIS?.renderTo?.('#cusdis_thread'); setCusdisTheme(); }catch(_){} }
    }
    function showGH(){ ghBox.style.display='block'; anonBox.style.display='none'; loadGH(); }
    function showAnon(){ ghBox.style.display='none'; anonBox.style.display='block'; loadAnon(); }
    wrap.querySelector('#tab-gh').onclick=showGH; wrap.querySelector('#tab-anon').onclick=showAnon;
    const io=new IntersectionObserver(es=>{ if(es.some(e=>e.isIntersecting)){ showGH(); io.disconnect(); } },{rootMargin:'200px'}); io.observe(wrap);
  }
  function setUtterancesTheme(theme){ const iframe=document.querySelector('iframe.utterances-frame'); if(iframe) iframe.contentWindow.postMessage({type:'set-theme', theme:theme==='light'?'github-light':'github-dark'}, 'https://utteranc.es'); }
  function setCusdisTheme(){ try{ window.CUSDIS?.setTheme?.(document.documentElement.getAttribute('data-theme')==='light'?'light':'dark'); }catch(_){} }

  const adminDock=document.getElementById('adminDock');
  const editThisBtn=document.getElementById('editThisBtn');
  function adminDockHide(){ adminDock.style.display='none'; }
  function adminDockFor(kind, slug){
    if (!isAdmin) return adminDockHide();
    if(kind==='story')   editThisBtn.href=`/admin/#/collections/stories/entries/${slug}`;
    else if(kind==='note')   editThisBtn.href=`/admin/#/collections/notes/entries/${slug}`;
    else if(kind==='perg')   editThisBtn.href=`/admin/#/collections/pergament/entries/${slug}`;
    else if(kind==='article')editThisBtn.href=`/admin/#/collections/articles/entries/${slug}`;
    adminDock.style.display='block';
  }

  const progress=document.getElementById('progress'); let ticking=false;
  function onScroll(){
    if(ticking) return; ticking=true;
    requestAnimationFrame(()=>{
      const art=document.querySelector('article');
      if(!art){progress.style.width='0%'; ticking=false; return;}
      const total=art.scrollHeight - window.innerHeight + 1;
      const pct=Math.min(100, Math.max(0, ((window.scrollY - art.offsetTop) / total)*100));
      progress.style.width=(isFinite(pct)?pct:0)+'%';
      const id=art.dataset.slug||art.dataset.id; if(id){ localStorage.setItem('read:'+id, window.scrollY); }
      ticking=false;
    });
  }
  addEventListener('scroll', onScroll, {passive:true});
  function restoreScroll(){
    const art=document.querySelector('article'); if(!art) return;
    const id=art.dataset.slug||art.dataset.id;
    const y=+localStorage.getItem('read:'+id)||0;
    if(y>0) setTimeout(()=>scrollTo({top:y,behavior:'instant'}),0);
  }
  </script>

  <script>
  /* ===== –ö–æ—Å–º–µ—Ç–∏–∫–∞ (–∑–≤—ë–∑–¥—ã –∏ —Ç.–¥.) ===== */
  const canvas=document.getElementById('stars'); const ctx=canvas.getContext('2d');
  let W,H,starsArr=[], running=true;
  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; makeStars(); if(prefersReduced){ drawStars(0,true); } }
  addEventListener('resize', resize, {passive:true});
  function makeStars(){
    const base = document.documentElement.getAttribute('data-theme')==='light' ? 40 : 80;
    const k = (W*H)/60000;
    const count = Math.floor(base + k);
    starsArr = Array.from({length: count}, ()=>({ x: Math.random()*W, y: Math.random()*H, r: Math.random()*1+0.3, s: Math.random()*0.5+0.2 }));
  }
  function drawStars(ts, once=false){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--star').trim() || 'rgba(255,255,255,.9)';
    for(const st of starsArr){
      const a = once ? 0.7 : 0.55 + Math.sin((ts/1200)*st.s + st.x*0.002)*0.35;
      ctx.globalAlpha = a; ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI*2); ctx.fill();
    }
    if(!once && !prefersReduced && running) requestAnimationFrame(drawStars);
  }
  document.addEventListener('visibilitychange',()=>{ running = document.visibilityState==='visible'; if(running && !prefersReduced) requestAnimationFrame(drawStars); });

  function initSkyLine() {
    const skyLine = document.getElementById('sky-line'); if (!skyLine) return; let running = true;
    function updatePosition() {
      const now = new Date();
      const msSinceMidnight = (now.getHours()*3600000)+(now.getMinutes()*60000)+(now.getSeconds()*1000)+now.getMilliseconds();
      const progress = msSinceMidnight / 86400000;
      skyLine.style.top = `${progress * 100}vh`;
      if (running) requestAnimationFrame(updatePosition);
    }
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') { running = true; requestAnimationFrame(updatePosition); } else { running = false; }
    });
    requestAnimationFrame(updatePosition);
  }
  </script>

  <script>
  /* ===== –†–æ—É—Ç–∏–Ω–≥ ===== */
  async function render(){
    const r=state.route;
    if(r==='/'||r===''){ renderList(); return; }
    if(r==='/arcs'){ renderArcs(); return; }
    if(r==='/articles'){ renderArticlesList(); return; }
    if(r==='/notes'){ renderNotes(); return; }
    if(r==='/project'){ renderProject(); return; }
    if(r==='/perg'){ renderPergList(); return; }

    const mReadId=r.match(/^\/read-id\/([^?]+)(?:\?.*)?$/);
    if(mReadId){ await renderArticleByObj(findStoryByKey(mReadId[1])); return; }

    const mRead=r.match(/^\/read\/([^?]+)(?:\?.*)?$/);
    if(mRead){ await renderArticleByObj(findStoryByKey(mRead[1])); return; }

    const mArc=r.match(/^\/arc\/([^?]+)(?:\?.*)?$/); if(mArc){ renderArc(mArc[1]); return; }
    const mTag=r.match(/^\/tag\/([^?]+)(?:\?.*)?$/); if(mTag){ renderTag(decodeURIComponent(mTag[1])); return; }
    const mNote=r.match(/^\/note\/([^?]+)(?:\?.*)?$/); if(mNote){ await renderNote(mNote[1]); return; }
    const mPerg=r.match(/^\/perg\/([^?]+)(?:\?.*)?$/); if(mPerg){ await renderPerg(mPerg[1]); return; }
    const mArt=r.match(/^\/read-article\/([^?]+)(?:\?.*)?$/); if(mArt){ await renderArticleRead(mArt[1]); return; }
    renderList();
  }

  async function renderArticleByObj(s){
    if(!s){ location.hash='#/'; return; }
    try{ await loadMdIntoStory(s, isAdmin); }catch(e){}

    const arcs=buildArcs();
    const a=arcs.find(x=>x.id===(s.arc||'kainrax'))||{title:'–í–µ—Ç–∫–∞',items:[]};
    const order=a.items; const pos=Math.max(0, order.findIndex(v=> v.id===s.id ));
    const prev=order[pos-1], next=order[pos+1];

    app.innerHTML=`
      <a class="back" href="#/">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
      <article class="with-margin" data-id="${s.id}" data-slug="${s.slug||s.id}">
        <div class="prose readbox">
          <h1>${s.title}</h1>
          <div class="muted">
            ${fmtHumanDate(s.date)} ¬∑ ${s.minutes||Math.max(5,Math.round((s.text||'').length/1100))} –º–∏–Ω
            ¬∑ –≤–µ—Ç–∫–∞: <a href="#/arc/${s.arc||'kainrax'}">${(arcMeta[s.arc||'kainrax']||{title:'–í–µ—Ç–∫–∞'}).title}</a>
            (${pos+1}/${order.length})
          </div>
          <div style="margin:6px 0 12px">${(s.tags||[]).map(t=>`<a class='tag' href='#/tag/${encodeURIComponent(t)}'>${t}</a>`).join(' ')}</div>
          ${(s.text||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}
          <hr style="border:0;border-top:1px solid var(--line);margin:18px 0">
          <div style="display:flex;justify-content:space-between;gap:10px">
            ${prev?`<a class="btn" href="#/read-id/${prev.id}">‚Üê ${prev.title}</a>`:'<span></span>'}
            ${next?`<a class="btn" href="#/read-id/${next.id}">${next.title} ‚Üí</a>`:'<span></span>'}
          </div>
        </div>
        <aside class="margin-notes"></aside>
      </article>
      <section class="card" style="margin-top:16px">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section>
      </section>`;

    await typesetMath(document.querySelector('.prose.readbox'));
    KX_refitMath(document);
    mountComments('story:'+(s.slug||s.id));
    setTimeout(restoreScroll,0);
    adminDockFor('story', s.slug||s.id);
    ensureAdminUI();
    window.hit && window.hit('story:'+(s.slug||s.id)).catch(()=>{});
  }
  </script>

  <script>
  /* ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===== */
  (async function init(){
    app.innerHTML = `<section class="card"><h1>–†–∞—Å—Å–∫–∞–∑—ã</h1><div class="muted">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è‚Ä¶</div></section>`;
    try { await loadContent(); } catch(_) {}
    applyTheme();
    render();
    ensureAdminUI();
    (function initStars(){ const canvas=document.getElementById('stars'); if(!canvas) return; resize(); const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; if (!prefersReduced) requestAnimationFrame(drawStars); })();
    initSkyLine();
  })();
  </script>

  <script>
/* ===== –ù–∞–¥—ë–∂–Ω—ã–π –∞–≤—Ç–æ—Å–∫–µ–π–ª –±–ª–æ—á–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª ===== */
(function(){
  function fitLargeMath(root){
    const scope = root || document;
    const blocks = scope.querySelectorAll(
      '.prose .mjx-container[display="true"], .article-body .mjx-container[display="true"]'
    );

    blocks.forEach(el=>{
      // –æ–¥–Ω–∞ –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å —Ñ–æ—Ä–º—É–ª—ã
      let wrap = el.parentElement;
      if(!wrap || !wrap.classList.contains('kx-math-fit')){
        const w = document.createElement('div');
        w.className = 'kx-math-fit';
        (wrap || el.parentNode).insertBefore(w, el);
        w.appendChild(el);
        wrap = w;
      }

      // —Å–±—Ä–æ—Å –∏ –∏–∑–º–µ—Ä–µ–Ω–∏–µ
      el.style.transform = '';
      wrap.style.height = '';
      const cs = getComputedStyle(wrap);
      const avail = Math.max(0, wrap.clientWidth - (parseFloat(cs.paddingLeft)||0) - (parseFloat(cs.paddingRight)||0));
      const need  = el.scrollWidth;

      if(need > avail && avail > 0){
        // –Ω–∏–∂–Ω–∏–π –ø–æ—Ä–æ–≥ –º–∞—Å—à—Ç–∞–±–∞ ‚Äî 0.3, –Ω–∏–∂–µ —á–∏—Ç–∞—Ç—å –±–æ–ª—å–Ω–æ
        const scale = Math.max(0.30, Math.min(1, avail / need));
        const rect  = el.getBoundingClientRect(); // –≤—ã—Å–æ—Ç–∞ –î–û —Å–∫–µ–π–ª–∞
        el.style.transform = `scale(${scale})`;
        wrap.style.height = (rect.height * scale + 2) + 'px';
      }
    });
  }

  // –¢—Ä–∏–≥–≥–µ—Ä—ã: –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞, —Ä–µ—Å–∞–π–∑–∞ –∏ —Å–º–µ–Ω—ã —Ö—ç—à–∞ (SPA)
  let raf = 0;
  function scheduleFit(target){
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=> fitLargeMath(target || document));
  }
  addEventListener('resize', ()=> scheduleFit(), {passive:true});
  addEventListener('orientationchange', ()=> scheduleFit(), {passive:true});
  addEventListener('hashchange', ()=> scheduleFit(), {passive:true});

  // –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç
  window.KX_refitMath = scheduleFit;

  // –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>scheduleFit(), {once:true});
  } else {
    scheduleFit();
  }
})();
  </script>
</body>
</html>
