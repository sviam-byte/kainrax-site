<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–π—Ä–Ω–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã</title>
  <meta name="description" content="–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –í–µ—Ç–∫–∏, —Ç–µ–≥–∏, –∑–∞–º–µ—Ç–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –ø—è—Ç–Ω–∏—Ü–∞/—Å—É–±–±–æ—Ç–∞." />
  <meta name="theme-color" content="#0b0f14" />
  <!-- favicon: –ø—Ä–æ—Å—Ç–∞—è –≤–æ—Å—å–º–∏–∫–æ–Ω–µ—á–Ω–∞—è ¬´–∏—Å–∫—Ä–∞¬ª (–Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–∏–º–æ–≥–µ–º) -->
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23FFD54A' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E">

  <style>
  :root{
    --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa5b1;
    --card:rgba(16,21,32,.85); --line:#243447;
    --accent:#7dd3fc; --accent2:#a78bfa; --link:#93c5fd;
    --max:960px; --r:14px; --shadow:0 12px 36px rgba(0,0,0,.45);
    --code:#0a0e16; --mountain:#121723; --star:rgba(255,255,255,.9);
  }
  [data-theme="light"]{
    --bg:#f7fbff; --fg:#0b0f14; --muted:#5a6774;
    --card:rgba(255,255,255,.92); --line:#e6ecf2;
    --accent:#0ea5e9; --accent2:#7c3aed; --link:#1d4ed8;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --code:#f6f8fb; --mountain:#dfe7f3; --star:rgba(10,20,40,.85);
  }
  [data-theme="cringe"]{
    --bg:linear-gradient(135deg,#ffb6f3,#ffd699 50%,#b3f1ff);
    --fg:#111; --muted:#333; --card:rgba(255,255,255,.88); --line:#ffd1f4;
    --accent:#ff3ea5; --accent2:#07f49e; --link:#7c00ff;
    --shadow:0 14px 40px rgba(0,0,0,.25); --code:#fff5ff; --mountain:#ffc6fb; --star:rgba(0,0,0,.7);
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif}
  a{color:var(--link)}
  h1{margin:6px 0 10px;font-size:28px}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
  .btn,button{border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;box-shadow:var(--shadow)}
  input[type="search"]{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}

  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,21,32,.9), rgba(15,21,32,.65));backdrop-filter: blur(10px) saturate(1.1);border-bottom:1px solid var(--line)}
  [data-theme="light"] header{background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.75))}
  [data-theme="cringe"] header{background:linear-gradient(90deg, rgba(255,255,255,.9), rgba(255,255,255,.6))}
  .head{max-width:var(--max);margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand a{color:var(--fg);text-decoration:none}
  .search{flex:1;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  main{max-width:var(--max);margin:0 auto;padding:20px 16px 80px;position:relative;z-index:1}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:900px){ .grid{grid-template-columns:1.15fr .85fr;gap:22px} }
  .list{display:flex;flex-direction:column;gap:12px}
  .story-item{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(125,211,252,.08), transparent);border:1px solid rgba(125,211,252,.18)}
  .story-item a{color:var(--fg);text-decoration:none}
  .title{font-weight:700}
  .prose{font-family: Georgia, "Times New Roman", serif;font-size:18px;line-height:1.75}
  .prose p{margin:0 0 14px}
  article.prose a::before{content:"‚ú∂ ";color:var(--muted)} /* –Ω–µ–±–ª–µ—Å—Ç—è—â–∞—è ¬´–∏—Å–∫—Ä–∞¬ª, –Ω–µ –≥–µ–Ω—à–∏–Ω */
  .tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;margin-right:6px}
  .tag:before{content:"‚ú∂";color:var(--muted)}
  [data-theme="light"] .tag:before{content:"#";}
  .back{display:inline-flex;align-items:center;gap:8px;margin:6px 0 12px}
  .progress{position:fixed;left:0;top:0;height:3px;background:linear-gradient(90deg, var(--accent), var(--accent2));width:0;z-index:6}

  /* —Ñ–æ–Ω: –∑–≤—ë–∑–¥—ã + ¬´–≥–æ—Ä—ã¬ª —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É (–ø–æ–¥–∑–µ–º–Ω—ã–π —Å–≤–æ–¥) */
  #stars{position:fixed;inset:0;z-index:0;pointer-events:none}
  #ceiling{position:fixed;left:0;right:0;top:0;height:18vh;z-index:0;pointer-events:none;opacity:.95}
  #ceiling svg{width:100%;height:100%;display:block;transform:scaleY(-1)} /* –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç—ã–π –≥—Ä–µ–±–µ–Ω—å ‚Äî –∫–∞–∫ –ø–æ—Ç–æ–ª–æ–∫ */
  #ceiling path{fill:var(--mountain)}
  #mountains{position:fixed;left:0;right:0;bottom:0;height:28vh;z-index:0;pointer-events:none;opacity:.92}
  #mountains svg{width:100%;height:100%;display:block}
  #mountains path{fill:var(--mountain)}

  /* –∞–¥–º–∏–Ω-UI —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  #adminDock{position:fixed;right:14px;bottom:14px;z-index:7;display:none}
  #adminDock .btn{background:var(--card)}
  #adminBtns{display:none}

  #c-anon{min-height:300px}
  </style>
</head>
<body>
  <canvas id="stars" aria-hidden="true"></canvas>

  <!-- –ø–æ—Ç–æ–ª–æ–∫ (—Å–≤–æ–¥) -->
  <div id="ceiling" aria-hidden="true">
    <svg viewBox="0 0 100 30" preserveAspectRatio="none">
      <path d="M0,25 L8,18 L18,22 L28,15 L38,20 L48,12 L58,19 L68,13 L78,22 L88,16 L100,23 L100,30 L0,30 Z"/>
    </svg>
  </div>
  <!-- –ø–æ–ª (–≥—Ä–µ–±–µ–Ω—å) -->
  <div id="mountains" aria-hidden="true">
    <svg viewBox="0 0 100 30" preserveAspectRatio="none">
      <path d="M0,25 L10,18 L20,22 L30,14 L40,20 L50,10 L60,19 L70,13 L80,22 L90,16 L100,23 L100,30 L0,30 Z"/>
    </svg>
  </div>

  <div class="progress" id="progress"></div>

  <header>
    <div class="head">
      <div class="brand"><a href="#/">–ö–∞–π—Ä–Ω–∞–∫—Å ‚ú∂</a></div>
      <div class="search" style="max-width:720px">
        <span class="pill" title="–ù–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –≤—ã—Ö–æ–¥—è—Ç –≤ —ç—Ç–∏ –¥–Ω–∏">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ø—Ç/—Å–±</span>
        <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–∞—Å—Å–∫–∞–∑–∞–º‚Ä¶" aria-label="–ü–æ–∏—Å–∫" />
        <a class="btn" href="#/arcs">–í–µ—Ç–∫–∏</a>
        <a class="btn" href="#/notes">–ó–∞–º–µ—Ç–∫–∏</a>
        <a class="btn" href="#/about">–û –º–∏—Ä–µ</a>
        <button id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>

        <!-- –∞–¥–º–∏–Ω-–∫–Ω–æ–ø–∫–∏ (–≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≤ admin-—Ä–µ–∂–∏–º–µ) -->
        <span id="adminBtns" style="display:none">
          <a class="btn" href="/admin/" target="_blank" rel="noopener">–ê–¥–º–∏–Ω–∫–∞</a>
          <a class="btn" id="newStoryBtn" href="/admin/#/collections/stories/new" target="_blank" rel="noopener">+ –†–∞—Å—Å–∫–∞–∑</a>
          <a class="btn" id="newNoteBtn"  href="/admin/#/collections/notes/new"  target="_blank" rel="noopener">+ –ó–∞–º–µ—Ç–∫–∞</a>
        </span>
      </div>
    </div>
  </header>

  <div id="adminDock"><a class="btn" id="editThisBtn" target="_blank" rel="noopener">‚úèÔ∏è –ü—Ä–∞–≤–∏—Ç—å</a></div>
  <main id="app" aria-live="polite"></main>

  <script>
  /* ===== –ö–û–ù–§–ò–ì ===== */
  // –í Cusdis ‚Üí Project Settings –≤–Ω–µ—Å–∏ Allowed Domains: kainrax.netlify.app (+ —Ç–≤–æ–π –¥–æ–º–µ–Ω)
  window.CUSDIS_APP_ID = "079685b7-f335-4fbd-9217-9d857a3cc369";

  const state={ theme: localStorage.getItem('theme') || 'dark', route: location.hash.slice(1)||'/', q:'' };
  const app=document.getElementById('app'); const qEl=document.getElementById('q');

  /* ===== –í–ï–¢–ö–ò ===== */
  const arcs=[
    { id:'surface', title:'–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å', desc:'–ò–æ–Ω–∞ –∏ ¬´–¶–≤–µ—Ç–æ–∫¬ª.', order:['epitimya','tsvetok'] },
    { id:'kainrax',  title:'–ö–∞–π–Ω—Ä–∞–∫—Å',    desc:'–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Å–∫–∞–∑—ã –∏–∑ –º–∏—Ä–∞ –ö–∞–π–Ω—Ä–∞–∫—Å–∞.', order:['dorogovato','chelovecheskiy-faktor'] },
    { id:'ibut',     title:'–ò–ë–£–¢',        desc:'–õ—ë–≥–∫–æ–µ —á—Ç–∏–≤–æ –ø—Ä–æ –ø–æ–ø–∞–¥–∞–Ω—Ü–µ–≤.', order:['ibut-g1','ibut-g2'] }
  ];
  const arcById=id=>arcs.find(a=>a.id===id)||{title:'–í–µ—Ç–∫–∞',order:[]};
  const fmtDate=iso=>{ try{const d=new Date(iso);return d.toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'});}catch(_){return iso} };

  /* ===== –î–ê–ù–ù–´–ï (—Ñ–æ–ª–±—ç–∫–∏, –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞—é—Ç—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º) ===== */
  let stories=[{id:'epitimya',slug:'epitimya',title:'–ï–ø–∏—Ç–∏–º—å—è',date:'2025-08-01',minutes:12,tags:['–ö–∞–π—Ä–Ω–∞–∫—Å','–ò–æ–Ω–∞'],arc:'surface',text:'–ó–ê–ì–õ–£–®–ö–ê'}];
  let notes=[{id:'n-2025-08-08-a',slug:'n-2025-08-08-a',title:'–û —Ç–æ–Ω–µ',date:'2025-08-08',text:'–ó–ê–ì–õ–£–®–ö–ê'}];

  async function loadContent(){
    try{
      const j=await fetch('content/index.json',{cache:'no-store'}).then(r=>r.json());
      if(Array.isArray(j.stories)) stories=j.stories;
      if(Array.isArray(j.notes))   notes=j.notes;
    }catch(e){}
  }

  /* ===== –¢–ï–ú–ê + FAVICON ===== */
  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme);
    localStorage.setItem('theme', state.theme);
    setUtterancesTheme(state.theme);
    setCusdisTheme();
    // —Å–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ favicon –ø–æ–¥ —Ç–µ–º—É
    const el=document.getElementById('favicon');
    const color = state.theme==='light' ? '%230A1830' : '%23FFD54A';
    const svg = `%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='${color}' d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z'/%3E%3C/svg%3E`;
    el.href = `data:image/svg+xml,${svg}`;
  }
  applyTheme();
  document.getElementById('themeBtn').onclick=()=>{
    state.theme = state.theme==='dark' ? 'light' : (state.theme==='light' ? 'cringe' : 'dark');
    applyTheme();
  };

  /* ===== ADMIN MODE (—Å–∫—Ä—ã—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö) ===== */
  let isAdmin =
    new URLSearchParams(location.search).has('admin') ||
    localStorage.getItem('admin') === '1';

  if (new URLSearchParams(location.search).has('admin')) {
    localStorage.setItem('admin', '1');
    history.replaceState({}, '', location.pathname + location.hash); // —É–±—Ä–∞—Ç—å ?admin=1 –∏–∑ URL
  }

  function ensureAdminUI() {
    const bar = document.getElementById('adminBtns');
    if (bar) bar.style.display = isAdmin ? 'inline-flex' : 'none';
    if (!isAdmin) adminDockHide();
  }

  // –≥–æ—Ä—è—á–∞—è –∫–Ω–æ–ø–∫–∞: Alt+Shift+A
  addEventListener('keydown', (e) => {
    if (e.altKey && e.shiftKey && e.key.toLowerCase() === 'a') {
      isAdmin = !isAdmin;
      localStorage.setItem('admin', isAdmin ? '1' : '0');
      ensureAdminUI();
    }
  });

  /* ===== –†–û–£–¢–ï–† / –ü–û–ò–°–ö ===== */
  addEventListener('hashchange',()=>{ state.route=location.hash.slice(1)||'/'; render(); restoreScroll(); });
  qEl.addEventListener('input',()=>{ state.q=qEl.value.trim().toLowerCase(); renderList(); });

  /* ===== –í–¨–Æ–•–ò ===== */
  function renderList(){
    const q=state.q;
    const items=stories.filter(s=>!q || s.title.toLowerCase().includes(q) || (s.text||'').toLowerCase().includes(q) || (s.tags||[]).join(' ').toLowerCase().includes(q));
    app.innerHTML=`
      <div class="grid">
        <section class="card">
          <h1>–†–∞—Å—Å–∫–∞–∑—ã</h1>
          <div class="muted">–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –í—ã—Ö–æ–¥—ã: –ø—è—Ç–Ω–∏—Ü–∞/—Å—É–±–±–æ—Ç–∞.</div>
          <div class="list">
            ${items.map(s=>{
              const ex=(s.text||'').replace(/\n+/g,' ').slice(0,130).trim()+((s.text||'').length>130?'‚Ä¶':'');
              return `<div class="story-item">
                <a href="#/read/${s.id}">
                  <div class="title">‚ú∂ ${s.title}</div>
                  <div class="muted">${fmtDate(s.date)} ¬∑ ${s.minutes||8} –º–∏–Ω —á—Ç–µ–Ω–∏—è ¬∑ –≤–µ—Ç–∫–∞: ${arcById(s.arc).title}</div>
                  <div>${ex}</div>
                </a>
              </div>`;
            }).join('')}
          </div>
        </section>
        <aside class="card">
          <h2>–í–µ—Ç–∫–∏</h2>
          <div class="list">
            ${arcs.map(a=>`
              <div class="story-item">
                <a href="#/arc/${a.id}">
                  <div class="title">‚ú∂ ${a.title}</div>
                  <div class="muted">${a.order.length} —Ç–µ–∫—Å—Ç(–∞)</div>
                  <div>${a.desc}</div>
                </a>
              </div>`).join('')}
          </div>
          <h3 style="margin-top:14px">–ü–æ–¥–ø–∏—Å–∫–∞</h3>
          <p class="muted">–¢–µ–ª–µ–≥—Ä–∞–º: <a href="https://t.me/kainrax" target="_blank" rel="noopener">@kainrax</a></p>
        </aside>
      </div>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArcs(){
    app.innerHTML=`<section class="card"><h1>–í–µ—Ç–∫–∏</h1>
    <div class="list">${arcs.map(a=>`
      <div class="story-item"><a href="#/arc/${a.id}">
        <div class="title">‚ú∂ ${a.title}</div>
        <div class="muted">${a.order.length} —Ç–µ–∫—Å—Ç(–∞)</div>
        <div>${a.desc}</div>
      </a></div>`).join('')}</div></section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArc(id){
    const a=arcById(id); const arr=a.order.map(i=>stories.find(s=>s.id===i||s.slug===i)).filter(Boolean);
    app.innerHTML=`<section class="card">
      <a class="back" href="#/arcs">‚Üê –ö–æ –≤—Å–µ–º –≤–µ—Ç–∫–∞–º</a>
      <h1>${a.title}</h1><div class="muted">${a.desc}</div>
      <ol class="list" style="margin-top:10px">${arr.map((s,i)=>`
        <li class="story-item"><a href="#/read/${s.id}">
          <div class="title">‚ú∂ ${i+1}. ${s.title}</div>
          <div class="muted">${fmtDate(s.date)} ¬∑ ${s.minutes||8} –º–∏–Ω</div>
        </a></li>`).join('')}
      </ol></section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderNotes(){
    app.innerHTML=`<section class="card"><h1>–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –∑–∞–º–µ—Ç–∫–∏</h1>
    <div class="list">${notes.map(n=>`
      <div class="story-item"><a href="#/note/${n.id}">
        <div class="title">‚ú∂ ${n.title}</div>
        <div class="muted">${fmtDate(n.date)}</div>
      </a></div>`).join('')}</div></section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderNote(id){
    const n=notes.find(x=>x.id===id||x.slug===id); if(!n){location.hash='#/notes';return;}
    app.innerHTML=`<a class="back" href="#/notes">‚Üê –ö –∑–∞–º–µ—Ç–∫–∞–º</a>
    <article class="prose" data-id="${n.id}" data-slug="${n.slug}">
      <h1>${n.title}</h1>
      <div class="muted">${fmtDate(n.date)}</div>
      ${(n.text||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}
    </article>
    <div class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></div>`;
    mountComments('note:'+ (n.slug||n.id)); setTimeout(restoreScroll,0);
    adminDockFor('note', n.slug||n.id); ensureAdminUI();
  }

  function renderAbout(){
    app.innerHTML=`<section class="card">
      <h1>–û –º–∏—Ä–µ ¬´–ö–∞–π—Ä–Ω–∞–∫—Å¬ª</h1>
      <div class="prose">
        <p><em>¬´–ù–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –µ—Å—Ç—å —Å–∫–∞–∑–∫–∞ ‚Äî —Å–∫–∞–∑–∫–∞ –ø—Ä–æ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–¥–Ω–∞–∂–¥—ã —É–±–∏–ª –±–æ–≥–∞, –∫–æ—Ç–æ—Ä–æ–º—É –∫–ª—è–ª—Å—è —Å–ª—É–∂–∏—Ç—å. –ó–≤–∞–ª–∏ —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –ö–∞–∏–Ω, –∏ –≥—Ä–µ—Ö –µ–≥–æ ‚Äî –ø–µ—Ä–≤–æ—Ä–æ–¥–Ω—ã–º.</em></p>
        <p><em>–ù–æ –í–æ–∑–¥–≤–∏–∂–µ–Ω—Ü—ã –Ω–µ –∫–ª—è–ª–∏—Å—å –≤ –≤–µ—Ä–Ω–æ—Å—Ç–∏ –Ω–∏ –æ–¥–Ω–∏–º –±–æ–≥–∞–º.</em><br>
        <em>–û–Ω–∏ —É—à–ª–∏ –∏–∑-–ø–æ–¥ –Ω–µ–ø—Ä–∏–≤–µ—Ç–ª–∏–≤—ã—Ö –±–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫—Ä—ã–ª—å–µ–≤, –≥–¥–µ –≤–º–µ—Å—Ç–æ –ø–µ—Ä—å–µ–≤ –±—ã–ª —á–∞—Å—Ç–æ–∫–æ–ª –∑–∞–±–æ—Ä–∞, –∏ –Ω–∞–∑–≤–∞–ª–∏ —Å–µ–±—è ‚Äî –Ω–∞—Ü–∏–µ–π –ö–∞–∏–Ω–∞, –ö–∞–∏–Ω-–Ω–∞—Ü–∏–µ–π.</em></p>
        <p><em>–ü–æ–¥–∑–µ–º–Ω–∞—è –∂–∏–∑–Ω—å, —Å—É—Ä–æ–≤–∞—è –∏ –Ω–µ–ø—Ä–∏—Ö–æ—Ç–ª–∏–≤–∞—è, –æ–±—Ç–æ—á–∏–ª–∞ —ç—Ç–æ –∏–º—è, –∏ –ø—Ä–∏–¥–∞–ª–∞ –µ–º—É –∑–≤—É—á–∞–Ω–∏–µ, –∫–∞–∫–æ–µ –Ω–µ –º–æ–≥–ª–æ —Ä–æ–¥–∏—Ç—å—Å—è –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏.</em><br>
        <em>–ö–∞–π–Ω—Ä–∞–∫—Å.</em><br>
        <em>–ò –∏–º—è –ø–µ—Ä–≤–æ–≥–æ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –≥—Ä–µ—à–Ω–∏–∫–∞ ‚Äî —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —É–±–∏–ª –±–æ–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫–∞–∑–∞–ª—Å—è —Å—á–∏—Ç–∞—Ç—å —Å–µ–±—è –Ω–µ–¥–æ—Å—Ç–æ–π–Ω—ã–º –±–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ø, ‚Äî –º—ã –Ω–æ—Å–∏–º —Å –≥–æ—Ä–¥–æ—Å—Ç—å—é¬ª.</em></p>
        <p class="muted">–ü–µ—Ä–≥–∞–º–µ–Ω—Ç. –ù–∞—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫ –º–æ–ª–æ–¥—ã–º. –ü–µ—Ä–≤–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è; 67–≥ –æ—Ç –í–æ–∑–¥–≤–∏–∂–µ–Ω–∏—è; –≠–ª–∏–∞—Ä–∞, –í—Ç–æ—Ä–æ–π –•—Ä–æ–Ω–∏–∫—ë—Ä.</p>

        <hr style="border:0;border-top:1px solid var(--line);margin:18px 0">

        <p><em>¬´–î—Ä–µ–≤–Ω–∏–µ —Å–∫–∞–∑–∫–∏ –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –≥–æ–≤–æ—Ä—è—Ç –æ –≥—Ä–µ—à–Ω–∏–∫–µ, —á—Ç–æ –ø–æ–¥–Ω—è–ª —Ä—É–∫—É –Ω–∞ —Å–≤–æ–µ–≥–æ –±—Ä–∞—Ç–∞ –∏–∑ –∑–∞–≤–∏—Å—Ç–∏, –∏ –∑–≤–∞–ª–∏ –µ–≥–æ –ö–∞–∏–Ω. –ù–æ –º—ã, –¥–µ—Ç–∏ –ü–µ—Ä–≤–æ–≥–æ –°–≤–µ—Ç–∞, –∑–Ω–∞–µ–º –∏—Å—Ç–∏–Ω—É, –∫–æ—Ç–æ—Ä—É—é –æ–Ω–∏ –∑–∞–±—ã–ª–∏! –ò–±–æ –±—ã–ª –¥—Ä—É–≥–æ–π –ö–∞–∏–Ω, –ø–µ—Ä–≤—ã–π –∏–∑ –ª—é–¥–µ–π, –∫—Ç–æ –ø–æ—Å–º–µ–ª –ø–æ–¥–Ω—è—Ç—å –≤–∑–≥–ª—è–¥ –∫ –Ω–µ–±—É –∏ —É–≤–∏–¥–µ–ª –Ω–µ –±–æ–≥–∞, –∞ —Ç—é—Ä–µ–º—â–∏–∫–∞.</em></p>
        <p><em>–ú—ã ‚Äî –í–æ–∑–¥–≤–∏–∂–µ–Ω—Ü—ã, –∏ –º—ã –Ω–µ –∫–ª—è–ª–∏—Å—å –≤ –≤–µ—Ä–Ω–æ—Å—Ç–∏ —Ç—é—Ä–µ–º—â–∏–∫–∞–º. –ú—ã –Ω–µ —Å–∫–ª–æ–Ω—è–ª–∏ –≥–æ–ª–æ–≤—ã –ø–µ—Ä–µ–¥ —Ç–µ–º–∏, –∫—Ç–æ —Å–æ–∑–¥–∞–ª –º–∏—Ä –Ω–µ –∫–∞–∫ –¥–∞—Ä, –∞ –∫–∞–∫ –∫–ª–µ—Ç–∫—É —Å –ø–æ–∑–æ–ª–æ—á–µ–Ω–Ω—ã–º–∏ –ø—Ä—É—Ç—å—è–º–∏. –ú—ã —Ä–∞–∑–æ—Ä–≤–∞–ª–∏ —Ü–µ–ø–∏! –ú—ã —É—à–ª–∏ –∏–∑-–ø–æ–¥ –∏—Ö –∫–∞–º–µ–Ω–Ω—ã—Ö –∫—Ä—ã–ª—å–µ–≤ –∏ –Ω–∞–∑–≤–∞–ª–∏ —Å–µ–±—è –≥–æ—Ä–¥–æ ‚Äî –ö–∞–∏–Ω-—Ä–∞–∫—Å, –ù–∞—Ä–æ–¥ –ö–∞–∏–Ω–∞, –ù–∞—Ü–∏—è –ü–µ—Ä–≤–æ–≥–æ –ß–µ–ª–æ–≤–µ–∫–∞, –æ—Ç–∫–∞–∑–∞–≤—à–µ–≥–æ—Å—è –±—ã—Ç—å —Ä–∞–±–æ–º!</em></p>
        <p><em>–ü—É—Å—Ç—å –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –ø–æ–º–Ω–∏—Ç –ª–∏—à—å –≥—Ä–µ—Ö. –ú—ã –∂–µ –ø–æ–º–Ω–∏–º –ø–æ–¥–≤–∏–≥. –ö–∞–∂–¥—ã–π —É–¥–∞—Ä –º–æ–ª–æ—Ç–∞, –æ—Ç–µ—Å—ã–≤–∞—é—â–∏–π –∫–∞–º–µ–Ω—å –Ω–∞—à–∏—Ö –≥–æ—Ä–æ–¥–æ–≤, –∫–∞–∂–¥—ã–π –ª—É—á –Ω–∞—à–µ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –Ω–µ–±–∞ –≤—Ç–æ—Ä–∏—Ç —ç—Ç–æ–º—É –∏–º–µ–Ω–∏. –ò–±–æ –ö–∞–π–Ω—Ä–∞–∫—Å ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ. –≠—Ç–æ –∫–ª—è—Ç–≤–∞. –ö–ª—è—Ç–≤–∞ –≤–µ—á–Ω–æ –Ω–µ—Å—Ç–∏ —Å–≤–µ—Ç —Ä–∞–∑—É–º–∞ –≤–æ —Ç—å–º—É —Å–ª–µ–ø–æ–π –≤–µ—Ä—ã –∏ –Ω–∏–∫–æ–≥–¥–∞, –Ω–∏–∫–æ–≥–¥–∞ –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–µ–∫–ª–æ–Ω—è—Ç—å –∫–æ–ª–µ–Ω¬ª.</em></p>
        <p class="muted">–ü–µ—Ä–≥–∞–º–µ–Ω—Ç. –ù–∞—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫ –º–æ–ª–æ–¥—ã–º. –°–µ–¥—å–º–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è; 180–≥ –æ—Ç –í–æ–∑–¥–≤–∏–∂–µ–Ω–∏—è; –≠–ª–∏–∞—Ä–∞, –í—Ç–æ—Ä–æ–π –•—Ä–æ–Ω–∏–∫—ë—Ä.</p>

        <hr style="border:0;border-top:1px solid var(--line);margin:18px 0">

        <p><em>¬´–ù–∞ –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –±—ã—Ç—É–µ—Ç –Ω–∞–∏–≤–Ω–∞—è —Å–∫–∞–∑–∫–∞ –æ –ö–∞–∏–Ω–µ, —É–±–∏–π—Ü–µ –±–æ–≥–æ–≤. –ü–æ–¥–æ–±–Ω—ã–µ –º–∏—Ñ—ã –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è –¥–µ—Ç–µ–π –∏ —Å–æ–ª–¥–∞—Ç, –Ω–æ –∑—Ä–µ–ª—ã–π —Ä–∞–∑—É–º –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –∑–∞ –Ω–∏–º–∏ —Å—É—Ç—å.</em></p>
        <p><em>–í–æ–∑–¥–≤–∏–∂–µ–Ω—Ü—ã –Ω–µ –±—ã–ª–∏ –Ω–∏ –≥–µ—Ä–æ—è–º–∏, –Ω–∏ –≥—Ä–µ—à–Ω–∏–∫–∞–º–∏. –û–Ω–∏ –±—ã–ª–∏ –ø—Ä–∞–≥–º–∞—Ç–∏–∫–∞–º–∏, —Å—Ç–æ–ª–∫–Ω—É–≤—à–∏–º–∏—Å—è —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º —Å–±–æ–µ–º. –ë–æ–≥–∏ —Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –±—ã–ª–∏ –Ω–µ —Ç–∏—Ä–∞–Ω–∞–º–∏, –∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏, –≤—ã—à–µ–¥—à–∏–º–∏ –∏–∑-–ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è —Ñ—É–Ω–∫—Ü–∏—è–º–∏. "–£–±–∏–π—Å—Ç–≤–æ –±–æ–≥–∞" –±—ã–ª–æ –Ω–µ –∞–∫—Ç–æ–º –±—É–Ω—Ç–∞, –∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–æ–π –ø–æ —É–¥–∞–ª–µ–Ω–∏—é –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–ª–ª–∞–ø—Å–∞ —Å–∏—Å—Ç–µ–º—ã.</em></p>
        <p><em>–ú—ã –Ω–∞–∑–≤–∞–ª–∏ —Å–µ–±—è –ö–∞–π–Ω—Ä–∞–∫—Å –Ω–µ –∏–∑ –≥–æ—Ä–¥–æ—Å—Ç–∏ –∑–∞ –Ω–µ–∫–∏–π "–≥—Ä–µ—Ö", –∞ –≤ –∑–Ω–∞–∫ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è —Å—É—Ä–æ–≤–æ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏: –ø–æ—Ä—è–¥–æ–∫ —Ç—Ä–µ–±—É–µ—Ç –∂–µ—Ä—Ç–≤, –∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –≤–∞–∂–Ω–µ–µ –ª—é–±–æ–≥–æ –µ–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞. –ò–º—è –ö–∞–∏–Ω–∞ ‚Äî —ç—Ç–æ –Ω–µ –∑–Ω–∞–º—è —Ä–µ–≤–æ–ª—é—Ü–∏–∏, –∞ –≤–µ—á–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ü–µ–Ω–µ, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –ø–ª–∞—Ç–∏—Ç—å –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å. –ü–æ–º–Ω–∏—Ç—å –æ–± —ç—Ç–æ–º ‚Äî –¥–æ–ª–≥ –∫–∞–∂–¥–æ–≥–æ, –∫—Ç–æ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –≤—ã–∂–∏–≤–∞–Ω–∏–µ –Ω–∞—à–µ–≥–æ –º–∏—Ä–∞¬ª.</em></p>
        <p class="muted">–ü–µ—Ä–≥–∞–º–µ–Ω—Ç. –ù–∞—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫ –º–æ–ª–æ–¥—ã–º. –î–≤–∞–¥—Ü–∞—Ç—å —Ç—Ä–µ—Ç—å—è —Ä–µ–¥–∞–∫—Ü–∏—è; 250–≥ –æ—Ç –í–æ–∑–¥–≤–∏–∂–µ–Ω–∏—è; –ò—Ç—É—Ä, –ß–µ—Ç–≤—ë—Ä—Ç—ã–π –•—Ä–æ–Ω–∏–∫—ë—Ä.</p>
      </div>
    </section>`;
    adminDockHide(); ensureAdminUI();
  }

  function renderArticle(id){
    const s=stories.find(x=>x.id===id||x.slug===id); if(!s){location.hash='#/'; return;}
    const a=arcById(s.arc);
    const order=a.order.map(i=>stories.find(st=>st.id===i||st.slug===i)).filter(Boolean);
    const pos=Math.max(0, order.findIndex(v=>v.id===s.id||v.slug===s.slug));
    const prev=order[pos-1], next=order[pos+1];

    app.innerHTML=`
      <a class="back" href="#/">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
      <article class="prose" data-id="${s.id}" data-slug="${s.slug}">
        <h1>${s.title}</h1>
        <div class="muted">${fmtDate(s.date)} ¬∑ ${s.minutes||8} –º–∏–Ω ¬∑ –≤–µ—Ç–∫–∞: <a href="#/arc/${a.id}">${a.title}</a> (${pos+1}/${order.length})</div>
        <div style="margin:6px 0 12px">${(s.tags||[]).map(t=>`<a class='tag' href='#/tag/${encodeURIComponent(t)}'>${t}</a>`).join(' ')}</div>
        ${(s.text||'').split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}
        <hr style="border:0;border-top:1px solid var(--line);margin:18px 0">
        <div style="display:flex;justify-content:space-between;gap:10px">
          ${prev?`<a class="btn" href="#/read/${prev.id}">‚Üê ${prev.title}</a>`:'<span></span>'}
          ${next?`<a class="btn" href="#/read/${next.id}">${next.title} ‚Üí</a>`:'<span></span>'}
        </div>
      </article>
      <section class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></section>`;
    mountComments('story:'+ (s.slug||s.id)); setTimeout(restoreScroll,0);
    adminDockFor('story', s.slug||s.id); ensureAdminUI();
  }

  function renderTag(tag){
    const items=stories.filter(s=> (s.tags||[]).map(t=>t.toLowerCase()).includes(tag.toLowerCase()));
    app.innerHTML=`<section class="card">
      <a class="back" href="#/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      <h1>#${tag}</h1>
      <div class="list">${items.map(s=>`
        <div class="story-item"><a href="#/read/${s.id}">
          <div class="title">‚ú∂ ${s.title}</div>
          <div class="muted">${fmtDate(s.date)} ¬∑ ${s.minutes||8} –º–∏–Ω ¬∑ –≤–µ—Ç–∫–∞: ${arcById(s.arc).title}</div>
        </a></div>`).join('')}</div></section>`;
    adminDockHide(); ensureAdminUI();
  }

  /* ===== –õ–ï–ù–ò–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ö–û–ú–ú–ï–ù–¢–û–í ===== */
  function mountComments(term){
    const wrap=document.getElementById('comments'); if(!wrap) return;

    wrap.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button class="btn" id="tab-gh">GitHub</button>
        <button class="btn" id="tab-anon">–ê–Ω–æ–Ω–∏–º–Ω–æ</button>
      </div>
      <div id="c-gh"></div>
      <div id="c-anon" style="display:none;min-height:300px"></div>`;

    const ghBox=wrap.querySelector('#c-gh');
    const anonBox=wrap.querySelector('#c-anon');
    let ghLoaded=false, anonLoaded=false;

    function loadGH(){
      if (ghLoaded) return; ghLoaded=true;
      ghBox.innerHTML='';
      const s=document.createElement('script');
      s.src='https://utteranc.es/client.js';
      s.setAttribute('repo','sviam-byte/kainrax-site');   // Issues –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω—ã
      s.setAttribute('issue-term', term || 'home');       // –£–ù–ò–ö–ê–õ–¨–ù–´–ô –∫–ª—é—á: story:slug / note:slug
      s.setAttribute('label','comments');
      s.setAttribute('theme', document.documentElement.getAttribute('data-theme')==='light'?'github-light':'github-dark');
      s.setAttribute('crossorigin','anonymous');
      s.async=true; ghBox.appendChild(s);
    }

    function loadAnon(){
      if (!window.CUSDIS_APP_ID){
        anonBox.innerHTML='<div class="muted">–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.</div>';
        return;
      }
      if (anonLoaded) return; anonLoaded=true;
      anonBox.innerHTML='';
      const t=document.createElement('div');
      t.id='cusdis_thread';
      t.dataset.host='https://cusdis.com';
      t.dataset.appId=window.CUSDIS_APP_ID;
      t.dataset.pageId=term || (location.pathname+location.hash); // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
      t.dataset.pageUrl=location.href;
      t.dataset.pageTitle=document.title;
      t.dataset.lang='ru';
      t.dataset.theme=(document.documentElement.getAttribute('data-theme')==='light')?'light':'dark';
      anonBox.appendChild(t);

      if (!window.__cusdisLoaded){
        const s=document.createElement('script');
        s.defer=true; s.src='https://cusdis.com/js/cusdis.es.js';
        s.onload=()=>{ window.__cusdisLoaded=true; try{ window.CUSDIS?.renderTo?.('#cusdis_thread'); setCusdisTheme(); }catch(_){} };
        document.body.appendChild(s);
      } else {
        try{ window.CUSDIS?.renderTo?.('#cusdis_thread'); setCusdisTheme(); }catch(_){}
      }
    }

    function showGH(){ ghBox.style.display='block'; anonBox.style.display='none'; loadGH(); }
    function showAnon(){ ghBox.style.display='none'; anonBox.style.display='block'; loadAnon(); }
    wrap.querySelector('#tab-gh').onclick=showGH;
    wrap.querySelector('#tab-anon').onclick=showAnon;

    // –Ω–∏—á–µ–≥–æ –Ω–µ –≥—Ä—É–∑–∏–º, –ø–æ–∫–∞ –Ω–µ –¥–æ—Å–∫—Ä–æ–ª–ª–∏–ª–∏
    const io=new IntersectionObserver((entries)=>{
      if(entries.some(e=>e.isIntersecting)){ showGH(); io.disconnect(); }
    },{rootMargin:'200px'});
    io.observe(wrap);
  }

  // —Å–º–µ–Ω–∞ —Ç–µ–º—ã —É –≤–∏–¥–∂–µ—Ç–æ–≤
  function setUtterancesTheme(theme){
    const iframe=document.querySelector('iframe.utterances-frame');
    if(iframe) iframe.contentWindow.postMessage(
      {type:'set-theme', theme:theme==='light'?'github-light':'github-dark'},
      'https://utteranc.es'
    );
  }
  function setCusdisTheme(){
    try{ window.CUSDIS?.setTheme?.(document.documentElement.getAttribute('data-theme')==='light'?'light':'dark'); }catch(_){}
  }

  /* ===== –ê–î–ú–ò–ù ¬´–ü–†–ê–í–ò–¢–¨¬ª ===== */
  const adminDock=document.getElementById('adminDock');
  const editThisBtn=document.getElementById('editThisBtn');
  function adminDockHide(){ adminDock.style.display='none'; }
  function adminDockFor(kind, slug){
    if (!isAdmin) return adminDockHide();
    if(kind==='story') editThisBtn.href=`/admin/#/collections/stories/entries/${slug}`;
    else if(kind==='note') editThisBtn.href=`/admin/#/collections/notes/entries/${slug}`;
    adminDock.style.display='block';
  }

  /* ===== –ü–†–û–ì–†–ï–°–° + –í–û–°–°–¢. –°–ö–†–û–õ–õ–ê ===== */
  const progress=document.getElementById('progress'); let ticking=false;
  function onScroll(){
    if(ticking) return; ticking=true; requestAnimationFrame(()=>{
      const art=document.querySelector('article');
      if(!art){progress.style.width='0%'; ticking=false; return;}
      const total=art.scrollHeight - window.innerHeight + 1;
      const pct=Math.min(100, Math.max(0, ((window.scrollY - art.offsetTop) / total)*100));
      progress.style.width=(isFinite(pct)?pct:0)+'%';
      const id=art.dataset.slug||art.dataset.id; if(id){ localStorage.setItem('read:'+id, window.scrollY); }
      ticking=false;
    });
  }
  addEventListener('scroll', onScroll, {passive:true});
  function restoreScroll(){
    const art=document.querySelector('article'); if(!art) return;
    const id=art.dataset.slug||art.dataset.id;
    const y=+localStorage.getItem('read:'+id)||0; if(y>0) setTimeout(()=>scrollTo({top:y,behavior:'instant'}),0);
  }

  /* ===== –ó–í–Å–ó–î–´ (–ª—ë–≥–∫–∏–µ + respect reduced motion) ===== */
  const canvas=document.getElementById('stars'); const ctx=canvas.getContext('2d');
  let W,H,starsArr=[], running=true;
  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; makeStars(); if(prefersReduced){ drawStars(0,true); } }
  addEventListener('resize', resize);

  function makeStars(){
    const base = document.documentElement.getAttribute('data-theme')==='light' ? 60 : 120;
    const k = (W*H)/30000;
    const count = Math.floor(base + k);
    starsArr = Array.from({length: count}, ()=>({
      x: Math.random()*W, y: Math.random()*H, r: Math.random()*1.1+0.3, s: Math.random()*0.5+0.2
    }));
  }

  function drawStars(ts, once=false){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--star').trim() || 'rgba(255,255,255,.9)';
    for(const st of starsArr){
      const a = once ? 0.7 : 0.5 + Math.sin((ts/1200)*st.s + st.x*0.002)*0.4;
      ctx.globalAlpha = a;
      ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI*2); ctx.fill();
    }
    if(!once && !prefersReduced && running) requestAnimationFrame(drawStars);
  }
  document.addEventListener('visibilitychange',()=>{ running = document.visibilityState==='visible'; if(running && !prefersReduced) requestAnimationFrame(drawStars); });

  function render(){
    const r=state.route;
    if(r==='/'||r===''){ renderList(); return; }
    if(r==='/about'){ renderAbout(); return; }
    if(r==='/arcs'){ renderArcs(); return; }
    const mRead=r.match(/^\/read\/(.+)$/); if(mRead){ renderArticle(mRead[1]); return; }
    const mArc=r.match(/^\/arc\/(.+)$/); if(mArc){ renderArc(mArc[1]); return; }
    const mTag=r.match(/^\/tag\/(.+)$/); if(mTag){ renderTag(decodeURIComponent(mTag[1])); return; }
    const mNote=r.match(/^\/note\/(.+)$/); if(mNote){ renderNote(mNote[1]); return; }
    if(r==='/notes'){ renderNotes(); return; }
    renderList();
  }

  loadContent().then(()=>{ applyTheme(); render(); ensureAdminUI(); resize(); if(!prefersReduced) requestAnimationFrame(drawStars); });
  </script>
</body>
</html>
