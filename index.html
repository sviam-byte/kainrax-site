<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–π—Ä–Ω–∞–∫—Å ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã</title>
  <meta name="description" content="–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –í–µ—Ç–∫–∏, —Ç–µ–≥–∏, –∑–∞–º–µ—Ç–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏." />
  <meta name="theme-color" content="#0b0f14" />
  <style>
  /* ===== TOKENS ===== */
  :root{
    --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa5b1;
    --card:rgba(16,21,32,.85); --line:#243447;
    --accent:#7dd3fc; --accent2:#a78bfa; --link:#93c5fd;
    --max:960px; --r:14px; --shadow:0 12px 36px rgba(0,0,0,.45);
    --code:#0a0e16; --mountain:#121723; --star:rgba(255,255,255,.9);
  }
  [data-theme="light"]{
    --bg:#f7fbff; --fg:#0b0f14; --muted:#5a6774;
    --card:rgba(255,255,255,.92); --line:#e6ecf2;
    --accent:#0ea5e9; --accent2:#7c3aed; --link:#1d4ed8;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --code:#f6f8fb; --mountain:#dfe7f3; --star:rgba(10,20,40,.85);
  }
  /* CRINGE (–Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –ø–µ—Ä–µ–±–æ—Ä) */
  [data-theme="cringe"]{
    --bg:linear-gradient(135deg,#ffb6f3,#ffd699 50%,#b3f1ff);
    --fg:#111; --muted:#333; --card:rgba(255,255,255,.88); --line:#ffd1f4;
    --accent:#ff3ea5; --accent2:#07f49e; --link:#7c00ff;
    --shadow:0 14px 40px rgba(0,0,0,.25); --code:#fff5ff; --mountain:#ffc6fb;
  }

  /* ===== BASE ===== */
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;
  }
  [data-theme="cringe"] body{font-family:"Comic Sans MS","Impact",system-ui,sans-serif}
  a{color:var(--link)}
  h1{margin:6px 0 10px;font-size:28px} h2{margin:6px 0 8px} h3{margin:6px 0 8px}
  .muted{color:var(--muted)}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--r); padding:18px; box-shadow:var(--shadow)}
  .btn,button{border:1px solid var(--line); background:var(--card); color:var(--fg); padding:8px 12px; border-radius:10px; cursor:pointer; text-decoration:none; box-shadow:var(--shadow)}
  input[type="search"]{padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--fg)}

  /* ===== LAYOUT ===== */
  header{
    position:sticky; top:0; z-index:5;
    background:linear-gradient(to bottom, rgba(15,21,32,.9), rgba(15,21,32,.65));
    backdrop-filter: blur(10px) saturate(1.1);
    border-bottom:1px solid var(--line);
  }
  [data-theme="light"] header{background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,.75))}
  [data-theme="cringe"] header{background:linear-gradient(90deg, rgba(255,255,255,.9), rgba(255,255,255,.6))}
  .head{max-width:var(--max); margin:0 auto; padding:12px 16px; display:flex; gap:10px; align-items:center}
  .brand{font-weight:800; letter-spacing:.2px}
  .brand a{color:var(--fg); text-decoration:none}
  .search{flex:1; display:flex; gap:8px; align-items:center}
  main{max-width:var(--max); margin:0 auto; padding:20px 16px 80px; position:relative; z-index:1}
  .grid{display:grid; grid-template-columns:1fr; gap:16px}
  @media (min-width:900px){ .grid{grid-template-columns:1.15fr .85fr; gap:22px} }
  .list{display:flex; flex-direction:column; gap:12px}
  .story-item{padding:14px; border-radius:12px; background:linear-gradient(180deg, rgba(125,211,252,.08), transparent); border:1px solid rgba(125,211,252,.18)}
  .story-item a{color:var(--fg); text-decoration:none}
  .title{font-weight:700}
  .prose{font-family: Georgia, "Times New Roman", serif; font-size:18px; line-height:1.75}
  .prose p{margin:0 0 14px}
  .tag{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); font-size:12px; margin-right:6px}
  .back{display:inline-flex; align-items:center; gap:8px; margin:6px 0 12px}
  .progress{position:fixed; left:0; top:0; height:3px; background:linear-gradient(90deg, var(--accent), var(--accent2)); width:0; z-index:6}

  /* ===== BACKGROUND: STARS + MOUNTAINS ===== */
  #stars{position:fixed; inset:0; z-index:0; pointer-events:none}
  #mountains{position:fixed; left:0; right:0; bottom:0; height:30vh; z-index:0; pointer-events:none; opacity:.9}
  #mountains svg{width:100%; height:100%; display:block}
  #mountains path{fill:var(--mountain)}
  [data-theme="cringe"] #mountains path{filter:drop-shadow(0 0 12px rgba(255,0,255,.35))}

  /* ===== ADMIN BAR ===== */
  #adminBtns{display:none; gap:8px; align-items:center}
  #adminDock{position:fixed; right:14px; bottom:14px; z-index:7; display:none}
  #adminDock .btn{background:var(--card)}

  /* ===== CRINGE EXTRA ===== */
  [data-theme="cringe"] .sparkles:after{
    content:"‚ú®üí•ü¶Ñ‚ú®"; position:fixed; right:12px; bottom:12px; font-size:22px; animation: spin 8s linear infinite; opacity:.9; pointer-events:none
  }
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  </style>
  <!-- Netlify Identity widget, —á—Ç–æ–±—ã –Ω–∞ —Å–∞–π—Ç–µ –ø–æ–Ω–∏–º–∞—Ç—å ¬´–≤–æ—à—ë–ª/–Ω–µ—Ç¬ª -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div id="mountains" aria-hidden="true">
    <svg viewBox="0 0 100 30" preserveAspectRatio="none">
      <path d="M0,25 L10,18 L20,22 L30,14 L40,20 L50,10 L60,19 L70,13 L80,22 L90,16 L100,23 L100,30 L0,30 Z"/>
    </svg>
  </div>

  <div class="progress" id="progress"></div>

  <header class="sparkles">
    <div class="head">
      <div class="brand"><a href="#/">–ö–∞–π—Ä–Ω–∞–∫—Å</a></div>
      <div class="search" style="max-width:600px">
        <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–∞—Å—Å–∫–∞–∑–∞–º‚Ä¶" aria-label="–ü–æ–∏—Å–∫" />
        <a class="btn" href="#/arcs">–í–µ—Ç–∫–∏</a>
        <a class="btn" href="#/notes">–ó–∞–º–µ—Ç–∫–∏</a>
        <a class="btn" href="#/about">–û –º–∏—Ä–µ</a>
        <button id="themeBtn" title="–¢–µ–º–∞">üåì</button>
        <span id="adminBtns">
          <a class="btn" href="/admin/" target="_blank" rel="noopener">–ê–¥–º–∏–Ω–∫–∞</a>
          <a class="btn" id="newStoryBtn"  target="_blank" rel="noopener">+ –†–∞—Å—Å–∫–∞–∑</a>
          <a class="btn" id="newNoteBtn"   target="_blank" rel="noopener">+ –ó–∞–º–µ—Ç–∫–∞</a>
        </span>
      </div>
    </div>
  </header>

  <!-- –ü–ª–∞–≤–∞—é—â–∞—è ¬´‚úèÔ∏è –ü—Ä–∞–≤–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç¬ª (—Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã—Ö) -->
  <div id="adminDock"><a class="btn" id="editThisBtn" target="_blank" rel="noopener">‚úèÔ∏è –ü—Ä–∞–≤–∏—Ç—å</a></div>

  <main id="app" aria-live="polite"></main>

  <script>
  /* ======= CONFIG ======= */
  // –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ‚Äî –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ App ID –∏–∑ Cusdis (–∏–Ω–∞—á–µ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º)
  window.CUSDIS_APP_ID = "";

  /* ======= STATE & DATA ======= */
  const state={ theme: localStorage.getItem('theme') || 'dark', route: location.hash.slice(1)||'/', q:'' };
  const app=document.getElementById('app'); const qEl=document.getElementById('q');

  // === –í–ï–¢–ö–ò (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ) ===
  // 1) –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å: –ò–æ–Ω–∞ + ¬´–¶–≤–µ—Ç–æ–∫¬ª
  // 2) –ö–∞–π–Ω—Ä–∞–∫—Å: –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Å–∫–∞–∑—ã
  // 3) –ò–ë–£–¢
  const arcs=[
    { id:'surface', title:'–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å', desc:'–ò–æ–Ω–∞ –∏ ¬´–¶–≤–µ—Ç–æ–∫¬ª (–ø–æ–≤–µ—Å—Ç—å ‚Äî –∑–∞–≥–ª—É—à–∫–∞).', order:['epitimya','tsvetok'] },
    { id:'kainrax', title:'–ö–∞–π–Ω—Ä–∞–∫—Å',   desc:'–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Å–∫–∞–∑—ã –∏–∑ –º–∏—Ä–∞ –ö–∞–π–Ω—Ä–∞–∫—Å–∞.',  order:['dorogovato','chelovecheskiy-faktor'] },
    { id:'ibut',    title:'–ò–ë–£–¢',       desc:'–õ—ë–≥–∫–æ–µ —á—Ç–∏–≤–æ –ø—Ä–æ –º–∏—Ä –ø–æ–ø–∞–¥–∞–Ω—Ü–µ–≤.',        order:['ibut-g1','ibut-g2'] }
  ];

  // Fallback-–∫–æ–Ω—Ç–µ–Ω—Ç (–µ—Å–ª–∏ JSON –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è)
  let stories=[
    { id:'epitimya', title:'–ï–ø–∏—Ç–∏–º—å—è', date:'2025-08-01', minutes:12, tags:['–ö–∞–π—Ä–Ω–∞–∫—Å','–ò–æ–Ω–∞','DOMINUS'], arc:'surface', text:'–ó–ê–ì–õ–£–®–ö–ê: –í–°–¢–ê–í–ò–¢–¨ –¢–ï–ö–°–¢ (–ï–ø–∏—Ç–∏–º—å—è)'},
    { id:'tsvetok', title:'–¶–≤–µ—Ç–æ–∫ (–ø–æ–≤–µ—Å—Ç—å, –∑–∞–≥–ª—É—à–∫–∞)', date:'2025-08-08', minutes:30, tags:['–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å','–ò–æ–Ω–∞','–ø–æ–≤–µ—Å—Ç—å'], arc:'surface', text:'–ó–ê–ì–õ–£–®–ö–ê: –í–°–¢–ê–í–ò–¢–¨ –¢–ï–ö–°–¢ (–¶–≤–µ—Ç–æ–∫). –ö–æ—Ä–æ—Ç–∫–∏–π —Å–∏–Ω–æ–ø—Å–∏—Å: –ò–æ–Ω–∞ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å, –≥–¥–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç ¬´–¶–≤–µ—Ç–æ–∫¬ª ‚Äî –æ–±—ä–µ–∫—Ç, –º–µ–Ω—è—é—â–∏–π –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ—Å–µ–ª–µ–Ω–∏–π.'},
    { id:'dorogovato', title:'–î–æ—Ä–æ–≥–æ–≤–∞—Ç–æ', date:'2025-07-25', minutes:10, tags:['–ª–∏–Ω–∏–∏','R-—Å–µ–∫—Ç–æ—Ä','–ê—Å—Å–∏'], arc:'kainrax', text:'–ó–ê–ì–õ–£–®–ö–ê: –í–°–¢–ê–í–ò–¢–¨ –¢–ï–ö–°–¢ (–î–æ—Ä–æ–≥–æ–≤–∞—Ç–æ)'},
    { id:'chelovecheskiy-faktor', title:'–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä', date:'2025-07-23', minutes:9, tags:['–∏–Ω–∂–µ–Ω–µ—Ä–∏—è','B-—Å–µ–∫—Ç–æ—Ä','–ì–∏–¥–µ–æ–Ω'], arc:'kainrax', text:'–ó–ê–ì–õ–£–®–ö–ê: –í–°–¢–ê–í–ò–¢–¨ –¢–ï–ö–°–¢ (–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä)'},
    { id:'ibut-g1', title:'–ò–ë–£–¢ ‚Äî –≥–ª–∞–≤–∞ 1', date:'2025-08-08', minutes:8, tags:['–ò–ë–£–¢','–ø–æ–ø–∞–¥–∞–Ω—Ü—ã'], arc:'ibut', text:'–ó–ê–ì–õ–£–®–ö–ê: –í–°–¢–ê–í–ò–¢–¨ –¢–ï–ö–°–¢ (–ò–ë–£–¢ ‚Äî –≥–ª–∞–≤–∞ 1)'},
    { id:'ibut-g2', title:'–ò–ë–£–¢ ‚Äî –≥–ª–∞–≤–∞ 2', date:'2025-08-08', minutes:8, tags:['–ò–ë–£–¢','–ø–æ–ø–∞–¥–∞–Ω—Ü—ã'], arc:'ibut', text:'–ó–ê–ì–õ–£–®–ö–ê: –í–°–¢–ê–í–ò–¢–¨ –¢–ï–ö–°–¢ (–ò–ë–£–¢ ‚Äî –≥–ª–∞–≤–∞ 2)'}
  ];
  let notes=[ { id:'n-2025-08-08-a', title:'–û —Ç–æ–Ω–µ –∏ —Ç–µ–º–ø–µ ¬´–ö–∞–π—Ä–Ω–∞–∫—Å–∞¬ª', date:'2025-08-08', text:'–ó–ê–ì–õ–£–®–ö–ê: –í–°–¢–ê–í–ò–¢–¨ –¢–ï–ö–°–¢ (–∑–∞–º–µ—Ç–∫–∞ –æ —Ç–æ–Ω–µ).' } ];

  async function loadContent(){
    try{
      const [s,n]=await Promise.all([
        fetch('content/stories.json',{cache:'no-store'}).then(r=>r.ok?r.json():{stories}),
        fetch('content/notes.json',{cache:'no-store'}).then(r=>r.ok?r.json():{notes})
      ]);
      stories=s.stories||stories; notes=n.notes||notes;
    }catch(_){}
  }

  /* ======= THEME ======= */
  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme);
    localStorage.setItem('theme', state.theme);
    setUtterancesTheme(state.theme);
  }
  applyTheme();
  document.getElementById('themeBtn').onclick=()=>{
    state.theme = state.theme==='dark' ? 'light' : (state.theme==='light' ? 'cringe' : 'dark');
    applyTheme();
  };

  /* ======= ROUTER ======= */
  addEventListener('hashchange',()=>{ state.route=location.hash.slice(1)||'/'; render(); restoreScroll(); });
  qEl.addEventListener('input',()=>{ state.q=qEl.value.trim().toLowerCase(); renderList(); });

  const arcById=id=>arcs.find(a=>a.id===id)||{title:'–í–µ—Ç–∫–∞',order:[]};
  const fmtDate=iso=>{ try{const d=new Date(iso);return d.toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'});}catch(_){return iso} };

  /* ======= VIEWS ======= */
  function renderList(){
    const q=state.q;
    const items=stories.filter(s=>!q || s.title.toLowerCase().includes(q) || s.text.toLowerCase().includes(q) || (s.tags||[]).join(' ').toLowerCase().includes(q));
    app.innerHTML=`
      <div class="grid">
        <section class="card">
          <h1>–†–∞—Å—Å–∫–∞–∑—ã</h1>
          <div class="muted">–ö–æ—Ä–æ—Ç–∫–∞—è –ù–§ –±–µ–∑ –ª–æ—Ä–æ–≤–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞. –í—ã–±–∏—Ä–∞–π –∏ —á–∏—Ç–∞–π.</div>
          <div class="list">
            ${items.map(s=>{
              const ex=s.text.replace(/\n+/g,' ').slice(0,130).trim()+(s.text.length>130?'‚Ä¶':'');
              return `<div class="story-item">
                <a href="#/read/${s.id}">
                  <div class="title">${s.title}</div>
                  <div class="muted">${fmtDate(s.date)} ¬∑ ${s.minutes} –º–∏–Ω —á—Ç–µ–Ω–∏—è ¬∑ –≤–µ—Ç–∫–∞: ${arcById(s.arc).title}</div>
                  <div>${ex}</div>
                </a>
              </div>`;
            }).join('')}
          </div>
        </section>
        <aside class="card">
          <h2>–í–µ—Ç–∫–∏</h2>
          <div class="list">
            ${arcs.map(a=>`
              <div class="story-item">
                <a href="#/arc/${a.id}">
                  <div class="title">${a.title}</div>
                  <div class="muted">${a.order.length} —Ç–µ–∫—Å—Ç(–∞)</div>
                  <div>${a.desc}</div>
                </a>
              </div>`).join('')}
          </div>
          <h3 style="margin-top:14px">–ü–æ–¥–ø–∏—Å–∫–∞</h3>
          <p class="muted">–¢–µ–ª–µ–≥—Ä–∞–º: <a href="https://t.me/kainrax" target="_blank" rel="noopener">@kainrax</a></p>
          <p><span class="tag">–∂–∞–Ω—Ä: –ù–§</span> <span class="tag">–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ø–Ω/—á—Ç</span></p>
        </aside>
      </div>`;
    adminDockHide();
  }

  function renderArcs(){
    app.innerHTML=`<section class="card"><h1>–í–µ—Ç–∫–∏</h1>
    <div class="list">${arcs.map(a=>`
      <div class="story-item"><a href="#/arc/${a.id}">
        <div class="title">${a.title}</div>
        <div class="muted">${a.order.length} —Ç–µ–∫—Å—Ç(–∞)</div>
        <div>${a.desc}</div>
      </a></div>`).join('')}</div></section>`;
    adminDockHide();
  }

  function renderArc(id){
    const a=arcById(id); const arr=a.order.map(i=>stories.find(s=>s.id===i)).filter(Boolean);
    app.innerHTML=`<section class="card">
      <a class="back" href="#/arcs">‚Üê –ö–æ –≤—Å–µ–º –≤–µ—Ç–∫–∞–º</a>
      <h1>${a.title}</h1><div class="muted">${a.desc}</div>
      <ol class="list" style="margin-top:10px">${arr.map((s,i)=>`
        <li class="story-item"><a href="#/read/${s.id}">
          <div class="title">${i+1}. ${s.title}</div>
          <div class="muted">${fmtDate(s.date)} ¬∑ ${s.minutes} –º–∏–Ω</div>
        </a></li>`).join('')}
      </ol></section>`;
    adminDockHide();
  }

  function renderTag(tag){
    const items=stories.filter(s=> (s.tags||[]).map(t=>t.toLowerCase()).includes(tag.toLowerCase()));
    app.innerHTML=`<section class="card">
      <a class="back" href="#/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      <h1>#${tag}</h1>
      <div class="list">${items.map(s=>`
        <div class="story-item"><a href="#/read/${s.id}">
          <div class="title">${s.title}</div>
          <div class="muted">${fmtDate(s.date)} ¬∑ ${s.minutes} –º–∏–Ω ¬∑ –≤–µ—Ç–∫–∞: ${arcById(s.arc).title}</div>
        </a></div>`).join('')}</div></section>`;
    adminDockHide();
  }

  function renderNotes(){
    app.innerHTML=`<section class="card"><h1>–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –∑–∞–º–µ—Ç–∫–∏</h1>
    <div class="list">${notes.map(n=>`
      <div class="story-item"><a href="#/note/${n.id}">
        <div class="title">${n.title}</div>
        <div class="muted">${fmtDate(n.date)}</div>
      </a></div>`).join('')}</div></section>`;
    adminDockHide();
  }

  function renderNote(id){
    const n=notes.find(x=>x.id===id); if(!n){location.hash='#/notes';return;}
    app.innerHTML=`<a class="back" href="#/notes">‚Üê –ö –∑–∞–º–µ—Ç–∫–∞–º</a>
    <article class="prose" data-id="${n.id}">
      <h1>${n.title}</h1>
      <div class="muted">${fmtDate(n.date)}</div>
      ${n.text.split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}
    </article>
    <div class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></div>`;
    mountComments(); setTimeout(restoreScroll,0);
    adminDockFor('notes');
  }

  function renderAbout(){
    app.innerHTML=`<section class="card">
    <h1>–û –º–∏—Ä–µ ¬´–ö–∞–π—Ä–Ω–∞–∫—Å¬ª</h1>
    <div class="prose">
    <p><strong>–ö–∞–π—Ä–Ω–∞–∫—Å</strong> ‚Äî –ø–æ–¥–∑–µ–º–Ω–∞—è —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ —Å ¬´–ª–∏–Ω–∏—è–º–∏¬ª. –°–µ–∫—Ç–æ—Ä–∞ A/B/C/R, —É–ø—Ä—è–º–∞—è –∏–Ω–∂–µ–Ω–µ—Ä–∏—è –∏ —Å—Ç—Ä–∞–Ω–Ω—ã–µ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã.</p>
    <p>–í–µ—Ç–∫–∏: <em>–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å</em> (–ò–æ–Ω–∞, ¬´–¶–≤–µ—Ç–æ–∫¬ª), <em>–ö–∞–π–Ω—Ä–∞–∫—Å</em> (–æ—Å—Ç–∞–ª—å–Ω–æ–µ), <em>–ò–ë–£–¢</em>.</p>
    </div></section>`;
    adminDockHide();
  }

  function renderArticle(id){
    const s=stories.find(x=>x.id===id); if(!s){location.hash='#/'; return;}
    const a=arcById(s.arc), idx=a.order.indexOf(s.id);
    const prevId=idx>0? a.order[idx-1]:null, nextId=idx<a.order.length-1? a.order[idx+1]:null;

    app.innerHTML=`
      <a class="back" href="#/">‚Üê –ö —Å–ø–∏—Å–∫—É</a>
      <article class="prose" data-id="${s.id}">
        <h1>${s.title}</h1>
        <div class="muted">${fmtDate(s.date)} ¬∑ ${s.minutes} –º–∏–Ω —á—Ç–µ–Ω–∏—è ¬∑ –≤–µ—Ç–∫–∞: <a href="#/arc/${a.id}">${a.title}</a> (${idx+1}/${a.order.length})</div>
        <div style="margin:6px 0 12px">${(s.tags||[]).map(t=>`<a class='tag' href='#/tag/${encodeURIComponent(t)}'>${t}</a>`).join(' ')}</div>
        ${s.text.split(/\n\n+/).map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}
        <hr style="border:0;border-top:1px solid var(--line);margin:18px 0">
        <div style="display:flex;justify-content:space-between;gap:10px">
          ${prevId?`<a class="btn" href="#/read/${prevId}">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>`:'<span></span>'}
          ${nextId?`<a class="btn" href="#/read/${nextId}">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>`:'<span></span>'}
        </div>
      </article>
      <section class="card" style="margin-top:16px"><h3>–ü–æ—Ö–æ–∂–∏–µ</h3>
        <div class="list">${
          stories.filter(x=>x.id!==s.id && x.tags?.some(t=>s.tags?.includes(t))).slice(0,3)
          .map(p=>`<div class="story-item"><a href="#/read/${p.id}">
            <div class="title">${p.title}</div><div class="muted">${fmtDate(p.date)} ¬∑ ${p.minutes} –º–∏–Ω</div></a></div>`).join('') || '<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>'}
        </div>
      </section>
      <div class="card" style="margin-top:16px"><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><section id="comments"></section></div>`;
    mountComments(); setTimeout(restoreScroll,0);
    adminDockFor('stories');
  }

  /* ======= COMMENTS ======= */
  function mountComments(){
    const wrap=document.getElementById('comments'); if(!wrap) return;

    wrap.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button class="btn" id="tab-gh">GitHub</button>
        <button class="btn" id="tab-anon">–ê–Ω–æ–Ω–∏–º–Ω–æ</button>
      </div>
      <div id="c-gh"></div>
      <div id="c-anon" style="display:none"></div>`;

    // UTTERANCES (GitHub)
    const ghBox = wrap.querySelector('#c-gh');
    const gh = document.createElement('script');
    gh.src = 'https://utteranc.es/client.js';
    gh.setAttribute('repo','sviam-byte/kainrax-site');
    gh.setAttribute('issue-term','pathname');
    gh.setAttribute('theme', document.documentElement.getAttribute('data-theme')==='light' ? 'github-light' : 'github-dark');
    gh.setAttribute('crossorigin','anonymous');
    gh.async = true;
    ghBox.appendChild(gh);

    // CUSDIS (–∞–Ω–æ–Ω–∏–º–Ω–æ)
    const anonBox = wrap.querySelector('#c-anon');
    anonBox.innerHTML = '';
    if (window.CUSDIS_APP_ID){
      const thread = document.createElement('div');
      thread.id = 'cusdis_thread';
      thread.dataset.host = 'https://cusdis.com';
      thread.dataset.appId = window.CUSDIS_APP_ID;
      thread.dataset.pageId = location.pathname + location.hash;
      thread.dataset.pageUrl = location.href;
      thread.dataset.pageTitle = document.title;
      anonBox.appendChild(thread);

      const s = document.createElement('script');
      s.defer = true;
      s.src = 'https://cusdis.com/js/cusdis.es.js';
      anonBox.appendChild(s);
    } else {
      anonBox.innerHTML = '<div class="muted">–ê–Ω–æ–Ω–∏–º–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã. –î–æ–±–∞–≤—å Cusdis App ID –≤–≤–µ—Ä—Ö—É index.html.</div>';
    }

    // Tabs (–µ—Å–ª–∏ –µ—Å—Ç—å Cusdis ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–Ω–∞—á–∞–ª–∞ ¬´–ê–Ω–æ–Ω–∏–º–Ω–æ¬ª)
    const tabGh   = wrap.querySelector('#tab-gh');
    const tabAnon = wrap.querySelector('#tab-anon');
    function showGh(){ ghBox.style.display='block'; anonBox.style.display='none'; }
    function showAnon(){ ghBox.style.display='none';  anonBox.style.display='block'; }
    tabGh.onclick=showGh; tabAnon.onclick=showAnon;
    if(window.CUSDIS_APP_ID){ showAnon(); } else { showGh(); }
  }

  function setUtterancesTheme(theme){
    const iframe=document.querySelector('iframe.utterances-frame');
    if(!iframe) return;
    iframe.contentWindow.postMessage({type:'set-theme', theme: theme==='light'?'github-light':'github-dark'}, 'https://utteranc.es');
  }

  /* ======= ADMIN SHORTCUTS (–≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º —á–µ—Ä–µ–∑ Netlify Identity) ======= */
  const adminBtns=document.getElementById('adminBtns');
  const adminDock=document.getElementById('adminDock');
  const editThisBtn=document.getElementById('editThisBtn');
  const newStoryBtn=document.getElementById('newStoryBtn');
  const newNoteBtn=document.getElementById('newNoteBtn');

  function adminDockHide(){ adminDock.style.display='none'; }
  function adminDockFor(kind){
    if(!window.netlifyIdentity || !window.netlifyIdentity.currentUser()){ adminDockHide(); return; }
    editThisBtn.href = kind==='stories'
      ? '/admin/#/collections/stories/entries/stories_root'
      : '/admin/#/collections/notes/entries/notes_root';
    adminDock.style.display='block';
  }

  function setupIdentity(){
    const id=window.netlifyIdentity; if(!id) return;
    function toggle(user){
      const on=!!user;
      adminBtns.style.display = on ? 'flex' : 'none';
      newStoryBtn.href = '/admin/#/collections/stories/entries/stories_root';
      newNoteBtn.href  = '/admin/#/collections/notes/entries/notes_root';
      if(!on) adminDockHide();
    }
    id.on('init', toggle); id.on('login', u=>{toggle(u); location.reload();}); id.on('logout', ()=>{toggle(null); location.reload();});
    id.init();
  }
  setupIdentity();

  /* ======= PROGRESS BAR & SCROLL ======= */
  const progress=document.getElementById('progress'); let ticking=false;
  function onScroll(){
    if(ticking) return; ticking=true; requestAnimationFrame(()=>{
      const art=document.querySelector('article');
      if(!art){progress.style.width='0%'; ticking=false; return;}
      const total=art.scrollHeight - window.innerHeight + 1;
      const pct=Math.min(100, Math.max(0, ((window.scrollY - art.offsetTop) / total)*100));
      progress.style.width=(isFinite(pct)?pct:0)+'%';
      const id=art.dataset.id; if(id){ localStorage.setItem('read:'+id, window.scrollY); }
      ticking=false;
    });
  }
  addEventListener('scroll', onScroll, {passive:true});
  function restoreScroll(){
    const art=document.querySelector('article'); if(!art) return;
    const y=+localStorage.getItem('read:'+art.dataset.id)||0; if(y>0) setTimeout(()=>scrollTo({top:y,behavior:'instant'}),0);
  }

  /* ======= STARS ======= */
  const canvas=document.getElementById('stars'); const ctx=canvas.getContext('2d');
  let W,H,starsArr=[];
  function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; makeStars(); }
  addEventListener('resize', resize);
  function makeStars(){
    const density = state.theme==='light' ? 120 : 220;
    starsArr = Array.from({length: Math.floor((W*H)/14000) + density}, ()=>({
      x: Math.random()*W, y: Math.random()*H, r: Math.random()*1.5+0.2, s: Math.random()*0.8+0.2
    }));
  }
  function drawStars(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--star').trim() || 'rgba(255,255,255,.9)';
    for(const st of starsArr){
      ctx.globalAlpha = 0.6 + Math.sin((performance.now()/1000)*st.s + st.x)*0.4;
      ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI*2); ctx.fill();
    }
    requestAnimationFrame(drawStars);
  }
  resize(); requestAnimationFrame(drawStars);

  /* ======= BOOT ======= */
  function render(){
    const r=state.route;
    if(r==='/'||r===''){ renderList(); return; }
    if(r==='/about'){ renderAbout(); return; }
    if(r==='/arcs'){ renderArcs(); return; }
    const mRead=r.match(/^\/read\/(.+)$/); if(mRead){ renderArticle(mRead[1]); return; }
    const mArc=r.match(/^\/arc\/(.+)$/); if(mArc){ renderArc(mArc[1]); return; }
    const mTag=r.match(/^\/tag\/(.+)$/); if(mTag){ renderTag(decodeURIComponent(mTag[1])); return; }
    const mNote=r.match(/^\/note\/(.+)$/); if(mNote){ renderNote(mNote[1]); return; }
    if(r==='/notes'){ renderNotes(); return; }
    renderList();
  }
  loadContent().then(()=>{ applyTheme(); render(); });
  </script>
</body>
</html>
