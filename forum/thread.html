<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Тема — Доска сектора</title>
  <meta name="theme-color" content="#0b0f14"/>
  <link rel="stylesheet" href="/assets/forum.css"/>
  <script defer data-domain="forum.kainrax.site" src="https://plausible.io/js/script.js"></script>
  <style>
    /* Ползущая линия свода */
    #sky-line{
      position:fixed;left:0;right:0;height:3px;z-index:0;pointer-events:none;opacity:.7;filter:blur(1px);
      background:radial-gradient(ellipse 80% 150% at 50% 50%, rgba(125,211,252,.9) 0%, transparent 40%);
    }
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>

  <header class="kx-head">
    <a class="kx-brand" href="/index.html">Доска Кайнракс</a>
    <nav class="kx-nav">
      <a class="kx-btn" href="/index.html">Темы</a>
      <a class="kx-btn" href="https://kainrax.site/">К рассказам</a>
    </nav>
  </header>

  <main class="kx-shell">
    <article id="post" class="kx-panel">Загрузка…</article>
  </main>

  <script type="module">
    /* ===== Линия свода (по времени суток) ===== */
    (function sky(){
      const el=document.getElementById('sky-line'); let run=true;
      function tick(){
        const n=new Date();
        const ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds();
        el.style.top=(ms/86400000*100)+'vh';
        if(run) requestAnimationFrame(tick);
      }
      document.addEventListener('visibilitychange',()=>{run=document.visibilityState==='visible'; if(run) requestAnimationFrame(tick);});
      requestAnimationFrame(tick);
    })();

    /* ===== Дата "N-й день YYYY-го года, HH:MM" ===== */
    function fmtDayYear(s){
      if(!s) return '';
      // ISO -> DOY
      if(/^\d{4}-\d{2}-\d{2}/.test(s)){
        const d=new Date(s);
        const yy=d.getUTCFullYear();
        const start=new Date(Date.UTC(yy,0,1));
        const doy=Math.floor((d-start)/86400000)+1;
        const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0');
        return `${doy}-й день ${yy}-го года, ${hh}:${mm}`;
      }
      // "YYYY DOY [HH:MM]" или "YYYY-DOY"
      const m=String(s).trim().match(/^(\d{4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if(m){
        const yy=+m[1], doy=+m[2];
        const hh=m[3]?m[3].padStart(2,'0'):'00'; const mm=m[4]?m[4]:'00';
        return `${doy}-й день ${yy}-го года, ${hh}:${mm}`;
      }
      return s;
    }

    /* ===== Утилиты ===== */
    function getId(){ return decodeURIComponent(location.hash.replace(/^#\/?/,'')).trim(); }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
    async function fetchJSON(url){
      const r=await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }

    /* ===== Рендер темы ===== */
    async function render(){
      const box=document.getElementById('post');
      const id=getId();
      if(!id){ box.textContent='Тема не указана.'; return; }

      try{
        const t = await fetchJSON(`/content/threads/${id}.json`);
        document.title = `${t.title} — Доска сектора`;

        const when = fmtDayYear(t.created);
        const tags = (t.tags||[]).map(x=>`<span class="kx-tag">${escapeHTML(x)}</span>`).join(' ');
        const body = (t.body||'').split(/\n\n+/).map(p=>`<p>${escapeHTML(p)}</p>`).join('');

        box.innerHTML = `
          <h1>${escapeHTML(t.title||id)}</h1>
          <div class="kx-muted">${when} · ${escapeHTML(t.author||'anon')} · сектор: ${escapeHTML(t.sector||'—')}${t.board?` · раздел: ${escapeHTML(t.board)}`:''}</div>
          <div class="kx-tags" style="margin:8px 0 14px">${tags}</div>
          ${body}
          <hr class="kx-hr">
          <div id="related"></div>
          <h3 style="margin-top:12px">Комментарии</h3>
          <div id="comments"></div>
        `;

        // Связанные темы: дети и "соседи" по rootId
        try{
          const idx = await fetchJSON('/content/threads-index.json');
          const kids = idx.filter(x=>x.parentId === t.id);
          const siblings = t.parentId ? idx.filter(x=>x.parentId === t.parentId && x.id !== t.id) : [];
          let html='';
          if(kids.length){
            html += `<div><strong>Подтемы:</strong><ul>${kids.map(x=>`<li><a href="/thread.html#/${x.id}">${escapeHTML(x.title)}</a></li>`).join('')}</ul></div>`;
          }
          if(siblings.length){
            html += `<div style="margin-top:6px"><strong>Связанные темы:</strong><ul>${siblings.map(x=>`<li><a href="/thread.html#/${x.id}">${escapeHTML(x.title)}</a></li>`).join('')}</ul></div>`;
          }
          document.getElementById('related').innerHTML = html || '';
        }catch(_){ /* молча, если индекса нет */ }

        // Комменты (Cusdis анонимно)
        const d=document.createElement('div');
        d.id='cusdis_thread';
        d.dataset.host='https://cusdis.com';
        d.dataset.appId='079685b7-f335-4fbd-9217-9d857a3cc369';
        d.dataset.pageId='thread:'+(t.id||id);
        d.dataset.pageTitle=t.title||id;
        d.dataset.lang='ru';
        document.getElementById('comments').appendChild(d);
        const s=document.createElement('script'); s.defer=true; s.src='https://cusdis.com/js/cusdis.es.js';
        document.body.appendChild(s);

      }catch(e){
        box.innerHTML = `<div class="kx-muted">Тема не найдена. Проверь путь <code>/content/threads/${escapeHTML(id)}.json</code> и корректность JSON.</div>`;
      }
    }

    addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
