<!doctype html>
<html lang="ru" data-theme="subsurface">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Тема — Доска сектора</title>
  <meta name="theme-color" content="#0b0f14"/>

  <!-- Фавикон: svg + fallback -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%237dd3fc'/%3E%3Cstop offset='70%25' stop-color='%230b0f14' stop-opacity='.05'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%230b0f14'/%3E%3Cpath d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z' fill='url(%23g)'/%3E%3Ccircle cx='32' cy='32' r='2.4' fill='%23a78bfa'/%3E%3C/svg%3E" />
  <link rel="icon" type="image/png" sizes="64x64" href="/assets/icon-64.png" />

  <!-- общий стиль тематики (без внешних комментов) -->
  <style>
    :root{
      --bg:#0b0f14; --bg-soft:#111720; --panel:#0f1620; --text:#e6edf5; --muted:#9fb0c7;
      --brand:#7dd3fc; --tag:#1b2735; --tag-on:#274056; --ring:#a78bfa; --card:#0e141d; --link:#bfe9ff;
      --radius:14px; --shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 8px 30px rgba(0,0,0,.35);
    }
    /* Тема 1: Subsurface Lab */
    html[data-theme="subsurface"]{
      --bg:#0b0f14; --bg-soft:#0f1620; --panel:#0e141d; --card:#0e141d;
      --text:#e6edf5; --muted:#9fb0c7; --brand:#7dd3fc; --link:#bfe9ff;
      --tag:#112131; --tag-on:#183140; --ring:#7dd3fc;
    }
    /* Тема 2: Archive Sepia */
    html[data-theme="sepia"]{
      --bg:#0e0b09; --bg-soft:#14100d; --panel:#16120d; --card:#17120e;
      --text:#ece3d3; --muted:#bdae95; --brand:#d2b48c; --link:#f3d7a6;
      --tag:#2a2218; --tag-on:#3a2f21; --ring:#d6b778;
    }
    /* Тема 3: Glitch Basilica */
    html[data-theme="glitch"]{
      --bg:#07090d; --bg-soft:#0b0f16; --panel:#0c121b; --card:#0c121b;
      --text:#e8f0ff; --muted:#9fb6d6; --brand:#a78bfa; --link:#b9a4ff;
      --tag:#0d1a2a; --tag-on:#14253a; --ring:#a78bfa;
    }

    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; letter-spacing:.1px}
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    .kx-head{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
      backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .kx-brand{font-weight:700; letter-spacing:.4px; color:var(--text)}
    .kx-nav{display:flex; gap:8px; align-items:center}
    .kx-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:12px; background:var(--tag);
      border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow);
      color:var(--text); text-decoration:none; transition:transform .08s ease;
    }
    .kx-btn:hover{transform:translateY(-1px)}
    .is-active{outline:2px solid var(--ring)}

    .kx-cta{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)), var(--tag-on);
      border-color:rgba(255,255,255,.12); font-weight:600;
    }
    .tg-ico{width:16px; height:16px; display:inline-block; vertical-align:-2px}

    .kx-shell{max-width:900px; margin:0 auto; padding:16px}
    .kx-panel{
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--panel);
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px;
    }
    h1{margin:4px 0 8px 0; font-size:24px}
    .kx-muted{color:var(--muted); font-size:14px}
    .kx-tags{display:flex; flex-wrap:wrap; gap:6px; margin:10px 0 0}
    .kx-tag{
      display:inline-flex; align-items:center; padding:4px 8px; border-radius:10px;
      background:var(--tag); color:var(--muted); font-size:12px; border:1px solid rgba(255,255,255,.06)
    }
    .kx-hr{border:0; height:1px; background:rgba(255,255,255,.08); margin:16px 0}

    /* Ползущая линия свода */
    #sky-line{
      position:fixed; left:0; right:0; height:3px; z-index:0; pointer-events:none; opacity:.7; filter:blur(1px);
      background:radial-gradient(ellipse 80% 150% at 50% 50%, var(--brand) 0%, transparent 40%);
    }

    /* Еле заметные гличи для темы glitch */
    html[data-theme="glitch"] article.kx-panel{
      background:
        linear-gradient(180deg, rgba(255,255,255,.02), transparent),
        var(--panel);
      position:relative;
    }
    html[data-theme="glitch"] article.kx-panel::after{
      content:""; position:absolute; inset:0; opacity:.06; pointer-events:none;
      background:
        repeating-linear-gradient(180deg, rgba(167,139,250,.25) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(90deg, rgba(125,211,252,.15) 0 2px, transparent 2px 4px);
      mix-blend-mode:screen;
    }
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>

  <header class="kx-head">
    <a class="kx-brand" href="/index.html">Доска Кайнракс</a>
    <nav class="kx-nav">
      <a class="kx-btn" href="/index.html">Темы</a>
      <a class="kx-btn" href="https://kainrax.netlify.app/">К проекту</a>

      <!-- Подписка / TG -->
      <a class="kx-btn kx-cta" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow" aria-label="Подписаться на канал в Telegram">
        <svg class="tg-ico" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9.75 15.5 9.9 12.7l6.1-5.52c.28-.25-.07-.37-.43-.17l-7.54 4.75-3.16-1c-.69-.22-.7-.68.15-1.02l12.34-4.76c.57-.21 1.12.14.93 1.02l-2.1 9.89c-.14.65-.52.8-1.05.5l-2.91-2.15-1.4 1.36c-.16.16-.3.3-.6.3z" fill="currentColor"/>
        </svg>
        <span>Подписаться</span>
      </a>
      <a class="kx-btn" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow" aria-label="Открыть Telegram-канал">
        <svg class="tg-ico" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9.75 15.5 9.9 12.7l6.1-5.52c.28-.25-.07-.37-.43-.17l-7.54 4.75-3.16-1c-.69-.22-.7-.68.15-1.02l12.34-4.76c.57-.21 1.12.14.93 1.02l-2.1 9.89c-.14.65-.52.8-1.05.5l-2.91-2.15-1.4 1.36c-.16.16-.3.3-.6.3z" fill="currentColor"/>
        </svg>
        <span>TG</span>
      </a>
    </nav>
  </header>

  <main class="kx-shell">
    <article id="post" class="kx-panel">Загрузка…</article>
  </main>

  <script type="module">
    /* ===== Полоса неба ===== */
    (function sky(){
      const el=document.getElementById('sky-line'); let run=true;
      function tick(){
        const n=new Date();
        const ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds();
        el.style.top=(ms/86400000*100)+'vh';
        if(run) requestAnimationFrame(tick);
      }
      document.addEventListener('visibilitychange',()=>{run=document.visibilityState==='visible'; if(run) requestAnimationFrame(tick);});
      requestAnimationFrame(tick);
    })();

    /* ===== Темы с памятью ===== */
    const THEMES=['subsurface','sepia','glitch'];
    const themeKey='kx-theme';
    (function initTheme(){
      let t='subsurface';
      try{ t = localStorage.getItem(themeKey) || t; }catch(_){}
      applyTheme(t);
      // подхватываем тему, выбранную на главной
      window.addEventListener('storage', e=>{
        if(e.key===themeKey && e.newValue){ applyTheme(e.newValue); }
      });
    })();
    function applyTheme(t){
      if(!THEMES.includes(t)) t='subsurface';
      document.documentElement.setAttribute('data-theme', t);
      const meta=document.querySelector('meta[name="theme-color"]');
      if(meta){
        const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#0b0f14';
        meta.setAttribute('content', bg);
      }
    }

    /* ===== Формат даты "N-й день YYYY-го года, HH:MM" ===== */
    function fmtDayYear(s){
      if(!s) return '';
      if(/^\d{4}-\d{2}-\d{2}/.test(s)){
        const d=new Date(s);
        const yy=d.getUTCFullYear();
        const start=new Date(Date.UTC(yy,0,1));
        const doy=Math.floor((d-start)/86400000)+1;
        const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0');
        return `${doy}-й день ${yy}-го года, ${hh}:${mm}`;
      }
      const m=String(s).trim().match(/^(\d{4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if(m){
        const yy=+m[1], doy=+m[2];
        const hh=m[3]?m[3].padStart(2,'0'):'00'; const mm=m[4]?m[4]:'00';
        return `${doy}-й день ${yy}-го года, ${hh}:${mm}`;
      }
      return s;
    }

    /* ===== Утилиты ===== */
    function getId(){ return decodeURIComponent(location.hash.replace(/^#\/?/,'')).trim(); }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
    async function fetchJSON(url){
      const r=await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }

    /* ===== Рендер темы ===== */
    async function render(){
      const box=document.getElementById('post');
      const id=getId();
      if(!id){ box.textContent='Тема не указана.'; return; }

      try{
        const t = await fetchJSON(`/content/threads/${id}.json`);
        document.title = `${t.title||id} — Доска сектора`;

        const when = fmtDayYear(t.created);
        const tags = (t.tags||[]).map(x=>`<span class="kx-tag">${escapeHTML(x)}</span>`).join(' ');

        // Разбиваем по пустой строке и экранируем
        const body = (t.body||'').split(/\n\n+/).map(p=>`<p>${escapeHTML(p)}</p>`).join('');

        box.innerHTML = `
          <h1>${escapeHTML(t.title||id)}</h1>
          <div class="kx-muted">${when} · ${escapeHTML(t.author||'anon')} · сектор: ${escapeHTML(t.sector||'—')}${t.board?` · раздел: ${escapeHTML(t.board)}`:''}</div>
          <div class="kx-tags">${tags}</div>
          ${body}
          <hr class="kx-hr">
          <div id="related"></div>
        `;

        // Связанные темы: дети и соседи
        try{
          const idx = await fetchJSON('/content/threads-index.json');
          const kids = idx.filter(x=>x.parentId === t.id);
          const siblings = t.parentId ? idx.filter(x=>x.parentId === t.parentId && x.id !== t.id) : [];
          let html='';
          if(kids.length){
            html += `<div><strong>Подтемы:</strong><ul>${kids.map(x=>`<li><a href="/thread.html#/${encodeURIComponent(x.id)}">${escapeHTML(x.title)}</a></li>`).join('')}</ul></div>`;
          }
          if(siblings.length){
            html += `<div style="margin-top:6px"><strong>Связанные темы:</strong><ul>${siblings.map(x=>`<li><a href="/thread.html#/${encodeURIComponent(x.id)}">${escapeHTML(x.title)}</a></li>`).join('')}</ul></div>`;
          }
          document.getElementById('related').innerHTML = html || '';
        }catch(_){ /* индекс не обязателен */ }

        // Комментариев нет. Ничего не монтируем.

      }catch(e){
        box.innerHTML = `<div class="kx-muted">Тема не найдена. Проверь путь <code>/content/threads/${escapeHTML(id)}.json</code> и корректность JSON.</div>`;
      }
    }

    addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
