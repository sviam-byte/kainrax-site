<!doctype html>
<html lang="ru" data-theme="subsurface">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–¢–µ–º–∞ ‚Äî –î–æ—Å–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞</title>
  <meta name="theme-color" content="#0b0f14"/>

  <!-- Yandex.Metrika counter -->
  <script>
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      for (var j=0;j<document.scripts.length;j++){
        if (document.scripts[j].src === r) return;
      }
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym');
  
    ym(103711087, 'init', {
      webvisor:true,
      clickmap:true,
      trackLinks:true,
      accurateTrackBounce:true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/103711087" style="position:absolute; left:-9999px;" alt=""></div></noscript>
  <!-- /Yandex.Metrika counter -->


  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%237dd3fc'/%3E%3Cstop offset='70%25' stop-color='%230b0f14' stop-opacity='.05'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%230b0f14'/%3E%3Cpath d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z' fill='url(%23g)'/%3E%3Ccircle cx='32' cy='32' r='2.4' fill='%23a78bfa'/%3E%3C/svg%3E" />
  <link rel="icon" type="image/png" sizes="64x64" href="/assets/icon-64.png" />
  <style>
    :root{--bg:#0b0f14;--panel:#0e141d;--text:#e6edf5;--muted:#9fb0c7;--tag:#112131;--tag-on:#183140;--link:#bfe9ff;--ring:#7dd3fc;--r:14px;--shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 8px 30px rgba(0,0,0,.35)}
    html[data-theme="sepia"]{--bg:#0e0b09;--panel:#16120d;--text:#ece3d3;--muted:#bdae95;--tag:#2a2218;--tag-on:#3a2f21;--link:#f3d7a6;--ring:#d6b778}
    html[data-theme="glitch"]{--bg:#07090d;--panel:#0c121b;--text:#e8f0ff;--muted:#9fb6d6;--tag:#0d1a2a;--tag-on:#14253a;--link:#b9a4ff;--ring:#a78bfa}
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    .kx-head{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid rgba(255,255,255,.05)}
    .kx-brand{font-weight:800;color:var(--text)} .kx-nav{display:flex;gap:8px;align-items:center}
    .kx-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--tag);border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow);color:var(--text)}
    .kx-btn:hover{transform:translateY(-1px)} .is-active{outline:2px solid var(--ring)}
    .kx-cta{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0)),var(--tag-on);border-color:rgba(255,255,255,.12);font-weight:600}
    .kx-shell{max-width:900px;margin:0 auto;padding:16px}
    .kx-panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
    h1{margin:4px 0 8px 0;font-size:24px}
    .kx-muted{color:var(--muted);font-size:14px}
    .kx-tags{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0 0}
    .kx-tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:10px;background:var(--tag);color:var(--muted);font-size:12px;border:1px solid rgba(255,255,255,.06)}
    .kx-hr{border:0;height:1px;background:rgba(255,255,255,.08);margin:16px 0}
    #sky-line{position:fixed;left:0;right:0;height:3px;z-index:0;pointer-events:none;opacity:.7;filter:blur(1px);background:radial-gradient(ellipse 80% 150% at 50% 50%, #7dd3fc 0%, transparent 40%)}
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>

  <header class="kx-head">
    <a class="kx-brand" href="/index.html">–î–æ—Å–∫–∞ –ö–∞–π–Ω—Ä–∞–∫—Å</a>
    <nav class="kx-nav">
      <a class="kx-btn" href="/index.html">–¢–µ–º—ã</a>
      <a class="kx-btn" href="/people.html">–í—Å–µ –ª—é–¥–∏</a>
      <a class="kx-btn" href="/tags.html">–¢–µ–≥–∏</a>
      <a class="kx-btn" href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">–ö –ø—Ä–æ–µ–∫—Ç—É</a>
      <a class="kx-btn kx-cta" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</a>
    </nav>
  </header>

  <main class="kx-shell">
    <article id="post" class="kx-panel">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</article>
  </main>

  <script type="module">
    // –ü–æ–ª–æ—Å–∞ –Ω–µ–±–∞
    (function sky(){
      const el=document.getElementById('sky-line'); let run=true;
      function tick(){ const n=new Date(); const ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds(); el.style.top=(ms/86400000*100)+'vh'; if(run) requestAnimationFrame(tick); }
      document.addEventListener('visibilitychange',()=>{run=document.visibilityState==='visible'; if(run) requestAnimationFrame(tick)});
      requestAnimationFrame(tick);
    })();

    // –¢–µ–º–∞
    const THEMES=['subsurface','sepia','glitch'], themeKey='kx-theme';
    (function initTheme(){let t='subsurface';try{t=localStorage.getItem(themeKey)||t}catch(_){ }applyTheme(t)})();
    function applyTheme(t){
      if(!THEMES.includes(t)) t='subsurface';
      document.documentElement.setAttribute('data-theme',t);
      const m=document.querySelector('meta[name="theme-color"]');
      if(m){const bg=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0b0f14'; m.setAttribute('content', bg)}
    }

    // –î–∞—Ç—ã 429/430 + "430-218 22:17"
    function fmtDayYear(s){
      if(!s) return '';
      const m = String(s).trim().match(/^(\d{3,4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if (m){
        const yy=+m[1], doy=+m[2];
        const hh=m[3]?m[3].padStart(2,'0'):'00', mm=m[4]?m[4]:'00';
        return `${doy}-–π –¥–µ–Ω—å ${yy}-–≥–æ –≥–æ–¥–∞, ${hh}:${mm}`;
      }
      const d = new Date(s);
      if (!isNaN(d)){
        const ry = d.getUTCFullYear();
        const wy = ry===2024 ? 429 : ry===2025 ? 430 : (ry - 1595);
        const start=new Date(Date.UTC(ry,0,1));
        const doy=Math.floor((d - start)/86400000)+1;
        const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
        return `${doy}-–π –¥–µ–Ω—å ${wy}-–≥–æ –≥–æ–¥–∞, ${hh}:${mm}`;
      }
      return s;
    }

    // –£—Ç–∏–ª–∏—Ç—ã
    function esc(s){return (s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]))}
    async function getJSON(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return await r.json() }
    function slugify(s){ return String(s||'anon').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_.]+/g,'').slice(0,64) }

    // –ü–∞—Ä—Å–µ—Ä —Ö–µ—à–∞: "#/id?c=cid" -> { id, params }
    function parseHash(){
      const raw = (location.hash || '').slice(1).replace(/^\//,'');
      const [idPart, qStr] = raw.split('?');
      return { id: decodeURIComponent(idPart || '').trim(), params: new URLSearchParams(qStr || '') };
    }

    // –≠–º–æ–¥–∑–∏ –∞–≤—Ç–æ—Ä–∞
    const EMO=["üõ†Ô∏è","ü™´","üõ∞Ô∏è","üß≠","üåò","üí°","‚öôÔ∏è","üß™","üì°","üß±","ü™ì","‚õìÔ∏è","üßØ","üîß","üî≠","ü™®","üå´Ô∏è","üåä","ü™ô","üúÇ","üúÅ","üúÑ","üúÉ"];
    function hashStr(s){let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0}
    function authorEmoji(name){ const i=hashStr(name||'anon')%EMO.length; return EMO[i] }

    function renderCommentNode(c, depth=0){
      const pad = Math.min(depth*14, 56);
      const name = c.author || 'anon';
      const aid = encodeURIComponent(c.author_id || slugify(name));
      const emo = authorEmoji(name);
      const cid = String(c.id || '');
      return `
        <div data-cid="${esc(cid)}" style="border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;background:rgba(255,255,255,.02); margin-left:${pad}px">
          <div class="kx-muted" style="font-size:12px">
            ${fmtDayYear(c.created)} ¬∑ <a href="/author.html#/${aid}">${emo} ${esc(name)}</a>${c.sector?` ¬∑ —Å–µ–∫—Ç–æ—Ä: ${esc(c.sector)}`:''}
          </div>
          <div style="margin-top:6px;white-space:pre-wrap">${esc(c.body||'')}</div>
          ${Array.isArray(c.replies)&&c.replies.length ? c.replies.map(r=>renderCommentNode(r, depth+1)).join('') : ''}
        </div>
      `;
    }

    async function render(){
      const box=document.getElementById('post');
      const { id, params } = parseHash();
      if(!id){ box.textContent='–¢–µ–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞.'; return }

      try{
        const t = await getJSON(`/content/threads/${id}.json`);
        document.title = `${t.title||id} ‚Äî –î–æ—Å–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞`;

        const when=fmtDayYear(t.created);
        const tags=(t.tags||[]).map(x=>`<a class="kx-tag" href="/tags.html#/${encodeURIComponent(x)}">${esc(x)}</a>`).join(' ');
        const body=(t.body||'').split(/\n\n+/).map(p=>`<p>${esc(p)}</p>`).join('');
        const auth=t.author||'anon'; const aId=encodeURIComponent(t.author_id||slugify(auth));
        const emo=authorEmoji(auth);

        box.innerHTML = `
          <h1>${esc(t.title||id)}</h1>
          <div class="kx-muted">${when} ¬∑ <a href="/author.html#/${aId}">${emo} ${esc(auth)}</a> ¬∑ —Å–µ–∫—Ç–æ—Ä: ${esc(t.sector||'‚Äî')}${t.board?` ¬∑ —Ä–∞–∑–¥–µ–ª: ${esc(t.board)}`:''}</div>
          <div class="kx-tags">${tags}</div>
          ${body}
          <hr class="kx-hr">
          <div id="related"></div>
        `;

        const relatedBox = document.getElementById('related');

        if (Array.isArray(t.comments) && t.comments.length){
          relatedBox.innerHTML = `
            <div><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong></div>
            <div style="margin-top:8px;display:flex;flex-direction:column;gap:10px">
              ${t.comments.map(c => renderCommentNode(c, 0)).join('')}
            </div>
          `;
        } else {
          try{
            const idx = await getJSON('/content/threads-index.json');
            const kids = idx.filter(x=>x.parentId === t.id);
            const comments = kids.filter(x => (x.board||'') === '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏');
            const subthreads = kids.filter(x => (x.board||'') !== '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏');
            let html = '';
            if (comments.length){
              html += `<div><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong><div style="margin-top:6px;display:flex;flex-direction:column;gap:10px">
                ${comments.map(c => `
                  <div style="border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;background:rgba(255,255,255,.02)">
                    <div class="kx-muted" style="font-size:12px">${fmtDayYear(c.created)} ¬∑ ${esc(c.author||'anon')}</div>
                    <div style="margin-top:6px">${esc((c.body||'').slice(0,600))}${(c.body||'').length>600?'‚Ä¶':''}</div>
                  </div>`).join('')}
              </div></div>`;
            }
            if (subthreads.length){
              html += `<div style="margin-top:12px"><strong>–ü–æ–¥—Ç–µ–º—ã:</strong><ul>${subthreads.map(x=>`<li><a href="/thread.html#/${encodeURIComponent(x.id)}">${esc(x.title)}</a></li>`).join('')}</ul></div>`;
            }
            relatedBox.innerHTML = html || '';
          }catch(_){ relatedBox.innerHTML = '' }
        }

        // –Ø–∫–æ—Ä—å –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ?c=ID
        const target = params.get('c');
        if (target){
          const el = document.querySelector(`[data-cid="${CSS.escape(target)}"]`);
          if (el){
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.style.outline = '1px solid var(--ring)';
            setTimeout(()=> el.style.outline = 'none', 1600);
          }
        }

      }catch(e){
        box.innerHTML = `<div class="kx-muted">–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å <code>/content/threads/${esc(id)}.json</code>.</div>`;
      }
    }

    addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
