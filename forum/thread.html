<!doctype html>
<html lang="ru" data-theme="subsurface">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Тема — Доска сектора</title>
  <meta name="theme-color" content="#0b0f14"/>
  <meta name="color-scheme" content="dark light"/>
  <meta name="format-detection" content="telephone=no"/>

  <!-- метрика не должна блокировать парсинг -->
  <script src="/assets/metrika.js" defer></script>

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%237dd3fc'/%3E%3Cstop offset='70%25' stop-color='%230b0f14' stop-opacity='.05'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%230b0f14'/%3E%3Cpath d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z' fill='url(%23g)'/%3E%3Ccircle cx='32' cy='32' r='2.4' fill='%23a78bfa'/%3E%3C/svg%3E" />
  <link rel="icon" type="image/png" sizes="64x64" href="/assets/icon-64.png" />

  <style>
    :root{
      --bg:#0b0f14; --panel:#0e141d; --card:#0e141d; --text:#e6edf5; --muted:#9fb0c7;
      --tag:#112131; --tag-on:#183140; --link:#bfe9ff; --ring:#7dd3fc; --brand:#7dd3fc;
      --r:14px; --shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 8px 30px rgba(0,0,0,.35);
      --border:rgba(255,255,255,.06);
    }
    html[data-theme="sepia"]{
      --bg:#f8f4ec; --panel:#ffffff; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --brand:#d6b778; --link:#0b66d3; --tag:#efe3cc; --tag-on:#e6d8be; --ring:#d6b778;
      --shadow:0 1px 0 rgba(0,0,0,.03) inset, 0 8px 30px rgba(0,0,0,.08);
      --border:rgba(0,0,0,.08);
    }
    html[data-theme="glitch"]{
      --bg:#07090d; --panel:#0c121b; --card:#0c121b; --text:#e8f0ff; --muted:#9fb6d6;
      --brand:#a78bfa; --link:#b9a4ff; --tag:#0d1a2a; --tag-on:#14253a; --ring:#a78bfa;
      --border:rgba(255,255,255,.08);
    }

    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      -webkit-text-size-adjust:100%; text-size-adjust:100%;
      overscroll-behavior-y:none; scrollbar-gutter:stable both-edges;
    }
    *{box-sizing:border-box}
    img,svg,video{max-width:100%;height:auto}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    :focus-visible{outline:2px solid var(--ring); outline-offset:2px}

    .kx-head{
      position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 16px;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));
      backdrop-filter:saturate(1.1) blur(6px);
      -webkit-backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid var(--border);
    }
    html[data-theme="sepia"] .kx-head{background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,0))}
    .kx-brand{font-weight:800;color:var(--text);white-space:nowrap}
    .kx-nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kx-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:var(--tag);border:1px solid var(--border);box-shadow:var(--shadow);color:var(--text);min-height:40px}
    .kx-btn:hover{transform:translateY(-1px)}
    .is-active{outline:2px solid var(--ring)}
    .kx-cta{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0)),var(--tag-on);border-color:var(--border);font-weight:600}

    .kx-shell{max-width:900px;margin:0 auto;padding:16px}
    .kx-panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}

    h1{margin:4px 0 8px 0;font-size:24px}
    .kx-muted{color:var(--muted);font-size:14px}
    .kx-tags{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0 0}
    .kx-tag{display:inline-flex;align-items:center;padding:6px 10px;border-radius:10px;background:var(--tag);color:var(--muted);font-size:12px;border:1px solid var(--border)}
    .kx-hr{border:0;height:1px;background:rgba(255,255,255,.08);margin:16px 0}

    .comment{border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--card);content-visibility:auto;contain-intrinsic-size:120px}

    /* Пост и медиа */
    .post{padding:1rem 1.25rem;background:var(--card);border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .post-head{margin-bottom:.5rem}
    .post-title{margin:0;font-size:1.1rem;line-height:1.35}
    .post-meta{font-size:.85rem;color:var(--muted)}
    .post-body{line-height:1.65}
    .post-body p{margin:.6rem 0}
    .post-media{margin-top:1rem;position:relative;z-index:1}
    .post-media figure{margin:0 0 .75rem 0;background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .post-media img{display:block;width:100%;height:auto;aspect-ratio:auto;object-fit:cover;loading:lazy;decoding:async}
    .post-media figcaption{padding:.5rem .75rem;font-size:.9rem;color:var(--muted);text-align:center}

    #sky-line{position:fixed;left:0;right:0;height:3px;z-index:0;pointer-events:none;opacity:.7;filter:blur(1px);background:radial-gradient(ellipse 80% 150% at 50% 50%, var(--brand) 0%, transparent 40%)}

    @media (max-width:640px){
      .kx-head{gap:8px}
      .kx-brand{font-size:16px}
      .kx-nav{gap:6px}
      .kx-btn{padding:8px 10px;min-height:36px}
      .kx-shell{padding:12px}
      .kx-panel{padding:12px}
    }
    @media (prefers-reduced-motion: reduce){ *{animation:none !important; transition:none !important} }
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>

  <header class="kx-head" role="banner">
    <a class="kx-brand" href="/index.html">Доска Кайнракс</a>
    <nav class="kx-nav" role="navigation" aria-label="Основная">
      <a class="kx-btn is-active" href="/index.html">Темы</a>
      <a class="kx-btn" href="/people.html">Все люди</a>
      <a class="kx-btn" href="/tags.html">Теги</a>
      <a class="kx-btn" href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">К проекту</a>
      <a class="kx-btn kx-cta" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow">Подписаться</a>
      <div class="kx-themes" id="themePicker" aria-label="Темы">
        <button class="kx-pill" data-theme="subsurface" type="button">Subsurface</button>
        <button class="kx-pill" data-theme="sepia" type="button">Sepia</button>
        <button class="kx-pill" data-theme="glitch" type="button">Glitch</button>
      </div>
    </nav>
  </header>

  <main class="kx-shell">
    <article id="post" class="kx-panel" aria-live="polite">Загрузка…</article>
  </main>

  <script type="module">
    // ===== Полоса неба с svh-фоллбеком
    (function sky(){
      const el=document.getElementById('sky-line'); let run=true;
      const unit = (CSS && CSS.supports && CSS.supports('height: 100svh')) ? 'svh' : 'vh';
      function tick(){ const n=new Date(); const ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds(); el.style.top=(ms/86400000*100)+unit; if(run) requestAnimationFrame(tick); }
      document.addEventListener('visibilitychange',()=>{run=document.visibilityState==='visible'; if(run) requestAnimationFrame(tick)},{passive:true});
      requestAnimationFrame(tick);
    })();

    // ===== Темы
    (function initTheme(){
      const THEMES=['subsurface','sepia','glitch'], key='kx-theme';
      function applyTheme(t){
        if(!THEMES.includes(t)) t='subsurface';
        document.documentElement.setAttribute('data-theme', t);
        try{ localStorage.setItem(key,t) }catch(_){}
        document.querySelectorAll('.kx-pill').forEach(b=> b.dataset.on = (b.dataset.theme===t) ? 'true' : 'false');
        const meta=document.querySelector('meta[name="theme-color"]');
        if(meta){ const bg=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0b0f14'; meta.setAttribute('content', bg); }
      }
      let t='subsurface'; try{ t=localStorage.getItem(key)||t }catch(_){}
      applyTheme(t);
      document.getElementById('themePicker').addEventListener('click', e=>{
        const btn=e.target.closest('.kx-pill'); if(!btn) return; applyTheme(btn.dataset.theme);
      }, {passive:true});
      document.addEventListener('keyup', e=>{
        if((e.key||'').toLowerCase()!=='t') return;
        const cur=document.documentElement.getAttribute('data-theme')||'subsurface';
        const list=['subsurface','sepia','glitch'];
        applyTheme(list[(list.indexOf(cur)+1)%list.length]);
      });
    })();

    // ===== Мелкие утилиты
    const qs=(s,root=document)=>root.querySelector(s);
    const esc=s=>(s||'').replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    const slugify=s=>String(s||'anon').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_.]+/g,'').slice(0,64);

    // Формат даты
    function fmtDayYear(s){
      if(!s) return '';
      const m=String(s).trim().match(/^(\d{3,4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if(m){const yy=+m[1],doy=+m[2];const hh=m[3]?m[3].padStart(2,'0'):'00',mm=m[4]?m[4]:'00';return `${doy}-й день ${yy}-го года, ${hh}:${mm}`;}
      const d=new Date(s); if(!isNaN(d)){const ry=d.getUTCFullYear(); const wy=ry===2024?429:ry===2025?430:(ry-1595); const start=new Date(Date.UTC(ry,0,1)); const doy=Math.floor((d-start)/86400000)+1; const hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0'); return `${doy}-й день ${wy}-го года, ${hh}:${mm}`;}
      return s;
    }

    // Эмодзи-аватар
    const EMO=["🛠️","🪫","🛰️","🧭","🌘","💡","⚙️","🧪","📡","🧱","🪓","⛓️","🧯","🔧","🔭","🪨","🌫️","🌊","🪙","🜂","🜁","🜄","🜃"];
    const hashStr=s=>{let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0;}
    const authorEmoji=name=>EMO[hashStr(name||'anon')%EMO.length];

    // ===== Быстрый cache-first fetch c проверкой MIME (защита от SPA-редиректа)
    async function getJSON(url){
      // Если Netlify редиректнул JSON на index.html, content-type будет text/html — ловим это.
      const fetchJson = async (reqInit)=> {
        const r = await fetch(url, reqInit);
        if(!r.ok) throw new Error('HTTP '+r.status);
        const ct = (r.headers.get('content-type')||'').toLowerCase();
        if(!ct.includes('application/json')) throw new Error('Не JSON: возможно SPA-редирект перехватил '+url);
        return r.json();
      };
      // Cache API
      if('caches' in window){
        const cache = await caches.open('kx-v1');
        const cached = await cache.match(url);
        if(cached){
          // быстрый рендер из кеша
          try{
            const ct=(cached.headers.get('content-type')||'').toLowerCase();
            if(ct.includes('application/json')){
              cached.clone().json().then(()=>{}); // прогреваем
              // фон: обновим кеш
              fetchJson({cache:'no-cache'}).then(resp=>{
                cache.put(url, new Response(JSON.stringify(resp),{headers:{'Content-Type':'application/json; charset=utf-8'}}));
              }).catch(()=>{});
              return cached.json();
            }
          }catch{}
        }
        // нет кеша — нормальный запрос
        const fresh = await fetchJson({cache:'no-cache'});
        await cache.put(url, new Response(JSON.stringify(fresh),{headers:{'Content-Type':'application/json; charset=utf-8'}}));
        return fresh;
      }
      // без Cache API: пусть браузер решает
      return fetchJson({cache:'force-cache'});
    }

    // ===== Разбор ID из URL
    const parseHashId = ()=> (location.hash||'').slice(1).replace(/^\//,'').split('?')[0].trim();
    const parseQueryId = ()=> new URLSearchParams(location.search).get('id')?.trim() || '';
    function parsePathId(){
      const parts = location.pathname.replace(/\/+$/,'').split('/');
      const last = parts.at(-1) || '';
      const prev = parts.at(-2) || '';
      if(/^threads?$/i.test(prev) && last) return last.replace(/\.[a-z0-9]+$/i,'');
      if(last && !/^(index|thread|post)$/i.test(last)) return last.replace(/\.[a-z0-9]+$/i,'');
      return '';
    }
    async function resolvePostId(){
      return parseHashId() || parseQueryId() || parsePathId() || '';
    }

    // ===== Рендер комментариев (рекурсивно)
    function renderCommentNode(c, depth=0){
      const pad = Math.min(depth*14, 56);
      const name = c.author || 'anon';
      const aid = encodeURIComponent(c.author_id || slugify(name));
      const emo = authorEmoji(name);
      const cid = String(c.id || '');
      return `
        <div class="comment" data-cid="${esc(cid)}" style="margin-left:${pad}px">
          <div class="kx-muted" style="font-size:12px">
            ${fmtDayYear(c.created)} · <a href="/author.html#/${aid}">${emo} ${esc(name)}</a>${c.sector?` · сектор: ${esc(c.sector)}`:''}
          </div>
          <div style="margin-top:6px;white-space:pre-wrap">${esc(c.body||'')}</div>
          ${Array.isArray(c.replies)&&c.replies.length ? c.replies.map(r=>renderCommentNode(r, depth+1)).join('') : ''}
        </div>
      `;
    }

    // ===== Текст → параграфы (если body — plain text)
    const paragraphs = txt => (txt||'')
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .split(/\n{2,}/).map(p=>`<p>${p.replace(/\n/g,"<br>")}</p>`).join("");

    // ===== Рендер карточки поста
    function renderPostCard(t){
      const article=document.createElement('article'); article.className='post';
      const head=document.createElement('header'); head.className='post-head';
      const h2=document.createElement('h2'); h2.className='post-title'; h2.textContent=t.title||'(без названия)';
      const meta=document.createElement('div'); meta.className='post-meta';
      const when=fmtDayYear(t.created); const auth=t.author||'anon'; const aId=encodeURIComponent(t.author_id||slugify(auth));
      meta.innerHTML = `${when} · <a href="/author.html#/${aId}">${authorEmoji(auth)} ${esc(auth)}</a> · сектор: ${esc(t.sector||'—')}${t.board?` · раздел: ${esc(t.board)}`:''}`;
      head.appendChild(h2); head.appendChild(meta); article.appendChild(head);

      const body=document.createElement('div'); body.className='post-body';
      body.innerHTML = paragraphs(t.body); // если у тебя безопасный HTML — поменяй на body.innerHTML = t.body
      article.appendChild(body);

      if(Array.isArray(t.media) && t.media.length){
        const mediaWrap=document.createElement('div'); mediaWrap.className='post-media';
        t.media.forEach(m=>{
          if(m.type==='image' && m.src){
            const fig=document.createElement('figure');
            const img=document.createElement('img');
            img.src = m.src; img.alt = m.alt||''; img.loading='lazy'; img.decoding='async';
            if(m.width) img.width = m.width; if(m.height) img.height = m.height;
            if(m.srcset){ img.setAttribute('srcset', m.srcset); }
            if(m.sizes){ img.setAttribute('sizes', m.sizes); }
            fig.appendChild(img);
            if(m.caption){ const cap=document.createElement('figcaption'); cap.textContent=m.caption; fig.appendChild(cap); }
            mediaWrap.appendChild(fig);
          }
        });
        article.appendChild(mediaWrap);
      }
      return article;
    }

    // ===== Основной рендер без top-level await
    (async function init(){
      const box=qs('#post');
      box.textContent='Загрузка…';

      const id = await resolvePostId();
      if(!id){ box.innerHTML='<div class="kx-muted">Тема не указана.</div>'; return; }

      // 1) быстрый fetch поста
      try{
        const t = await getJSON(`/content/threads/${id}.json`);
        document.title = `${t.title||id} — Доска сектора`;

        // моментально рисуем пост и теги
        const wrap=document.createElement('div');
        const card=renderPostCard(t);
        wrap.appendChild(card);

        const tagBar=document.createElement('div'); tagBar.className='kx-tags';
        tagBar.innerHTML=(t.tags||[]).map(x=>`<a class="kx-tag" href="/tags.html#/${encodeURIComponent(x)}">${esc(x)}</a>`).join(' ');
        wrap.appendChild(tagBar);

        const hr=document.createElement('hr'); hr.className='kx-hr';
        wrap.appendChild(hr);

        // контейнер для комментариев, отрисуем позже
        const related=document.createElement('div'); related.id='related';
        related.innerHTML = '<div class="kx-muted">Загрузка комментариев…</div>';
        wrap.appendChild(related);

        box.innerHTML=''; box.appendChild(wrap);

        // 2) догружаем комментарии: из t.comments или из индекса
        (async ()=>{
          let html = '';
          if(Array.isArray(t.comments) && t.comments.length){
            html = `
              <div><strong>Комментарии:</strong></div>
              <div style="margin-top:8px;display:flex;flex-direction:column;gap:10px">
                ${t.comments.map(c=>renderCommentNode(c,0)).join('')}
              </div>
            `;
          } else {
            try{
              const idx = await getJSON('/content/threads-index.json');
              const kids = (Array.isArray(idx)? idx : (idx?.items||[])).filter(x=>x.parentId===t.id);
              const comments = kids.filter(x=>(x.board||'')==='комментарии');
              const subthreads = kids.filter(x=>(x.board||'')!=='комментарии');
              if(comments.length){
                html += `<div><strong>Комментарии:</strong><div style="margin-top:6px;display:flex;flex-direction:column;gap:10px">
                  ${comments.map(c=>`
                    <div class="comment">
                      <div class="kx-muted" style="font-size:12px">${fmtDayYear(c.created)} · ${esc(c.author||'anon')}</div>
                      <div style="margin-top:6px">${esc((c.body||'').slice(0,800))}${(c.body||'').length>800?'…':''}</div>
                    </div>`).join('')}
                </div></div>`;
              }
              if(subthreads.length){
                html += `<div style="margin-top:12px"><strong>Подтемы:</strong><ul>${subthreads.map(x=>`<li><a href="/thread.html#/${encodeURIComponent(x.id)}">${esc(x.title)}</a></li>`).join('')}</ul></div>`;
              }
            }catch(_){}
          }
          related.innerHTML = html || '<div class="kx-muted">Комментариев нет.</div>';

          // Прокрутка к якорю ?c=
          const q = new URLSearchParams(location.search);
          const target = q.get('c') || (location.hash.includes('?c=') ? new URLSearchParams(location.hash.split('?')[1]).get('c') : '');
          if (target){
            const el = document.querySelector(`[data-cid="${CSS.escape(String(target))}"]`);
            if (el){
              el.scrollIntoView({ behavior: 'smooth', block: 'center' });
              el.style.outline = '1px solid var(--ring)'; setTimeout(()=> el.style.outline='none', 1600);
            }
          }
        })();

      }catch(e){
        // Если это Netlify редиректит JSON на HTML — покажем явное сообщение
        const msg = String(e||'').includes('Не JSON') ?
          'Похоже, SPA-редирект перехватывает /content/… и отдаёт HTML. Проверь _redirects ниже.' :
          'Тема не найдена или сеть умерла по пути.';
        box.innerHTML = `<div class="kx-muted">${esc(msg)}</div>`;
      }
    })();
  </script>
</body>
</html>
