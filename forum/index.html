<!doctype html>
<html lang="ru" data-theme="subsurface">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Доска сектора</title>
  <meta name="theme-color" content="#0b0f14"/>

  <script src="/assets/metrika.js" defer></script>

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%237dd3fc'/%3E%3Cstop offset='70%25' stop-color='%230b0f14' stop-opacity='.05'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%230b0f14'/%3E%3Cpath d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z' fill='url(%23g)'/%3E%3Ccircle cx='32' cy='32' r='2.4' fill='%23a78bfa'/%3E%3C/svg%3E"/>
  <link rel="icon" type="image/png" sizes="64x64" href="/assets/icon-64.png"/>

  <style>
    :root{ --bg:#0b0f14; --panel:#0e141d; --card:#0e141d; --text:#e6edf5; --muted:#9fb0c7;
      --tag:#112131; --tag-on:#183140; --link:#bfe9ff; --ring:#7dd3fc; --brand:#7dd3fc;
      --r:14px; --shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 8px 30px rgba(0,0,0,.35) }
    html[data-theme="sepia"]{ --bg:#f8f4ec; --panel:#fff; --card:#fff; --text:#1f2937; --muted:#6b7280;
      --brand:#d6b778; --link:#0b66d3; --tag:#efe3cc; --tag-on:#e6d8be; --ring:#d6b778; --shadow:0 1px 0 rgba(0,0,0,.03) inset, 0 8px 30px rgba(0,0,0,.08) }
    html[data-theme="glitch"]{ --bg:#07090d; --panel:#0c121b; --card:#0c121b; --text:#e8f0ff; --muted:#9fb6d6;
      --brand:#a78bfa; --link:#b9a4ff; --tag:#0d1a2a; --tag-on:#14253a; --ring:#a78bfa }

    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    :focus-visible{outline:2px solid var(--ring); outline-offset:2px}

    .kx-head{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 16px;background:rgba(0,0,0,.65);border-bottom:1px solid rgba(255,255,255,.05)}
    @media (min-width: 900px){ @supports (backdrop-filter: blur(6px)){
      .kx-head{background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));
      backdrop-filter:saturate(1.1) blur(6px); -webkit-backdrop-filter:saturate(1.1) blur(6px)} } }
    html[data-theme="sepia"] .kx-head{background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,0));border-bottom:1px solid rgba(0,0,0,.08)}
    .kx-brand{font-weight:800;color:var(--text)}
    .kx-nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kx-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--tag);border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow);color:var(--text)}
    .kx-btn:hover{transform:translateY(-1px)} .is-active{outline:2px solid var(--ring)}
    .kx-cta{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0)),var(--tag-on);border-color:rgba(255,255,255,.12);font-weight:600}

    .kx-shell{max-width:1100px;margin:0 auto;padding:16px}
    .kx-panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .kx-muted{color:var(--muted);font-size:14px}

    .bar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
    #filters{display:flex;gap:6px;flex-wrap:wrap}
    #sorters{display:flex;gap:8px;flex-wrap:wrap}
    #sorters .kx-btn.is-active{outline:1px solid var(--ring);background:var(--tag-on);color:var(--text)}
    .search{flex:1;min-width:220px;display:flex;gap:8px}
    .search input{flex:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:var(--card);color:var(--text)}

    .kx-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .kx-thread{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);content-visibility:auto;contain-intrinsic-size:160px}
    .kx-title{margin:2px 0 4px 0;font-size:18px}
    .kx-sub{font-size:12px;color:var(--muted)}
    .kx-preview{margin:8px 0 10px 0}
    .kx-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .kx-tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:10px;background:var(--tag);color:var(--muted);font-size:12px;border:1px solid rgba(255,255,255,.06);cursor:pointer}
    .kx-tag--on{background:var(--tag-on);color:var(--text)}
    #status{margin-top:12px}
    #sky-line{position:fixed;left:0;right:0;height:3px;z-index:0;pointer-events:none;opacity:.7;filter:blur(1px);background:radial-gradient(ellipse 80% 150% at 50% 50%, var(--brand) 0%, transparent 40%)}
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>

  <header class="kx-head" role="banner">
    <a class="kx-brand" href="/index.html">Доска Кайнракс</a>
    <nav class="kx-nav" role="navigation" aria-label="Основная">
      <a class="kx-btn is-active" href="/index.html" aria-current="page">Темы</a>
      <a class="kx-btn" href="/people.html">Все люди</a>
      <a class="kx-btn" href="/tags.html">Теги</a>
      <a class="kx-btn kx-cta" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow" aria-label="Подписаться">Подписаться</a>
      <div class="kx-themes" id="themePicker" aria-label="Темы">
        <button class="kx-pill" data-theme="subsurface" type="button">Subsurface</button>
        <button class="kx-pill" data-theme="sepia" type="button">Archive Sepia</button>
        <button class="kx-pill" data-theme="glitch" type="button">Glitch Basilica</button>
      </div>
    </nav>
  </header>

  <main class="kx-shell" id="main" tabindex="-1">
    <section class="kx-panel" aria-labelledby="h1">
      <h1 id="h1">Доска сектора</h1>
      <p class="kx-muted">Быт, странности, техузлы. Каждая карточка — ветка. Фильтры, поиск, сортировка — справа.</p>

      <div class="bar" role="group" aria-label="Инструменты">
        <div id="filters" role="tablist" aria-label="Разделы"></div>

        <div id="sorters" role="group" aria-label="Сортировка">
          <button class="kx-btn" data-sort="newest" aria-pressed="true" type="button">Сначала новые</button>
          <button class="kx-btn" data-sort="popular" aria-pressed="false" type="button">Популярные</button>
        </div>

        <div class="search" role="search">
          <input id="q" type="search" placeholder="поиск по заголовку, тексту, тегам, автору…  (нажми /)" autocomplete="off" aria-label="Поиск по темам"/>
          <button class="kx-btn" id="clearQ" type="button" aria-label="Сбросить поиск">Сброс</button>
        </div>
      </div>

      <div id="threads" class="kx-grid" aria-live="polite"></div>
      <div id="status" class="kx-panel kx-muted" hidden></div>
    </section>
  </main>

  <script>
    /* — Полоса неба — */
    (function(){
      var el=document.getElementById('sky-line'), run=true;
      function tick(){ var n=new Date(); var ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds(); el.style.top=(ms/86400000*100)+'vh'; if(run) requestAnimationFrame(tick) }
      document.addEventListener('visibilitychange',function(){ run=document.visibilityState==='visible'; if(run) requestAnimationFrame(tick) });
      requestAnimationFrame(tick);
    })();

    /* — Темы — */
    (function(){
      var THEMES=['subsurface','sepia','glitch'], key='kx-theme';
      function applyTheme(t){
        if(THEMES.indexOf(t)===-1) t='subsurface';
        document.documentElement.setAttribute('data-theme', t);
        try{ localStorage.setItem(key, t) }catch(_){}
        Array.prototype.forEach.call(document.querySelectorAll('.kx-pill'), function(b){ b.dataset.on = (b.dataset.theme===t) ? 'true' : 'false' });
        var meta=document.querySelector('meta[name="theme-color"]');
        if(meta){ var bg=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0b0f14'; meta.setAttribute('content', bg) }
      }
      var t='subsurface'; try{ t=localStorage.getItem(key)||t }catch(_){}
      applyTheme(t);
      document.getElementById('themePicker').addEventListener('click', function(e){ var btn=e.target.closest('.kx-pill'); if(!btn) return; applyTheme(btn.dataset.theme) });
      document.addEventListener('keyup', function(e){ if((e.key||'').toLowerCase()!=='t') return; var cur=document.documentElement.getAttribute('data-theme')||'subsurface'; var i=THEMES.indexOf(cur); applyTheme(THEMES[(i+1)%THEMES.length]) });
    })();

    /* — Утилиты — */
    function esc(s){return (String(s||'')).replace(/[&<>"']/g,function(ch){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]})}
    function slugify(s){ return String(s||'anon').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_.]+/g,'').slice(0,64) }
    function fmtDayYear(s){
      if(!s) return '';
      var m=String(s).trim().match(/^(\d{3,4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if(m){ var yy=+m[1],doy=+m[2]; var hh=m[3]?(''+m[3]).padStart(2,'0'):'00', mm=m[4]?m[4]:'00'; return doy+'-й день '+yy+'-го года, '+hh+':'+mm }
      var d=new Date(s); if(!isNaN(d)){ var ry=d.getUTCFullYear(); var wy=ry===2024?429:ry===2025?430:(ry-1595); var start=new Date(Date.UTC(ry,0,1)); var doy=Math.floor((d-start)/86400000)+1; var hh=(''+d.getHours()).padStart(2,'0'), mm=(''+d.getMinutes()).padStart(2,'0'); return doy+'-й день '+wy+'-го года, '+hh+':'+mm } return s;
    }
    var EMO=["🛠️","🪫","🛰️","🧭","🌘","💡","⚙️","🧪","📡","🧱","🪓","⛓️","🧯","🔧","🔭","🪨","🌫️","🌊","🪙","🜂","🜁","🜄","🜃"];
    function hashStr(s){var h=2166136261>>>0; s=String(s||''); for(var i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0}
    function authorEmoji(name){ return EMO[hashStr(name||'anon')%EMO.length] }

    function getJSON(url){
      return fetch(url,{cache:'force-cache'}).then(function(r){
        if(!r.ok) throw new Error('HTTP '+r.status+' '+url);
        var ct=(r.headers.get('content-type')||'').toLowerCase();
        if(ct.indexOf('application/json')===-1 && ct.indexOf('+json')===-1) throw new Error('NOT_JSON '+url);
        return r.json();
      }).catch(function(err){
        if(url.charAt(0)==='/' ){
          return fetch('.'+url,{cache:'force-cache'}).then(function(r2){
            if(!r2.ok) throw err;
            var ct2=(r2.headers.get('content-type')||'').toLowerCase();
            if(ct2.indexOf('application/json')===-1 && ct2.indexOf('+json')===-1) throw err;
            return r2.json();
          });
        }
        throw err;
      });
    }

    /* — Состояние и URL — */
    var box=document.getElementById('threads');
    var filtBox=document.getElementById('filters');
    var sortersBox=document.getElementById('sorters');
    var qInp=document.getElementById('q'), qClr=document.getElementById('clearQ');
    var statusBox=document.getElementById('status');

    var allItems=[], currentBoard='', query=''; var currentSort='newest';
    function readURL(){
      var u=new URL(location.href);
      currentBoard=u.searchParams.get('board')||'';
      query=(u.searchParams.get('q')||'').toLowerCase();
      var s=u.searchParams.get('sort'); currentSort = (s==='popular'?'popular':'newest');
      qInp.value=query;
    }
    function writeURL(){
      var u=new URL(location.href);
      if(currentBoard) u.searchParams.set('board', currentBoard); else u.searchParams.delete('board');
      if(query) u.searchParams.set('q', query); else u.searchParams.delete('q');
      u.searchParams.set('sort', currentSort);
      history.replaceState(null,'',u);
    }

    function matches(t){
      if ((t.board||'') === 'комментарии') return false;
      if(currentBoard && (t.board||'')!==currentBoard) return false;
      if(!query) return true;
      var hay = [t.title,t.body,(t.tags||[]).join(' '),t.author,t.sector,t.id].join(' ').toLowerCase();
      return hay.indexOf(query)!==-1;
    }

    function card(t){
      var when=fmtDayYear(t.created);
      var preview=(t.body||'').replace(/\s+/g,' ').slice(0,200)+((t.body&&t.body.length>200)?'…':'');
      var name=esc(t.author||'anon'); var aId=encodeURIComponent(t.author_id||slugify(name));
      var emo=authorEmoji(name);
      var tags=(t.tags||[]).map(function(x){return '<a class="kx-tag" href="/tags.html#/'+encodeURIComponent(x)+'" title="Посты с тегом '+esc(x)+'">'+esc(x)+'</a>'}).join(' ');
      var cc = t.commentCount||0;
      return '<article class="kx-thread">'
       + '<a class="kx-link" href="/thread.html?id='+encodeURIComponent(t.id)+'"><h3 class="kx-title">✶ '+esc(t.title||'Без названия')+'</h3></a>'
       + '<div class="kx-sub">'+when+' · <a href="/author.html?id='+aId+'" title="Все посты автора">'+emo+' '+name+'</a> · сектор: '+esc(t.sector||'—')+(t.board?(' · раздел: '+esc(t.board)):'')+(cc?(' · комментариев: '+cc):'')+'</div>'
       + '<p class="kx-preview">'+esc(preview)+'</p>'
       + '<div class="kx-tags">'+tags+'</div>'
       + '</article>';
    }

    function renderBoards(){
      var boards = Array.from(new Set(allItems.map(function(x){return x.board}).filter(function(b){return b && b!=='комментарии'}))).sort();
      if(!boards.length){ filtBox.innerHTML=''; return; }
      function chip(b){ return '<span class="kx-tag'+(b===currentBoard?' kx-tag--on':'')+'" role="tab" tabindex="0" data-board="'+esc(b)+'">'+esc(b)+'</span>' }
      filtBox.innerHTML = '<span class="kx-tag'+(!currentBoard?' kx-tag--on':'')+'" role="tab" tabindex="0" data-board="">Все</span>' + boards.map(chip).join('');
      filtBox.onclick = function(e){ var el=e.target.closest('.kx-tag'); if(!el) return; currentBoard = el.dataset.board || ''; renderBoards(); render(); };
      filtBox.onkeydown = function(e){ if(e.key==='Enter'||e.key===' '){ var el=e.target.closest('.kx-tag'); if(!el) return; currentBoard = el.dataset.board || ''; renderBoards(); render(); e.preventDefault(); } };
    }

    function syncSortUI(){
      Array.prototype.forEach.call(sortersBox.querySelectorAll('button[data-sort]'), function(btn){
        var on = btn.dataset.sort === currentSort;
        btn.classList.toggle('is-active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }

    function render(){
      var items = allItems.filter(matches);
      if (currentSort === 'popular') items.sort(function(a,b){ return (b.commentCount||0) - (a.commentCount||0) || (new Date(b.created) - new Date(a.created)) });
      else items.sort(function(a,b){ return new Date(b.created) - new Date(a.created) });
      box.innerHTML = items.length ? items.map(card).join('') : '<div class="kx-panel kx-muted">Ничего не найдено. Попробуй другой запрос или раздел.</div>';
      writeURL();
    }

    /* — Инициализация — */
    (function init(){
      readURL(); syncSortUI();
      getJSON('/content/threads-index.json').then(function(payload){
        allItems = Array.isArray(payload) ? payload : (Array.isArray(payload.items)?payload.items:[]);
        renderBoards(); render();
      }).catch(function(err){
        statusBox.hidden=false;
        statusBox.innerHTML='Не удалось получить <code>/content/threads-index.json</code>: '+esc(String(err.message||err))+'. Проверь путь, редиректы и CORS.';
      });

      function debounce(fn,ms){ var t; return function(){ var a=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,a) },ms) } }
      var applySearch = debounce(function(){ query=qInp.value.trim().toLowerCase(); render(); }, 120);
      qInp.addEventListener('input', applySearch);
      qClr.addEventListener('click', function(){ qInp.value=''; query=''; render(); qInp.focus(); });

      sortersBox.addEventListener('click', function(e){
        var btn=e.target.closest('button[data-sort]'); if(!btn) return;
        currentSort = btn.dataset.sort; syncSortUI(); render();
      });

      document.addEventListener('keydown', function(e){
        var key=(e.key||'').toLowerCase();
        if(key==='/' && document.activeElement!==qInp){ qInp.focus(); qInp.select(); e.preventDefault(); }
        else if(key==='escape'){ if(qInp.value){ qInp.value=''; query=''; render(); } }
      });
    })();
  </script>
</body>
</html>
