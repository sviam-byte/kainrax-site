<!doctype html>
<html lang="ru" data-theme="subsurface">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–æ—Å–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞ ‚Äî –ö–∞–π–Ω—Ä–∞–∫—Å</title>
  <meta name="description" content="–ë—ã—Ç, —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏, —Ç–µ—Ö—É–∑–ª—ã. –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –≤–µ—Ç–∫–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ –º–∏—Ä–∞ –ö–∞–π–Ω—Ä–∞–∫—Å." />
  <meta name="theme-color" content="#0b0f14" />

  <link rel="icon" type="image/svg+xml" id="favicon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%237dd3fc'/%3E%3Cstop offset='70%25' stop-color='%230b0f14' stop-opacity='.05'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%230b0f14'/%3E%3Cpath d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z' fill='url(%23g)'/%3E%3Ccircle cx='32' cy='32' r='2.4' fill='%23a78bfa'/%3E%3C/svg%3E" />
  <link rel="icon" type="image/png" sizes="64x64" href="/assets/icon-64.png" />

  <!-- –ú–ï–¢–†–ò–ö–ê (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
  <script src="/assets/metrika.js" defer></script>

  <style>
    :root{
      --bg:#0b0f14; --bg-soft:#0f1620; --panel:#0e141d; --card:#0e141d; --text:#e6edf5; --muted:#9fb0c7;
      --brand:#7dd3fc; --tag:#112131; --tag-on:#183140; --ring:#7dd3fc; --link:#bfe9ff;
      --gap:12px; --r:14px; --shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 8px 30px rgba(0,0,0,.35);
      --border:rgba(255,255,255,.08);
    }
    html[data-theme="sepia"]{
      --bg:#f8f4ec; --bg-soft:#f2eadf; --panel:#ffffff; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --brand:#d6b778; --tag:#efe3cc; --tag-on:#e6d8be; --ring:#d6b778; --link:#0b66d3;
      --shadow:0 1px 0 rgba(0,0,0,.03) inset, 0 8px 30px rgba(0,0,0,.08);
      --border:rgba(0,0,0,.08);
    }
    html[data-theme="glitch"]{
      --bg:#07090d; --bg-soft:#0b0f16; --panel:#0c121b; --card:#0c121b; --text:#e8f0ff; --muted:#9fb6d6;
      --brand:#a78bfa; --link:#b9a4ff; --tag:#0d1a2a; --tag-on:#14253a; --ring:#a78bfa; --border:rgba(255,255,255,.08);
    }

    html,body{height:100%}
    html{scroll-behavior:smooth}
    @media (prefers-reduced-motion: reduce){
      html{scroll-behavior:auto}
    }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    :focus-visible{outline:2px solid var(--ring); outline-offset:2px}

    /* –®–∞–ø–∫–∞ */
    .kx-head{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 16px;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid var(--border)}
    html[data-theme="sepia"] .kx-head{background:linear-gradient(180deg,rgba(255,255,255,.88),rgba(255,255,255,0))}
    .kx-brand{font-weight:800;color:var(--text)}
    .kx-nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kx-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--tag);border:1px solid var(--border);box-shadow:var(--shadow);color:var(--text)}
    .kx-btn:hover{transform:translateY(-1px)}
    .is-active{outline:2px solid var(--ring)}
    .kx-cta{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0)),var(--tag-on);border-color:var(--border);font-weight:600}

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º */
    .kx-themes{display:flex;gap:6px}
    .kx-pill{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--tag);color:var(--muted);border:1px solid var(--border);cursor:pointer}
    .kx-pill[data-on="true"]{background:var(--tag-on);color:var(--text);outline:1px solid var(--ring)}

    /* –û–±–æ–ª–æ—á–∫–∞ */
    .kx-shell{max-width:1100px;margin:0 auto;padding:16px}
    .kx-panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}

    h1{margin:0 0 6px 0;font-size:22px}
    .kx-muted{color:var(--muted);font-size:14px}

    /* –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π */
    .bar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
    #filters{display:flex;gap:6px;flex-wrap:wrap}
    #sorters{display:flex;gap:8px;flex-wrap:wrap}
    #sorters .kx-btn.is-active{outline:1px solid var(--ring);background:var(--tag-on);color:var(--text)}
    .search{flex:1;min-width:220px;display:flex;gap:8px}
    .search input{flex:1;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}

    /* –°–µ—Ç–∫–∞ —Ç–µ–º */
    .kx-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .kx-thread{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px;box-shadow:var(--shadow)}
    .kx-title{margin:2px 0 4px 0;font-size:18px}
    .kx-sub{font-size:12px;color:var(--muted)}
    .kx-preview{margin:8px 0 10px 0}
    .kx-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .kx-tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:10px;background:var(--tag);color:var(--muted);font-size:12px;border:1px solid var(--border);cursor:pointer}
    .kx-tag--on{background:var(--tag-on);color:var(--text)}

    /* –ì–ª–∏—Ç—á-–ø–æ–¥–ª–æ–∂–∫–∞ */
    html[data-theme="glitch"] .kx-link{position:relative;display:block;background:linear-gradient(0deg,rgba(255,255,255,.012),rgba(255,255,255,0))}
    html[data-theme="glitch"] .kx-link::after{content:"";position:absolute;inset:0;mix-blend-mode:screen;opacity:.07;background:repeating-linear-gradient(180deg,rgba(167,139,250,.25) 0 1px,transparent 1px 3px),repeating-linear-gradient(90deg,rgba(125,211,252,.15) 0 2px,transparent 2px 4px);pointer-events:none}

    /* –õ–∏–Ω–∏—è –Ω–µ–±–∞ */
    #sky-line{position:fixed;left:0;right:0;height:3px;z-index:0;pointer-events:none;opacity:.7;filter:blur(1px);background:radial-gradient(ellipse 80% 150% at 50% 50%, var(--brand) 0%, transparent 40%)}

    /* –°–∫–µ–ª–µ—Ç–æ–Ω */
    .skeleton{border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.08), rgba(255,255,255,.04));animation:sh 1.4s infinite}
    html[data-theme="sepia"] .skeleton{background:linear-gradient(90deg, rgba(0,0,0,.04), rgba(0,0,0,.08), rgba(0,0,0,.04))}
    @keyframes sh{0%{background-position:-200px 0}100%{background-position:200px 0}}
    .kx-skeleton-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .kx-skeleton-card{height:140px;border:1px solid var(--border)}

    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    .kx-msg{padding:14px;border:1px dashed var(--border);border-radius:10px;background:var(--card);color:var(--muted)}

    /* ABOUT */
    .kx-about{margin:10px 0 14px}
    .kx-about details{
      position:relative;border:1px solid var(--border);border-radius:var(--r);background:var(--card);box-shadow:var(--shadow);overflow:hidden;max-width:760px;margin:0 auto;
    }
    .kx-about details::before{
      content:"";position:absolute; inset:0 auto 0 0; width:4px;background:linear-gradient(180deg, var(--brand), transparent);opacity:.65; pointer-events:none;
    }
    .kx-about summary{
      list-style:none; cursor:pointer; user-select:none;padding:9px 12px;display:flex; align-items:center; gap:8px;font-weight:600; font-size:15px;
    }
    .kx-about summary::-webkit-details-marker{display:none}
    .kx-about .caret{transition:transform .18s ease; font-size:12px; line-height:1; opacity:.85}
    .kx-about details[open] .caret{transform:rotate(90deg)}
    .kx-about .body{padding:0 12px 12px; color:var(--muted)}
    .kx-badge{font-size:12px; padding:4px 8px; border-radius:999px;background:var(--tag); border:1px solid var(--border); color:var(--muted);margin-right:6px;}

    @media (max-width:480px){
      .kx-head{gap:8px}
      .kx-nav{gap:6px}
      .kx-btn{padding:7px 10px}
      .kx-pill{padding:5px 8px}
    }
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>

  <header class="kx-head" role="banner">
    <a class="kx-brand" href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">–ö–∞–π–Ω—Ä–∞–∫—Å ‚ú∂</a>
    <nav class="kx-nav" role="navigation" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è">
      <a class="kx-btn" href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">‚Üê –∫ —Ä–∞—Å—Å–∫–∞–∑–∞–º</a>
      <a class="kx-btn is-active" href="/index.html" aria-current="page">–¢–µ–º—ã</a>
      <a class="kx-btn" href="/people.html">–í—Å–µ –ª—é–¥–∏</a>
      <a class="kx-btn" href="/tags.html">–¢–µ–≥–∏</a>
      <a class="kx-btn kx-cta" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow" aria-label="–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</a>
      <div class="kx-themes" id="themePicker" aria-label="–¢–µ–º—ã">
        <button class="kx-pill" data-theme="subsurface" type="button">Subsurface Lab</button>
        <button class="kx-pill" data-theme="sepia" type="button">Archive Sepia</button>
        <button class="kx-pill" data-theme="glitch" type="button">Glitch Basilica</button>
      </div>
    </nav>
  </header>

  <main class="kx-shell" id="main">
    <section class="kx-panel" aria-labelledby="h1">
      <h1 id="h1">–î–æ—Å–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞</h1>

      <div class="kx-about" id="about">
        <details id="aboutBox" aria-labelledby="aboutTitle">
          <summary><span class="caret" aria-hidden="true">‚ñ∏</span><span id="aboutTitle">–ß—Ç–æ –∑–¥–µ—Å—å –≤–æ–æ–±—â–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?</span></summary>
          <div class="body">
            <p>
              <span class="kx-badge">in-world –ø—Ä–æ–µ–∫—Ç</span>
              <span class="kx-badge">—Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–∏–∫—Ü–∏—è</span>
              <span class="kx-badge">—Ñ–æ—Ä—É–º –≤–Ω—É—Ç—Ä–∏ –º–∏—Ä–∞</span>
            </p>
            <p><strong>–ß—Ç–æ —ç—Ç–æ.</strong> ¬´–î–æ—Å–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞¬ª ‚Äî —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π in-world-–ø—Ä–æ–µ–∫—Ç –≤–æ –≤—Å–µ–ª–µ–Ω–Ω–æ–π –ö–∞–π–Ω—Ä–∞–∫—Å. –ó–¥–µ—Å—å –∑–∞–ø–∏—Å–∏ –∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π.</p>
            <p><strong>–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ.</strong></p>
            <ul>
              <li><strong>–ö–∞—Ä—Ç–æ—á–∫–∞ = –≤–µ—Ç–∫–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏—è.</strong></li>
              <li><strong>–ê–≤—Ç–æ—Ä—ã –∏ —Ä–æ–ª–∏ ‚Äî –≤-–º–∏—Ä–µ.</strong></li>
              <li><strong>–í—Ä–µ–º—è.</strong> ¬´N-–π –¥–µ–Ω—å 430-–≥–æ –≥–æ–¥–∞¬ª –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è.</li>
              <li><strong>–°—Ç—Ä—É–∫—Ç—É—Ä–∞.</strong> –°–µ–∫—Ç–æ—Ä, —Ç–µ—Ö—É–∑–µ–ª, —Ç–µ–≥–∏.</li>
            </ul>
            <p><strong>–ß—Ç–æ —Å—á–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–¥–æ–π.</strong> –ù–∏—á–µ–≥–æ. –ö–∞–Ω–æ–Ω ‚Äî –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–∞—Å—Å–∫–∞–∑–∞—Ö.</p>
            <p><strong>–ö–∞–∫ —á–∏—Ç–∞—Ç—å.</strong> –§–∏–ª—å—Ç—Ä—ã, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –ø–æ–∏—Å–∫; –∫–ª–∏–∫–∏ –ø–æ –∞–≤—Ç–æ—Ä–∞–º –∏ —Ç–µ–≥–∞–º.</p>
            <p class="kx-muted">–î–∏—Å–∫–ª–µ–π–º–µ—Ä: —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã. –ñ–∏–∑–Ω—å —Å—Ç—Ä–∞–Ω–Ω–∞—è. <a href="https://www.youtube.com/watch?v=HIcSWuKMwOw" target="_blank" rel="noopener">–†–∏–∫—Ä–æ–ª–ª</a>.</p>
            <p>–ï—â—ë: <a href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">—Ä–∞—Å—Å–∫–∞–∑—ã</a> ¬∑ <a href="https://t.me/kainrax" target="_blank" rel="noopener nofollow">Telegram</a></p>
          </div>
        </details>
      </div>

      <div class="kx-about" id="stories">
        <details id="storiesBox" aria-labelledby="storiesTitle">
          <summary><span class="caret" aria-hidden="true">‚ñ∏</span><span id="storiesTitle">–°—é–∂–µ—Ç—ã (–∞—Ä–∫–∏)</span></summary>
          <div class="body">
            <ul>
              <li><strong>–ê—Ä–∫–∞: –∫–∏—Å–ª–æ—Ä–æ–¥ –∏ –ê-–∫–∞—Ç–µ–≥–æ—Ä–∏—è</strong> ‚Äî —Å–µ–π—á–∞—Å –ø–æ —Ç–µ–≥—É –ê-–∫–∞—Ç–µ–≥–æ—Ä–∏—è. <span class="kx-muted">—Å <b>100-–≥–æ</b> –ø–æ <b>‚Äî–π</b> –¥–µ–Ω—å 430-–≥–æ –≥–æ–¥–∞</span></li>
              <li><strong>–ê—Ä–∫–∞: –¢–∏—Ö–∏–π –î–æ–∂–¥—å</strong> ‚Äî —Å–µ–Ω—Å–æ—Ä–Ω—ã–π ¬´–¥–æ–∂–¥—å¬ª, –¥–∞–≤–ª–µ–Ω–∏–µ –ö—É—Ä–∞—Ç–æ—Ä–∞, –±–ª—ç–∫–∞—É—Ç. <span class="kx-muted">—Å <b>96-–≥–æ</b> –ø–æ <b>99-–π</b> –¥–µ–Ω—å</span></li>
              <li><strong>–ê—Ä–∫–∞: ¬´–ü—Ä–æ—Ç–æ–∫–æ–ª –ø—Ä–æ—Ç–∏–≤ –ß–µ–ª–æ–≤–µ—á–Ω–æ—Å—Ç–∏¬ª</strong> ‚Äî —Å—Ç–∞–∂—ë—Ä–Ω–∞—è –¥–∏–ª–µ–º–º–∞. <span class="kx-muted">—Å <b>72-–≥–æ</b> –ø–æ <b>93-–π</b> –¥–µ–Ω—å</span></li>
              <li><strong>¬´–¢—Ä–∞–≥–µ–¥–∏—è –∫–∞–¥–µ—Ç–æ–≤ –∏–∑ –¢–µ–ª–µ–º–∞¬ª</strong> ‚Äî –±–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–π —Ñ–∏–Ω–∞–ª. <span class="kx-muted">—Å <b>94-–≥–æ</b> –ø–æ <b>95-–π</b> –¥–µ–Ω—å</span></li>
            </ul>
            <hr style="border:0;border-top:1px solid var(--border);opacity:.6;margin:10px 0">
            <ul>
              <li><strong>–û–±–∑–æ—Ä—ã –µ–¥—ã</strong> ‚Äî –ø–∞–π–∫–∏ –∏ –ø—Ä–æ—á–µ–µ. <span class="kx-muted">73-95 –¥–µ–Ω—å</span></li>
              <li><strong>–ò—Å—Ç–æ—Ä–∏–∏ —Å –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏</strong> ‚Äî —Ä–µ–π—Å—ã, —Ç–∞–º–æ–∂–Ω–∏. <span class="kx-muted">70-96 –¥–µ–Ω—å</span></li>
              <li><strong>–£—á–µ–±–Ω—ã–µ –∑–∞–ø–∏—Å–∏</strong> ‚Äî –ª–µ–∫—Ü–∏–∏, –æ—Ç—á—ë—Ç—ã. <span class="kx-muted">70-79 –¥–µ–Ω—å</span></li>
            </ul>
          </div>
        </details>
      </div>

      <p class="kx-muted">–ë—ã—Ç, —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏, —Ç–µ—Ö—É–∑–ª—ã. –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ ‚Äî –≤–µ—Ç–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∏–ª—å—Ç—Ä—ã, –ø–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É.</p>

      <div class="bar" role="group" aria-label="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã">
        <div id="filters" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã"></div>

        <div id="sorters" role="group" aria-label="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞">
          <button class="kx-btn" data-sort="newest" aria-pressed="true" type="button">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</button>
          <button class="kx-btn" data-sort="popular" aria-pressed="false" type="button">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
        </div>

        <div class="search" role="search">
          <input id="q" type="search" placeholder="–ø–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É, —Ç–µ–∫—Å—Ç—É, —Ç–µ–≥–∞–º, –∞–≤—Ç–æ—Ä—É‚Ä¶  (–Ω–∞–∂–º–∏ /)" autocomplete="off" aria-label="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–∞–º" />
          <button class="kx-btn" id="clearQ" type="button" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <div id="threads" class="kx-grid" aria-live="polite"></div>
      <div id="status" class="kx-msg" hidden></div>

      <div id="skeleton" class="kx-skeleton-grid" aria-hidden="true">
        <div class="kx-skeleton-card skeleton"></div>
        <div class="kx-skeleton-card skeleton"></div>
        <div class="kx-skeleton-card skeleton"></div>
        <div class="kx-skeleton-card skeleton"></div>
        <div class="kx-skeleton-card skeleton"></div>
        <div class="kx-skeleton-card skeleton"></div>
      </div>
    </section>
  </main>

  <script type="module">
    // ---------- –ü–æ–ª–æ—Å–∞ –Ω–µ–±–∞ ----------
    (function initSkyLine(){
      const el=document.getElementById('sky-line'); let run=true;
      function tick(){
        const n=new Date();
        const ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds();
        el.style.top=(ms/86400000*100)+'vh';
        if(run) requestAnimationFrame(tick);
      }
      document.addEventListener('visibilitychange',()=>{run=document.visibilityState==='visible'; if(run) requestAnimationFrame(tick)});
      requestAnimationFrame(tick);
    })();

    // ---------- –¢–µ–º–∞ + —Ö–æ—Ç–∫–µ–π T ----------
    const THEMES=['subsurface','sepia','glitch'];
    const themeKey='kx-theme';
    function applyTheme(t){
      if(!THEMES.includes(t)) t='subsurface';
      document.documentElement.setAttribute('data-theme', t);
      try{ localStorage.setItem(themeKey, t) }catch(_){}
      document.querySelectorAll('.kx-pill').forEach(b=> b.dataset.on = (b.dataset.theme===t) ? 'true' : 'false');
      const meta=document.querySelector('meta[name="theme-color"]');
      if(meta){
        const bg=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0b0f14';
        meta.setAttribute('content', bg);
      }
    }
    (function initTheme(){
      let t='subsurface';
      try{ t=localStorage.getItem(themeKey)||t }catch(_){}
      applyTheme(t);
      document.getElementById('themePicker').addEventListener('click', e=>{
        const btn=e.target.closest('.kx-pill'); if(!btn) return; applyTheme(btn.dataset.theme);
      });
      document.addEventListener('keyup', e=>{
        if((e.key||'').toLowerCase()!=='t') return;
        const cur=document.documentElement.getAttribute('data-theme')||'subsurface';
        const next=THEMES[(THEMES.indexOf(cur)+1)%THEMES.length];
        applyTheme(next);
      });
    })();

    // ---------- –î–∞—Ç–∞: ISO ‚Üí ¬´–¥–µ–Ω—å/–≥–æ–¥¬ª, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ¬´430-218 22:17¬ª ----------
    function fmtDayYear(s){
      if(!s) return '';
      const m = String(s).trim().match(/^(\d{3,4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if (m){
        const yy=+m[1], doy=+m[2];
        const hh=m[3]?m[3].padStart(2,'0'):'00', mm=m[4]?m[4]:'00';
        return `${doy}-–π –¥–µ–Ω—å ${yy}-–≥–æ –≥–æ–¥–∞, ${hh}:${mm}`;
      }
      const d = new Date(s);
      if (!isNaN(d)){
        const ry = d.getUTCFullYear();
        const wy = ry===2024 ? 429 : ry===2025 ? 430 : (ry - 1595);
        const start=new Date(Date.UTC(ry,0,1));
        const doy=Math.floor((d - start)/86400000)+1;
        const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
        return `${doy}-–π –¥–µ–Ω—å ${wy}-–≥–æ –≥–æ–¥–∞, ${hh}:${mm}`;
      }
      return s;
    }

    // ---------- –£—Ç–∏–ª–∏—Ç—ã ----------
    const qs = (s,root=document)=>root.querySelector(s);
    function esc(s){return (s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]))}
    function slugify(s){ return String(s||'anon').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_.]+/g,'').slice(0,64) }
    async function loadIndex(){ try{ const r=await fetch('/content/threads-index.json',{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json() }catch(err){ console.error(err); return {error: String(err), items: []} } }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms) } }
    function throttle(fn, ms){ let last=0, id=null, lastArgs=null; return (...args)=>{ const now=Date.now(); lastArgs=args; if(now-last>=ms){ last=now; fn(...args); } else { clearTimeout(id); id=setTimeout(()=>{ last=Date.now(); fn(...lastArgs); }, ms-(now-last)); } } }

    // –≠–º–æ–¥–∑–∏-¬´–∞–≤–∞—Ç–∞—Ä¬ª
    const EMO=["üõ†Ô∏è","ü™´","üõ∞Ô∏è","üß≠","üåò","üí°","‚öôÔ∏è","üß™","üì°","üß±","ü™ì","‚õìÔ∏è","üßØ","üîß","üî≠","ü™®","üå´Ô∏è","üåä","ü™ô","üúÇ","üúÅ","üúÑ","üúÉ"];
    function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0 }
    function authorEmoji(name){ const i = hashStr(name||'anon') % EMO.length; return EMO[i] }

    // ---------- –°–æ—Å—Ç–æ—è–Ω–∏–µ ----------
    const box=qs('#threads'), filt=qs('#filters');
    const qInp=qs('#q'), qClr=qs('#clearQ');
    const sortersBox=qs('#sorters');
    const statusBox=qs('#status');
    const skeleton=qs('#skeleton');

    const sortKey='kx-sort';
    let allItems=[], currentBoard='', query='';
    let currentSort='newest';
    try{ currentSort = localStorage.getItem(sortKey) || 'newest'; }catch(_){ }

    // ---------- URL <-> state ----------
    function readURL(){
      const u=new URL(location.href);
      currentBoard=u.searchParams.get('board')||'';
      query=(u.searchParams.get('q')||'').toLowerCase();
      const s=u.searchParams.get('sort'); if(s==='popular'||s==='newest') currentSort=s;
      qInp.value=query;
    }
    function writeURL(){
      const u=new URL(location.href);
      if(currentBoard) u.searchParams.set('board', currentBoard); else u.searchParams.delete('board');
      if(query) u.searchParams.set('q', query); else u.searchParams.delete('q');
      u.searchParams.set('sort', currentSort);
      history.replaceState({...history.state},'',u);
    }

    function card(t){
      const when=fmtDayYear(t.created);
      const preview=(t.body||'').replace(/\s+/g,' ').slice(0,200)+(t.body&&t.body.length>200?'‚Ä¶':'');
      const name=esc(t.author||'anon'); const aId=encodeURIComponent(t.author_id||slugify(name));
      const emo=authorEmoji(name);
      const tags=(t.tags||[]).map(x=>`<a class="kx-tag" href="/tags.html#/${encodeURIComponent(x)}" title="–ü–æ—Å—Ç—ã —Å —Ç–µ–≥–æ–º ${esc(x)}">${esc(x)}</a>`).join(' ');
      const cc = t.commentCount||0;
      return `<article class="kx-thread">
        <a class="kx-link" href="/thread.html#/${encodeURIComponent(t.id)}"><h3 class="kx-title">‚ú∂ ${esc(t.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h3></a>
        <div class="kx-sub">${when} ¬∑ <a href="/author.html#/${aId}" title="–í—Å–µ –ø–æ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∞">${emo} ${name}</a> ¬∑ —Å–µ–∫—Ç–æ—Ä: ${esc(t.sector||'‚Äî')}${t.board?` ¬∑ —Ä–∞–∑–¥–µ–ª: ${esc(t.board)}`:''}${cc?` ¬∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${cc}`:''}</div>
        <p class="kx-preview">${esc(preview)}</p>
        <div class="kx-tags">${tags}</div>
      </article>`;
    }

    function matches(t){
      if ((t.board||'') === '–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏') return false;
      if(currentBoard && (t.board||'')!==currentBoard) return false;
      if(!query) return true;
      const hay = [t.title,t.body,(t.tags||[]).join(' '),t.author,t.sector,t.id].join(' ').toLowerCase();
      return hay.includes(query);
    }

    function render(){
      let items = allItems.filter(matches);
      if (currentSort === 'popular') {
        items.sort((a,b)=> (b.commentCount||0) - (a.commentCount||0) || (new Date(b.created) - new Date(a.created)));
      } else {
        items.sort((a,b)=> new Date(b.created) - new Date(a.created));
      }
      box.innerHTML = items.length ? items.map(card).join('') : `<div class="kx-msg">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Ä–∞–∑–¥–µ–ª.</div>`;
      writeURL();
      // –µ—Å–ª–∏ –º—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –ø–æ ¬´–ù–∞–∑–∞–¥¬ª, –ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–æ–ª–ª —É–∂–µ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
      scheduleRestore();
    }

    function renderBoards(){
      const boards = Array.from(new Set(allItems.map(x=>x.board).filter(b=>b && b!=='–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏'))).sort();
      if(!boards.length){ filt.innerHTML=''; return; }
      const chip = b => `<span class="kx-tag${b===currentBoard?' kx-tag--on':''}" role="tab" aria-selected="${b===currentBoard?'true':'false'}" tabindex="0" data-board="${esc(b)}">${esc(b)}</span>`;
      filt.innerHTML = `<span class="kx-tag${!currentBoard?' kx-tag--on':''}" role="tab" aria-selected="${!currentBoard?'true':'false'}" tabindex="0" data-board="">–í—Å–µ</span>` + boards.map(chip).join('');
      filt.onclick = e=>{ const el=e.target.closest('.kx-tag'); if(!el) return; currentBoard = el.dataset.board || ''; renderBoards(); render(); };
      filt.onkeydown = e=>{ if(e.key==='Enter' || e.key===' '){ const el=e.target.closest('.kx-tag'); if(!el) return; currentBoard = el.dataset.board || ''; renderBoards(); render(); e.preventDefault(); } };
    }

    function syncSortUI(){
      sortersBox.querySelectorAll('button[data-sort]').forEach(btn=>{
        const on = btn.dataset.sort === currentSort;
        btn.classList.toggle('is-active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }

    // ---------- –ù–∞–¥—ë–∂–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ ----------
    history.scrollRestoration = 'manual';
    const SCROLL_KEY = 'kx-scroll:'+location.pathname+location.search+location.hash;

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º state, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
    if(!history.state || typeof history.state !== 'object' || !('scroll' in history.state)){
      try { history.replaceState({scroll:[scrollX, scrollY]}, ''); } catch(_){}
    }

    const saveScroll = throttle(()=>{
      try {
        const st = {...(history.state||{}) , scroll:[scrollX, scrollY]};
        history.replaceState(st, '');
        sessionStorage.setItem(SCROLL_KEY, JSON.stringify(st.scroll));
      } catch(_) {}
    }, 120);

    let desiredScrollY = null;
    function restoreNow(y){
      if(typeof y !== 'number') return;
      const html = document.documentElement;
      const prev = html.style.scrollBehavior;
      html.style.scrollBehavior = 'auto';
      window.scrollTo(0, y);
      html.style.scrollBehavior = prev;
    }

    function scheduleRestore(){
      if(desiredScrollY == null) return;
      let tries = 0;
      const tick = ()=>{
        tries++;
        const vh = window.innerHeight || document.documentElement.clientHeight || 0;
        const bodyH = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        // –ñ–¥—ë–º –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ—Ä–∏—Å—É–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –¥–æ –Ω—É–∂–Ω–æ–π —Ç–æ—á–∫–∏
        if (bodyH >= desiredScrollY + Math.floor(vh*0.5) || tries > 60){
          restoreNow(desiredScrollY);
          desiredScrollY = null;
        } else {
          requestAnimationFrame(tick);
        }
      };
      requestAnimationFrame(tick);
    }

    function pullSavedScroll(eState){
      const fromState = eState && eState.scroll;
      if (Array.isArray(fromState) && typeof fromState[1]==='number') return fromState[1];
      try {
        const ss = JSON.parse(sessionStorage.getItem(SCROLL_KEY) || 'null');
        if (Array.isArray(ss) && typeof ss[1]==='number') return ss[1];
      } catch(_){}
      return null;
    }

    window.addEventListener('pageshow', (e)=>{
      // –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ bfcache –±—Ä–∞—É–∑–µ—Ä —á–∞—Å—Ç–æ —Å–∞–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç, –Ω–æ —É —Ç–µ–±—è —ç—Ç–æ –ª–æ–º–∞–ª–æ—Å—å –∏–∑-–∑–∞ –ø–æ–∑–¥–Ω–µ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
      const y = pullSavedScroll(history.state);
      if (y != null) { desiredScrollY = y; scheduleRestore(); }
    });

    window.addEventListener('popstate', (e)=>{
      const y = pullSavedScroll(e.state);
      if (y != null) { desiredScrollY = y; scheduleRestore(); }
    });

    window.addEventListener('scroll', saveScroll, {passive:true});
    window.addEventListener('pagehide', saveScroll, {capture:true});

    // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ UI ----------
    readURL();
    syncSortUI();

    // –°–∫–µ–ª–µ—Ç–æ–Ω –≤–∫–ª –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
    skeleton.hidden=false; box.innerHTML='';

    const payload = await loadIndex();
    if(payload && payload.error){
      statusBox.hidden=false;
      statusBox.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å /content/threads-index.json ‚Äî ' + payload.error + '. –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∏ CORS.';
    }
    allItems = Array.isArray(payload) ? payload : Array.isArray(payload.items) ? payload.items : [];

    renderBoards(); render();
    skeleton.hidden=true;

    // ---------- –°–æ–±—ã—Ç–∏—è ----------
    const applySearch = debounce(()=>{ query=qInp.value.trim().toLowerCase(); render(); }, 120);
    qInp.addEventListener('input', applySearch);
    qClr.addEventListener('click', ()=>{ qInp.value=''; query=''; render(); qInp.focus(); });

    sortersBox.addEventListener('click', e=>{
      const btn=e.target.closest('button[data-sort]'); if(!btn) return;
      currentSort = btn.dataset.sort;
      try{ localStorage.setItem(sortKey, currentSort) }catch(_){}
      syncSortUI(); render();
    });

    // –•–æ—Ç–∫–µ–∏: / ‚Äî –ø–æ–∏—Å–∫, Esc ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å, T ‚Äî —Ç–µ–º–∞, ? ‚Äî –æ—Ç–∫—Ä—ã—Ç—å ¬´–æ –ø—Ä–æ–µ–∫—Ç–µ¬ª
    document.addEventListener('keydown', e=>{
      const key=(e.key||'').toLowerCase();
      const tag=(e.target && (e.target.tagName||'')).toLowerCase();
      const typing = tag==='input' || tag==='textarea' || (e.target && e.target.isContentEditable);
      if(key==='/' && !typing){ qInp.focus(); qInp.select(); e.preventDefault(); }
      else if(key==='escape'){ if(qInp.value){ qInp.value=''; query=''; render(); } }
      else if(key==='?' && !typing){
        const box = document.getElementById('aboutBox');
        if(box && !box.open){ box.open = true; document.getElementById('aboutTitle')?.focus?.(); }
      }
    });

    // ABOUT: –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è + –∞–≤—Ç–æ–ø–æ–∫–∞–∑ –ø–æ URL
    (function initAbout(){
      const box = document.getElementById('aboutBox');
      if(!box) return;
      const key = 'kx-about-open';
      try{
        const saved = localStorage.getItem(key);
        if(saved==='1') box.open = true;
      }catch(_){}
      const u = new URL(location.href);
      if(u.hash==='#about' || u.searchParams.get('about')==='1'){ box.open = true; }
      box.addEventListener('toggle', ()=>{
        try{ localStorage.setItem(key, box.open ? '1':'0'); }catch(_){}
      });
    })();

    // –§–∏–∫—Å: –µ—Å–ª–∏ hash –±—ã–ª, –ø–µ—Ä–µ–≤–µ–¥—ë–º –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞—Å–ª–µ–¥–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å—Å—ã–ª–æ–∫)
    if(location.hash && !location.search){
      const m=location.hash.match(/^#\/(.+)$/); if(m){ currentBoard=decodeURIComponent(m[1]); renderBoards(); render(); }
    }
  </script>
</body>
</html>
