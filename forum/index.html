<!doctype html>
<html lang="ru" data-theme="subsurface">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Доска сектора — Кайнракс</title>
  <meta name="theme-color" content="#0b0f14" />
  <!-- Фавикон -->
  <link rel="icon" type="image/svg+xml" id="favicon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%237dd3fc'/%3E%3Cstop offset='70%25' stop-color='%230b0f14' stop-opacity='.05'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%230b0f14'/%3E%3Cpath d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z' fill='url(%23g)'/%3E%3Ccircle cx='32' cy='32' r='2.4' fill='%23a78bfa'/%3E%3C/svg%3E" />
  <link rel="icon" type="image/png" sizes="64x64" href="/assets/icon-64.png" />
  <style>
    :root{
      --bg:#0b0f14; --bg-soft:#0f1620; --panel:#0e141d; --text:#e6edf5; --muted:#9fb0c7;
      --brand:#7dd3fc; --tag:#112131; --tag-on:#183140; --ring:#7dd3fc; --card:#0e141d; --link:#bfe9ff;
      --gap:12px; --r:14px; --shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 8px 30px rgba(0,0,0,.35);
    }
    html[data-theme="sepia"]{ --bg:#0e0b09; --bg-soft:#14100d; --panel:#16120d; --card:#17120e; --text:#ece3d3; --muted:#bdae95; --brand:#d2b48c; --link:#f3d7a6; --tag:#2a2218; --tag-on:#3a2f21; --ring:#d6b778; }
    html[data-theme="glitch"]{ --bg:#07090d; --bg-soft:#0b0f16; --panel:#0c121b; --card:#0c121b; --text:#e8f0ff; --muted:#9fb6d6; --brand:#a78bfa; --link:#b9a4ff; --tag:#0d1a2a; --tag-on:#14253a; --ring:#a78bfa; }
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}

    .kx-head{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 16px;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid rgba(255,255,255,.05)}
    .kx-brand{font-weight:800;color:var(--text)} .kx-nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kx-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--tag);border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow);color:var(--text)}
    .kx-btn:hover{transform:translateY(-1px)} .is-active{outline:2px solid var(--ring)}
    .kx-cta{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0)),var(--tag-on);border-color:rgba(255,255,255,.12);font-weight:600}

    .kx-themes{display:flex;gap:6px} .kx-pill{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--tag);color:var(--muted);border:1px solid rgba(255,255,255,.06);cursor:pointer}
    .kx-pill[data-on="true"]{background:var(--tag-on);color:var(--text);outline:1px solid var(--ring)}

    .kx-shell{max-width:1100px;margin:0 auto;padding:16px}
    .kx-panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    h1{margin:0 0 6px 0;font-size:22px} .kx-muted{color:var(--muted);font-size:14px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 12px}
    .search{flex:1;min-width:220px;display:flex;gap:8px}
    .search input{flex:1;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:var(--card);color:var(--text)}

    .kx-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .kx-thread{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);position:relative;overflow:hidden}
    .kx-thread .kx-title{margin:2px 0 4px 0;font-size:18px}
    .kx-sub{font-size:12px;color:var(--muted)} .kx-preview{margin:8px 0 10px 0}
    .kx-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .kx-tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:10px;background:var(--tag);color:var(--muted);font-size:12px;border:1px solid rgba(255,255,255,.06)}
    .kx-tag--on{background:var(--tag-on);color:var(--text)}
    #sky-line{position:fixed;left:0;right:0;height:3px;z-index:0;pointer-events:none;opacity:.7;filter:blur(1px);background:radial-gradient(ellipse 80% 150% at 50% 50%, var(--brand) 0%, transparent 40%)}
    html[data-theme="glitch"] .kx-link{position:relative;display:block;background:linear-gradient(0deg,rgba(255,255,255,.012),rgba(255,255,255,0))}
    html[data-theme="glitch"] .kx-link::after{content:"";position:absolute;inset:0;mix-blend-mode:screen;opacity:.07;background:repeating-linear-gradient(180deg,rgba(167,139,250,.25) 0 1px,transparent 1px 3px),repeating-linear-gradient(90deg,rgba(125,211,252,.15) 0 2px,transparent 2px 4px);pointer-events:none}
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>

  <header class="kx-head">
    <a class="kx-brand" href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">Кайнракс ✶</a>
    <nav class="kx-nav">
      <a class="kx-btn" href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">← к рассказам</a>
      <a class="kx-btn is-active" href="/index.html">Темы</a>
      <a class="kx-btn" href="/people.html">Все люди</a>
      <a class="kx-btn kx-cta" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow" aria-label="Подписаться на канал в Telegram">
        <!-- одна кнопка, без дублирующего TG -->
        <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M9.75 15.5 9.9 12.7l6.1-5.52c.28-.25-.07-.37-.43-.17l-7.54 4.75-3.16-1c-.69-.22-.7-.68.15-1.02l12.34-4.76c.57-.21 1.12.14.93 1.02l-2.1 9.89c-.14.65-.52.8-1.05.5l-2.91-2.15-1.4 1.36c-.16.16-.3.3-.6.3z" fill="currentColor"/></svg>
        <span>Подписаться</span>
      </a>
      <div class="kx-themes" id="themePicker">
        <button class="kx-pill" data-theme="subsurface">Subsurface Lab</button>
        <button class="kx-pill" data-theme="sepia">Archive Sepia</button>
        <button class="kx-pill" data-theme="glitch">Glitch Basilica</button>
      </div>
    </nav>
  </header>

  <main class="kx-shell">
    <section class="kx-panel">
      <h1>Доска сектора</h1>
      <p class="kx-muted">Быт, странности, техузлы. Каждая карточка — ветка.</p>

      <div class="bar">
        <div id="filters"></div>
        <div class="search">
          <input id="q" type="search" placeholder="поиск по заголовку, тексту, тегам, автору…" autocomplete="off">
          <button class="kx-btn" id="clearQ">Сброс</button>
        </div>
      </div>

      <div id="threads" class="kx-grid"></div>
    </section>
  </main>

  <script type="module">
    // Полоса неба
    (function initSkyLine(){
      const el=document.getElementById('sky-line'); let run=true;
      function tick(){ const n=new Date(); const ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds(); el.style.top=(ms/86400000*100)+'vh'; if(run) requestAnimationFrame(tick); }
      document.addEventListener('visibilitychange',()=>{run=document.visibilityState==='visible'; if(run) requestAnimationFrame(tick)});
      requestAnimationFrame(tick);
    })();

    // Темы + хоткей T
    const THEMES=['subsurface','sepia','glitch']; const themeKey='kx-theme';
    function applyTheme(t){
      if(!THEMES.includes(t)) t='subsurface';
      document.documentElement.setAttribute('data-theme', t);
      try{ localStorage.setItem(themeKey, t) }catch(_){}
      document.querySelectorAll('.kx-pill').forEach(b=> b.dataset.on = (b.dataset.theme===t) ? 'true' : 'false');
      const meta=document.querySelector('meta[name="theme-color"]');
      if(meta){ const bg=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0b0f14'; meta.setAttribute('content', bg); }
    }
    (function initTheme(){
      let t='subsurface'; try{ t=localStorage.getItem(themeKey)||t }catch(_){}
      applyTheme(t);
      document.getElementById('themePicker').addEventListener('click', e=>{
        const btn=e.target.closest('.kx-pill'); if(!btn) return; applyTheme(btn.dataset.theme);
      });
      document.addEventListener('keyup', e=>{
        if((e.key||'').toLowerCase()!=='t') return;
        const cur=document.documentElement.getAttribute('data-theme')||'subsurface';
        const next=THEMES[(THEMES.indexOf(cur)+1)%THEMES.length]; applyTheme(next);
      });
    })();

    // Утилиты
    function fmtDayYear(s){
      if(!s) return '';
      if(/^\d{4}-\d{2}-\d{2}/.test(s)){
        const d=new Date(s); const y=d.getUTCFullYear();
        const start=new Date(Date.UTC(y,0,1));
        const doy=Math.floor((d-start)/86400000)+1;
        const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
        return `${doy}-й день ${y}-го года, ${hh}:${mm}`;
      }
      const m=String(s).trim().match(/^(\d{4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if(m){ const y=+m[1], doy=+m[2]; const hh=m[3]?m[3].padStart(2,'0'):'00', mm=m[4]?m[4]:'00'; return `${doy}-й день ${y}-го года, ${hh}:${mm}`;}
      return s;
    }
    function esc(s){return (s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]))}

    // Стабильный смайлик автора
    const EMO=["🛠️","🪫","🛰️","🧭","🌘","💡","⚙️","🧪","📡","🧱","🪓","⛓️","🧯","🔧","🔭","🪨","🌫️","🌊","🪙","🜂","🜁","🜄","🜃"];
    function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0 }
    function authorEmoji(name){ const i = hashStr(name||'anon') % EMO.length; return EMO[i] }

    // Состояние
    const box=document.getElementById('threads'), filt=document.getElementById('filters');
    const qInp=document.getElementById('q'), qClr=document.getElementById('clearQ');
    let allItems=[], currentBoard='', query='';

    async function loadIndex(){
      try{ const r=await fetch('/content/threads-index.json',{cache:'no-store'}); if(!r.ok) throw 0; return await r.json() }catch(_){ return [] }
    }

    function card(t){
      const when=fmtDayYear(t.created);
      const preview=(t.body||'').replace(/\s+/g,' ').slice(0,200)+(t.body&&t.body.length>200?'…':'');
      const auth=esc(t.author||'anon'); const aId=encodeURIComponent(t.author_id||auth.toLowerCase());
      const emo=authorEmoji(auth);
      const tags=(t.tags||[]).map(x=>`<span class="kx-tag">${esc(x)}</span>`).join(' ');
      return `<article class="kx-thread">
        <a class="kx-link" href="/thread.html#/${encodeURIComponent(t.id)}"><h3 class="kx-title">✶ ${esc(t.title||'Без названия')}</h3></a>
        <div class="kx-sub">${when} · <a href="/author.html#/${aId}" title="Все посты автора">${emo} ${auth}</a> · сектор: ${esc(t.sector||'—')}${t.board?` · раздел: ${esc(t.board)}`:''}</div>
        <p class="kx-preview">${esc(preview)}</p>
        <div class="kx-tags">${tags}</div>
      </article>`;
    }

    function matches(t){
      // не показываем «комментарии»-файлы как темы
      if ((t.board||'') === 'комментарии') return false;
      if(currentBoard && (t.board||'')!==currentBoard) return false;
      if(!query) return true;
      const hay = [t.title,t.body,(t.tags||[]).join(' '),t.author,t.sector,t.id].join(' ').toLowerCase();
      return hay.includes(query);
    }

    function render(){
      const items = allItems.filter(matches);
      box.innerHTML = items.length ? items.map(card).join('') : `<div class="kx-muted">Ничего не найдено.</div>`;
    }

    function renderBoards(){
      const boards = Array.from(new Set(allItems.map(x=>x.board).filter(b=>b && b!=='комментарии'))).sort();
      if(!boards.length){ filt.innerHTML=''; return; }
      const chip = b => `<span class="kx-tag${b===currentBoard?' kx-tag--on':''}" data-board="${esc(b)}">${esc(b)}</span>`;
      filt.innerHTML = `<span class="kx-tag${!currentBoard?' kx-tag--on':''}" data-board="">Все</span>` + boards.map(chip).join('');
      filt.onclick = e=>{ const el=e.target.closest('.kx-tag'); if(!el) return; currentBoard = el.dataset.board || ''; renderBoards(); render(); };
    }

    allItems = await loadIndex();
    renderBoards(); render();

    qInp.addEventListener('input', ()=>{ query=qInp.value.trim().toLowerCase(); render(); });
    qClr.addEventListener('click', ()=>{ qInp.value=''; query=''; render(); });
  </script>
</body>
</html>
