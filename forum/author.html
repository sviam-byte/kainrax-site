<!doctype html>
<html lang="ru" data-theme="subsurface">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>–ü—Ä–æ—Ñ–∏–ª—å –∞–≤—Ç–æ—Ä–∞ ‚Äî –î–æ—Å–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞</title>
  <meta name="theme-color" content="#0b0f14"/>
  <meta name="color-scheme" content="dark light"/>
  <meta name="format-detection" content="telephone=no"/>

  <script src="/assets/metrika.js" defer></script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0e141d; --card:#0e141d; --text:#e6edf5; --muted:#9fb0c7;
      --tag:#112131; --tag-on:#183140; --link:#bfe9ff; --ring:#7dd3fc; --brand:#7dd3fc;
      --r:14px; --shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 8px 30px rgba(0,0,0,.35);
      --border:rgba(255,255,255,.06);
    }
    html[data-theme="sepia"]{
      --bg:#f8f4ec; --panel:#ffffff; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --brand:#d6b778; --link:#0b66d3; --tag:#efe3cc; --tag-on:#e6d8be; --ring:#d6b778;
      --shadow:0 1px 0 rgba(0,0,0,.03) inset, 0 8px 30px rgba(0,0,0,.08);
      --border:rgba(0,0,0,.08);
    }
    html[data-theme="glitch"]{
      --bg:#07090d; --panel:#0c121b; --card:#0c121b; --text:#e8f0ff; --muted:#9fb6d6;
      --brand:#a78bfa; --link:#b9a4ff; --tag:#0d1a2a; --tag-on:#14253a; --ring:#a78bfa;
      --border:rgba(255,255,255,.08);
    }

    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      -webkit-text-size-adjust:100%; text-size-adjust:100%;
      overscroll-behavior-y:none; scrollbar-gutter:stable both-edges;
    }
    *{box-sizing:border-box}
    img,svg,video{max-width:100%;height:auto}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    :focus-visible{outline:2px solid var(--ring); outline-offset:2px}

    .kx-head{
      position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 16px;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));
      backdrop-filter:saturate(1.1) blur(6px);
      -webkit-backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid var(--border)
    }
    html[data-theme="sepia"] .kx-head{background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,0))}
    .kx-brand{font-weight:800;color:var(--text);white-space:nowrap}
    .kx-nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kx-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:var(--tag);border:1px solid var(--border);box-shadow:var(--shadow);color:var(--text);min-height:40px}
    .kx-btn:hover{transform:translateY(-1px)}
    .is-active{outline:2px solid var(--ring)}
    .kx-themes{display:flex;gap:6px}
    .kx-pill{font-size:12px;padding:8px 12px;border-radius:999px;background:var(--tag);color:var(--muted);border:1px solid var(--border);cursor:pointer}
    .kx-pill[data-on="true"]{background:var(--tag-on);color:var(--text);outline:1px solid var(--ring)}

    .kx-shell{max-width:1000px;margin:0 auto;padding:16px}
    .kx-panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}

    .kx-tag{display:inline-flex;align-items:center;padding:6px 10px;border-radius:10px;background:var(--tag);color:var(--muted);font-size:12px;border:1px solid var(--border)}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card);content-visibility:auto;contain-intrinsic-size:120px}
    .muted{color:var(--muted);font-size:13px}

    #sky-line{position:fixed;left:0;right:0;height:3px;z-index:0;pointer-events:none;opacity:.7;filter:blur(1px);background:radial-gradient(ellipse 80% 150% at 50% 50%, var(--brand) 0%, transparent 40%)}
  </style>
</head>
<body>
  <div id="sky-line" aria-hidden="true"></div>

  <header class="kx-head" role="banner">
    <a class="kx-brand" href="/index.html">–î–æ—Å–∫–∞ –ö–∞–π–Ω—Ä–∞–∫—Å</a>
    <nav class="kx-nav" role="navigation" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è">
      <a class="kx-btn" href="/index.html">–¢–µ–º—ã</a>
      <a class="kx-btn is-active" href="/people.html" aria-current="page">–í—Å–µ –ª—é–¥–∏</a>
      <a class="kx-btn" href="/tags.html">–¢–µ–≥–∏</a>
      <a class="kx-btn" href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">–ö –ø—Ä–æ–µ–∫—Ç—É</a>
      <a class="kx-btn" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</a>
      <div class="kx-themes" id="themePicker" aria-label="–¢–µ–º—ã">
        <button class="kx-pill" data-theme="subsurface" type="button">Subsurface</button>
        <button class="kx-pill" data-theme="sepia" type="button">Sepia</button>
        <button class="kx-pill" data-theme="glitch" type="button">Glitch</button>
      </div>
    </nav>
  </header>

  <main class="kx-shell" id="main" tabindex="-1">
    <section class="kx-panel" id="box" aria-live="polite">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</section>
  </main>

  <script type="module">
    // –£—Ç–∏–ª–∏—Ç—ã
    const qs = (s,root=document)=>root.querySelector(s);
    function esc(s){return (s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]))}
    function parseHash(){const raw=(location.hash||'').slice(1).replace(/^\//,''); return decodeURIComponent(raw||'').trim()}
    function j(u, opt){ return fetch(u, opt||{cache:'force-cache'}).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }) }

    // –î–∞—Ç–∞
    function fmtDayYear(s){
      if(!s) return '';
      const m=String(s).trim().match(/^(\d{3,4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if(m){const yy=+m[1],doy=+m[2];const hh=m[3]?m[3].padStart(2,'0'):'00',mm=m[4]?m[4]:'00';return `${doy}-–π –¥–µ–Ω—å ${yy}-–≥–æ –≥–æ–¥–∞, ${hh}:${mm}`}
      const d=new Date(s); if(!isNaN(d)){const ry=d.getUTCFullYear(); const wy=ry===2024?429:ry===2025?430:(ry-1595); const start=new Date(Date.UTC(ry,0,1)); const doy=Math.floor((d-start)/86400000)+1; const hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0'); return `${doy}-–π –¥–µ–Ω—å ${wy}-–≥–æ –≥–æ–¥–∞, ${hh}:${mm}`} return s;
    }

    // –≠–º–æ–¥–∑–∏
    const EMO=["üõ†Ô∏è","ü™´","üõ∞Ô∏è","üß≠","üåò","üí°","‚öôÔ∏è","üß™","üì°","üß±","ü™ì","‚õìÔ∏è","üßØ","üîß","üî≠","ü™®","üå´Ô∏è","üåä","ü™ô","üúÇ","üúÅ","üúÑ","üúÉ"];
    function hashStr(s){let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0}
    function em(name){return EMO[hashStr(name||'anon')%EMO.length]}

    // –ü–æ–ª–æ—Å–∞ –Ω–µ–±–∞
    (function initSkyLine(){
      const el=document.getElementById('sky-line'); let run=true;
      const unit = (CSS && CSS.supports && CSS.supports('height: 100svh')) ? 'svh' : 'vh';
      function tick(){ const n=new Date(); const ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds(); el.style.top=(ms/86400000*100)+unit; if(run) requestAnimationFrame(tick); }
      document.addEventListener('visibilitychange',()=>{run=document.visibilityState==='visible'; if(run) requestAnimationFrame(tick)},{passive:true});
      requestAnimationFrame(tick);
    })();

    // –¢–µ–º—ã
    (function initTheme(){
      const THEMES=['subsurface','sepia','glitch'], key='kx-theme';
      function applyTheme(t){
        if(!THEMES.includes(t)) t='subsurface';
        document.documentElement.setAttribute('data-theme', t);
        try{ localStorage.setItem(key,t) }catch(_){}
        document.querySelectorAll('.kx-pill').forEach(b=> b.dataset.on = (b.dataset.theme===t) ? 'true' : 'false');
        const meta=document.querySelector('meta[name="theme-color"]');
        if(meta){ const bg=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0b0f14'; meta.setAttribute('content', bg); }
      }
      let t='subsurface'; try{ t=localStorage.getItem(key)||t }catch(_){}
      applyTheme(t);
      document.getElementById('themePicker').addEventListener('click', e=>{ const btn=e.target.closest('.kx-pill'); if(!btn) return; applyTheme(btn.dataset.theme); }, {passive:true});
      document.addEventListener('keyup', e=>{ if((e.key||'').toLowerCase()!=='t') return; const cur=document.documentElement.getAttribute('data-theme')||'subsurface'; const list=['subsurface','sepia','glitch']; applyTheme(list[(list.indexOf(cur)+1)%list.length]) });
    })();

    // –†–µ–Ω–¥–µ—Ä
    function tplPost(t){
      return `<div class="item"><div><a href="/thread.html#/${encodeURIComponent(t.id)}"><strong>${esc(t.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</strong></a></div><div class="muted">${fmtDayYear(t.created)} ¬∑ —Å–µ–∫—Ç–æ—Ä: ${esc(t.sector||'‚Äî')}${t.board?` ¬∑ —Ä–∞–∑–¥–µ–ª: ${esc(t.board)}`:''} ¬∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${t.commentCount||0}</div></div>`;
    }
    function tplComment(c){
      return `<div class="item"><div class="muted">${fmtDayYear(c.created)} ¬∑ –≤ —Ç–µ–º–µ: <a href="/thread.html#/${encodeURIComponent(c.thread_id)}?c=${encodeURIComponent(c.comment_id||'')}">${esc(c.thread_title||c.thread_id)}</a></div><div style="margin-top:6px;white-space:pre-wrap">${esc((c.body||'').slice(0,800))}${(c.body||'').length>800?'‚Ä¶':''}</div></div>`;
    }

    async function render(){
      const aid = parseHash();
      const box = qs('#box');
      if(!aid){ box.innerHTML = `<p class="muted">–ê–≤—Ç–æ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω. –û—Ç–∫—Ä–æ–π –ø–æ —Å—Å—ã–ª–∫–µ –≤–∏–¥–∞ <code>/people.html#/author_id</code>.</p>`; return; }

      // –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π ¬´—à–∞–ø–æ—á–Ω—ã–π¬ª —Ä–µ–Ω–¥–µ—Ä
      box.innerHTML = `<h1>üë§ ${esc(aid)}</h1><p class="muted">ID: ${esc(aid)} ¬∑ –ø–æ—Å—Ç–æ–≤: ‚Äî ¬∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ‚Äî</p><div class="grid"><section><h3>–ü–æ—Å—Ç—ã</h3><div class="item">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤‚Ä¶</div></section><section><h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><div class="item">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤‚Ä¶</div></section></div>`;

      // –≥—Ä—É–∑–∏–º –ø–æ—Å—Ç—ã (cache-first)
      let threads = [];
      try{
        threads = await j('/content/threads-index.json', {cache:'force-cache'});
      }catch(_){}
      threads = Array.isArray(threads) ? threads : (threads && Array.isArray(threads.items) ? threads.items : []);
      const authored = threads.filter(x => (x.board||'')!=='–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏' && (x.author_id||'') === aid)
                              .sort((a,b)=> new Date(b.created) - new Date(a.created));
      const displayName = authored[0]?.author || null;
      if(displayName){
        box.querySelector('h1').innerHTML = `${em(displayName)} ${esc(displayName)}`;
      }
      box.querySelectorAll('section')[0].innerHTML = `<h3>–ü–æ—Å—Ç—ã</h3>${authored.length ? authored.map(tplPost).join('') : '<div class="muted">–ü–æ—Å—Ç–æ–≤ –Ω–µ—Ç.</div>'}`;

      // –¥–æ–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–¥–µ–ª—å–Ω–æ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –ø–µ–π–Ω—Ç)
      try{
        let comments = await j('/content/comments-index.json', {cache:'force-cache'});
        comments = Array.isArray(comments) ? comments : (comments && Array.isArray(comments.items) ? comments.items : []);
        const comms = comments.filter(x => (x.author_id||'') === aid)
                              .sort((a,b)=> new Date(b.created) - new Date(a.created));
        box.querySelectorAll('section')[1].innerHTML = `<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>${comms.length ? comms.map(tplComment).join('') : '<div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç.</div>'}`;
        // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
        const p = box.querySelector('.muted');
        if(p) p.innerHTML = `ID: ${esc(aid)} ¬∑ –ø–æ—Å—Ç–æ–≤: ${authored.length} ¬∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${comms.length}`;
      }catch(e){
        box.querySelectorAll('section')[1].innerHTML = `<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><div class="item"><strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</strong><div class="muted">${esc(String(e))}</div></div>`;
      }
    }

    addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
