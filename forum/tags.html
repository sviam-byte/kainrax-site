<!doctype html>
<html lang="ru" data-theme="subsurface">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–¢–µ–≥–∏ ‚Äî –î–æ—Å–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞</title>
  <meta name="theme-color" content="#0b0f14"/>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%237dd3fc'/%3E%3Cstop offset='70%25' stop-color='%230b0f14' stop-opacity='.05'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%230b0f14'/%3E%3Cpath d='M32 6 L36 24 L58 28 L36 32 L32 50 L28 32 L6 28 L28 24 Z' fill='url(%23g)'/%3E%3Ccircle cx='32' cy='32' r='2.4' fill='%23a78bfa'/%3E%3C/svg%3E" />
  <style>
    :root{--bg:#0b0f14;--panel:#0e141d;--text:#e6edf5;--muted:#9fb0c7;--tag:#112131;--tag-on:#183140;--link:#bfe9ff;--ring:#7dd3fc;--r:14px;--shadow:0 8px 30px rgba(0,0,0,.35)}
    html[data-theme="sepia"]{--bg:#0e0b09;--panel:#16120d;--text:#ece3d3;--muted:#bdae95;--tag:#2a2218;--tag-on:#3a2f21;--link:#f3d7a6;--ring:#d6b778}
    html[data-theme="glitch"]{--bg:#07090d;--panel:#0c121b;--text:#e8f0ff;--muted:#9fb6d6;--tag:#0d1a2a;--tag-on:#14253a;--link:#b9a4ff;--ring:#a78bfa}
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    .kx-head{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));border-bottom:1px solid rgba(255,255,255,.05)}
    .kx-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--tag);border:1px solid rgba(255,255,255,.06);color:var(--text)}
    .kx-cta{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,0)),var(--tag-on);border-color:rgba(255,255,255,.12);font-weight:600}
    .kx-shell{max-width:1100px;margin:0 auto;padding:16px}
    .kx-panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    h1{margin:0 0 6px 0;font-size:22px} .muted{color:var(--muted)}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .kx-tag{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:var(--tag);border:1px solid rgba(255,255,255,.06);color:var(--text);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .card{background:#0e141d;border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:var(--shadow);padding:14px}
    .title{margin:2px 0 4px 0;font-size:18px}
    .sub{font-size:12px;color:var(--muted)}
    .preview{margin:8px 0 10px 0}
    .tbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    #sky{position:fixed;left:0;right:0;height:3px;opacity:.7;filter:blur(1px);background:radial-gradient(ellipse 80% 150% at 50% 50%, var(--ring) 0%, transparent 40%)}
  </style>
</head>
<body>
  <div id="sky" aria-hidden="true"></div>
  <header class="kx-head">
    <div style="display:flex;gap:8px">
      <a class="kx-btn" href="/index.html">‚Üê –¢–µ–º—ã</a>
      <a class="kx-btn" href="/people.html">–í—Å–µ –ª—é–¥–∏</a>
    </div>
    <div style="display:flex;gap:8px">
      <a class="kx-btn" href="https://kainrax.netlify.app/#/" target="_blank" rel="noopener">–ö –ø—Ä–æ–µ–∫—Ç—É</a>
      <a class="kx-btn kx-cta" href="https://t.me/kainrax" target="_blank" rel="noopener nofollow">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</a>
    </div>
  </header>

  <main class="kx-shell">
    <section class="kx-panel">
      <h1 id="heading">–¢–µ–≥–∏</h1>
      <div id="controls" class="tbar"></div>
      <div id="tags" class="tags"></div>
      <div id="list" class="grid"></div>
    </section>
  </main>

  <script type="module">
    // –Ω–µ–±–æ
    (function sky(){const el=document.getElementById('sky');let run=true;function t(){const n=new Date();const ms=n.getHours()*3600000+n.getMinutes()*60000+n.getSeconds()*1000+n.getMilliseconds();el.style.top=(ms/86400000*100)+'vh'; if(run) requestAnimationFrame(t)}document.addEventListener('visibilitychange',()=>{run=document.visibilityState==='visible'; if(run) requestAnimationFrame(t)});requestAnimationFrame(t)})();

    // –¥–∞—Ç—ã 429/430 + "430-218 22:17"
    function fmtDayYear(s){
      if(!s) return '';
      const m = String(s).trim().match(/^(\d{3,4})[\s\-_:.\/]+(\d{1,3})(?:.*?(\d{1,2}):(\d{2}))?$/);
      if (m){ const yy=+m[1], doy=+m[2]; const hh=m[3]?m[3].padStart(2,'0'):'00', mm=m[4]?m[4]:'00'; return `${doy}-–π –¥–µ–Ω—å ${yy}-–≥–æ –≥–æ–¥–∞, ${hh}:${mm}`; }
      const d = new Date(s);
      if (!isNaN(d)){ const ry=d.getUTCFullYear(); const wy=ry===2024?429:ry===2025?430:(ry-1595); const start=new Date(Date.UTC(ry,0,1)); const doy=Math.floor((d-start)/86400000)+1; const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0'); return `${doy}-–π –¥–µ–Ω—å ${wy}-–≥–æ –≥–æ–¥–∞, ${hh}:${mm}` }
      return s;
    }
    function esc(s){return (s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]))}
    function slugify(s){ return String(s||'anon').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_.]+/g,'').slice(0,64) }
    function getTag(){ return decodeURIComponent(location.hash.replace(/^#\/?/,'')).trim() }

    const EMO=["üõ†Ô∏è","ü™´","üõ∞Ô∏è","üß≠","üåò","üí°","‚öôÔ∏è","üß™","üì°","üß±","ü™ì","‚õìÔ∏è","üßØ","üîß","üî≠","ü™®","üå´Ô∏è","üåä","ü™ô","üúÇ","üúÅ","üúÑ","üúÉ"];
    function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0 }
    function authorEmoji(name){ return EMO[hashStr(name||'anon')%EMO.length] }

    async function loadIdx(){ const r=await fetch('/content/threads-index.json',{cache:'no-store'}); if(!r.ok) throw 0; return await r.json() }

    function card(t){
      const when=fmtDayYear(t.created);
      const preview=(t.body||'').replace(/\s+/g,' ').slice(0,200)+(t.body&&t.body.length>200?'‚Ä¶':'');
      const name=esc(t.author||'anon'); const aId=encodeURIComponent(t.author_id||slugify(name));
      const emo=authorEmoji(name);
      const tags=(t.tags||[]).map(x=>`<a class="kx-tag" href="#/${encodeURIComponent(x)}">${esc(x)}</a>`).join(' ');
      return `<article class="card">
        <a class="title" href="/thread.html#/${encodeURIComponent(t.id)}">‚ú∂ ${esc(t.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</a>
        <div class="sub">${when} ¬∑ <a href="/author.html#/${aId}">${emo} ${name}</a> ¬∑ —Å–µ–∫—Ç–æ—Ä: ${esc(t.sector||'‚Äî')}${t.board?` ¬∑ —Ä–∞–∑–¥–µ–ª: ${esc(t.board)}`:''}</div>
        <p class="preview">${esc(preview)}</p>
        <div class="tbar">${tags}</div>
      </article>`;
    }

    function buildTagMap(items){
      const map=new Map();
      for (const t of items){
        if ((t.board||'')==='–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏') continue; // –Ω–µ —Å—á–∏—Ç–∞–µ–º —Ñ–∞–π–ª—ã-–∫–æ–º–º–µ–Ω—Ç—ã
        for (const tag of (t.tags||[])){
          const k=String(tag); const arr=map.get(k)||[]; arr.push(t); map.set(k, arr);
        }
      }
      return map;
    }

    async function render(){
      const boxL=document.getElementById('list');
      const boxT=document.getElementById('tags');
      const heading=document.getElementById('heading');
      const controls=document.getElementById('controls');

      const items = await loadIdx();
      const tagMap = buildTagMap(items);
      const tag = getTag();

      if (!tag){
        heading.textContent='–¢–µ–≥–∏';
        controls.innerHTML = `<a class="kx-tag" href="/index.html">‚Üê –∫–æ –≤—Å–µ–º —Ç–µ–º–∞–º</a>`;
        // —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ–≥–æ–≤
        const sorted = Array.from(tagMap.entries()).sort((a,b)=> a[0].localeCompare(b[0],'ru'));
        boxT.innerHTML = sorted.map(([k,arr])=>`<a class="kx-tag" href="#/${encodeURIComponent(k)}">${esc(k)}&nbsp;<span class="muted">(${arr.length})</span></a>`).join(' ');
        boxL.innerHTML = '';
      } else {
        heading.textContent = `–¢–µ–≥: ${tag}`;
        controls.innerHTML = `<a class="kx-tag" href="/tags.html">‚Üê –≤—Å–µ —Ç–µ–≥–∏</a> <a class="kx-tag" href="/index.html">–∫–æ –≤—Å–µ–º —Ç–µ–º–∞–º</a>`;
        boxT.innerHTML = '';
        const posts = (tagMap.get(tag)||[]).sort((a,b)=>(new Date(b.created))-(new Date(a.created)));
        boxL.innerHTML = posts.length ? posts.map(card).join('') : `<div class="muted">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤ —Å —Ç–µ–≥–æ–º ¬´${esc(tag)}¬ª.</div>`;
      }
    }

    addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
