# netlify.toml

[build]
  # Сначала общий контент-индекс, потом пергамент
  command   = "node scripts/build-index.mjs && node scripts/build-pergament.mjs"
  publish   = "."
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "18"
  # PERG_DEFAULT_CODE = "Chronicle"   # если нужен единый код для старых редакций (опционально)

[functions]
  node_bundler  = "esbuild"
  included_files = ["content/**"]

# ─────────────────────────────────────────────────────────────
# Спец-исключение: /o2log — отдельная страница, не SPA-маршрут
# ─────────────────────────────────────────────────────────────
[[redirects]]
  from   = "/o2log"
  to     = "/o2log/"
  status = 301

[[redirects]]
  from   = "/o2log/*"
  to     = "/o2log/index.html"
  status = 200

# Проксирование функций (оставляем как было)
[[redirects]]
  from   = "/.netlify/functions/*"
  to     = "/.netlify/functions/:splat"
  status = 200

# Отдаём статический контент как есть
[[redirects]]
  from   = "/content/*"
  to     = "/content/:splat"
  status = 200

# ─────────────────────────────────────────────────────────────
# Общий SPA-роутинг: всё остальное — на корневой index.html
# ─────────────────────────────────────────────────────────────
[[redirects]]
  from   = "/*"
  to     = "/index.html"
  status = 200
