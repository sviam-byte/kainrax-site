# ── СБОРКА ───────────────────────────────────────────────────────
[build]
  # Твой генератор Пергамента
  command   = "node scripts/build-pergament.mjs"
  publish   = "."
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "18"
  # Поставь эти штуки в UI, если нужно
  # MEDIA_HUB_BASE            = "https://hub.example.com/media"
  # MEDIA_ASSETS_BASE         = "https://assets.example.com"
  # MEDIA_DOMAIN_WHITELIST    = "hub.example.com,assets.example.com,cdn.example.org"

# ── ФУНКЦИИ ──────────────────────────────────────────────────────
[functions]
  # esbuild нормальный, тянем внешний модуль deta
  node_bundler           = "esbuild"
  external_node_modules  = ["deta"]
  included_files         = ["content/**"]  # твой контент доступен функциям

# ── ГЛАВНАЯ: новый лендинг на /home.html ────────────────────────
# Если хочешь, чтобы с корня открывался новый экран — редиректим
[[redirects]]
  from   = "/"
  to     = "/home.html"
  status = 200

# ── /o2log: отдельное статическое мини-приложение ────────────────
# /o2log → /o2log/
[[redirects]]
  from   = "/o2log"
  to     = "/o2log/"
  status = 301

# все файлы внутри /o2log/* отдаём как есть (JS, JSON, PNG…)
[[redirects]]
  from   = "/o2log/*"
  to     = "/o2log/:splat"
  status = 200

# ── API: безопасный алиас /api/* → /.netlify/functions/:splat ───
[[redirects]]
  from   = "/api/*"
  to     = "/.netlify/functions/:splat"
  status = 200

# ── СТАТИКА /content/* ──────────────────────────────────────────
[[redirects]]
  from   = "/content/*"
  to     = "/content/:splat"
  status = 200

# Кэш для статического контента
[[headers]]
  for = "/content/*"
  [headers.values]
    Cache-Control = "public, max-age=600"

# Главные html без кэша, чтобы не залипала разметка/мета
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-store"

[[headers]]
  for = "/home.html"
  [headers.values]
    Cache-Control = "no-store"

# (опционально) долгий кэш для /o2log/*
# [[headers]]
#   for = "/o2log/*"
#   [headers.values]
#     Cache-Control = "public, max-age=31536000, immutable"

# ── SPA-ФОЛЛБЭК (ПОСЛЕДНИМ!) ────────────────────────────────────
# Если у тебя клиентская маршрутизация, незнакомые пути отправляем на index.
# Важно: стоит ПОСЛЕ /api и /o2log, чтобы их не сломать.
[[redirects]]
  from   = "/*"
  to     = "/index.html"
  status = 200
