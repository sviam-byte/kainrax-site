# ── СБОРКА ───────────────────────────────────────────────────────
[build]
  command   = "node scripts/build-pergament.mjs"
  publish   = "."
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION       = "18"
  # Пока правишь контент, можно не падать из-за отсутствующих редакций:
  PERGAMENT_STRICT   = "0"
  # MEDIA_* — опционально
  # MEDIA_HUB_BASE    = "https://hub.example.com/media"
  # MEDIA_ASSETS_BASE = "https://assets.example.com"
  # MEDIA_DOMAIN_WHITELIST = "hub.example.com,assets.example.com,cdn.example.org"

# ── ФУНКЦИИ ──────────────────────────────────────────────────────
[functions]
  node_bundler           = "esbuild"
  external_node_modules  = ["deta"]
  included_files         = ["content/**"]

# ── ГЛАВНАЯ: новый лендинг на корне ─────────────────────────────
[[redirects]]
  from   = "/"
  to     = "/home.html"
  status = 200

# ── ПЕРГАМЕНТ: реальные тексты (.txt) ───────────────────────────
# Канонический проход к файлам внутри /content/pergament/*
[[redirects]]
  from   = "/pergament/*"
  to     = "/content/pergament/:splat"
  status = 200

# ── /o2log: статическое мини-приложение ─────────────────────────
[[redirects]]
  from   = "/o2log"
  to     = "/o2log/"
  status = 301

[[redirects]]
  from   = "/o2log/*"
  to     = "/o2log/:splat"
  status = 200

# ── API: человекопонятный алиас ─────────────────────────────────
[[redirects]]
  from   = "/api/*"
  to     = "/.netlify/functions/:splat"
  status = 200

# ── Статика /content/* как есть ─────────────────────────────────
[[redirects]]
  from   = "/content/*"
  to     = "/content/:splat"
  status = 200

# ── КЭШИ ─────────────────────────────────────────────────────────
# Пергамент всегда как text/plain и с лёгким кэшем
[[headers]]
  for = "/pergament/*"
  [headers.values]
    Cache-Control = "public, max-age=600"
    Content-Type  = "text/plain; charset=utf-8"

[[headers]]
  for = "/content/pergament/*"
  [headers.values]
    Cache-Control = "public, max-age=600"
    Content-Type  = "text/plain; charset=utf-8"

# Общий кэш для прочего /content/*
[[headers]]
  for = "/content/*"
  [headers.values]
    Cache-Control = "public, max-age=600"

# Главные HTML не кэшируем
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-store"

[[headers]]
  for = "/home.html"
  [headers.values]
    Cache-Control = "no-store"

# ── SPA-фоллбек (ПОСЛЕДНИМ!) ────────────────────────────────────
[[redirects]]
  from   = "/*"
  to     = "/index.html"
  status = 200
