[build]
  command = "npm run build"
  publish = "build"

[build.environment]
  NODE_VERSION = "20"

[functions]
  node_bundler          = "esbuild"
  external_node_modules = ["deta"]
  included_files        = ["content/**"]

# root landing
[[redirects]]
  from = "/"
  to   = "/home.html"
  status = 200

# canonar (subpath + SPA fallback)
[[redirects]]
  from = "/canonar"
  to   = "/canonar/"
  status = 301

[[redirects]]
  from = "/canonar/*"
  to   = "/canonar/index.html"
  status = 200

# pergament (plain text from /content/pergament)
[[redirects]]
  from = "/pergament/*"
  to   = "/content/pergament/:splat"
  status = 200

# raw content pass-through
[[redirects]]
  from = "/content/*"
  to   = "/content/:splat"
  status = 200

# /o2log static mini-app
[[redirects]]
  from = "/o2log"
  to   = "/o2log/"
  status = 301

[[redirects]]
  from = "/o2log/*"
  to   = "/o2log/:splat"
  status = 200

# forum sections as static
[[redirects]]
  from = "/forum"
  to   = "/forum/"
  status = 301

[[redirects]]
  from = "/forum/*"
  to   = "/forum/:splat"
  status = 200

[[redirects]]
  from = "/forumen"
  to   = "/forumen/"
  status = 301

[[redirects]]
  from = "/forumen/*"
  to   = "/forumen/:splat"
  status = 200

# kids section (dir or single html — оба кейса покрыты)
[[redirects]]
  from = "/kids"
  to   = "/kids/"
  status = 301

[[redirects]]
  from = "/kids/*"
  to   = "/kids/:splat"
  status = 200

# API -> Netlify functions
[[redirects]]
  from = "/api/*"
  to   = "/.netlify/functions/:splat"
  status = 200

# headers for pergament
[[headers]]
  for = "/pergament/*"
  [headers.values]
    Cache-Control = "public, max-age=600"
    Content-Type  = "text/plain; charset=utf-8"

[[headers]]
  for = "/content/pergament/*"
  [headers.values]
    Cache-Control = "public, max-age=600"
    Content-Type  = "text/plain; charset=utf-8"

# generic cache for other /content/*
[[headers]]
  for = "/content/*"
  [headers.values]
    Cache-Control = "public, max-age=600"

# avoid caching main html
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-store"

[[headers]]
  for = "/home.html"
  [headers.values]
    Cache-Control = "no-store"
