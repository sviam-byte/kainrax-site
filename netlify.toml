[build]
  command   = "npm run build"
  publish   = "build"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "20"

[functions]
  node_bundler          = "esbuild"
  external_node_modules = ["deta"]
  included_files        = ["content/**"]

# Root landing
[[redirects]]
  from = "/"
  to   = "/home.html"
  status = 200

# Pergament plain text under /pergament/*
[[redirects]]
  from = "/pergament/*"
  to   = "/content/pergament/:splat"
  status = 200

# /o2log mini-app
[[redirects]]
  from = "/o2log"
  to   = "/o2log/"
  status = 301

[[redirects]]
  from = "/o2log/*"
  to   = "/o2log/:splat"
  status = 200

# API -> Netlify functions
[[redirects]]
  from = "/api/*"
  to   = "/.netlify/functions/:splat"
  status = 200

# Pass-through for /content/*
[[redirects]]
  from = "/content/*"
  to   = "/content/:splat"
  status = 200

# SPA fallback ONLY for canonar
[[redirects]]
  from = "/canonar/*"
  to   = "/canonar/index.html"
  status = 200

# Caching/text for pergament
[[headers]]
  for = "/pergament/*"
  [headers.values]
    Cache-Control = "public, max-age=600"
    Content-Type  = "text/plain; charset=utf-8"

[[headers]]
  for = "/content/pergament/*"
  [headers.values]
    Cache-Control = "public, max-age=600"
    Content-Type  = "text/plain; charset=utf-8"

# Generic cache for /content/*
[[headers]]
  for = "/content/*"
  [headers.values]
    Cache-Control = "public, max-age=600"

# Do not cache main html
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-store"

[[headers]]
  for = "/home.html"
  [headers.values]
    Cache-Control = "no-store"
