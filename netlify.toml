# ── Сборка ───────────────────────────────────────────────────────
[build]
  command   = "node scripts/build-index.mjs && node scripts/build-pergament.mjs"
  publish   = "."
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "18"

[functions]
  node_bundler   = "esbuild"
  included_files = ["content/**"]

# ── /o2log: отдельное статическое мини-приложение ───────────────
# редиректим только голый /o2log → /o2log/
[[redirects]]
  from   = "/o2log"
  to     = "/o2log/"
  status = 301

# все файлы внутри /o2log/* отдаём как есть (JS, JSON, PNG…)
[[redirects]]
  from   = "/o2log/*"
  to     = "/o2log/:splat"
  status = 200

# ── Функции: безопасный алиас /api/* → /.netlify/functions/:splat ─
# (нельзя использовать /.netlify/... в "from", поэтому даём внешний путь)
[[redirects]]
  from   = "/api/*"
  to     = "/.netlify/functions/:splat"
  status = 200

# ── Статический контент ─────────────────────────────────────────
[[redirects]]
  from   = "/content/*"
  to     = "/content/:splat"
  status = 200

# Кеш для статического контента
[[headers]]
  for = "/content/*"
  [headers.values]
    Cache-Control = "public, max-age=600"

# ── Общий SPA-фоллбек для основного сайта (последним!) ─────────
[[redirects]]
  from   = "/*"
  to     = "/index.html"
  status = 200
